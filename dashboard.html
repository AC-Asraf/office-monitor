<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Office Infrastructure Monitor v2</title>

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0F172A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Office Monitor">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230F172A' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle'>üè¢</text></svg>">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Office Monitor">
  <meta name="msapplication-TileColor" content="#0F172A">
  <meta name="msapplication-tap-highlight" content="no">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ==================== DESIGN SYSTEM ==================== */
    :root {
      /* Background Layers */
      --bg-base: #0A0F1A;
      --bg-surface: #111827;
      --bg-elevated: #1F2937;
      --bg-overlay: #374151;
      --bg-glass: rgba(17, 24, 39, 0.8);

      /* Status Colors */
      --status-online: #10B981;
      --status-online-bg: rgba(16, 185, 129, 0.15);
      --status-offline: #EF4444;
      --status-offline-bg: rgba(239, 68, 68, 0.15);
      --status-warning: #F59E0B;
      --status-warning-bg: rgba(245, 158, 11, 0.15);
      --status-info: #3B82F6;
      --status-info-bg: rgba(59, 130, 246, 0.15);

      /* Text */
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;

      /* Accents */
      --accent-blue: #3B82F6;
      --accent-purple: #8B5CF6;
      --accent-cyan: #06B6D4;
      --accent-emerald: #10B981;

      /* Borders */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.1);
      --border-strong: rgba(255, 255, 255, 0.2);

      /* Typography - Responsive */
      --text-hero: clamp(2.5rem, 4vw, 4rem);
      --text-display: clamp(1.75rem, 3vw, 2.5rem);
      --text-title: clamp(1.25rem, 2vw, 1.5rem);
      --text-large: clamp(1rem, 1.5vw, 1.25rem);
      --text-body: clamp(0.875rem, 1.2vw, 1rem);
      --text-small: clamp(0.75rem, 1vw, 0.875rem);
      --text-tiny: clamp(0.625rem, 0.8vw, 0.75rem);

      /* Spacing - Responsive */
      --space-xs: clamp(4px, 0.5vw, 8px);
      --space-sm: clamp(8px, 1vw, 12px);
      --space-md: clamp(12px, 1.5vw, 20px);
      --space-lg: clamp(20px, 2.5vw, 32px);
      --space-xl: clamp(32px, 4vw, 48px);

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-glow-green: 0 0 20px rgba(16, 185, 129, 0.4);
      --shadow-glow-red: 0 0 20px rgba(239, 68, 68, 0.4);
      --shadow-glow-blue: 0 0 20px rgba(59, 130, 246, 0.4);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 250ms ease;
      --transition-slow: 400ms ease;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html {
      font-size: 16px;
    }

    @media (min-width: 1920px) {
      html { font-size: 18px; }
    }

    @media (min-width: 2560px) {
      html { font-size: 20px; }
    }

    body {
      min-height: 100vh;
      background: var(--bg-base);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes ping {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    @keyframes ticker {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Enhanced Status Animations */
    @keyframes statusPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    @keyframes statusRipple {
      0% { box-shadow: 0 0 0 0 currentColor; }
      70% { box-shadow: 0 0 0 8px transparent; }
      100% { box-shadow: 0 0 0 0 transparent; }
    }

    @keyframes breathe {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.98); }
    }

    @keyframes onlineGlow {
      0%, 100% { box-shadow: 0 0 4px var(--status-online), 0 0 8px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 8px var(--status-online), 0 0 16px rgba(16, 185, 129, 0.5); }
    }

    @keyframes offlineAlert {
      0%, 100% { box-shadow: 0 0 4px var(--status-offline); }
      25% { box-shadow: 0 0 12px var(--status-offline), 0 0 20px rgba(239, 68, 68, 0.4); }
      75% { box-shadow: 0 0 8px var(--status-offline); }
    }

    @keyframes dataRefresh {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    /* Animated Status Classes */
    .status-animated.online {
      animation: onlineGlow 3s ease-in-out infinite;
    }

    .status-animated.offline {
      animation: offlineAlert 1.5s ease-in-out infinite;
    }

    .data-refreshing {
      animation: dataRefresh 1s ease-in-out infinite;
    }

    .status-change-enter {
      animation: scaleIn 0.3s ease-out;
    }

    /* Device marker animations */
    .device-marker.status-changed {
      animation: statusPulse 0.5s ease-out;
    }

    .device-dot.animated {
      animation: breathe 2s ease-in-out infinite;
    }

    /* ==================== MAIN LAYOUT ==================== */
    .app-container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    /* ==================== HEADER ==================== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      backdrop-filter: blur(12px);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .logo-icon {
      font-size: var(--text-display);
    }

    .logo-text {
      font-size: var(--text-title);
      font-weight: 600;
      color: var(--text-primary);
    }

    .logo-badge {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--accent-blue);
      color: white;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .status-metric {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid var(--border-subtle);
    }

    .status-metric:hover {
      background: var(--bg-overlay);
      border-color: var(--border-default);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .status-dot.online { background: var(--status-online); box-shadow: var(--shadow-glow-green); }
    .status-dot.offline { background: var(--status-offline); box-shadow: var(--shadow-glow-red); animation: pulse 2s infinite; }
    .status-dot.warning { background: var(--status-warning); }

    .status-value {
      font-size: var(--text-large);
      font-weight: 700;
      color: var(--text-primary);
    }

    .status-label {
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .health-bar-container {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      min-width: 200px;
    }

    .health-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .health-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--status-online), var(--accent-emerald));
      border-radius: var(--radius-full);
      transition: width var(--transition-slow);
    }

    .health-percent {
      font-size: var(--text-body);
      font-weight: 600;
      color: var(--status-online);
      min-width: 45px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .time-display {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .time-value {
      font-size: var(--text-large);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: var(--text-tiny);
      color: var(--status-online);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--status-online);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .header-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .header-btn:hover {
      background: var(--bg-overlay);
      border-color: var(--border-default);
    }

    .header-btn.primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .header-btn.primary:hover {
      background: #2563EB;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      cursor: pointer;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: var(--text-small);
    }

    .user-name {
      font-size: var(--text-small);
      font-weight: 500;
    }

    .user-role {
      font-size: var(--text-tiny);
      padding: 2px 6px;
      background: var(--status-warning-bg);
      color: var(--status-warning);
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    /* ==================== MAIN CONTENT ==================== */
    .main-content {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 0;
      overflow: hidden;
      height: 100%;
    }

    /* Collapsible left panel */
    .main-content.left-collapsed {
      grid-template-columns: 1fr 320px;
    }

    .main-content.left-collapsed .left-panel {
      display: none;
    }

    .panel-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .panel-toggle:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr 280px;
      }
      .left-panel { display: none; }
      .panel-toggle { display: none; }
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      .right-panel {
        max-height: 40vh;
        border-top: 1px solid var(--border-subtle);
        border-left: none;
      }
    }

    /* ==================== LEFT PANEL ==================== */
    .left-panel {
      background: var(--bg-surface);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .panel-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .floor-nav {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
    }

    .floor-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-xs);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .floor-item:hover {
      background: var(--bg-elevated);
    }

    .floor-item.active {
      background: var(--status-info-bg);
      border-color: var(--accent-blue);
    }

    .floor-item.has-issues {
      border-color: var(--status-offline);
    }

    .floor-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      font-size: var(--text-large);
    }

    .floor-item.active .floor-icon {
      background: var(--accent-blue);
    }

    .floor-info {
      flex: 1;
    }

    .floor-name {
      font-size: var(--text-body);
      font-weight: 600;
    }

    .floor-stats {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .floor-status {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .floor-status.ok { color: var(--status-online); }
    .floor-status.issue { color: var(--status-offline); }

    .quick-stats {
      padding: var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }

    .quick-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .quick-stat-item:last-child {
      border-bottom: none;
    }

    .quick-stat-label {
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .quick-stat-value {
      font-size: var(--text-body);
      font-weight: 600;
    }

    /* ==================== FLOOR MAP (HERO) ==================== */
    .map-container {
      position: relative;
      background: var(--bg-base);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floor-map {
      position: relative;
      width: 100%;
      height: 100%;
      transform-origin: center center;
      will-change: transform;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    .floor-plan-bg-loader {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      max-width: 1px;
      max-height: 1px;
    }

    .markers-overlay {
      position: absolute;
      pointer-events: none;
    }

    .markers-overlay .device-marker {
      pointer-events: auto;
    }

    .map-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      color: var(--text-muted);
      text-align: center;
      padding: var(--space-xl);
    }

    .map-placeholder-icon {
      font-size: 4rem;
      opacity: 0.5;
    }

    .map-placeholder-title {
      font-size: var(--text-title);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .map-placeholder-subtitle {
      font-size: var(--text-body);
    }

    .map-controls {
      position: absolute;
      bottom: var(--space-md);
      right: var(--space-md);
      display: flex;
      gap: var(--space-xs);
    }

    .map-control-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .map-control-btn:hover {
      background: var(--bg-elevated);
    }

    .floor-label {
      position: absolute;
      top: var(--space-md);
      left: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      font-size: var(--text-large);
      font-weight: 600;
    }

    /* ==================== DEVICE MARKERS ==================== */
    .device-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 10;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .device-marker:hover {
      z-index: 100;
      transform: translate(-50%, -50%) scale(1.15);
    }

    .marker-ring {
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid currentColor;
      opacity: 0;
      animation: ping 2s infinite;
    }

    .device-marker.offline .marker-ring {
      opacity: 1;
      border-color: var(--status-offline);
    }

    .marker-dot {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 3px solid;
      box-shadow: var(--shadow-md);
      transition: var(--transition-fast);
    }

    .marker-dot.online {
      background: var(--status-online-bg);
      border-color: var(--status-online);
    }

    .marker-dot.offline {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
      animation: glow 2s infinite;
    }

    /* Disabled/non-serviceable devices */
    .device-marker.disabled {
      opacity: 0.4;
    }

    .device-marker.disabled .device-dot {
      background: var(--bg-overlay) !important;
      border-color: var(--text-muted) !important;
      filter: grayscale(1);
    }

    .device-marker.disabled .device-ping {
      display: none;
    }

    .marker-dot.warning {
      background: var(--status-warning-bg);
      border-color: var(--status-warning);
    }

    .marker-dot.ap { border-color: var(--accent-blue); }
    .marker-dot.printer { border-color: var(--accent-purple); }
    .marker-dot.zoom { border-color: var(--status-warning); }

    .device-marker:hover .marker-dot {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    /* Device Popup */
    .device-popup {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-fast);
      pointer-events: none;
      z-index: 1000;
    }

    .device-marker:hover .device-popup {
      opacity: 1;
      visibility: visible;
    }

    .popup-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .popup-icon {
      font-size: var(--text-title);
    }

    .popup-title {
      flex: 1;
    }

    .popup-name {
      font-size: var(--text-body);
      font-weight: 600;
    }

    .popup-type {
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .popup-status {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .popup-status.online {
      background: var(--status-online-bg);
      color: var(--status-online);
    }

    .popup-status.offline {
      background: var(--status-offline-bg);
      color: var(--status-offline);
    }

    .popup-body {
      padding: var(--space-md);
    }

    .popup-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-xs) 0;
      font-size: var(--text-small);
    }

    .popup-label {
      color: var(--text-secondary);
    }

    .popup-value {
      font-weight: 500;
    }

    .popup-actions {
      display: flex;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }

    .popup-btn {
      flex: 1;
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: var(--text-tiny);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .popup-btn:hover {
      background: var(--bg-overlay);
    }

    .popup-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 8px;
      overflow: hidden;
    }

    .popup-arrow::after {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 12px;
      height: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
    }

    /* Popup positioned below for markers near top of map */
    .device-marker.popup-below .device-popup {
      bottom: auto;
      top: calc(100% + 12px);
    }

    .device-marker.popup-below .popup-arrow {
      bottom: auto;
      top: -8px;
    }

    .device-marker.popup-below .popup-arrow::after {
      top: auto;
      bottom: -8px;
    }

    /* Make popup more compact for MacBook screens */
    @media (max-width: 1600px) {
      .device-popup {
        min-width: 240px;
        max-width: 280px;
      }
      .popup-header {
        padding: var(--space-sm);
      }
      .popup-body {
        padding: var(--space-sm);
      }
      .popup-row {
        font-size: var(--text-tiny);
      }
    }

    /* ==================== RIGHT PANEL ==================== */
    .right-panel {
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .device-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .device-list-title {
      font-size: var(--text-body);
      font-weight: 600;
    }

    .device-search {
      position: relative;
    }

    .device-search input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      padding-left: 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: var(--text-small);
    }

    .device-search input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .device-search::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
    }

    .device-list {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
    }

    .device-category {
      margin-bottom: var(--space-sm);
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .category-header:hover {
      background: var(--bg-overlay);
    }

    .category-icon {
      font-size: var(--text-large);
    }

    .category-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 600;
    }

    .category-count {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
    }

    .category-toggle {
      font-size: 10px;
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .category-header.collapsed .category-toggle {
      transform: rotate(-90deg);
    }

    .category-devices {
      margin-top: var(--space-xs);
      overflow: hidden;
      transition: var(--transition-base);
    }

    .category-devices.collapsed {
      max-height: 0 !important;
      margin-top: 0;
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      margin-bottom: 2px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .device-item:hover {
      background: var(--bg-elevated);
    }

    .device-item.offline {
      background: var(--status-offline-bg);
    }

    .device-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .device-status-dot.online { background: var(--status-online); }
    .device-status-dot.offline { background: var(--status-offline); animation: pulse 1.5s infinite; }

    .device-info {
      flex: 1;
      min-width: 0;
    }

    .device-name {
      font-size: var(--text-small);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-meta {
      font-size: var(--text-tiny);
      color: var(--text-muted);
    }

    .device-ping {
      font-size: var(--text-tiny);
      color: var(--status-online);
      font-weight: 500;
    }

    /* ==================== FOOTER ==================== */
    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-lg);
      background: var(--bg-surface);
      border-top: 1px solid var(--border-subtle);
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .legend {
      display: flex;
      gap: var(--space-md);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-dot.ap { background: var(--accent-blue); }
    .legend-dot.printer { background: var(--accent-purple); }
    .legend-dot.zoom { background: var(--status-warning); }
    .legend-dot.online { background: var(--status-online); }
    .legend-dot.offline { background: var(--status-offline); }

    .footer-center {
      flex: 1;
      overflow: hidden;
    }

    .event-ticker {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-small);
      color: var(--text-secondary);
      white-space: nowrap;
      animation: ticker 30s linear infinite;
    }

    .event-ticker-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: 0 var(--space-lg);
    }

    .footer-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .data-source {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
    }

    .data-source:hover {
      color: var(--text-primary);
    }

    /* ==================== MODALS ==================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.95);
      transition: var(--transition-base);
    }

    .modal-overlay.open .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .modal-title {
      font-size: var(--text-title);
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    .modal-section {
      margin-bottom: var(--space-lg);
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }

    .info-item {
      padding: var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
    }

    .info-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: var(--text-body);
      font-weight: 500;
    }

    .info-source {
      font-size: var(--text-tiny);
      color: var(--accent-blue);
      cursor: pointer;
      margin-top: 4px;
    }

    .info-source:hover {
      text-decoration: underline;
    }

    .uptime-chart {
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
    }

    .uptime-bar {
      flex: 1;
      border-radius: 2px;
      min-height: 4px;
      transition: var(--transition-fast);
    }

    .uptime-bar.up { background: var(--status-online); }
    .uptime-bar.down { background: var(--status-offline); }
    .uptime-bar.partial { background: var(--status-warning); }

    .modal-actions {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-lg);
      border-top: 1px solid var(--border-subtle);
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #2563EB;
    }

    .btn-secondary {
      background: var(--bg-elevated);
      border-color: var(--border-default);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-overlay);
    }

    .btn-danger {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
      color: var(--status-offline);
    }

    .btn-danger:hover {
      background: var(--status-offline);
      color: white;
    }

    .btn-sm {
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--text-small);
    }

    .btn-warning {
      background: rgba(245, 158, 11, 0.2);
      border-color: var(--status-warning);
      color: var(--status-warning);
    }

    .btn-warning:hover {
      background: var(--status-warning);
      color: white;
    }

    .btn-success {
      background: rgba(16, 185, 129, 0.2);
      border-color: var(--status-online);
      color: var(--status-online);
    }

    .btn-success:hover {
      background: var(--status-online);
      color: white;
    }

    /* ==================== ADMIN PANEL ==================== */
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .admin-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .admin-panel {
      position: fixed;
      top: 0;
      right: -500px;
      width: 500px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      z-index: 1000;
      transition: right var(--transition-base);
      display: flex;
      flex-direction: column;
    }

    .admin-panel.open {
      right: 0;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .admin-title {
      font-size: var(--text-title);
      font-weight: 600;
    }

    .admin-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-subtle);
    }

    .admin-tab {
      flex: 1;
      padding: var(--space-md);
      text-align: center;
      font-size: var(--text-small);
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-fast);
    }

    .admin-tab:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .admin-tab.active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }

    .admin-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
    }

    /* ==================== FORMS ==================== */
    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-label {
      display: block;
      font-size: var(--text-small);
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-body);
      transition: var(--transition-fast);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* ==================== UTILITIES ==================== */
    .hidden { display: none !important; }
    .text-online { color: var(--status-online); }
    .text-offline { color: var(--status-offline); }
    .text-warning { color: var(--status-warning); }
    .text-muted { color: var(--text-muted); }
    .font-mono { font-family: 'SF Mono', Monaco, monospace; }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-base);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-overlay);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ==================== LEGACY COMPATIBILITY ==================== */
    /* Login Page */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--bg-base) 0%, var(--bg-surface) 50%, var(--bg-base) 100%);
    }

    .login-container {
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
    }

    .login-logo {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .login-logo-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }

    .login-logo-title {
      font-size: var(--text-title);
      font-weight: 600;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .login-input {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: var(--text-body);
      transition: var(--transition-fast);
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .login-btn {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-size: var(--text-body);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow-blue);
    }

    .login-error {
      padding: var(--space-sm);
      border-radius: var(--radius-md);
      background: var(--status-offline-bg);
      border: 1px solid var(--status-offline);
      color: var(--status-offline);
      font-size: var(--text-small);
      text-align: center;
    }

    /* Analytics Sidebar */
    .analytics-sidebar {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      z-index: 1002;
      transition: right var(--transition-base);
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .analytics-sidebar.open { right: 0; }

    .analytics-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      background: var(--bg-surface);
      z-index: 10;
    }

    .analytics-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .analytics-title {
      font-size: var(--text-title);
      font-weight: 600;
      margin: 0 0 4px 0;
    }

    .analytics-subtitle {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .analytics-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }

    .analytics-close:hover { color: var(--text-primary); }

    .analytics-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: var(--text-small);
      font-weight: 500;
      margin-top: var(--space-sm);
    }

    .analytics-status.up {
      background: var(--status-online-bg);
      color: var(--status-online);
    }

    .analytics-status.down {
      background: var(--status-offline-bg);
      color: var(--status-offline);
    }

    .analytics-content { padding: var(--space-lg); }

    .analytics-section { margin-bottom: var(--space-lg); }

    .analytics-section-title {
      font-size: var(--text-tiny);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }

    .stat-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      border: 1px solid var(--border-subtle);
    }

    .stat-value {
      font-size: var(--text-title);
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-value.green { color: var(--status-online); }
    .stat-value.red { color: var(--status-offline); }
    .stat-value.yellow { color: var(--status-warning); }
    .stat-value.blue { color: var(--accent-blue); }

    .stat-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-top: 4px;
    }

    .analytics-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .analytics-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Analytics sidebar - uptime bar and segments */
    .analytics-section .uptime-bar {
      display: flex;
      gap: 2px;
      height: 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      padding: 3px;
      overflow: hidden;
    }

    .uptime-segment {
      flex: 1;
      border-radius: 2px;
      min-width: 2px;
      transition: var(--transition-fast);
      cursor: pointer;
      position: relative;
    }

    .uptime-segment.up { background: var(--status-online); }
    .uptime-segment.down { background: var(--status-offline); }
    .uptime-segment.unknown { background: var(--border-default); }

    .uptime-segment:hover {
      transform: scaleY(1.2);
      opacity: 0.9;
    }

    .uptime-segment[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-overlay);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 4px;
    }

    .uptime-legend {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Analytics sidebar - response time chart */
    .response-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 60px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      padding: 8px;
      overflow: hidden;
    }

    .response-bar {
      flex: 1;
      min-width: 4px;
      background: var(--status-online);
      border-radius: 2px 2px 0 0;
      transition: var(--transition-fast);
      cursor: pointer;
      position: relative;
    }

    .response-bar:hover {
      opacity: 0.8;
      transform: scaleX(1.3);
    }

    .response-bar.slow {
      background: var(--status-warning);
    }

    .response-bar.timeout {
      background: var(--status-offline);
    }

    .response-bar[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-overlay);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 4px;
    }

    /* Analytics sidebar - history list */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }

    .history-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .history-status.up { background: var(--status-online); }
    .history-status.down { background: var(--status-offline); }

    .history-info {
      flex: 1;
      min-width: 0;
    }

    .history-time {
      font-size: var(--text-tiny);
      color: var(--text-muted);
    }

    .history-message {
      font-size: var(--text-small);
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-ping {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--accent-blue);
      flex-shrink: 0;
    }

    /* Feature-specific styles using design system variables */
    .import-dropzone {
      border: 2px dashed var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-fast);
      background: var(--bg-elevated);
    }

    .import-dropzone:hover,
    .import-dropzone.dragover {
      border-color: var(--accent-blue);
      background: var(--status-info-bg);
    }

    .import-icon { font-size: 3rem; margin-bottom: var(--space-sm); }
    .import-title { font-size: var(--text-body); font-weight: 500; }
    .import-subtitle { font-size: var(--text-small); color: var(--text-muted); }

    .device-notes {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }

    .device-notes-label {
      font-size: var(--text-tiny);
      color: var(--status-warning);
      margin-bottom: 4px;
    }

    .device-notes-content {
      font-size: var(--text-small);
      color: var(--text-secondary);
      background: var(--bg-elevated);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      font-style: italic;
    }

    .health-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .health-badge.excellent { background: var(--status-online-bg); color: var(--status-online); }
    .health-badge.good { background: var(--status-info-bg); color: var(--accent-blue); }
    .health-badge.fair { background: var(--status-warning-bg); color: var(--status-warning); }
    .health-badge.poor { background: var(--status-offline-bg); color: var(--status-offline); }

    .bulk-actions-bar {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background: var(--status-info-bg);
      border: 1px solid var(--accent-blue);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .template-card {
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      text-align: center;
    }

    .template-card:hover,
    .template-card.selected {
      background: var(--status-info-bg);
      border-color: var(--accent-blue);
    }

    .zone-overlay {
      position: absolute;
      pointer-events: none;
      inset: 0;
      z-index: 5;
    }

    .zone-editor-panel {
      position: absolute;
      bottom: var(--space-lg);
      left: var(--space-lg);
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      z-index: 100;
      min-width: 250px;
    }

    .discovery-progress-bar {
      height: 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .discovery-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      border-radius: var(--radius-sm);
      transition: width var(--transition-base);
    }

    .context-menu {
      position: fixed;
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      min-width: 180px;
      overflow: hidden;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      font-size: var(--text-small);
      transition: var(--transition-fast);
    }

    .context-menu-item:hover { background: var(--status-info-bg); }
    .context-menu-item.danger:hover { background: var(--status-offline-bg); color: var(--status-offline); }

    .context-menu-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 4px 0;
    }

    .widgets-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .widget {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      border: 1px solid var(--border-subtle);
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .widget-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .pie-chart {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: relative;
    }

    .pie-chart-center {
      position: absolute;
      inset: 12px;
      background: var(--bg-surface);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-large);
      font-weight: 700;
    }

    .widget-stat-value.green { color: var(--status-online); }
    .widget-stat-value.red { color: var(--status-offline); }
    .widget-stat-value.yellow { color: var(--status-warning); }

    /* ==================== ENHANCED SIDEBAR COMPONENTS ==================== */
    .device-category {
      margin-bottom: var(--space-sm);
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      border-left: 3px solid;
    }

    .category-header:hover {
      background: var(--bg-overlay);
    }

    .category-header.ap { border-color: var(--accent-blue); background: var(--status-info-bg); }
    .category-header.printer { border-color: var(--accent-purple); background: rgba(139, 92, 246, 0.1); }
    .category-header.poly { border-color: var(--status-warning); background: var(--status-warning-bg); }

    .category-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 600;
    }

    .category-count {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
    }

    .collapse-icon {
      font-size: 10px;
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .category-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .category-content {
      margin-top: var(--space-xs);
      max-height: 1000px;
      overflow: hidden;
      transition: max-height var(--transition-base);
    }

    .category-content.collapsed {
      max-height: 0;
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      margin-bottom: 2px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
    }

    .device-item:hover {
      background: var(--bg-overlay);
      border-color: var(--border-default);
    }

    .device-item.clickable:hover {
      border-color: var(--accent-blue);
    }

    .device-item.down {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
    }

    .device-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .device-status-dot.up, .device-status-dot.online { background: var(--status-online); }
    .device-status-dot.down, .device-status-dot.offline { background: var(--status-offline); animation: pulse 1.5s infinite; }
    .device-status-dot.maintenance { background: var(--status-warning); }

    .device-info {
      flex: 1;
      min-width: 0;
    }

    .device-name {
      font-size: var(--text-small);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-meta {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .device-model {
      color: var(--status-warning);
      font-weight: 500;
    }

    /* Room Groups for Zoom Rooms */
    .room-group {
      margin-bottom: var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .room-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--status-warning-bg);
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .room-header:hover {
      background: rgba(245, 158, 11, 0.2);
    }

    .room-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .room-status.up { background: var(--status-online); }
    .room-status.down { background: var(--status-offline); box-shadow: var(--shadow-glow-red); }

    .room-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 500;
    }

    .room-devices {
      padding: var(--space-sm);
      max-height: 500px;
      overflow: hidden;
      transition: max-height var(--transition-base), padding var(--transition-base);
    }

    .room-devices.collapsed {
      max-height: 0;
      padding: 0 var(--space-sm);
    }

    /* Device Marker Enhancements */
    .device-marker .device-dot,
    .marker-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 3px solid;
      box-shadow: var(--shadow-md);
      transition: var(--transition-fast);
      background: var(--bg-surface);
    }

    .device-marker:hover .device-dot {
      transform: scale(1.15);
      box-shadow: var(--shadow-lg);
    }

    .device-ping {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      opacity: 0.5;
      animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
      transform: translate(-50%, -50%);
      left: 50%;
      top: 50%;
    }

    /* Device Popup Enhancements */
    .device-popup {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-fast);
      pointer-events: none;
      z-index: 1000;
    }

    .device-marker:hover .device-popup {
      opacity: 1;
      visibility: visible;
    }

    .popup-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .popup-icon { font-size: var(--text-title); }
    .popup-name { font-size: var(--text-body); font-weight: 600; }
    .popup-details { padding: var(--space-md); }

    .popup-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-xs) 0;
      font-size: var(--text-small);
    }

    .popup-row strong { color: var(--text-secondary); }

    .status-badge {
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .popup-section {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }

    .popup-section-title {
      font-size: var(--text-tiny);
      color: var(--status-warning);
      font-weight: 600;
      margin-bottom: var(--space-xs);
    }

    .popup-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--bg-surface);
    }

    /* Toner Level Bars - Enhanced */
    .printer-consumables {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(31, 41, 55, 0.9) 100%);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 12px;
    }

    .consumables-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .consumables-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .consumables-title-icon {
      font-size: 18px;
    }

    .consumables-refresh {
      padding: 4px 10px;
      background: var(--bg-overlay);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .consumables-refresh:hover {
      background: var(--accent-blue);
      color: white;
    }

    .toner-levels {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .toner-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px 6px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .toner-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toner-bar.low {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--status-offline);
    }

    .toner-bar-track {
      width: 28px;
      height: 55px;
      background: var(--bg-overlay);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--border-subtle);
    }

    .toner-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 4px;
      transition: height 0.5s ease;
    }

    .toner-bar-fill.black {
      background: linear-gradient(to top, #1a1a1a, #404040);
      box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.1);
    }
    .toner-bar-fill.cyan {
      background: linear-gradient(to top, #0891B2, #22D3EE);
      box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
    }
    .toner-bar-fill.magenta {
      background: linear-gradient(to top, #BE185D, #F472B6);
      box-shadow: 0 0 10px rgba(236, 72, 153, 0.5);
    }
    .toner-bar-fill.yellow {
      background: linear-gradient(to top, #CA8A04, #FDE047);
      box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
    }

    .toner-bar-label {
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toner-bar-value {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .toner-bar.low .toner-bar-value {
      color: var(--status-offline);
    }

    .toner-bar.low .toner-bar-track {
      border-color: var(--status-offline);
      animation: toner-pulse 2s infinite;
    }

    @keyframes toner-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
    }

    .toner-low-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      background: var(--status-offline);
      color: white;
      font-size: 9px;
      font-weight: 600;
      border-radius: 4px;
      text-transform: uppercase;
      animation: pulse 1.5s infinite;
    }

    /* Paper Level - Enhanced */
    .paper-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      margin-top: 12px;
    }

    .paper-icon-large {
      font-size: 24px;
    }

    .paper-info {
      flex: 1;
    }

    .paper-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .paper-bar {
      height: 10px;
      background: var(--bg-overlay);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }

    .paper-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--status-online), #34D399);
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .paper-bar-fill.low {
      background: linear-gradient(90deg, var(--status-warning), #FBBF24);
    }

    .paper-bar-fill.empty {
      background: linear-gradient(90deg, var(--status-offline), #F87171);
    }

    .paper-value {
      font-size: 14px;
      font-weight: 700;
      min-width: 45px;
      text-align: right;
    }

    /* Page count styling */
    .page-count-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      margin-top: 8px;
    }

    .page-count-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .page-count-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-blue);
    }

    /* Legacy support */
    .paper-level {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: var(--space-xs);
      padding: var(--space-xs);
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
    }

    .paper-icon {
      font-size: 16px;
    }

    /* Sidebar toner indicator */
    .sidebar-toner {
      display: flex;
      gap: 2px;
      margin-left: auto;
    }

    .sidebar-toner-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .sidebar-toner-dot.black { background: #1a1a1a; border: 1px solid #444; }
    .sidebar-toner-dot.cyan { background: #06B6D4; }
    .sidebar-toner-dot.magenta { background: #EC4899; }
    .sidebar-toner-dot.yellow { background: #EAB308; }
    .sidebar-toner-dot.low { opacity: 0.3; }

    /* ==================== DASHBOARD WIDGETS ==================== */
    .widgets-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 4px 16px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      align-items: center;
    }

    .widget-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-elevated);
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--border-subtle);
    }

    .widget-badge:hover {
      background: var(--bg-overlay);
      border-color: var(--accent-blue);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .badge-dot.green { background: var(--status-online); }
    .badge-dot.red { background: var(--status-offline); }

    .badge-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    .widget-badge.green .badge-value { color: var(--status-online); }
    .widget-badge.red .badge-value { color: var(--status-offline); }
    .widget-badge.yellow .badge-value { color: var(--status-warning); }
    .widget-badge.blue .badge-value { color: var(--accent-blue); }

    .badge-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Status Summary in Right Panel */
    .status-summary {
      padding: 12px;
      border-top: 1px solid var(--border-subtle);
      background: var(--bg-base);
    }

    .summary-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .summary-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: var(--bg-elevated);
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid transparent;
    }

    .summary-stat:hover {
      background: var(--bg-overlay);
      border-color: var(--accent-blue);
    }

    .summary-stat .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .summary-stat.green .stat-value { color: var(--status-online); }
    .summary-stat.red .stat-value { color: var(--status-offline); }
    .summary-stat.yellow .stat-value { color: var(--status-warning); }
    .summary-stat.blue .stat-value { color: var(--accent-blue); }

    .summary-stat .stat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* ==================== GLOBAL SEARCH ==================== */
    .global-search {
      position: relative;
      margin-right: 16px;
    }

    .search-input {
      width: 220px;
      padding: 8px 12px 8px 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 13px;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      width: 300px;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 14px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s;
    }

    .search-result-item:hover {
      background: var(--bg-elevated);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .search-result-status.up { background: var(--status-online); }
    .search-result-status.down { background: var(--status-offline); }

    .search-result-info {
      flex: 1;
    }

    .search-result-name {
      font-weight: 500;
      font-size: 13px;
    }

    .search-result-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .search-no-results {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ==================== NOTIFICATION CENTER ==================== */
    .notification-btn {
      position: relative;
      padding: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 18px;
    }

    .notification-btn:hover {
      background: var(--bg-overlay);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: var(--status-offline);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .notification-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 380px;
      max-height: 500px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 2000;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .notification-title {
      font-weight: 600;
      font-size: 14px;
    }

    .notification-clear {
      font-size: 12px;
      color: var(--accent-blue);
      cursor: pointer;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      transition: background 0.15s;
    }

    .notification-item:hover {
      background: var(--bg-elevated);
    }

    .notification-item.unread {
      background: rgba(59, 130, 246, 0.05);
    }

    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .notification-icon.offline { background: rgba(239, 68, 68, 0.15); }
    .notification-icon.online { background: rgba(16, 185, 129, 0.15); }
    .notification-icon.warning { background: rgba(245, 158, 11, 0.15); }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      font-size: 13px;
      line-height: 1.4;
    }

    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    /* ==================== BULK ACTIONS ==================== */
    .bulk-mode-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      border: 1px solid var(--accent-blue);
      border-radius: var(--radius-lg);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .bulk-count {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .bulk-actions {
      display: flex;
      gap: 8px;
    }

    .bulk-btn {
      padding: 8px 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bulk-btn.primary {
      background: var(--accent-blue);
      color: white;
    }

    .bulk-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .bulk-btn.danger {
      background: var(--status-offline);
      color: white;
    }

    .bulk-btn:hover {
      filter: brightness(1.1);
    }

    .device-checkbox {
      position: absolute;
      top: -5px;
      left: -5px;
      width: 18px;
      height: 18px;
      background: var(--bg-surface);
      border: 2px solid var(--border-default);
      border-radius: 4px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
    }

    .bulk-mode .device-checkbox {
      display: flex;
    }

    .device-checkbox.selected {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    /* ==================== ZONE EDITOR ==================== */
    .zone-overlay {
      position: absolute;
      border: 2px dashed var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--radius-sm);
      pointer-events: none;
    }

    .zone-label {
      position: absolute;
      top: 4px;
      left: 4px;
      padding: 2px 8px;
      background: var(--accent-blue);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
    }

    .zone-editor-toolbar {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 8px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .zone-tool-btn {
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zone-tool-btn:hover, .zone-tool-btn.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    /* ==================== HISTORICAL TRENDS ==================== */
    .trends-chart {
      height: 200px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .trends-bars {
      display: flex;
      align-items: flex-end;
      height: 150px;
      gap: 2px;
      padding-top: 10px;
    }

    .trend-bar {
      flex: 1;
      background: var(--accent-blue);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .trend-bar:hover {
      background: var(--status-info);
    }

    .trend-bar.low { background: var(--status-offline); }
    .trend-bar.medium { background: var(--status-warning); }
    .trend-bar.high { background: var(--status-online); }

    .trends-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ==================== INCIDENT TIMELINE ==================== */
    .incident-timeline {
      position: relative;
      padding-left: 24px;
    }

    .incident-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-default);
    }

    .incident-item {
      position: relative;
      padding: 12px 0;
      padding-left: 20px;
    }

    .incident-dot {
      position: absolute;
      left: -20px;
      top: 16px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--bg-surface);
    }

    .incident-dot.down { background: var(--status-offline); }
    .incident-dot.up { background: var(--status-online); }
    .incident-dot.warning { background: var(--status-warning); }

    .incident-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 12px;
    }

    .incident-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .incident-title {
      font-weight: 600;
      font-size: 13px;
    }

    .incident-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .incident-details {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .incident-duration {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(239, 68, 68, 0.15);
      color: var(--status-offline);
      font-size: 11px;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* ==================== ACTIVITY LOG ==================== */
    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-icon.edit { background: rgba(59, 130, 246, 0.15); }
    .activity-icon.add { background: rgba(16, 185, 129, 0.15); }
    .activity-icon.delete { background: rgba(239, 68, 68, 0.15); }
    .activity-icon.login { background: rgba(139, 92, 246, 0.15); }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 13px;
    }

    .activity-user {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* ==================== COMPACT MODE ==================== */
    .compact-mode {
      --space-xs: 2px;
      --space-sm: 4px;
      --space-md: 8px;
      --space-lg: 12px;
      --space-xl: 16px;
      --text-title: 1rem;
      --text-large: 0.875rem;
      --text-body: 0.8125rem;
      --text-small: 0.75rem;
      --text-tiny: 0.625rem;
    }

    .compact-mode .header {
      padding: 8px 16px;
    }

    .compact-mode .logo-text {
      display: none;
    }

    .compact-mode .logo-badge {
      display: none;
    }

    .compact-mode .status-metric {
      padding: 4px 8px;
      gap: 4px;
    }

    .compact-mode .status-label {
      display: none;
    }

    .compact-mode .health-bar-container {
      min-width: 120px;
      padding: 4px 8px;
    }

    .compact-mode .header-btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    .compact-mode .time-display {
      display: none;
    }

    .compact-mode .main-content {
      grid-template-columns: 200px 1fr 240px;
    }

    .compact-mode .left-panel {
      width: 200px;
    }

    .compact-mode .floor-item {
      padding: 8px;
    }

    .compact-mode .floor-icon {
      width: 28px;
      height: 28px;
      font-size: 14px;
    }

    .compact-mode .floor-name {
      font-size: 13px;
    }

    .compact-mode .floor-stats {
      font-size: 11px;
    }

    .compact-mode .quick-stats {
      padding: 8px;
    }

    .compact-mode .device-item {
      padding: 6px 8px;
    }

    .compact-mode .device-name {
      font-size: 12px;
    }

    .compact-mode .device-meta {
      font-size: 10px;
    }

    .compact-mode .footer {
      padding: 4px 16px;
    }

    .compact-mode .legend {
      font-size: 11px;
    }

    .compact-mode .marker-dot {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }

    .compact-mode .device-popup {
      min-width: 220px;
    }

    .compact-toggle {
      font-size: 11px;
      padding: 4px 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
    }

    .compact-toggle:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    .compact-toggle.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    /* ==================== SPARKLINE ==================== */
    .sparkline-container {
      margin-top: var(--space-sm);
      padding: var(--space-xs) 0;
    }

    .sparkline-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sparkline {
      display: flex;
      gap: 1px;
      height: 20px;
      align-items: flex-end;
    }

    .sparkline-bar {
      flex: 1;
      min-width: 2px;
      border-radius: 1px;
      transition: height 0.2s;
    }

    .sparkline-bar.up { background: var(--status-online); }
    .sparkline-bar.down { background: var(--status-offline); }
    .sparkline-bar.unknown { background: var(--bg-overlay); }

    .sparkline-legend {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 2px;
    }
  </style>
</head>
<body>
  <div id="app"></div>
  <div id="analytics-container"></div>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }

    // API Configuration
    const API_URL = window.location.origin;

    // Auth state
    let authToken = localStorage.getItem('authToken');
    let currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    let loginError = '';

    // Data stores
    let uptimeKumaData = {};
    let polyLensData = {};
    let printerStatusData = {}; // Store printer toner/paper status by monitor ID
    let apiStatus = {
      uptimeKuma: { connected: false, monitorCount: 0 },
      polyLens: { configured: false, deviceCount: 0 }
    };
    let lastFetchError = null;
    let activeFloor = "1st Floor";
    let floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor']; // Updated dynamically from data
    let leftPanelCollapsed = localStorage.getItem('leftPanelCollapsed') === 'true';
    let compactMode = localStorage.getItem('compactMode') === 'true';
    let alertSoundsEnabled = localStorage.getItem('alertSoundsEnabled') === 'true';
    let previousDeviceStatuses = {}; // Track previous statuses for change detection

    // Admin state
    let adminOpen = false;
    let adminTab = 'devices';
    let editMode = false;
    let pendingPositions = {}; // Track unsaved position changes: { deviceId: { x, y, isRoom, floor } }
    let allMonitors = [];
    let settings = {};
    let floorPlans = {};
    let roomPositions = {}; // Stored room positions from database
    let deviceFilter = '';
    let editingMonitor = null;
    let draggedDevice = null;
    let apiIntegrations = [];
    let customDeviceTypes = [];
    let pendingChangesCount = 0;

    // New feature states
    let bulkImportData = [];
    let bulkImportModalOpen = false;
    let bulkSelectMode = false;
    let selectedDevices = new Set();
    let savedFilters = [];
    let activeFilter = null;
    let deviceTemplates = [];
    let floorZones = {};
    let zoneEditMode = false;
    let discoveryModalOpen = false;
    let discoveryResults = [];
    let discoveryScanning = false;
    let discoveryProgress = 0;
    let contextMenu = { open: false, x: 0, y: 0, device: null };

    // WebSocket state
    let ws = null;
    let wsConnected = false;
    let wsReconnectTimer = null;

    // Notifications state
    let unreadNotifications = 0;

    // Auth helper for fetch
    function authFetch(url, options = {}) {
      const headers = { ...options.headers };
      if (authToken) {
        headers['Authorization'] = `Bearer ${authToken}`;
      }
      return fetch(url, { ...options, headers });
    }

    // Login function
    async function login(username, password) {
      try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          loginError = '';
          renderApp();
        } else {
          loginError = data.error || 'Login failed';
          renderLogin();
        }
      } catch (e) {
        loginError = 'Connection error. Please try again.';
        renderLogin();
      }
    }

    // Logout function
    async function logout() {
      try {
        await authFetch(`${API_URL}/api/auth/logout`, { method: 'POST' });
      } catch (e) {}

      // Clean up WebSocket and timers
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (ws) {
        ws.close();
        ws = null;
      }

      // Clean up analytics interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }

      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('notifications');
      renderLogin();
    }

    // Handle login form submit
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      login(username, password);
    }

    // Render login page
    function renderLogin() {
      document.getElementById('app').innerHTML = `
        <div class="login-page">
          <div class="login-container">
            <div class="login-logo">
              <div class="login-logo-icon">üè¢</div>
              <div class="login-logo-title">Office Monitor</div>
            </div>
            ${loginError ? `<div class="login-error">${loginError}</div>` : ''}
            <form class="login-form" onsubmit="handleLogin(event)">
              <input type="text" id="login-username" class="login-input" placeholder="Username" required autofocus>
              <input type="password" id="login-password" class="login-input" placeholder="Password" required>
              <button type="submit" class="login-btn">Sign In</button>
            </form>
          </div>
        </div>
      `;
    }

    // Check if user is admin
    function isAdmin() {
      return currentUser?.role === 'admin';
    }

    // Fetch data from both APIs
    async function fetchAllData() {
      try {
        // Fetch Uptime Kuma data
        const ukResponse = await fetch(`${API_URL}/api/monitors/by-floor`);
        if (ukResponse.ok) {
          const ukData = await ukResponse.json();
          if (ukData.success) {
            uptimeKumaData = ukData.floors;
            apiStatus.uptimeKuma.connected = ukData.connected;
          }
        }

        // Fetch Poly Lens data
        const plResponse = await fetch(`${API_URL}/api/poly-lens/by-floor`);
        if (plResponse.ok) {
          const plData = await plResponse.json();
          if (plData.success) {
            polyLensData = plData.floors;
            apiStatus.polyLens.configured = true;
            apiStatus.polyLens.deviceCount = plData.deviceCount;
          }
        }

        // Fetch health for counts
        const healthResponse = await fetch(`${API_URL}/api/health`);
        if (healthResponse.ok) {
          const health = await healthResponse.json();
          apiStatus.uptimeKuma.monitorCount = health.uptimeKuma?.monitorCount || 0;
          apiStatus.polyLens.deviceCount = health.polyLens?.deviceCount || 0;
        }

        // Fetch room positions
        await fetchRoomPositions();

        // Fetch printer status for all printers
        await fetchPrinterStatus();

        lastFetchError = null;
      } catch (error) {
        console.error('Failed to fetch data:', error);
        lastFetchError = error.message;
      }
    }

    const deviceTypes = {
      accessPoints: { icon: "üì°", label: "Access Points", color: "#3B82F6" },
      printers: { icon: "üñ®Ô∏è", label: "Printers", color: "#8B5CF6" },
      polyLens: { icon: "üìπ", label: "Zoom Rooms", color: "#F59E0B" }
    };

    const statusColors = {
      up: { bg: "#22C55E", pulse: "#4ADE80", label: "Online" },
      down: { bg: "#EF4444", pulse: "#F87171", label: "Offline" },
      unknown: { bg: "#6B7280", pulse: "#9CA3AF", label: "Unknown" }
    };

    function generatePositions(count, seed) {
      const positions = [];
      for (let i = 0; i < count; i++) {
        const angle = (seed + i * 137.5) % 360;
        const radius = 25 + ((seed * i) % 20);
        positions.push({
          x: 50 + radius * Math.cos(angle * Math.PI / 180) * 0.8,
          y: 50 + radius * Math.sin(angle * Math.PI / 180) * 0.6
        });
      }
      return positions;
    }

    function getStatusCounts(floorData, polyData) {
      let up = 0, down = 0;

      // Count from Uptime Kuma
      if (floorData) {
        Object.values(floorData).forEach(category => {
          if (Array.isArray(category)) {
            category.forEach(device => {
              if (device.status === 'up') up++;
              else if (device.status === 'down') down++;
            });
          }
        });
      }

      return { up, down, total: up + down };
    }

    function getPolyLensRooms(floor) {
      const devices = polyLensData[floor] || [];
      const rooms = {};

      devices.forEach(device => {
        const roomName = device.room || 'Unassigned';
        if (!rooms[roomName]) {
          rooms[roomName] = [];
        }
        rooms[roomName].push(device);
      });

      return rooms;
    }

    // ==================== ADMIN FUNCTIONS ====================

    async function fetchAllMonitors() {
      try {
        const response = await authFetch(`${API_URL}/api/monitors`);
        if (response.ok) {
          const data = await response.json();
          allMonitors = data.monitors || [];
        }
      } catch (e) {
        console.error('Failed to fetch monitors:', e);
      }
    }

    async function fetchSettings() {
      try {
        const response = await authFetch(`${API_URL}/api/settings`);
        if (response.ok) {
          const data = await response.json();
          settings = data.settings || {};
        }
      } catch (e) {
        console.error('Failed to fetch settings:', e);
      }
    }

    async function fetchFloorPlans() {
      try {
        // First get the list of floor plans
        const response = await fetch(`${API_URL}/api/floor-plans`);
        if (response.ok) {
          const data = await response.json();
          floorPlans = {};

          // Fetch full data for each floor plan (including image_data)
          for (const plan of data.plans) {
            try {
              const fullResponse = await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(plan.floor)}`);
              if (fullResponse.ok) {
                const fullData = await fullResponse.json();
                floorPlans[plan.floor] = fullData.plan;
              }
            } catch (e) {
              console.error(`Failed to fetch floor plan for ${plan.floor}:`, e);
            }
          }
        }
      } catch (e) {
        console.error('Failed to fetch floor plans:', e);
      }
    }

    async function fetchApiIntegrations() {
      try {
        const response = await authFetch(`${API_URL}/api/integrations`);
        if (response.ok) {
          const data = await response.json();
          apiIntegrations = data.integrations || [];
        }
      } catch (e) {
        console.error('Failed to fetch API integrations:', e);
      }
    }

    async function fetchCustomDeviceTypes() {
      try {
        const response = await fetch(`${API_URL}/api/device-types`);
        if (response.ok) {
          const data = await response.json();
          customDeviceTypes = data.types || [];
        }
      } catch (e) {
        console.error('Failed to fetch device types:', e);
      }
    }

    async function fetchRoomPositions() {
      try {
        const response = await fetch(`${API_URL}/api/room-positions`);
        if (response.ok) {
          const data = await response.json();
          roomPositions = data.positions || {};
        }
      } catch (e) {
        console.error('Failed to fetch room positions:', e);
      }
    }

    async function fetchPrinterStatus() {
      try {
        // Get all printer IDs from the current data
        const printerIds = [];
        Object.values(uptimeKumaData).forEach(floor => {
          if (floor.printers) {
            floor.printers.forEach(p => printerIds.push(p.id));
          }
        });

        // Fetch status for each printer in parallel
        const statusPromises = printerIds.map(async (id) => {
          try {
            const response = await fetch(`${API_URL}/api/printers/${id}/status`);
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.status) {
                printerStatusData[id] = data.status;
              }
            }
          } catch (e) {
            console.error(`Failed to fetch printer ${id} status:`, e);
          }
        });

        await Promise.all(statusPromises);
      } catch (e) {
        console.error('Failed to fetch printer status:', e);
      }
    }

    async function fetchPendingChangesCount() {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/count`);
        if (response.ok) {
          const data = await response.json();
          pendingChangesCount = data.count || 0;
        }
      } catch (e) {
        console.error('Failed to fetch pending changes count:', e);
      }
    }

    async function saveSettings(updates) {
      try {
        const response = await authFetch(`${API_URL}/api/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        if (response.ok) {
          await fetchSettings();
          return { success: true };
        }
        return { success: false, error: 'Save failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function testSlack() {
      try {
        const response = await authFetch(`${API_URL}/api/settings/test-slack`, { method: 'POST' });
        const data = await response.json();
        return data;
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function saveMonitor(monitor) {
      const isNew = !monitor.id;
      const url = isNew ? `${API_URL}/api/monitors` : `${API_URL}/api/monitors/${monitor.id}`;
      const method = isNew ? 'POST' : 'PUT';

      try {
        const response = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(monitor)
        });
        const data = await response.json();
        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          }
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false, error: 'Save failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function deleteMonitor(id) {
      if (!confirm('Are you sure you want to delete this monitor?')) return { success: false };

      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          }
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false, error: 'Delete failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function toggleMonitor(id) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/toggle`, { method: 'PATCH' });
        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function saveDevicePosition(id, pos_x, pos_y, tvMode = false) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/position`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pos_x, pos_y, tv_mode: tvMode })
        });
        return response.ok;
      } catch (e) {
        console.error('Failed to save position:', e);
        return false;
      }
    }

    async function uploadFloorPlan(floor, file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1];
          const imageType = file.type.split('/')[1];

          try {
            const response = await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(floor)}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image_data: base64, image_type: imageType })
            });
            if (response.ok) {
              await fetchFloorPlans();
              resolve({ success: true });
            } else {
              resolve({ success: false, error: 'Upload failed' });
            }
          } catch (e) {
            resolve({ success: false, error: e.message });
          }
        };
        reader.readAsDataURL(file);
      });
    }

    async function deleteFloorPlan(floor) {
      if (!confirm(`Delete floor plan for ${floor}?`)) return;

      try {
        await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(floor)}`, { method: 'DELETE' });
        await fetchFloorPlans();
        renderAdmin();
      } catch (e) {
        console.error('Failed to delete floor plan:', e);
      }
    }

    function toggleAdmin() {
      adminOpen = !adminOpen;
      if (adminOpen) {
        fetchAllMonitors();
        fetchSettings();
        fetchFloorPlans();
        fetchApiIntegrations();
        if (isAdmin()) {
          fetchPendingChangesCount();
        }
      }
      renderAdmin();
    }

    function setAdminTab(tab) {
      adminTab = tab;
      renderAdmin();
    }

    function toggleEditMode() {
      if (editMode) {
        // Exiting edit mode - ask to discard unsaved changes
        if (Object.keys(pendingPositions).length > 0) {
          if (!confirm('You have unsaved position changes. Discard them?')) {
            return;
          }
          pendingPositions = {};
        }
      }
      editMode = !editMode;
      render();
    }

    async function savePositionChanges() {
      const changes = Object.entries(pendingPositions);
      if (changes.length === 0) {
        alert('No changes to save');
        return;
      }

      let saved = 0;
      for (const [deviceId, pos] of changes) {
        let success = false;
        if (pos.isRoom) {
          // Save room position
          success = await saveRoomPosition(deviceId, pos.x, pos.y, pos.floor);
        } else {
          // Save monitor position
          success = await saveDevicePosition(deviceId, pos.x, pos.y);
        }
        if (success) saved++;
      }

      pendingPositions = {};
      editMode = false;
      await fetchAllData();
      render();
      alert(`Saved positions for ${saved} item(s)`);
    }

    async function saveRoomPosition(roomId, pos_x, pos_y, floor) {
      try {
        const response = await authFetch(`${API_URL}/api/room-positions/${encodeURIComponent(roomId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pos_x, pos_y, floor })
        });
        return response.ok;
      } catch (e) {
        console.error('Failed to save room position:', e);
        return false;
      }
    }

    function cancelPositionChanges() {
      if (Object.keys(pendingPositions).length > 0) {
        if (!confirm('Discard all position changes?')) {
          return;
        }
      }
      pendingPositions = {};
      editMode = false;
      render();
    }

    function getPendingCount() {
      return Object.keys(pendingPositions).length;
    }

    function openEditModal(monitor = null) {
      editingMonitor = monitor ? { ...monitor } : {
        name: '', type: 'ping', hostname: '', url: '', floor: '1st Floor', device_type: 'accessPoints', interval: 30
      };
      renderModal();
    }

    function closeModal() {
      editingMonitor = null;
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderModal() {
      if (!editingMonitor) return;

      const isNew = !editingMonitor.id;
      const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      // Built-in device types
      const builtInTypes = [
        { value: 'accessPoints', label: 'Access Point' },
        { value: 'printers', label: 'Printer' },
        { value: 'polyLens', label: 'Poly Lens Device' }
      ];

      // Combine with custom types
      const allTypes = [...builtInTypes];
      customDeviceTypes.forEach(t => {
        if (!builtInTypes.find(bt => bt.value === t.name)) {
          allTypes.push({ value: t.name, label: t.name, icon: t.icon, color: t.color });
        }
      });

      // Check if current device_type is custom (not in allTypes)
      const currentTypeInList = allTypes.find(t => t.value === editingMonitor.device_type);
      const showCustomInput = editingMonitor.device_type === '__custom__';

      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">${isNew ? 'Add New Device' : 'Edit Device'}</h3>
              <button class="admin-close" onclick="closeModal()">&times;</button>
            </div>
            ${isNew && deviceTemplates.length > 0 ? `
              <div class="form-group">
                <label class="form-label">Quick Templates</label>
                <div class="template-grid">
                  ${deviceTemplates.map(t => `
                    <div class="template-card" onclick="applyTemplate(${JSON.stringify(t).replace(/"/g, '&quot;')})">
                      <div class="template-icon">${t.icon || 'üì±'}</div>
                      <div class="template-name">${t.name}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="edit-name" value="${editingMonitor.name || ''}" placeholder="Device name">
            </div>
            <div class="form-group">
              <label class="form-label">Monitor Type</label>
              <select class="form-select" id="edit-type" onchange="updateModalFields()">
                <option value="ping" ${editingMonitor.type === 'ping' ? 'selected' : ''}>Ping (ICMP)</option>
                <option value="http" ${editingMonitor.type === 'http' ? 'selected' : ''}>HTTP/HTTPS</option>
              </select>
            </div>
            <div class="form-group" id="hostname-group" style="display: ${editingMonitor.type === 'ping' ? 'block' : 'none'}">
              <label class="form-label">Hostname / IP *</label>
              <input type="text" class="form-input" id="edit-hostname" value="${editingMonitor.hostname || ''}" placeholder="192.168.1.1">
            </div>
            <div class="form-group" id="url-group" style="display: ${editingMonitor.type === 'http' ? 'block' : 'none'}">
              <label class="form-label">URL *</label>
              <input type="text" class="form-input" id="edit-url" value="${editingMonitor.url || ''}" placeholder="https://192.168.1.1">
            </div>
            <div class="form-group">
              <label class="form-label">Floor</label>
              <select class="form-select" id="edit-floor">
                ${floors.map(f => `<option value="${f}" ${editingMonitor.floor === f ? 'selected' : ''}>${f}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Device Type</label>
              <select class="form-select" id="edit-device-type" onchange="toggleCustomDeviceType()">
                ${allTypes.map(t => `<option value="${t.value}" ${editingMonitor.device_type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                <option value="__custom__" ${showCustomInput ? 'selected' : ''}>+ Add Custom Type...</option>
              </select>
            </div>
            <div class="form-group" id="custom-device-type-group" style="display: ${showCustomInput ? 'block' : 'none'}">
              <label class="form-label">Custom Device Type Name *</label>
              <input type="text" class="form-input" id="edit-custom-device-type" value="" placeholder="Enter custom type name (e.g., Camera, Switch, Server)">
              <p style="font-size: 11px; color: #64748B; margin-top: 4px;">This will create a new device type that can be reused for other devices.</p>
            </div>
            <div class="form-group">
              <label class="form-label">Check Interval (seconds)</label>
              <input type="number" class="form-input" id="edit-interval" value="${editingMonitor.interval || 30}" min="10" max="3600">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="edit-notes" placeholder="Optional notes about this device...">${editingMonitor.notes || ''}</textarea>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="submitMonitor()">üíæ ${isNew ? 'Add Device' : 'Save Changes'}</button>
              <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleCustomDeviceType() {
      const select = document.getElementById('edit-device-type');
      const customGroup = document.getElementById('custom-device-type-group');
      customGroup.style.display = select.value === '__custom__' ? 'block' : 'none';
    }

    function updateModalFields() {
      const type = document.getElementById('edit-type').value;
      document.getElementById('hostname-group').style.display = type === 'ping' ? 'block' : 'none';
      document.getElementById('url-group').style.display = type === 'http' ? 'block' : 'none';
    }

    async function submitMonitor() {
      let deviceType = document.getElementById('edit-device-type').value;

      // Handle custom device type
      if (deviceType === '__custom__') {
        const customTypeName = document.getElementById('edit-custom-device-type').value.trim();
        if (!customTypeName) {
          alert('Please enter a custom device type name');
          return;
        }

        // Create the new device type
        try {
          const response = await authFetch(`${API_URL}/api/device-types`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: customTypeName })
          });
          const data = await response.json();
          if (data.success) {
            deviceType = customTypeName;
            // Refresh custom device types list
            await fetchCustomDeviceTypes();
          } else {
            // Type might already exist, use it anyway
            deviceType = customTypeName;
          }
        } catch (e) {
          // If creation fails, use the name as-is
          deviceType = customTypeName;
        }
      }

      const monitor = {
        ...editingMonitor,
        name: document.getElementById('edit-name').value,
        type: document.getElementById('edit-type').value,
        hostname: document.getElementById('edit-hostname').value,
        url: document.getElementById('edit-url').value,
        floor: document.getElementById('edit-floor').value,
        device_type: deviceType,
        interval: parseInt(document.getElementById('edit-interval').value) || 30,
        notes: document.getElementById('edit-notes').value || ''
      };

      if (!monitor.name) {
        alert('Name is required');
        return;
      }

      if (monitor.type === 'ping' && !monitor.hostname) {
        alert('Hostname is required for ping monitors');
        return;
      }

      if (monitor.type === 'http' && !monitor.url) {
        alert('URL is required for HTTP monitors');
        return;
      }

      const result = await saveMonitor(monitor);
      if (result.success) {
        closeModal();
        renderAdmin();
      } else {
        alert('Error: ' + (result.error || 'Unknown error'));
      }
    }

    async function submitSettings() {
      const updates = {
        slack_webhook_url: document.getElementById('setting-slack-webhook')?.value || '',
        slack_channel: document.getElementById('setting-slack-channel')?.value || '',
        slack_enabled: document.getElementById('setting-slack-enabled')?.checked ? '1' : '0'
      };

      const result = await saveSettings(updates);
      if (result.success) {
        showAlert('Settings saved!', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Unknown error'), 'error');
      }
    }

    async function submitApiSettings() {
      const updates = {
        poly_lens_client_id: document.getElementById('setting-poly-client-id')?.value || '',
        poly_lens_client_secret: document.getElementById('setting-poly-secret')?.value || ''
      };

      const result = await saveSettings(updates);
      if (result.success) {
        showAlert('API settings saved! Poly Lens will reconnect.', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Unknown error'), 'error');
      }
    }

    async function handleTestSlack() {
      const result = await testSlack();
      if (result.success) {
        showAlert('Test notification sent!', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Failed to send'), 'error');
      }
    }

    function showAlert(message, type) {
      const alertEl = document.createElement('div');
      alertEl.className = `alert alert-${type}`;
      alertEl.textContent = message;

      const content = document.querySelector('.admin-content');
      if (content) {
        content.insertBefore(alertEl, content.firstChild);
        setTimeout(() => alertEl.remove(), 3000);
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'var(--status-online)' : type === 'error' ? 'var(--status-offline)' : 'var(--accent-blue)'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 100000;
        animation: slideUp 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    function handleFloorPlanUpload(floor, input) {
      const file = input.files[0];
      if (file) {
        uploadFloorPlan(floor, file).then(result => {
          if (result.success) {
            showAlert(`Floor plan for ${floor} uploaded!`, 'success');
            render();
            renderAdmin();
          } else {
            showAlert('Upload failed: ' + result.error, 'error');
          }
        });
      }
    }

    function renderAdmin() {
      const overlay = document.getElementById('admin-overlay');
      const panel = document.getElementById('admin-panel');
      const tabsContainer = document.getElementById('admin-tabs-container');

      if (adminOpen) {
        overlay.classList.add('open');
        panel.classList.add('open');
      } else {
        overlay.classList.remove('open');
        panel.classList.remove('open');
        return;
      }

      // Render tabs based on user role
      let tabsHtml = `
        <div class="admin-tab ${adminTab === 'devices' ? 'active' : ''}" onclick="setAdminTab('devices')" data-tab="devices">Devices</div>
        <div class="admin-tab ${adminTab === 'notifications' ? 'active' : ''}" onclick="setAdminTab('notifications')" data-tab="notifications">Notifications</div>
        <div class="admin-tab ${adminTab === 'api' ? 'active' : ''}" onclick="setAdminTab('api')" data-tab="api">API</div>
        <div class="admin-tab ${adminTab === 'floors' ? 'active' : ''}" onclick="setAdminTab('floors')" data-tab="floors">Floor Plans</div>
      `;
      if (isAdmin()) {
        tabsHtml += `<div class="admin-tab ${adminTab === 'approvals' ? 'active' : ''}" onclick="setAdminTab('approvals')" data-tab="approvals">
          Approvals${pendingChangesCount > 0 ? `<span class="pending-badge">${pendingChangesCount}</span>` : ''}
        </div>`;
      }
      tabsContainer.innerHTML = tabsHtml;

      const filteredMonitors = allMonitors.filter(m =>
        !deviceFilter || m.name.toLowerCase().includes(deviceFilter.toLowerCase()) ||
        (m.hostname && m.hostname.includes(deviceFilter)) ||
        (m.floor && m.floor.toLowerCase().includes(deviceFilter.toLowerCase()))
      );

      // Get all device types including custom ones
      const allDeviceTypeOptions = [
        { value: 'accessPoints', label: 'Access Point' },
        { value: 'printers', label: 'Printer' },
        { value: 'polyLens', label: 'Poly Lens Device' },
        ...customDeviceTypes.filter(t => !['accessPoints', 'printers', 'polyLens'].includes(t.name))
          .map(t => ({ value: t.name, label: t.name }))
      ];

      let content = '';

      if (adminTab === 'devices') {
        content = `
          <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
              <h3 class="admin-section-title" style="margin: 0;">Devices (${allMonitors.length})</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-primary btn-sm" onclick="openEditModal()">+ Add Device</button>
                <button class="btn btn-secondary btn-sm" onclick="openBulkImportModal()">üì• Import</button>
                <button class="btn btn-secondary btn-sm" onclick="openDiscoveryModal()">üîç Discover</button>
                <button class="btn btn-secondary btn-sm ${bulkSelectMode ? 'active' : ''}" onclick="toggleBulkSelectMode()">
                  ‚òëÔ∏è ${bulkSelectMode ? 'Cancel' : 'Bulk'}
                </button>
              </div>
            </div>
            ${bulkSelectMode && selectedDevices.size > 0 ? `
              <div class="bulk-actions-bar">
                <span class="bulk-selected-count">${selectedDevices.size} selected</span>
                <div class="bulk-actions-btns">
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('activate')">Activate</button>
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('deactivate')">Deactivate</button>
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('move_floor')">Move</button>
                  <button class="btn btn-sm btn-danger" onclick="bulkAction('delete')">Delete</button>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="selectAllDevices()">All</button>
                <button class="btn btn-sm btn-secondary" onclick="deselectAllDevices()">None</button>
              </div>
            ` : ''}
            <div class="filter-bar">
              <div class="search-box" style="flex: 1; margin-bottom: 0;">
                <input type="text" placeholder="Search devices..." value="${deviceFilter}"
                  onkeyup="deviceFilter = this.value; renderAdmin()">
              </div>
              <select class="filter-select" style="width: auto; min-width: 120px;" onchange="if(this.value) applySavedFilter(this.value)">
                <option value="">Saved Filters</option>
                ${savedFilters.map(f => `<option value="${f.id}" ${activeFilter == f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
              <button class="btn btn-sm btn-secondary" onclick="saveCurrentFilter()" title="Save current filter">üíæ</button>
            </div>
            <div class="device-list">
              ${filteredMonitors.map(m => `
                <div class="device-item" oncontextmenu="showContextMenu(event, ${JSON.stringify(m).replace(/"/g, '&quot;')}); return false;">
                  ${bulkSelectMode ? `
                    <input type="checkbox" class="bulk-checkbox device-checkbox"
                      ${selectedDevices.has(m.id) ? 'checked' : ''}
                      onclick="event.stopPropagation(); toggleDeviceSelection(${m.id})">
                  ` : ''}
                  <div class="device-info">
                    <div class="device-name">
                      <span style="color: ${m.status === 'up' ? '#22C55E' : m.status === 'down' ? '#EF4444' : '#6B7280'};">‚óè</span>
                      ${m.name}
                      ${m.health_score !== null && m.health_score !== undefined ? renderHealthBadge(m.health_score) : ''}
                    </div>
                    <div class="device-meta">
                      ${m.hostname || m.url || ''} ¬∑ ${m.floor || 'No floor'} ¬∑ ${m.device_type || m.type}
                      ${m.notes ? `¬∑ <span title="${m.notes.replace(/"/g, '&quot;')}">üìù</span>` : ''}
                    </div>
                  </div>
                  <div class="device-actions">
                    ${isAdmin() ? `
                      <label class="toggle-switch">
                        <input type="checkbox" ${m.active ? 'checked' : ''} onchange="toggleMonitor(${m.id})">
                        <span class="toggle-slider"></span>
                      </label>
                    ` : ''}
                    <button class="btn btn-secondary btn-sm" onclick="openEditModal(${JSON.stringify(m).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteMonitor(${m.id})">üóëÔ∏è</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (adminTab === 'notifications') {
        const canEdit = isAdmin();
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Webhook Notifications</h3>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Send alerts to any webhook-compatible service: Slack, Discord, Microsoft Teams, Telegram bots, or custom endpoints.
            </p>
            ${!canEdit ? '<p style="color: #F59E0B; font-size: 13px; margin-bottom: 12px;">‚ö†Ô∏è Only admins can edit notification settings</p>' : ''}
            <div class="form-group">
              <label class="form-label">Webhook URL</label>
              <input type="text" class="form-input" id="setting-slack-webhook"
                value="${settings.slack_webhook_url || ''}" placeholder="https://hooks.slack.com/... or https://discord.com/api/webhooks/... or any webhook URL" ${!canEdit ? 'disabled' : ''}>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Examples: Slack, Discord, Teams, Telegram Bot API, n8n, Zapier, Make, or any custom endpoint
              </small>
            </div>
            <div class="form-group">
              <label class="form-label">Channel / Target (optional)</label>
              <input type="text" class="form-input" id="setting-slack-channel"
                value="${settings.slack_channel || ''}" placeholder="#channel, @user, or chat_id" ${!canEdit ? 'disabled' : ''}>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Depends on your platform - may be channel name, user ID, or chat ID
              </small>
            </div>
            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-slack-enabled" ${settings.slack_enabled === '1' ? 'checked' : ''} ${!canEdit ? 'disabled' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                Enable webhook notifications
              </label>
            </div>
            ${canEdit ? `
              <div class="btn-group">
                <button class="btn btn-primary" onclick="submitSettings()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="handleTestSlack()">üîî Send Test</button>
              </div>
            ` : ''}
          </div>
        `;
      } else if (adminTab === 'api') {
        const canEdit = isAdmin();
        content = `
          <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3 class="admin-section-title" style="margin: 0;">External Integrations</h3>
              <button class="btn btn-primary btn-sm" onclick="openApiModal()">+ Add Integration</button>
            </div>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Connect to external services and APIs: monitoring systems, device management platforms, IoT hubs, or any REST API.
            </p>
            ${!canEdit ? '<p style="color: #F59E0B; font-size: 13px; margin-bottom: 12px;">‚ö†Ô∏è Editing integrations requires admin approval</p>' : ''}
            ${apiIntegrations.map(api => `
              <div class="api-item">
                <div class="api-item-info">
                  <h4>
                    <span class="api-type-badge">${api.type}</span>
                    ${api.name}
                  </h4>
                  <div class="api-item-meta">
                    ${api.client_id ? `ID: ${api.client_id.substring(0, 10)}...` : api.webhook_url ? 'Webhook configured' : 'No credentials'}
                    ¬∑ ${api.active ? '<span style="color: #22C55E;">Active</span>' : '<span style="color: #EF4444;">Inactive</span>'}
                  </div>
                </div>
                <div class="device-actions">
                  <button class="btn btn-secondary btn-sm" onclick="openApiModal(${JSON.stringify(api).replace(/"/g, '&quot;')})">‚úèÔ∏è Edit</button>
                </div>
              </div>
            `).join('')}
            ${apiIntegrations.length === 0 ? `
              <div style="text-align: center; padding: 24px; color: #64748B; background: var(--bg-base); border-radius: 8px;">
                <div style="font-size: 24px; margin-bottom: 8px;">üîå</div>
                <p style="margin: 0 0 4px 0;">No integrations configured</p>
                <small>Add connections to Uptime Kuma, Poly Lens, LibreNMS, Zabbix, or any custom API</small>
              </div>
            ` : ''}
          </div>
        `;
      } else if (adminTab === 'floors') {
        const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Floor Plans</h3>
            <p style="color: #94A3B8; font-size: 13px; margin-bottom: 16px;">
              Upload blueprint images for each floor. Supported formats: PNG, JPG, SVG
            </p>
            ${floors.map(floor => {
              const plan = floorPlans[floor];
              return `
                <div style="margin-bottom: 16px;">
                  <label class="form-label">${floor}</label>
                  <div class="floor-plan-upload ${plan ? 'has-image' : ''}"
                    onclick="document.getElementById('upload-${floor.replace(/\s/g, '')}').click()">
                    ${plan ? `
                      <img src="data:image/${plan.image_type};base64,${plan.image_data || ''}"
                        class="floor-plan-preview" alt="${floor}" onerror="this.style.display='none'">
                      <div style="margin-top: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();">Change</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteFloorPlan('${floor}')">Remove</button>
                      </div>
                    ` : `
                      <div class="upload-icon">üìÅ</div>
                      <div class="upload-text">Click to upload floor plan</div>
                    `}
                  </div>
                  <input type="file" id="upload-${floor.replace(/\s/g, '')}" accept="image/*" style="display: none"
                    onchange="handleFloorPlanUpload('${floor}', this)">
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else if (adminTab === 'approvals' && isAdmin()) {
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Pending Approvals</h3>
            <div id="pending-changes-list"></div>
          </div>
        `;
        // Load pending changes after render
        setTimeout(loadPendingChanges, 0);
      }

      document.getElementById('admin-content').innerHTML = content;
    }

    async function loadPendingChanges() {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes`);
        const data = await response.json();
        const changes = data.changes || [];

        const container = document.getElementById('pending-changes-list');
        if (!container) return;

        if (changes.length === 0) {
          container.innerHTML = '<p style="color: #64748B; text-align: center; padding: 20px;">No pending changes</p>';
          return;
        }

        container.innerHTML = changes.map(change => {
          const changeData = JSON.parse(change.data);
          return `
            <div class="device-item" style="margin-bottom: 12px;">
              <div class="device-info">
                <div class="device-name">
                  <span class="api-type-badge">${change.change_type}</span>
                  ${change.entity_type}: ${changeData.name || `ID ${change.entity_id}`}
                </div>
                <div class="device-meta">
                  Requested by: ${change.requested_by} ¬∑ ${new Date(change.created_at).toLocaleString()}
                </div>
              </div>
              <div class="device-actions">
                <button class="btn btn-primary btn-sm" onclick="approveChange(${change.id})">‚úì Approve</button>
                <button class="btn btn-danger btn-sm" onclick="rejectChange(${change.id})">‚úó Reject</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Failed to load pending changes:', e);
      }
    }

    async function approveChange(id) {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/${id}/approve`, { method: 'POST' });
        if (response.ok) {
          showAlert('Change approved!', 'success');
          await fetchPendingChangesCount();
          await fetchAllMonitors();
          await fetchAllData();
          loadPendingChanges();
          render();
        }
      } catch (e) {
        showAlert('Failed to approve change', 'error');
      }
    }

    async function rejectChange(id) {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/${id}/reject`, { method: 'POST' });
        if (response.ok) {
          showAlert('Change rejected', 'success');
          await fetchPendingChangesCount();
          loadPendingChanges();
          render();
        }
      } catch (e) {
        showAlert('Failed to reject change', 'error');
      }
    }

    // ==================== API MODAL ====================
    let editingApi = null;

    function openApiModal(api = null) {
      editingApi = api ? { ...api } : {
        name: '',
        type: 'poly_lens',
        client_id: '',
        client_secret: '',
        webhook_url: '',
        config: '',
        active: 1
      };
      renderApiModal();
    }

    function closeApiModal() {
      editingApi = null;
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderApiModal() {
      if (!editingApi) return;

      const isNew = !editingApi.id;
      const apiTypes = [
        { value: 'uptime_kuma', label: 'Uptime Kuma' },
        { value: 'poly_lens', label: 'Poly Lens / Poly API' },
        { value: 'librenms', label: 'LibreNMS' },
        { value: 'zabbix', label: 'Zabbix' },
        { value: 'prtg', label: 'PRTG Network Monitor' },
        { value: 'webhook', label: 'Webhook (Slack, Discord, Teams, etc.)' },
        { value: 'custom', label: 'Custom REST API' }
      ];

      const showCredentials = ['poly_lens', 'librenms', 'zabbix', 'prtg', 'custom'].includes(editingApi.type);
      const showWebhook = ['webhook', 'custom', 'uptime_kuma'].includes(editingApi.type);

      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeApiModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">${isNew ? 'Add External Integration' : 'Edit Integration'}</h3>
              <button class="admin-close" onclick="closeApiModal()">&times;</button>
            </div>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Connect to monitoring systems, device APIs, or any REST endpoint.
            </p>
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="edit-api-name" value="${editingApi.name || ''}" placeholder="e.g., Production Monitoring, Office Network">
            </div>
            <div class="form-group">
              <label class="form-label">Integration Type</label>
              <select class="form-select" id="edit-api-type" onchange="updateApiModalFields()">
                ${apiTypes.map(t => `<option value="${t.value}" ${editingApi.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
              </select>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Select a preset or use Custom REST API for any other service
              </small>
            </div>
            <div class="form-group" id="api-webhook-group" style="display: ${showWebhook ? 'block' : 'none'}">
              <label class="form-label">API URL / Webhook URL</label>
              <input type="text" class="form-input" id="edit-api-webhook" value="${editingApi.webhook_url || ''}" placeholder="https://your-server.com/api/...">
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Base URL for API requests or full webhook endpoint
              </small>
            </div>
            <div class="form-group" id="api-client-id-group" style="display: ${showCredentials ? 'block' : 'none'}">
              <label class="form-label">API Key / Client ID</label>
              <input type="text" class="form-input" id="edit-api-client-id" value="${editingApi.client_id || ''}" placeholder="API key, Client ID, or username">
            </div>
            <div class="form-group" id="api-client-secret-group" style="display: ${showCredentials ? 'block' : 'none'}">
              <label class="form-label">Secret / Token ${!isNew ? '(leave blank to keep existing)' : ''}</label>
              <input type="password" class="form-input" id="edit-api-client-secret" value="" placeholder="${isNew ? 'API secret, token, or password' : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}">
            </div>
            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                  <input type="checkbox" id="edit-api-active" ${editingApi.active ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                Active
              </label>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="submitApi()">üíæ ${isNew ? 'Add Integration' : 'Save Changes'}</button>
              <button class="btn btn-secondary" onclick="closeApiModal()">Cancel</button>
            </div>
          </div>
        </div>
      `;
    }

    function updateApiModalFields() {
      const type = document.getElementById('edit-api-type').value;
      const showCredentials = ['poly_lens', 'librenms', 'zabbix', 'prtg', 'custom'].includes(type);
      const showWebhook = ['webhook', 'custom', 'uptime_kuma'].includes(type);

      document.getElementById('api-client-id-group').style.display = showCredentials ? 'block' : 'none';
      document.getElementById('api-client-secret-group').style.display = showCredentials ? 'block' : 'none';
      document.getElementById('api-webhook-group').style.display = showWebhook ? 'block' : 'none';
    }

    async function submitApi() {
      const api = {
        ...editingApi,
        name: document.getElementById('edit-api-name').value,
        type: document.getElementById('edit-api-type').value,
        client_id: document.getElementById('edit-api-client-id').value,
        client_secret: document.getElementById('edit-api-client-secret').value || editingApi.client_secret,
        webhook_url: document.getElementById('edit-api-webhook').value,
        active: document.getElementById('edit-api-active').checked ? 1 : 0
      };

      if (!api.name) {
        alert('Name is required');
        return;
      }

      const isNew = !api.id;
      const url = isNew ? `${API_URL}/api/integrations` : `${API_URL}/api/integrations/${api.id}`;
      const method = isNew ? 'POST' : 'PUT';

      try {
        const response = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(api)
        });
        const data = await response.json();

        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          } else {
            showAlert(isNew ? 'API integration added!' : 'API integration updated!', 'success');
          }
          await fetchApiIntegrations();
          closeApiModal();
          renderAdmin();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // ==================== ANALYTICS SIDEBAR ====================
    let analyticsOpen = false;
    let analyticsDevice = null;
    let analyticsData = null;
    let analyticsRefreshInterval = null;

    async function fetchAnalyticsData(deviceId, isRoom, roomName = null, isPolyDevice = false, polyDeviceData = null) {
      if (isRoom) {
        // Get room devices from polyLensData
        const roomDevices = [];
        Object.values(polyLensData).forEach(floorDevices => {
          floorDevices.forEach(device => {
            if (device.room === roomName) {
              roomDevices.push(device);
            }
          });
        });

        // Count only non-disabled devices for status
        const activeDevices = roomDevices.filter(d => !d.disabled);
        const onlineCount = activeDevices.filter(d => d.connected).length;
        const offlineCount = activeDevices.filter(d => !d.connected).length;
        const disabledCount = roomDevices.filter(d => d.disabled).length;
        const uptime = activeDevices.length > 0 ? ((onlineCount / activeDevices.length) * 100).toFixed(1) : 100;

        return {
          isRoom: true,
          roomName: roomName,
          devices: roomDevices,
          onlineCount,
          offlineCount,
          disabledCount,
          totalCount: roomDevices.length,
          activeCount: activeDevices.length,
          currentUptime: uptime
        };
      }

      if (isPolyDevice && polyDeviceData) {
        // Fetch real analytics data for Poly device from our database
        try {
          const polyDeviceId = polyDeviceData.id;

          // Fetch uptime stats
          const uptimeRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=24`);
          const uptimeData = uptimeRes.ok ? await uptimeRes.json() : null;

          // Fetch history
          const historyRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/history?limit=50`);
          const historyData = historyRes.ok ? await historyRes.json() : null;

          // Get 7 day uptime
          const uptime7dRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=168`);
          const uptime7dData = uptime7dRes.ok ? await uptime7dRes.json() : null;

          // Get 30 day uptime
          const uptime30dRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=720`);
          const uptime30dData = uptime30dRes.ok ? await uptime30dRes.json() : null;

          return {
            isPolyDevice: true,
            device: polyDeviceData,
            connected: polyDeviceData.connected,
            name: polyDeviceData.name,
            model: polyDeviceData.hardwareModel,
            ip: polyDeviceData.ip,
            serialNumber: polyDeviceData.serialNumber,
            softwareVersion: polyDeviceData.softwareVersion,
            room: polyDeviceData.room,
            lastSeen: polyDeviceData.lastSeen,
            // Analytics data from our database
            uptime24h: uptimeData?.uptime || 0,
            uptime7d: uptime7dData?.uptime || 0,
            uptime30d: uptime30dData?.uptime || 0,
            totalChecks: uptimeData?.total || 0,
            heartbeats: historyData?.heartbeats || []
          };
        } catch (e) {
          console.error('Failed to fetch Poly device analytics:', e);
          // Fallback to basic data
          return {
            isPolyDevice: true,
            device: polyDeviceData,
            connected: polyDeviceData.connected,
            name: polyDeviceData.name,
            model: polyDeviceData.hardwareModel,
            ip: polyDeviceData.ip,
            serialNumber: polyDeviceData.serialNumber,
            softwareVersion: polyDeviceData.softwareVersion,
            room: polyDeviceData.room,
            lastSeen: polyDeviceData.lastSeen,
            noHistory: true
          };
        }
      }

      try {
        // Get monitor info for maintenance/disabled status
        const monitor = allMonitors.find(m => m.id == deviceId);

        // Fetch uptime stats
        const uptimeRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=24`);
        const uptimeData = uptimeRes.ok ? await uptimeRes.json() : null;

        // Fetch history
        const historyRes = await fetch(`${API_URL}/api/monitors/${deviceId}/history?limit=50`);
        const historyData = historyRes.ok ? await historyRes.json() : null;

        // Get 7 day uptime
        const uptime7dRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=168`);
        const uptime7dData = uptime7dRes.ok ? await uptime7dRes.json() : null;

        // Get 30 day uptime
        const uptime30dRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=720`);
        const uptime30dData = uptime30dRes.ok ? await uptime30dRes.json() : null;

        return {
          uptime24h: uptimeData?.uptime || 0,
          uptime7d: uptime7dData?.uptime || 0,
          uptime30d: uptime30dData?.uptime || 0,
          totalChecks: uptimeData?.total || 0,
          heartbeats: historyData?.heartbeats || [],
          maintenance: monitor?.maintenance || 0,
          disabled: monitor?.disabled || 0
        };
      } catch (e) {
        console.error('Failed to fetch analytics:', e);
        return { error: true };
      }
    }

    async function refreshAnalytics() {
      if (!analyticsDevice || !analyticsOpen) return;

      console.log('Refreshing analytics data...');
      analyticsData = await fetchAnalyticsData(
        analyticsDevice.id,
        analyticsDevice.isRoom,
        analyticsDevice.name,
        analyticsDevice.isPolyDevice,
        analyticsDevice.polyDeviceData
      );
      renderAnalyticsSidebar(false);
    }

    async function openAnalytics(deviceId, deviceName, deviceType, isRoom = false, polyDeviceData = null) {
      // Clear any existing refresh interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }

      const isPolyDevice = polyDeviceData !== null;
      analyticsDevice = { id: deviceId, name: deviceName, type: deviceType, isRoom, isPolyDevice, polyDeviceData };
      analyticsOpen = true;

      // Render loading state
      renderAnalyticsSidebar(true);

      // Fetch device data (pass roomName for room analytics, or polyDeviceData for individual poly device)
      analyticsData = await fetchAnalyticsData(deviceId, isRoom, deviceName, isPolyDevice, polyDeviceData);
      renderAnalyticsSidebar(false);

      // Set up auto-refresh every 30 minutes (1800000 ms)
      analyticsRefreshInterval = setInterval(refreshAnalytics, 30 * 60 * 1000);
      console.log('Analytics auto-refresh enabled (every 30 minutes)');
    }

    function closeAnalytics() {
      // Clear auto-refresh interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
        console.log('Analytics auto-refresh disabled');
      }

      analyticsOpen = false;
      analyticsDevice = null;
      analyticsData = null;
      analyticsParentRoom = null;
      document.getElementById('analytics-container').innerHTML = '';
    }

    // Store parent room for back navigation
    let analyticsParentRoom = null;

    function openPolyDeviceAnalytics(deviceData) {
      // Store current room for back navigation
      if (analyticsDevice && analyticsDevice.isRoom) {
        analyticsParentRoom = { ...analyticsDevice };
      }
      // Open analytics for the individual Poly Lens device
      openAnalytics(deviceData.id || deviceData.name, deviceData.name, 'polyLensDevice', false, deviceData);
    }

    function goBackToRoom() {
      if (analyticsParentRoom) {
        const room = analyticsParentRoom;
        analyticsParentRoom = null;
        openAnalytics(room.id, room.name, room.type, true, null);
      }
    }

    function renderAnalyticsSidebar(loading = false) {
      if (!analyticsDevice) return;

      const device = analyticsDevice;
      const data = analyticsData;

      // Calculate current status from heartbeats
      const currentStatus = data?.heartbeats?.[0]?.status === 1 ? 'up' : 'down';
      const lastPing = data?.heartbeats?.[0]?.ping;
      const avgPing = data?.heartbeats?.length > 0
        ? (data.heartbeats.filter(h => h.ping).reduce((sum, h) => sum + (h.ping || 0), 0) / data.heartbeats.filter(h => h.ping).length).toFixed(1)
        : 0;

      // Calculate downtime incidents
      let incidents = 0;
      let lastStatus = null;
      data?.heartbeats?.forEach(h => {
        if (lastStatus === 1 && h.status === 0) incidents++;
        lastStatus = h.status;
      });

      // Build uptime bar (last 24 hours, each segment = 30 minutes)
      const uptimeSegments = [];
      if (data?.heartbeats?.length > 0) {
        const now = new Date();
        const segments = 48; // 24 hours / 30 min = 48 segments
        for (let i = 0; i < segments; i++) {
          const segmentEnd = new Date(now - i * 30 * 60 * 1000);
          const segmentStart = new Date(segmentEnd - 30 * 60 * 1000);

          const segmentHeartbeats = data.heartbeats.filter(h => {
            const time = new Date(h.time);
            return time >= segmentStart && time < segmentEnd;
          });

          if (segmentHeartbeats.length === 0) {
            uptimeSegments.unshift({ status: 'unknown', time: segmentStart });
          } else {
            const anyDown = segmentHeartbeats.some(h => h.status === 0);
            uptimeSegments.unshift({ status: anyDown ? 'down' : 'up', time: segmentStart });
          }
        }
      }

      // Build response time chart
      const responseTimes = data?.heartbeats?.slice(0, 30).reverse() || [];

      document.getElementById('analytics-container').innerHTML = `
        <div class="analytics-overlay ${analyticsOpen ? 'open' : ''}" onclick="closeAnalytics()"></div>
        <div class="analytics-sidebar ${analyticsOpen ? 'open' : ''}">
          <div class="analytics-header">
            <div class="analytics-header-top">
              <div>
                <h2 class="analytics-title">${device.name}</h2>
                <p class="analytics-subtitle">${device.type === 'accessPoints' ? 'Access Point' : device.type === 'printers' ? 'Printer' : device.type === 'polyLensDevice' ? 'Poly Lens Device' : 'Zoom Room'}</p>
              </div>
              <button class="analytics-close" onclick="closeAnalytics()">&times;</button>
            </div>
            ${!loading && !device.isRoom ? `
              <div class="analytics-status ${currentStatus}">
                <span style="font-size: 10px;">‚óè</span>
                ${currentStatus === 'up' ? 'Online' : 'Offline'}
                ${lastPing ? ` ‚Ä¢ ${lastPing}ms` : ''}
              </div>
            ` : ''}
            ${!loading && device.isRoom && data?.devices ? `
              <div class="analytics-status ${data.offlineCount === 0 ? 'up' : 'down'}">
                <span style="font-size: 10px;">‚óè</span>
                ${data.onlineCount}/${data.totalCount} Online
              </div>
            ` : ''}
            ${!loading && data?.isPolyDevice ? `
              <div class="analytics-status ${data.connected ? 'up' : 'down'}">
                <span style="font-size: 10px;">‚óè</span>
                ${data.connected ? 'Online' : 'Offline'}
              </div>
            ` : ''}
          </div>

          ${!loading && !device.isRoom && !device.isPolyDevice ? `
            <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
              <button onclick="toggleMaintenanceFromAnalytics(${device.id})" class="btn btn-sm ${data?.maintenance ? 'btn-warning' : 'btn-secondary'}" style="flex: 1; min-width: 120px;">
                üîß ${data?.maintenance ? 'End Maintenance' : 'Maintenance'}
              </button>
              <button onclick="toggleDisabledFromAnalytics(${device.id}, ${data?.disabled ? 'false' : 'true'})" class="btn btn-sm ${data?.disabled ? 'btn-success' : 'btn-danger'}" style="flex: 1; min-width: 120px;">
                ${data?.disabled ? '‚úÖ Enable' : 'üö´ Disable'}
              </button>
              <button onclick="highlightDevice('${device.id}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
                üìç Locate
              </button>
            </div>
          ` : ''}

          ${!loading && device.isRoom ? `
            <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
              <button onclick="highlightDevice('${device.id}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
                üìç Locate on Map
              </button>
            </div>
          ` : ''}

          <div class="analytics-content">
            ${loading ? `
              <div style="text-align: center; padding: 40px; color: #64748B;">
                <div style="font-size: 24px; margin-bottom: 12px;">‚è≥</div>
                Loading analytics...
              </div>
            ` : device.isRoom && data?.devices ? `
              <div class="analytics-section">
                <div class="analytics-section-title">Room Status</div>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.currentUptime) >= 99 ? 'green' : parseFloat(data.currentUptime) >= 50 ? 'yellow' : 'red'}">${data.currentUptime}%</div>
                    <div class="stat-label">Uptime</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value green">${data.onlineCount}</div>
                    <div class="stat-label">Online</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${data.offlineCount > 0 ? 'red' : 'green'}">${data.offlineCount}</div>
                    <div class="stat-label">Offline</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value" style="color: var(--text-muted);">${data.disabledCount || 0}</div>
                    <div class="stat-label">Disabled</div>
                  </div>
                </div>
              </div>

              ${data.devices.filter(d => d.disabled).length > 0 ? `
                <div class="analytics-section" style="background: rgba(107, 114, 128, 0.1); border: 1px solid rgba(107, 114, 128, 0.3); border-radius: 8px; padding: 12px;">
                  <div class="analytics-section-title" style="color: #9CA3AF;">üö´ Disabled Devices (${data.devices.filter(d => d.disabled).length})</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${data.devices.filter(d => d.disabled).map(d => `
                      <div style="background: rgba(107, 114, 128, 0.15); border-radius: 6px; padding: 10px; opacity: 0.6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                          <span style="font-weight: 600; color: #9CA3AF;">${d.name}</span>
                          <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', false)" class="btn btn-sm btn-success" style="padding: 2px 8px; font-size: 10px;">
                            ‚úÖ Enable
                          </button>
                        </div>
                        <div style="font-size: 12px; color: #6B7280;">${d.hardwareModel || 'Unknown Model'}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              ${data.devices.filter(d => !d.connected && !d.disabled).length > 0 ? `
                <div class="analytics-section" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
                  <div class="analytics-section-title" style="color: #EF4444;">‚ö†Ô∏è Devices with Issues (${data.devices.filter(d => !d.connected && !d.disabled).length})</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${data.devices.filter(d => !d.connected && !d.disabled).map(d => `
                      <div style="background: rgba(239, 68, 68, 0.15); border-radius: 6px; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                          <span onclick="openPolyDeviceAnalytics(${JSON.stringify(d).replace(/"/g, '&quot;')})" style="font-weight: 600; color: #FCA5A5; cursor: pointer;">${d.name}</span>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; background: #EF4444; color: white;">OFFLINE</span>
                            <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', true)" class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 10px;" title="Disable this device">
                              üö´
                            </button>
                          </div>
                        </div>
                        <div style="font-size: 12px; color: #FDA4AF;">${d.hardwareModel || 'Unknown Model'}</div>
                        ${d.ip ? `<div style="font-size: 11px; color: #94A3B8; margin-top: 4px;">IP: ${d.ip}</div>` : '<div style="font-size: 11px; color: #F87171; margin-top: 4px;">No IP assigned</div>'}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">${data.devices.filter(d => !d.connected && !d.disabled).length > 0 ? 'Online Devices' : 'All Devices'} (${data.devices.filter(d => d.connected && !d.disabled).length})</div>
                <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                  ${data.devices.filter(d => d.connected && !d.disabled).map(d => `
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 6px; padding: 10px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span onclick="openPolyDeviceAnalytics(${JSON.stringify(d).replace(/"/g, '&quot;')})" style="font-weight: 600; color: #86EFAC; cursor: pointer;">${d.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; background: #22C55E; color: white;">ONLINE</span>
                          <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', true)" class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 10px;" title="Disable this device">
                            üö´
                          </button>
                        </div>
                      </div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                        <div>
                          <span style="color: #64748B;">Model:</span>
                          <span style="color: #94A3B8; margin-left: 4px;">${d.hardwareModel || 'Unknown'}</span>
                        </div>
                        <div>
                          <span style="color: #64748B;">IP:</span>
                          <span style="color: #60A5FA; margin-left: 4px;">${d.ip || 'N/A'}</span>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="analytics-section" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: #64748B; text-align: center;">
                  üìπ Data from Poly Lens API ‚Ä¢ Auto-refreshes every 30 minutes
                </div>
              </div>
            ` : data?.isPolyDevice ? `
              ${analyticsParentRoom ? `
                <button onclick="goBackToRoom()" style="display: flex; align-items: center; gap: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #60A5FA; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 16px; font-size: 12px;">
                  ‚Üê Back to ${analyticsParentRoom.name}
                </button>
              ` : ''}

              ${data.heartbeats && data.heartbeats.length > 0 ? `
                <div class="analytics-section">
                  <div class="analytics-section-title">Uptime Statistics</div>
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime24h) >= 99 ? 'green' : parseFloat(data.uptime24h) >= 95 ? 'yellow' : 'red'}">${data.uptime24h}%</div>
                      <div class="stat-label">Last 24 Hours</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime7d) >= 99 ? 'green' : parseFloat(data.uptime7d) >= 95 ? 'yellow' : 'red'}">${data.uptime7d}%</div>
                      <div class="stat-label">Last 7 Days</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime30d) >= 99 ? 'green' : parseFloat(data.uptime30d) >= 95 ? 'yellow' : 'red'}">${data.uptime30d}%</div>
                      <div class="stat-label">Last 30 Days</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value blue">${data.totalChecks}</div>
                      <div class="stat-label">Total Checks</div>
                    </div>
                  </div>
                </div>

                <div class="analytics-section">
                  <div class="analytics-section-title">24 Hour Connection History</div>
                  <div class="uptime-bar">
                    ${(() => {
                      const segments = [];
                      const now = new Date();
                      for (let i = 0; i < 48; i++) {
                        const segmentEnd = new Date(now - i * 30 * 60 * 1000);
                        const segmentStart = new Date(segmentEnd - 30 * 60 * 1000);
                        const segmentHeartbeats = data.heartbeats.filter(h => {
                          const time = new Date(h.time);
                          return time >= segmentStart && time < segmentEnd;
                        });
                        if (segmentHeartbeats.length === 0) {
                          segments.unshift({ status: 'unknown', time: segmentStart });
                        } else {
                          const anyDown = segmentHeartbeats.some(h => h.status === 0);
                          segments.unshift({ status: anyDown ? 'down' : 'up', time: segmentStart });
                        }
                      }
                      return segments.map(seg =>
                        '<div class="uptime-segment ' + seg.status + '" data-tooltip="' + new Date(seg.time).toLocaleTimeString() + ' - ' + seg.status.toUpperCase() + '" style="flex: 1;"></div>'
                      ).join('');
                    })()}
                  </div>
                  <div class="uptime-legend">
                    <span>24h ago</span>
                    <span>Now</span>
                  </div>
                </div>

                <div class="analytics-section">
                  <div class="analytics-section-title">Recent History</div>
                  <div class="history-list">
                    ${data.heartbeats.slice(0, 15).map(h => `
                      <div class="history-item">
                        <div class="history-status ${h.status === 1 ? 'up' : 'down'}"></div>
                        <div class="history-info">
                          <div class="history-time">${new Date(h.time).toLocaleString()}</div>
                          <div class="history-message">${h.status === 1 ? 'Connected' : 'Disconnected'}${h.ip ? ' ‚Ä¢ IP: ' + h.ip : ''}</div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : `
                <div class="analytics-section">
                  <div class="analytics-section-title">Device Status</div>
                  <div style="background: ${data.connected ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border: 1px solid ${data.connected ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'}; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 8px;">${data.connected ? '‚úÖ' : '‚ùå'}</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${data.connected ? '#22C55E' : '#EF4444'};">
                      ${data.connected ? 'Online' : 'Offline'}
                    </div>
                    <div style="font-size: 12px; color: #94A3B8; margin-top: 4px;">
                      Current Connection Status
                    </div>
                  </div>
                </div>

                <div style="text-align: center; padding: 20px; color: #64748B; font-size: 12px;">
                  üìä Historical data will be available once the system starts tracking this device.
                </div>
              `}

              <div class="analytics-section">
                <div class="analytics-section-title">Device Information</div>
                <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 16px;">
                  <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Device Name</span>
                      <span style="color: #E2E8F0; font-weight: 500;">${data.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Model</span>
                      <span style="color: #E2E8F0;">${data.model || 'Unknown'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Room</span>
                      <span style="color: #E2E8F0;">${data.room || 'Unassigned'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">IP Address</span>
                      <span style="color: #60A5FA; font-family: monospace;">${data.ip || 'N/A'}</span>
                    </div>
                    ${data.serialNumber ? `
                      <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                        <span style="color: #64748B;">Serial Number</span>
                        <span style="color: #E2E8F0; font-family: monospace; font-size: 11px;">${data.serialNumber}</span>
                      </div>
                    ` : ''}
                    ${data.softwareVersion ? `
                      <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                        <span style="color: #64748B;">Software Version</span>
                        <span style="color: #E2E8F0;">${data.softwareVersion}</span>
                      </div>
                    ` : ''}
                    ${data.lastSeen ? `
                      <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748B;">Last Seen</span>
                        <span style="color: ${data.connected ? '#94A3B8' : '#F87171'};">${new Date(data.lastSeen).toLocaleString()}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              ${!data.connected ? `
                <div class="analytics-section" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px;">
                  <div class="analytics-section-title" style="color: #EF4444;">‚ö†Ô∏è Troubleshooting</div>
                  <ul style="margin: 0; padding-left: 20px; color: #FDA4AF; font-size: 12px; line-height: 1.8;">
                    <li>Check if the device is powered on</li>
                    <li>Verify network connectivity</li>
                    <li>Check if the device is connected to the correct network</li>
                    <li>Try restarting the device</li>
                    <li>Contact IT support if the issue persists</li>
                  </ul>
                </div>
              ` : ''}

              <div class="analytics-section" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: #64748B; text-align: center;">
                  üìπ Data tracked locally ‚Ä¢ Auto-refreshes every 30 minutes
                </div>
              </div>
            ` : data?.error ? `
              <div style="text-align: center; padding: 40px; color: #EF4444;">
                Failed to load analytics data.
              </div>
            ` : `
              <div class="analytics-section">
                <div class="analytics-section-title">Uptime Statistics</div>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime24h) >= 99 ? 'green' : parseFloat(data.uptime24h) >= 95 ? 'yellow' : 'red'}">${data.uptime24h}%</div>
                    <div class="stat-label">Last 24 Hours</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime7d) >= 99 ? 'green' : parseFloat(data.uptime7d) >= 95 ? 'yellow' : 'red'}">${data.uptime7d}%</div>
                    <div class="stat-label">Last 7 Days</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime30d) >= 99 ? 'green' : parseFloat(data.uptime30d) >= 95 ? 'yellow' : 'red'}">${data.uptime30d}%</div>
                    <div class="stat-label">Last 30 Days</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value blue">${avgPing}ms</div>
                    <div class="stat-label">Avg Response</div>
                  </div>
                </div>
              </div>

              ${device.type === 'printers' ? renderPrinterConsumables(device.id) : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">24 Hour Uptime</div>
                <div class="uptime-bar">
                  ${uptimeSegments.map(seg => `
                    <div class="uptime-segment ${seg.status}"
                      data-tooltip="${new Date(seg.time).toLocaleTimeString()} - ${seg.status.toUpperCase()}"
                      style="flex: 1;"></div>
                  `).join('')}
                </div>
                <div class="uptime-legend">
                  <span>24h ago</span>
                  <span>Now</span>
                </div>
              </div>

              ${responseTimes.length > 0 ? `
                <div class="analytics-section">
                  <div class="analytics-section-title">Response Time (Last ${responseTimes.length} checks)</div>
                  <div class="response-chart">
                    ${responseTimes.map(h => {
                      const maxPing = Math.max(...responseTimes.map(r => r.ping || 0), 100);
                      const height = h.ping ? Math.max(10, (h.ping / maxPing) * 100) : 5;
                      const slow = h.ping > 200;
                      const timeout = h.status === 0;
                      return `<div class="response-bar ${timeout ? 'timeout' : slow ? 'slow' : ''}"
                        style="height: ${timeout ? 100 : height}%;"
                        title="${h.ping ? h.ping + 'ms' : 'Timeout'} at ${new Date(h.time).toLocaleTimeString()}"></div>`;
                    }).join('')}
                  </div>
                </div>
              ` : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">Recent History</div>
                <div class="history-list">
                  ${data.heartbeats.slice(0, 15).map(h => `
                    <div class="history-item">
                      <div class="history-status ${h.status === 1 ? 'up' : 'down'}"></div>
                      <div class="history-info">
                        <div class="history-time">${new Date(h.time).toLocaleString()}</div>
                        ${h.message ? `<div class="history-message">${h.message}</div>` : ''}
                      </div>
                      ${h.ping ? `<div class="history-ping">${h.ping}ms</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function render() {
      // Update global floors array from data
      floors = Object.keys(uptimeKumaData).length > 0
        ? Object.keys(uptimeKumaData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      const currentFloorData = uptimeKumaData[activeFloor] || { accessPoints: [], printers: [], polyLens: [] };
      const currentPolyData = polyLensData[activeFloor] || [];
      const currentCounts = getStatusCounts(currentFloorData, currentPolyData);
      const now = new Date().toLocaleTimeString();

      // Build device markers for floor plan
      let deviceMarkersHTML = '';
      let allDevices = [];

      // Add monitors from database (Access Points and Printers only - not polyLens type)
      Object.entries(currentFloorData).forEach(([type, devices]) => {
        if (Array.isArray(devices) && type !== 'polyLens') {
          devices.forEach(d => allDevices.push({ ...d, type, source: 'monitor' }));
        }
      });

      // Group Poly Lens devices by room
      const polyRoomGroups = {};
      currentPolyData.forEach(polyDevice => {
        const roomName = polyDevice.room || 'Unassigned';
        if (!polyRoomGroups[roomName]) {
          polyRoomGroups[roomName] = [];
        }
        polyRoomGroups[roomName].push(polyDevice);
      });

      // Add one marker per Poly Lens room
      Object.entries(polyRoomGroups).forEach(([roomName, devices]) => {
        const allConnected = devices.every(d => d.connected);
        const anyDisconnected = devices.some(d => !d.connected);
        allDevices.push({
          id: `room-${roomName.replace(/\s+/g, '-')}`,
          name: roomName,
          ip: devices.map(d => d.ip).filter(Boolean).join(', '),
          status: anyDisconnected ? 'down' : 'up',
          type: 'polyLens',
          source: 'polyLensRoom',
          roomDevices: devices,
          deviceCount: devices.length,
          pos_x: null,
          pos_y: null
        });
      });

      const positions = generatePositions(allDevices.length, activeFloor.charCodeAt(0) * 7);

      allDevices.forEach((device, idx) => {
        // Use saved position if available, otherwise use generated position
        // In TV mode, prefer TV positions if available
        let pos;
        const isRoomMarker = device.source === 'polyLensRoom';

        if (isRoomMarker) {
          // Check for saved room position
          const savedRoomPos = roomPositions[device.id];
          if (savedRoomPos && savedRoomPos.pos_x !== null && savedRoomPos.pos_y !== null) {
            pos = { x: savedRoomPos.pos_x, y: savedRoomPos.pos_y };
          } else {
            pos = positions[idx];
          }
        } else {
          // Check for saved monitor position
          const hasCustomPos = device.pos_x !== null && device.pos_y !== null;
          pos = hasCustomPos ? { x: device.pos_x, y: device.pos_y } : positions[idx];
        }

        // Final safety check - ensure position is never null
        if (pos.x === null || pos.y === null || pos.x === undefined || pos.y === undefined) {
          pos = positions[idx] || { x: 10 + (idx % 5) * 20, y: 20 + Math.floor(idx / 5) * 20 };
        }

        const typeInfo = deviceTypes[device.type] || deviceTypes.polyLens;
        const status = statusColors[device.status] || statusColors.unknown;

        if (isRoomMarker) {
          // Room marker with multiple devices
          const roomDevices = device.roomDevices || [];
          // Filter out disabled and maintenance devices for status calculation
          const activeDevices = roomDevices.filter(d => !d.disabled && !d.maintenance);
          const onlineCount = activeDevices.filter(d => d.connected).length;
          const offlineCount = activeDevices.length - onlineCount;

          const popupBelowClass = pos.y < 30 ? 'popup-below' : '';
          deviceMarkersHTML += `
            <div class="device-marker ${popupBelowClass}" data-id="${device.id}" style="left: ${pos.x}%; top: ${pos.y}%;"
              ${editMode ? 'draggable="true" onmousedown="startDrag(event, this)" onclick="event.stopPropagation(); event.preventDefault();"' : `onclick="event.stopPropagation(); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'polyLens', true)"`}>
              ${offlineCount > 0 && activeDevices.length > 0 ? `<div class="device-ping" style="background: ${statusColors.down.pulse};"></div>` : ''}
              <div class="device-dot" style="background: ${status.bg}; border-color: ${typeInfo.color}; min-width: 28px; font-size: 9px;">
                ${roomDevices.length}
              </div>
              <div class="device-popup">
                <div class="popup-header">
                  <span class="popup-icon">üö™</span>
                  <span class="popup-name">${device.name}</span>
                </div>
                <div class="popup-details">
                  <div class="popup-row"><strong>Devices:</strong> <span>${roomDevices.length}</span></div>
                  <div class="popup-row">
                    <strong>Status:</strong>
                    <span class="status-badge" style="background: #22C55E;">${onlineCount} Online</span>
                    ${offlineCount > 0 ? `<span class="status-badge" style="background: #EF4444; margin-left: 4px;">${offlineCount} Offline</span>` : ''}
                  </div>
                </div>
                <div class="popup-section">
                  <div class="popup-section-title">üìπ Devices in Room</div>
                  ${roomDevices.map(rd => `
                    <div class="popup-row" style="padding: 6px 0; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="color: ${rd.connected ? '#22C55E' : '#EF4444'};">‚óè</span>
                        <strong>${rd.name}</strong>
                      </div>
                      <div style="margin-left: 16px; font-size: 11px; color: #94A3B8;">
                        <span>${rd.hardwareModel || 'Unknown model'}</span>
                        ${rd.ip ? `<span style="margin-left: 8px; color: #60A5FA;">IP: ${rd.ip}</span>` : ''}
                      </div>
                    </div>
                  `).join('')}
                </div>
                <div class="popup-arrow"></div>
              </div>
            </div>
          `;
        } else {
          // Regular device marker (AP, Printer)
          const polyDevice = currentPolyData.find(p => p.ip === device.ip);
          const popupBelowClass = pos.y < 30 ? 'popup-below' : '';

          const disabledClass = device.disabled ? 'disabled' : '';
          deviceMarkersHTML += `
            <div class="device-marker ${popupBelowClass} ${disabledClass}" data-id="${device.id}" style="left: ${pos.x}%; top: ${pos.y}%;"
              ${editMode ? 'draggable="true" onmousedown="startDrag(event, this)" onclick="event.stopPropagation(); event.preventDefault();"' : `onclick="event.stopPropagation(); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', '${device.type}')"`}
              oncontextmenu="showContextMenu(event, ${JSON.stringify({id: device.id, name: device.name, hostname: device.ip || device.hostname, url: device.url, device_type: device.type, notes: device.notes, maintenance: device.maintenance, disabled: device.disabled}).replace(/"/g, '&quot;')}); return false;">
              ${device.status === 'down' && !device.disabled ? `<div class="device-ping" style="background: ${status.pulse};"></div>` : ''}
              <div class="device-dot" style="background: ${status.bg}; border-color: ${typeInfo.color};">
                ${typeInfo.icon.slice(0, 2)}
              </div>
              <div class="device-popup">
                <div class="popup-header">
                  <span class="popup-icon">${typeInfo.icon}</span>
                  <span class="popup-name">${device.name}</span>
                  ${device.health_score !== null && device.health_score !== undefined ? `
                    <span class="health-badge ${getHealthClass(device.health_score)}" style="margin-left: auto;">
                      ‚ù§Ô∏è ${device.health_score}%
                    </span>
                  ` : ''}
                </div>
                <div class="popup-details">
                  <div class="popup-row"><strong>Type:</strong> <span>${typeInfo.label}</span></div>
                  <div class="popup-row"><strong>IP:</strong> <span>${device.ip || 'N/A'}</span></div>
                  <div class="popup-row">
                    <strong>Status:</strong>
                    <span class="status-badge" style="background: ${status.bg};">${status.label}</span>
                  </div>
                  ${device.ping ? `<div class="popup-row"><strong>Ping:</strong> <span>${device.ping}ms</span></div>` : ''}
                </div>
                ${device.notes ? `
                  <div class="device-notes">
                    <div class="device-notes-label">üìù Notes</div>
                    <div class="device-notes-content">${device.notes}</div>
                  </div>
                ` : ''}
                ${renderSparkline(device.id)}
                ${polyDevice ? `
                  <div class="popup-section">
                    <div class="popup-section-title">üìπ Poly Lens</div>
                    <div class="popup-row"><strong>Model:</strong> <span>${polyDevice.hardwareModel || 'N/A'}</span></div>
                    <div class="popup-row"><strong>Room:</strong> <span>${polyDevice.room || 'N/A'}</span></div>
                    <div class="popup-row">
                      <strong>Poly Status:</strong>
                      <span class="status-badge" style="background: ${polyDevice.connected ? '#22C55E' : '#EF4444'};">
                        ${polyDevice.connected ? 'Connected' : 'Disconnected'}
                      </span>
                    </div>
                  </div>
                ` : ''}
                ${device.type === 'printers' && printerStatusData[device.id] ? `
                  <div class="printer-consumables">
                    <div class="consumables-header">
                      <div class="consumables-title">
                        <span class="consumables-title-icon">üé®</span>
                        <span>Consumables</span>
                      </div>
                      <button class="consumables-refresh" onclick="event.stopPropagation(); refreshPrinterStatus(${device.id})">‚Üª Refresh</button>
                    </div>
                    <div class="toner-levels">
                      ${['black', 'cyan', 'magenta', 'yellow'].map(color => {
                        const level = printerStatusData[device.id].toner[color];
                        if (level === null || level === undefined) return '';
                        const isLow = level < 20;
                        const colorLabel = {black: 'K', cyan: 'C', magenta: 'M', yellow: 'Y'}[color];
                        return `
                          <div class="toner-bar ${isLow ? 'low' : ''}">
                            <div class="toner-bar-value">${level}%</div>
                            <div class="toner-bar-track">
                              <div class="toner-bar-fill ${color}" style="height: ${level}%;"></div>
                            </div>
                            <div class="toner-bar-label">${colorLabel}</div>
                            ${isLow ? '<span class="toner-low-badge">LOW</span>' : ''}
                          </div>
                        `;
                      }).join('')}
                    </div>
                    ${printerStatusData[device.id].paper?.level !== null ? `
                      <div class="paper-section">
                        <span class="paper-icon-large">üìÑ</span>
                        <div class="paper-info">
                          <div class="paper-label">Paper Level</div>
                          <div class="paper-bar">
                            <div class="paper-bar-fill ${printerStatusData[device.id].paper.level < 20 ? (printerStatusData[device.id].paper.level < 10 ? 'empty' : 'low') : ''}"
                                 style="width: ${printerStatusData[device.id].paper.level || 0}%;"></div>
                          </div>
                        </div>
                        <span class="paper-value">${printerStatusData[device.id].paper.level || 0}%</span>
                      </div>
                    ` : ''}
                    ${printerStatusData[device.id].info?.pageCount ? `
                      <div class="page-count-row">
                        <span class="page-count-label">üìä Total Pages Printed</span>
                        <span class="page-count-value">${printerStatusData[device.id].info.pageCount.toLocaleString()}</span>
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
                <div class="popup-arrow"></div>
              </div>
            </div>
          `;
        }
      });

      // Build sidebar with room groupings for Poly devices
      let sidebarHTML = '';

      // Access Points section
      const aps = currentFloorData.accessPoints || [];
      if (aps.length > 0) {
        const apDownCount = aps.filter(d => d.status === 'down').length;
        sidebarHTML += `
          <div class="device-category">
            <div class="category-header ap collapsed" onclick="toggleCategory(this)">
              <span>üì°</span>
              <span class="category-name">Access Points</span>
              <span class="category-count">${aps.length - apDownCount}/${aps.length}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${aps.map(device => `
                <div class="device-item clickable ${device.status === 'down' ? 'down' : ''}" onclick="highlightDevice('${device.id}'); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'accessPoints')">
                  <div class="device-status-dot ${device.status}"></div>
                  <div class="device-info">
                    <div class="device-name">${device.name}</div>
                    <div class="device-meta">
                      <span>${device.ip}</span>
                      ${device.ping ? `<span>${device.ping}ms</span>` : ''}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Printers section
      const printers = currentFloorData.printers || [];
      if (printers.length > 0) {
        const printerDownCount = printers.filter(d => d.status === 'down').length;
        sidebarHTML += `
          <div class="device-category">
            <div class="category-header printer collapsed" onclick="toggleCategory(this)">
              <span>üñ®Ô∏è</span>
              <span class="category-name">Printers</span>
              <span class="category-count">${printers.length - printerDownCount}/${printers.length}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${printers.map(device => {
                const ps = printerStatusData[device.id];
                const toner = ps?.toner || {};
                const hasLowToner = [toner.black, toner.cyan, toner.magenta, toner.yellow].some(v => v !== null && v < 20);
                return `
                <div class="device-item clickable ${device.status === 'down' ? 'down' : ''}" onclick="highlightDevice('${device.id}'); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'printers')">
                  <div class="device-status-dot ${device.status}"></div>
                  <div class="device-info">
                    <div class="device-name">${device.name} ${hasLowToner ? '<span style="color: var(--status-warning);" title="Low toner">‚ö†Ô∏è</span>' : ''}</div>
                    <div class="device-meta">
                      <span>${device.ip}</span>
                      ${ps ? `<span style="margin-left: 8px;">üìÑ ${ps.paper?.level || 0}%</span>` : ''}
                    </div>
                  </div>
                  ${ps ? `
                    <div class="sidebar-toner" title="Toner: K:${toner.black || 0}% C:${toner.cyan || 0}% M:${toner.magenta || 0}% Y:${toner.yellow || 0}%">
                      <div class="sidebar-toner-dot black ${(toner.black || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot cyan ${(toner.cyan || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot magenta ${(toner.magenta || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot yellow ${(toner.yellow || 0) < 20 ? 'low' : ''}"></div>
                    </div>
                  ` : ''}
                </div>
              `}).join('')}
            </div>
          </div>
        `;
      }

      // Poly Lens / Zoom Rooms section - grouped by room
      const polyRooms = getPolyLensRooms(activeFloor);
      const roomNames = Object.keys(polyRooms).sort();

      if (roomNames.length > 0) {
        const totalPolyDevices = currentPolyData.length;
        const onlinePolyDevices = currentPolyData.filter(d => d.connected).length;

        sidebarHTML += `
          <div class="device-category">
            <div class="category-header poly collapsed" onclick="toggleCategory(this)">
              <span>üìπ</span>
              <span class="category-name">Zoom Rooms</span>
              <span class="category-count">${onlinePolyDevices}/${totalPolyDevices}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${roomNames.map(roomName => {
                const roomDevices = polyRooms[roomName];
                // Filter out disabled and maintenance devices for status calculation
                const activeRoomDevices = roomDevices.filter(d => !d.disabled && !d.maintenance);
                const allOnline = activeRoomDevices.every(d => d.connected);
                const anyOffline = activeRoomDevices.some(d => !d.connected);
                const onlineInRoom = roomDevices.filter(d => d.connected).length;

                const roomId = 'room-' + roomName.replace(/\s+/g, '-');
                return `
                  <div class="room-group">
                    <div class="room-header collapsed" onclick="toggleRoom(event, this, '${roomId}')">
                      <div class="room-status ${anyOffline ? 'down' : 'up'}"></div>
                      <span class="room-name">${roomName}</span>
                      <span style="font-size: 11px; color: #64748B;">${onlineInRoom}/${roomDevices.length}</span>
                      <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="room-devices collapsed">
                      ${roomDevices.map(device => `
                        <div class="device-item clickable ${!device.connected ? 'down' : ''}" onclick="event.stopPropagation(); highlightDevice('${roomId}'); openAnalytics('${roomId}', '${roomName.replace(/'/g, "\\'")}', 'polyLens', true)">
                          <div class="device-status-dot ${device.connected ? 'up' : 'down'}"></div>
                          <div class="device-info">
                            <div class="device-name">${device.name}</div>
                            <div class="device-meta">
                              <span class="device-model">${device.hardwareModel || 'Unknown'}</span>
                              <span>${device.ip || 'No IP'}</span>
                            </div>
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      // Calculate total stats across all floors
      const totalStats = { online: 0, offline: 0, polyOnline: 0, polyTotal: 0 };
      floors.forEach(floor => {
        const fd = uptimeKumaData[floor] || { accessPoints: [], printers: [] };
        const pf = polyLensData[floor] || [];
        Object.values(fd).forEach(cat => {
          if (Array.isArray(cat)) {
            cat.forEach(d => {
              if (d.status === 'up') totalStats.online++;
              else if (d.status === 'down') totalStats.offline++;
            });
          }
        });
        totalStats.polyOnline += pf.filter(d => d.connected).length;
        totalStats.polyTotal += pf.length;
      });
      const healthPercent = totalStats.online + totalStats.offline > 0
        ? Math.round((totalStats.online / (totalStats.online + totalStats.offline)) * 100)
        : 100;

      // Render the page with new professional 3-column layout
      document.getElementById('app').innerHTML = `
        <div class="app-container">
          <!-- HEADER -->
          <header class="header">
            <div class="header-left">
              <div class="logo">
                <span class="logo-icon">üè¢</span>
                <span class="logo-text">Office Monitor</span>
                <span class="logo-badge">v2</span>
              </div>

              <div class="status-bar">
                <div class="status-metric" onclick="showStatusDetail('online')" title="Click for details">
                  <span class="status-dot online"></span>
                  <span class="status-value">${totalStats.online}</span>
                  <span class="status-label">Online</span>
                </div>
                <div class="status-metric" onclick="showStatusDetail('offline')" title="Click for details">
                  <span class="status-dot ${totalStats.offline > 0 ? 'offline' : 'online'}"></span>
                  <span class="status-value">${totalStats.offline}</span>
                  <span class="status-label">Offline</span>
                </div>
                <div class="status-metric" onclick="showStatusDetail('poly')" title="Click for details">
                  <span class="status-dot online"></span>
                  <span class="status-value">${totalStats.polyOnline}</span>
                  <span class="status-label">Zoom</span>
                </div>

                <div class="health-bar-container" title="System Health: ${healthPercent}%">
                  <div class="health-bar">
                    <div class="health-bar-fill" style="width: ${healthPercent}%; background: ${healthPercent >= 90 ? 'var(--status-online)' : healthPercent >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'};"></div>
                  </div>
                  <span class="health-percent" style="color: ${healthPercent >= 90 ? 'var(--status-online)' : healthPercent >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'};">${healthPercent}%</span>
                </div>
              </div>
            </div>

            <div class="header-right">
              <!-- Global Search -->
              <div class="global-search">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search devices..." id="global-search" oninput="handleSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                <div class="search-results" id="search-results" onmousedown="event.preventDefault()"></div>
              </div>

              <!-- Notification Center -->
              <button class="notification-btn" onclick="toggleNotifications()" title="Notifications">
                üîî
                <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
              </button>

              <div class="time-display">
                <span class="time-value">${now}</span>
                <div class="live-indicator">
                  <span class="live-dot"></span>
                  <span>${wsConnected ? 'Live' : 'Polling'}</span>
                </div>
              </div>

              <div class="header-actions">
                <button class="panel-toggle" onclick="toggleLeftPanel()" title="Toggle sidebar (S)">
                  ${leftPanelCollapsed ? '‚ñ∂' : '‚óÄ'}
                </button>
                <button class="compact-toggle ${compactMode ? 'active' : ''}" onclick="toggleCompactMode()" title="Compact mode (C)">
                  ${compactMode ? '‚ñ¢' : '‚ñ£'}
                </button>
                <button class="compact-toggle ${alertSoundsEnabled ? 'active' : ''}" onclick="toggleAlertSounds()" title="Alert sounds">
                  ${alertSoundsEnabled ? 'üîî' : 'üîï'}
                </button>
                ${editMode ? `
                  <button class="header-btn primary" onclick="savePositionChanges()">
                    üíæ Save${getPendingCount() > 0 ? ` (${getPendingCount()})` : ''}
                  </button>
                  <button class="header-btn" onclick="cancelPositionChanges()" style="border-color: var(--status-offline);">
                    ‚úï Cancel
                  </button>
                ` : `
                  <button class="header-btn" onclick="toggleEditMode()">‚úèÔ∏è Edit</button>
                `}
                <button class="header-btn" onclick="openCustomizeModal()" title="Customize Dashboard">
                  üé®
                </button>
                <button class="header-btn" onclick="window.location.href='reports.html'" title="Uptime Reports">
                  üìä
                </button>
                <button class="header-btn" onclick="window.location.href='topology.html'" title="Network Topology">
                  üîó
                </button>
                <button class="header-btn" onclick="window.location.href='settings.html'" title="Settings">
                  ‚öôÔ∏è${isAdmin() && pendingChangesCount > 0 ? `<span class="pending-badge">${pendingChangesCount}</span>` : ''}
                </button>
              </div>

              <div class="user-menu" onclick="toggleUserMenu()">
                <div class="user-avatar">${(currentUser?.username || 'G')[0].toUpperCase()}</div>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <span class="user-name">${currentUser?.username || 'Guest'}</span>
                  <span class="user-role">${currentUser?.role === 'admin' ? 'Admin' : 'User'}</span>
                </div>
              </div>
            </div>
          </header>

          <!-- NOTIFICATION PANEL -->
          <div class="notification-panel" id="notification-panel">
            <div class="notification-header">
              <span class="notification-title">üîî Notifications</span>
              <span class="notification-clear" onclick="clearNotifications()">Clear all</span>
            </div>
            <div class="notification-list" id="notification-list">
              <div class="notification-empty">No notifications yet</div>
            </div>
          </div>

          <!-- MAIN CONTENT - 3 Column Layout -->
          <div class="main-content ${editMode ? 'edit-mode' : ''} ${leftPanelCollapsed ? 'left-collapsed' : ''}">

            <!-- LEFT PANEL - Floor Navigation -->
            <aside class="left-panel">
              <div class="panel-header">
                <h2 class="panel-title">Floors</h2>
              </div>
              <nav class="floor-nav">
                ${floors.map(floor => {
                  const floorData = uptimeKumaData[floor] || { accessPoints: [], printers: [] };
                  const polyFloor = polyLensData[floor] || [];
                  const counts = getStatusCounts(floorData, polyFloor);
                  const deviceCount = counts.total + polyFloor.length;
                  const issueCount = counts.down + polyFloor.filter(d => !d.connected).length;
                  const isActive = floor === activeFloor;

                  return `
                    <div class="floor-item ${isActive ? 'active' : ''} ${issueCount > 0 ? 'has-issues' : ''}"
                         onclick="setFloor('${floor}')">
                      <div class="floor-icon">${isActive ? '‚ñ∂' : 'üè¢'}</div>
                      <div class="floor-info">
                        <div class="floor-name">${floor}</div>
                        <div class="floor-stats">
                          <span>${deviceCount} devices</span>
                          <span class="floor-status ${issueCount > 0 ? 'issue' : 'ok'}">
                            ${issueCount > 0 ? `‚óè ${issueCount} issue${issueCount > 1 ? 's' : ''}` : '‚úì OK'}
                          </span>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </nav>

              <div class="quick-stats">
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Access Points</span>
                  <span class="quick-stat-value">${(currentFloorData.accessPoints || []).length}</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Printers</span>
                  <span class="quick-stat-value">${(currentFloorData.printers || []).length}</span>
                </div>
                <div class="quick-stat-item">
                  <span class="quick-stat-label">Zoom Rooms</span>
                  <span class="quick-stat-value">${currentPolyData.length}</span>
                </div>
              </div>
            </aside>

            <!-- CENTER - Floor Map (Hero) -->
            <main class="map-container">
              <div class="floor-label">${activeFloor}</div>

              <div class="floor-map" id="floor-map-container">
                ${floorPlans[activeFloor]?.image_data ? `
                  <img src="data:image/${floorPlans[activeFloor].image_type};base64,${floorPlans[activeFloor].image_data}"
                       class="floor-plan-bg-loader"
                       id="floor-plan-img"
                       onload="onFloorPlanLoaded(this)"
                       alt="" />
                  <div class="markers-overlay" id="markers-overlay">
                    ${renderZones(activeFloor)}
                    ${deviceMarkersHTML}
                  </div>
                ` : `
                  <div class="map-placeholder">
                    <div class="map-placeholder-icon">üó∫Ô∏è</div>
                    <div class="map-placeholder-title">No Floor Plan</div>
                    <div class="map-placeholder-subtitle">Upload a floor plan in Settings</div>
                  </div>
                `}
              </div>

              <div class="map-controls">
                <button class="map-control-btn" onclick="zoomIn()" title="Zoom In">+</button>
                <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
                <button class="map-control-btn" onclick="resetZoom()" title="Reset">‚ü≤</button>
                <button class="map-control-btn" onclick="toggleFullscreen()" title="Fullscreen">‚õ∂</button>
              </div>
            </main>

            <!-- RIGHT PANEL - Device List -->
            <aside class="right-panel">
              <div class="device-list-header">
                <h2 class="device-list-title">${activeFloor} Devices</h2>
                <div class="device-search">
                  <input type="text" placeholder="Search devices..." onkeyup="filterDevices(this.value)">
                </div>
              </div>

              <div class="device-list">
                ${sidebarHTML || `
                  <div style="text-align: center; padding: var(--space-xl); color: var(--text-muted);">
                    <div style="font-size: 2rem; margin-bottom: var(--space-sm);">üì≠</div>
                    <div>No devices found</div>
                  </div>
                `}
              </div>

              <!-- Status Summary -->
              <div class="status-summary">
                <div class="summary-title">Status Overview</div>
                <div class="summary-stats">
                  <div class="summary-stat green" onclick="showStatusDetail('online')">
                    <span class="stat-value">${totalStats.online}</span>
                    <span class="stat-label">Online</span>
                  </div>
                  <div class="summary-stat ${totalStats.offline > 0 ? 'red' : ''}" onclick="showStatusDetail('offline')">
                    <span class="stat-value">${totalStats.offline}</span>
                    <span class="stat-label">Offline</span>
                  </div>
                  <div class="summary-stat yellow" onclick="showLowTonerPrinters()">
                    <span class="stat-value" id="low-toner-count">${getLowTonerCount()}</span>
                    <span class="stat-label">Low Toner</span>
                  </div>
                  <div class="summary-stat blue" onclick="showHealthDetails()">
                    <span class="stat-value">${healthPercent}%</span>
                    <span class="stat-label">Health</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>

          <!-- FOOTER -->
          <footer class="footer">
            <div class="footer-left">
              <div class="legend">
                <div class="legend-item">
                  <span class="legend-dot ap"></span>
                  <span>Access Points</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot printer"></span>
                  <span>Printers</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot zoom"></span>
                  <span>Zoom Rooms</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot online"></span>
                  <span>Online</span>
                </div>
                <div class="legend-item">
                  <span class="legend-dot offline"></span>
                  <span>Offline</span>
                </div>
              </div>
            </div>

            <div class="footer-center">
              <!-- Event ticker can go here -->
            </div>

            <div class="footer-right">
              <div class="data-source" onclick="showDataSourceInfo('monitors')">
                <span style="color: ${apiStatus.uptimeKuma.connected ? 'var(--status-online)' : 'var(--status-offline)'};">‚óè</span>
                Monitors (${apiStatus.uptimeKuma.monitorCount})
              </div>
              <div class="data-source" onclick="showDataSourceInfo('polylens')">
                <span style="color: ${apiStatus.polyLens.configured ? 'var(--status-online)' : 'var(--status-offline)'};">‚óè</span>
                Poly Lens (${apiStatus.polyLens.deviceCount})
              </div>
            </div>
          </footer>
        </div>
      `;

      // Update markers overlay position after DOM update
      setTimeout(updateMarkersOverlay, 50);
    }

    function setFloor(floor) {
      // Clean up any active drag operation
      if (isDragging) {
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        isDragging = false;
        currentDragElement = null;
      }
      activeFloor = floor;
      render();
    }

    function toggleLeftPanel() {
      leftPanelCollapsed = !leftPanelCollapsed;
      localStorage.setItem('leftPanelCollapsed', leftPanelCollapsed);
      render();
      // Update overlay after panel animation completes
      setTimeout(updateMarkersOverlay, 350);
    }

    function toggleCompactMode() {
      compactMode = !compactMode;
      localStorage.setItem('compactMode', compactMode);
      document.body.classList.toggle('compact-mode', compactMode);
      render();
    }

    // Apply compact mode on load
    if (compactMode) {
      document.body.classList.add('compact-mode');
    }

    function toggleAlertSounds() {
      alertSoundsEnabled = !alertSoundsEnabled;
      localStorage.setItem('alertSoundsEnabled', alertSoundsEnabled);
      if (alertSoundsEnabled) {
        playAlertSound('enable'); // Play a soft sound to confirm enabled
      }
      render();
    }

    function playAlertSound(type = 'alert') {
      if (!alertSoundsEnabled && type !== 'enable') return;

      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();

        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);

        if (type === 'alert') {
          // Alert sound - two quick beeps
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
          gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);

          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.15);

          // Second beep
          setTimeout(() => {
            const osc2 = audioContext.createOscillator();
            const gain2 = audioContext.createGain();
            osc2.connect(gain2);
            gain2.connect(audioContext.destination);
            osc2.type = 'sine';
            osc2.frequency.setValueAtTime(600, audioContext.currentTime);
            gain2.gain.setValueAtTime(0.3, audioContext.currentTime);
            gain2.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            osc2.start(audioContext.currentTime);
            osc2.stop(audioContext.currentTime + 0.15);
          }, 200);
        } else if (type === 'enable') {
          // Soft confirmation sound
          oscillator.type = 'sine';
          oscillator.frequency.setValueAtTime(440, audioContext.currentTime);
          oscillator.frequency.setValueAtTime(550, audioContext.currentTime + 0.1);
          gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
          gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
          oscillator.start(audioContext.currentTime);
          oscillator.stop(audioContext.currentTime + 0.2);
        }
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    // ==================== DASHBOARD CUSTOMIZATION ====================
    const defaultDashboardConfig = {
      showLeftPanel: true,
      showRightPanel: true,
      showFooter: true,
      showAccessPoints: true,
      showPrinters: true,
      showZoomRooms: true,
      showOfflineOnly: false,
      animateStatus: true,
      showResponseTimes: true,
      refreshRate: 30000
    };

    let dashboardConfig = { ...defaultDashboardConfig };

    function loadDashboardConfig() {
      const saved = localStorage.getItem('dashboardConfig');
      if (saved) {
        try {
          dashboardConfig = { ...defaultDashboardConfig, ...JSON.parse(saved) };
        } catch (e) {
          dashboardConfig = { ...defaultDashboardConfig };
        }
      }
      applyDashboardConfig();
    }

    function saveDashboardConfig() {
      dashboardConfig = {
        showLeftPanel: document.getElementById('show-left-panel')?.checked ?? true,
        showRightPanel: document.getElementById('show-right-panel')?.checked ?? true,
        showFooter: document.getElementById('show-footer')?.checked ?? true,
        showAccessPoints: document.getElementById('show-access-points')?.checked ?? true,
        showPrinters: document.getElementById('show-printers')?.checked ?? true,
        showZoomRooms: document.getElementById('show-zoom-rooms')?.checked ?? true,
        showOfflineOnly: document.getElementById('show-offline-only')?.checked ?? false,
        animateStatus: document.getElementById('animate-status')?.checked ?? true,
        showResponseTimes: document.getElementById('show-response-times')?.checked ?? true,
        refreshRate: parseInt(document.getElementById('refresh-rate')?.value) || 30000
      };
      localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
      applyDashboardConfig();
      render();
    }

    function applyDashboardConfig() {
      // Apply panel visibility
      const leftPanel = document.querySelector('.left-panel');
      const rightPanel = document.querySelector('.right-panel');
      const footer = document.querySelector('.footer');

      if (leftPanel) leftPanel.style.display = dashboardConfig.showLeftPanel ? '' : 'none';
      if (rightPanel) rightPanel.style.display = dashboardConfig.showRightPanel ? '' : 'none';
      if (footer) footer.style.display = dashboardConfig.showFooter ? '' : 'none';

      // Apply animation class to body
      document.body.classList.toggle('animations-enabled', dashboardConfig.animateStatus);

      // Update refresh interval if changed
      if (window.refreshInterval) {
        clearInterval(window.refreshInterval);
      }
      window.refreshInterval = setInterval(() => {
        fetchAllData();
      }, dashboardConfig.refreshRate);
    }

    function openCustomizeModal() {
      const modal = document.getElementById('customize-modal');
      modal.style.display = 'flex';

      // Populate form with current values
      document.getElementById('show-left-panel').checked = dashboardConfig.showLeftPanel;
      document.getElementById('show-right-panel').checked = dashboardConfig.showRightPanel;
      document.getElementById('show-footer').checked = dashboardConfig.showFooter;
      document.getElementById('show-access-points').checked = dashboardConfig.showAccessPoints;
      document.getElementById('show-printers').checked = dashboardConfig.showPrinters;
      document.getElementById('show-zoom-rooms').checked = dashboardConfig.showZoomRooms;
      document.getElementById('show-offline-only').checked = dashboardConfig.showOfflineOnly;
      document.getElementById('animate-status').checked = dashboardConfig.animateStatus;
      document.getElementById('show-response-times').checked = dashboardConfig.showResponseTimes;
      document.getElementById('refresh-rate').value = dashboardConfig.refreshRate;
    }

    function closeCustomizeModal() {
      document.getElementById('customize-modal').style.display = 'none';
    }

    function exportDashboardConfig() {
      const config = {
        dashboardConfig: dashboardConfig,
        leftPanelCollapsed: leftPanelCollapsed,
        compactMode: compactMode,
        alertSoundsEnabled: alertSoundsEnabled,
        activeFloor: activeFloor,
        exportDate: new Date().toISOString(),
        version: '2.0'
      };
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `office-monitor-config-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Configuration exported!', 'success');
    }

    function importDashboardConfig(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const config = JSON.parse(e.target.result);
          if (config.dashboardConfig) {
            dashboardConfig = { ...defaultDashboardConfig, ...config.dashboardConfig };
            localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
          }
          if (config.leftPanelCollapsed !== undefined) {
            leftPanelCollapsed = config.leftPanelCollapsed;
            localStorage.setItem('leftPanelCollapsed', leftPanelCollapsed);
          }
          if (config.compactMode !== undefined) {
            compactMode = config.compactMode;
            localStorage.setItem('compactMode', compactMode);
          }
          if (config.alertSoundsEnabled !== undefined) {
            alertSoundsEnabled = config.alertSoundsEnabled;
            localStorage.setItem('alertSoundsEnabled', alertSoundsEnabled);
          }
          applyDashboardConfig();
          render();
          closeCustomizeModal();
          showToast('Configuration imported!', 'success');
        } catch (err) {
          showToast('Invalid config file', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function resetDashboardConfig() {
      if (!confirm('Reset all dashboard settings to defaults?')) return;
      dashboardConfig = { ...defaultDashboardConfig };
      localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
      applyDashboardConfig();
      openCustomizeModal(); // Refresh the modal
      render();
      showToast('Settings reset to defaults', 'success');
    }

    // Close modal on escape key or outside click
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeCustomizeModal();
      }
    });

    document.getElementById('customize-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'customize-modal') {
        closeCustomizeModal();
      }
    });

    function checkForStatusChanges() {
      let newOfflineDevices = [];

      // Check all floors for status changes
      Object.values(uptimeKumaData).forEach(floor => {
        ['accessPoints', 'printers'].forEach(type => {
          if (floor[type]) {
            floor[type].forEach(device => {
              const prevStatus = previousDeviceStatuses[device.id];
              const currentStatus = device.status;

              // Device went offline
              if (prevStatus === 'up' && currentStatus === 'down') {
                newOfflineDevices.push(device.name);
              }

              // Update stored status
              previousDeviceStatuses[device.id] = currentStatus;
            });
          }
        });
      });

      // Play alert if any device went offline
      if (newOfflineDevices.length > 0) {
        playAlertSound('alert');
        // Show notification
        if (Notification.permission === 'granted') {
          new Notification('Device Offline', {
            body: newOfflineDevices.join(', ') + ' went offline',
            icon: 'üî¥'
          });
        }
      }
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      const floors = Object.keys(uptimeKumaData).length > 0
        ? Object.keys(uptimeKumaData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      switch(e.key) {
        case '1': setFloor(floors[0] || '1st Floor'); break;
        case '2': setFloor(floors[1] || '2nd Floor'); break;
        case '3': setFloor(floors[2] || '3rd Floor'); break;
        case '4': case '5': setFloor(floors[3] || '5th Floor'); break;
        case 'e': case 'E':
          if (!e.metaKey && !e.ctrlKey) toggleEditMode();
          break;
        case 's': case 'S':
          if (!e.metaKey && !e.ctrlKey) toggleLeftPanel();
          break;
        case 'c': case 'C':
          if (!e.metaKey && !e.ctrlKey) toggleCompactMode();
          break;
      }
    });

    // ==================== DASHBOARD WIDGETS & NEW FEATURES ====================

    // Notifications storage
    let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    let notificationPanelOpen = false;

    // Get low toner printer count
    function getLowTonerCount() {
      let count = 0;
      Object.values(printerStatusData).forEach(ps => {
        if (ps?.toner) {
          const levels = [ps.toner.black, ps.toner.cyan, ps.toner.magenta, ps.toner.yellow];
          if (levels.some(l => l !== null && l < 20)) count++;
        }
      });
      return count;
    }

    // Show low toner printers modal
    function showLowTonerPrinters() {
      const lowToner = [];
      Object.entries(printerStatusData).forEach(([id, ps]) => {
        if (ps?.toner) {
          const low = [];
          if (ps.toner.black !== null && ps.toner.black < 20) low.push('Black: ' + ps.toner.black + '%');
          if (ps.toner.cyan !== null && ps.toner.cyan < 20) low.push('Cyan: ' + ps.toner.cyan + '%');
          if (ps.toner.magenta !== null && ps.toner.magenta < 20) low.push('Magenta: ' + ps.toner.magenta + '%');
          if (ps.toner.yellow !== null && ps.toner.yellow < 20) low.push('Yellow: ' + ps.toner.yellow + '%');
          if (low.length > 0) {
            // Find printer name
            let name = 'Printer ' + id;
            Object.values(uptimeKumaData).forEach(floor => {
              if (floor.printers) {
                const p = floor.printers.find(pr => pr.id == id);
                if (p) name = p.name;
              }
            });
            lowToner.push({ id, name, low });
          }
        }
      });

      showAlert(lowToner.length > 0
        ? 'Low Toner Printers:\\n' + lowToner.map(p => p.name + ': ' + p.low.join(', ')).join('\\n')
        : 'All printers have sufficient toner!', lowToner.length > 0 ? 'warning' : 'success');
    }

    // Show health details
    function showHealthDetails() {
      const total = totalStats.online + totalStats.offline;
      const health = total > 0 ? Math.round((totalStats.online / total) * 100) : 100;
      showAlert('Network Health: ' + health + '%\\n' + totalStats.online + ' online, ' + totalStats.offline + ' offline', 'info');
    }

    // ==================== GLOBAL SEARCH ====================
    let allSearchableDevices = [];

    function buildSearchIndex() {
      allSearchableDevices = [];
      Object.entries(uptimeKumaData).forEach(([floor, data]) => {
        if (data.accessPoints) {
          data.accessPoints.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Access Point' }));
        }
        if (data.printers) {
          data.printers.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Printer' }));
        }
      });
      Object.entries(polyLensData).forEach(([floor, devices]) => {
        devices.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Zoom Room', status: d.connected ? 'up' : 'down' }));
      });
    }

    function handleSearch(query) {
      if (!query || query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }

      buildSearchIndex();
      const q = query.toLowerCase();
      const results = allSearchableDevices.filter(d =>
        (d.name && d.name.toLowerCase().includes(q)) ||
        (d.ip && d.ip.toLowerCase().includes(q)) ||
        (d.hostname && d.hostname.toLowerCase().includes(q)) ||
        (d.floor && d.floor.toLowerCase().includes(q)) ||
        (d.type && d.type.toLowerCase().includes(q))
      ).slice(0, 10);

      const container = document.getElementById('search-results');
      if (results.length === 0) {
        container.innerHTML = '<div class="search-no-results">No devices found</div>';
      } else {
        container.innerHTML = results.map(d => `
          <div class="search-result-item" onclick="goToDevice('${d.id}', '${d.floor}', '${d.type}')">
            <div class="search-result-status ${d.status}"></div>
            <div class="search-result-info">
              <div class="search-result-name">${d.name}</div>
              <div class="search-result-meta">${d.type} ¬∑ ${d.floor} ¬∑ ${d.ip || 'No IP'}</div>
            </div>
          </div>
        `).join('');
      }
    }

    function showSearchResults() {
      document.getElementById('search-results').classList.add('active');
    }

    function hideSearchResults() {
      document.getElementById('search-results').classList.remove('active');
    }

    function goToDevice(id, floor, type) {
      setFloor(floor);
      setTimeout(() => {
        highlightDevice(id);
        const typeLower = type === 'Access Point' ? 'accessPoints' : type === 'Printer' ? 'printers' : 'polyLens';
        openAnalytics(id, '', typeLower);
      }, 300);
      hideSearchResults();
      document.getElementById('global-search').value = '';
    }

    // ==================== NOTIFICATION CENTER ====================
    function addNotification(type, message, deviceName = '') {
      const notification = {
        id: Date.now(),
        type,
        message,
        deviceName,
        time: new Date().toISOString(),
        read: false
      };
      notifications.unshift(notification);
      if (notifications.length > 50) notifications = notifications.slice(0, 50);
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      renderNotifications();
    }

    function updateNotificationBadge() {
      const unread = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notification-badge');
      if (badge) {
        if (unread > 0) {
          badge.textContent = unread > 99 ? '99+' : unread;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function toggleNotifications() {
      notificationPanelOpen = !notificationPanelOpen;
      const panel = document.getElementById('notification-panel');
      if (panel) {
        panel.classList.toggle('active', notificationPanelOpen);
        if (notificationPanelOpen) {
          notifications.forEach(n => n.read = true);
          localStorage.setItem('notifications', JSON.stringify(notifications));
          updateNotificationBadge();
        }
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notification-list');
      if (!list) return;

      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty">No notifications yet</div>';
        return;
      }

      list.innerHTML = notifications.slice(0, 20).map(n => {
        const icon = n.type === 'offline' ? 'üî¥' : n.type === 'online' ? 'üü¢' : '‚ö†Ô∏è';
        const iconClass = n.type === 'offline' ? 'offline' : n.type === 'online' ? 'online' : 'warning';
        const timeAgo = getTimeAgo(new Date(n.time));
        return `
          <div class="notification-item ${n.read ? '' : 'unread'}">
            <div class="notification-icon ${iconClass}">${icon}</div>
            <div class="notification-content">
              <div class="notification-text">${n.message}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function clearNotifications() {
      notifications = [];
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      renderNotifications();
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    // Close notification panel when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('notification-panel');
      const btn = document.querySelector('.notification-btn');
      if (panel && notificationPanelOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
        notificationPanelOpen = false;
        panel.classList.remove('active');
      }
    });

    // ==================== BULK ACTIONS ====================
    let bulkMode = false;

    function toggleBulkMode() {
      bulkMode = !bulkMode;
      selectedDevices.clear();
      document.body.classList.toggle('bulk-mode', bulkMode);
      render();
    }

    function toggleDeviceSelection(deviceId, event) {
      if (event) event.stopPropagation();
      if (selectedDevices.has(deviceId)) {
        selectedDevices.delete(deviceId);
      } else {
        selectedDevices.add(deviceId);
      }
      render();
    }

    function selectAllDevices() {
      buildSearchIndex();
      allSearchableDevices.forEach(d => selectedDevices.add(d.id));
      render();
    }

    function deselectAllDevices() {
      selectedDevices.clear();
      render();
    }

    async function bulkMoveToFloor(targetFloor) {
      for (const deviceId of selectedDevices) {
        try {
          await authFetch(API_URL + '/api/monitors/' + deviceId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ floor: targetFloor })
          });
        } catch (e) {
          console.error('Failed to move device ' + deviceId);
        }
      }
      showAlert('Moved ' + selectedDevices.size + ' devices to ' + targetFloor, 'success');
      selectedDevices.clear();
      bulkMode = false;
      await fetchData();
    }

    async function bulkDelete() {
      if (!confirm('Delete ' + selectedDevices.size + ' devices? This cannot be undone.')) return;
      for (const deviceId of selectedDevices) {
        try {
          await authFetch(API_URL + '/api/monitors/' + deviceId, { method: 'DELETE' });
        } catch (e) {
          console.error('Failed to delete device ' + deviceId);
        }
      }
      showAlert('Deleted ' + selectedDevices.size + ' devices', 'success');
      selectedDevices.clear();
      bulkMode = false;
      await fetchData();
    }

    // ==================== INCIDENT TIMELINE ====================
    let incidents = [];

    async function loadIncidents() {
      try {
        const response = await authFetch(API_URL + '/api/incidents');
        if (response.ok) {
          const data = await response.json();
          incidents = data.incidents || [];
          updateIncidentCount();
        }
      } catch (e) {
        console.error('Failed to load incidents:', e);
      }
    }

    function updateIncidentCount() {
      const today = new Date().toDateString();
      const todayIncidents = incidents.filter(i => new Date(i.started_at).toDateString() === today);
      const el = document.getElementById('incident-count');
      if (el) el.textContent = todayIncidents.length;
    }

    function showIncidentTimeline() {
      if (incidents.length === 0) {
        showAlert('No incidents recorded yet', 'info');
        return;
      }

      const html = incidents.slice(0, 10).map(i => {
        const duration = i.resolved_at
          ? Math.round((new Date(i.resolved_at) - new Date(i.started_at)) / 60000) + ' min'
          : 'Ongoing';
        return i.device_name + ' went ' + (i.type === 'down' ? 'offline' : 'online') +
          ' (' + new Date(i.started_at).toLocaleString() + ', ' + duration + ')';
      }).join('\\n');

      showAlert('Recent Incidents:\\n' + html, 'info');
    }

    // Record incident when device status changes
    function recordIncident(deviceId, deviceName, type) {
      const incident = {
        device_id: deviceId,
        device_name: deviceName,
        type: type,
        started_at: new Date().toISOString()
      };

      // Try to save to server
      authFetch(API_URL + '/api/incidents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(incident)
      }).catch(e => console.error('Failed to record incident:', e));

      // Add to local list
      incidents.unshift(incident);
      updateIncidentCount();

      // Add notification
      addNotification(type, deviceName + ' went ' + (type === 'down' ? 'offline' : 'online'), deviceName);
    }

    // ==================== ACTIVITY LOG ====================
    async function logActivity(action, details) {
      try {
        await authFetch(API_URL + '/api/activity-log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, details })
        });
      } catch (e) {
        console.error('Failed to log activity:', e);
      }
    }

    // ==================== HISTORICAL TRENDS ====================
    function renderTrendsChart(containerId, data) {
      const container = document.getElementById(containerId);
      if (!container || !data || data.length === 0) return;

      const maxVal = Math.max(...data.map(d => d.value), 1);
      const bars = data.map(d => {
        const height = Math.round((d.value / maxVal) * 100);
        const className = d.value >= 99 ? 'high' : d.value >= 90 ? 'medium' : 'low';
        return '<div class="trend-bar ' + className + '" style="height: ' + height + '%;" title="' + d.label + ': ' + d.value + '%"></div>';
      }).join('');

      container.innerHTML = `
        <div class="trends-bars">${bars}</div>
        <div class="trends-labels">
          <span>${data[0]?.label || ''}</span>
          <span>${data[data.length - 1]?.label || ''}</span>
        </div>
      `;
    }

    // Initialize notifications on load
    setTimeout(() => {
      updateNotificationBadge();
      renderNotifications();
      loadIncidents();
    }, 1000);

    // ==================== UI FEATURES ====================

    // Store floor plan dimensions for positioning calculations
    let floorPlanDimensions = {};

    // Called when floor plan image loads (from hidden img element)
    function onFloorPlanLoaded(img) {
      const floor = activeFloor;
      floorPlanDimensions[floor] = {
        width: img.naturalWidth,
        height: img.naturalHeight,
        aspectRatio: img.naturalWidth / img.naturalHeight
      };

      // Set background image on container
      const container = document.getElementById('floor-map-container');
      if (container) {
        container.style.backgroundImage = `url('${img.src}')`;
      }

      // Position the markers overlay
      updateMarkersOverlay();
    }

    // Update markers overlay to match actual floor plan image bounds
    function updateMarkersOverlay() {
      const container = document.getElementById('floor-map-container');
      const overlay = document.getElementById('markers-overlay');
      const dims = floorPlanDimensions[activeFloor];

      if (!container || !overlay || !dims) return;

      const containerRect = container.getBoundingClientRect();
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      const containerAspect = containerWidth / containerHeight;
      const imageAspect = dims.aspectRatio;

      let imageWidth, imageHeight, offsetX, offsetY;

      if (containerAspect > imageAspect) {
        // Container is wider - image is limited by height
        imageHeight = containerHeight;
        imageWidth = imageHeight * imageAspect;
        offsetX = (containerWidth - imageWidth) / 2;
        offsetY = 0;
      } else {
        // Container is taller - image is limited by width
        imageWidth = containerWidth;
        imageHeight = imageWidth / imageAspect;
        offsetX = 0;
        offsetY = (containerHeight - imageHeight) / 2;
      }

      // Position the overlay to exactly match the image bounds
      overlay.style.left = `${offsetX}px`;
      overlay.style.top = `${offsetY}px`;
      overlay.style.width = `${imageWidth}px`;
      overlay.style.height = `${imageHeight}px`;
    }

    // Update overlay on window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(updateMarkersOverlay, 50);
    });

    // Also update after render completes
    setTimeout(updateMarkersOverlay, 100);

    // Zoom/Pan for floor map
    let mapZoom = 1;
    let mapPanX = 0;
    let mapPanY = 0;

    function zoomIn() {
      mapZoom = Math.min(mapZoom * 1.2, 4);
      applyMapTransform();
    }

    function zoomOut() {
      mapZoom = Math.max(mapZoom / 1.2, 0.5);
      applyMapTransform();
    }

    function resetZoom() {
      mapZoom = 1;
      mapPanX = 0;
      mapPanY = 0;
      applyMapTransform();
    }

    function applyMapTransform() {
      const floorMap = document.querySelector('.floor-map');
      if (floorMap) {
        floorMap.style.transform = `scale(${mapZoom}) translate(${mapPanX}px, ${mapPanY}px)`;
      }
    }

    function toggleFullscreen() {
      const mapContainer = document.querySelector('.map-container');
      if (!mapContainer) return;

      if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    }

    // Device filter
    function filterDevices(query) {
      const items = document.querySelectorAll('.device-item, .room-group');
      const q = query.toLowerCase();

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(q) ? '' : 'none';
      });
    }

    // User menu
    function toggleUserMenu() {
      // Simple logout for now
      if (confirm('Logout?')) {
        logout();
      }
    }

    // Status detail modal
    function showStatusDetail(type) {
      const floors = Object.keys(uptimeKumaData).length > 0
        ? Object.keys(uptimeKumaData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      let devices = [];

      if (type === 'online' || type === 'offline') {
        const targetStatus = type === 'online' ? 'up' : 'down';
        floors.forEach(floor => {
          const fd = uptimeKumaData[floor] || {};
          Object.entries(fd).forEach(([catType, cat]) => {
            if (Array.isArray(cat)) {
              cat.forEach(d => {
                if (d.status === targetStatus) {
                  devices.push({ ...d, floor, type: catType });
                }
              });
            }
          });
        });
      } else if (type === 'poly') {
        floors.forEach(floor => {
          const pf = polyLensData[floor] || [];
          pf.forEach(d => {
            devices.push({ ...d, floor, type: 'polyLens' });
          });
        });
      }

      // Show modal with device list
      const modal = document.createElement('div');
      modal.className = 'modal-overlay open';
      modal.innerHTML = `
        <div class="modal">
          <div class="modal-header">
            <h2 class="modal-title">${type === 'online' ? '‚úÖ Online Devices' : type === 'offline' ? '‚ùå Offline Devices' : 'üìπ Zoom Devices'} (${devices.length})</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>
          <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
            ${devices.map(d => `
              <div class="device-item" style="margin-bottom: 8px;">
                <span class="device-status-dot ${d.status === 'up' || d.connected ? 'online' : 'offline'}"></span>
                <div class="device-info">
                  <div class="device-name">${d.name}</div>
                  <div class="device-meta">${d.floor} ‚Ä¢ ${d.ip || 'No IP'}</div>
                </div>
              </div>
            `).join('') || '<p style="color: var(--text-muted); text-align: center;">No devices found</p>'}
          </div>
        </div>
      `;
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      document.body.appendChild(modal);
    }

    // Data source info modal
    function showDataSourceInfo(source) {
      const info = source === 'monitors' ? {
        title: 'üìä Monitor Data Source',
        status: apiStatus.uptimeKuma.connected ? 'Connected' : 'Disconnected',
        statusColor: apiStatus.uptimeKuma.connected ? 'var(--status-online)' : 'var(--status-offline)',
        details: [
          { label: 'Source', value: 'Uptime Kuma' },
          { label: 'Endpoint', value: '/api/monitors/by-floor' },
          { label: 'Monitor Count', value: apiStatus.uptimeKuma.monitorCount },
          { label: 'Refresh Rate', value: '30 seconds' }
        ]
      } : {
        title: 'üìπ Poly Lens Data Source',
        status: apiStatus.polyLens.configured ? 'Connected' : 'Not Configured',
        statusColor: apiStatus.polyLens.configured ? 'var(--status-online)' : 'var(--status-warning)',
        details: [
          { label: 'Source', value: 'Poly Lens API' },
          { label: 'Endpoint', value: '/api/poly-lens/by-floor' },
          { label: 'Device Count', value: apiStatus.polyLens.deviceCount },
          { label: 'Refresh Rate', value: '30 seconds' }
        ]
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay open';
      modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
          <div class="modal-header">
            <h2 class="modal-title">${info.title}</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>
          <div class="modal-body">
            <div class="modal-section">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--space-md);">
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${info.statusColor};"></span>
                <span style="font-weight: 600;">${info.status}</span>
              </div>
              <div class="info-grid" style="display: grid; gap: var(--space-sm);">
                ${info.details.map(d => `
                  <div class="info-item" style="display: flex; justify-content: space-between; padding: var(--space-sm); background: var(--bg-elevated); border-radius: var(--radius-sm);">
                    <span style="color: var(--text-muted);">${d.label}</span>
                    <span style="font-weight: 500;">${d.value}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      document.body.appendChild(modal);
    }

    // ==================== END NEW FEATURES ====================

    // Render the main app (after login)
    async function renderApp() {
      if (!authToken || !currentUser) {
        renderLogin();
        return;
      }

      loadDashboardConfig(); // Load user's dashboard customization
      await fetchAllData();
      await fetchFloorPlans();
      await fetchCustomDeviceTypes();
      await initNewFeatures();
      if (isAdmin()) {
        await fetchPendingChangesCount();
      }
      render();
    }

    // Initial check
    async function init() {
      if (authToken && currentUser) {
        // Verify token is still valid
        try {
          const response = await authFetch(`${API_URL}/api/auth/me`);
          if (!response.ok) {
            // Token expired
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
          }
        } catch (e) {
          // Server unavailable, keep trying with stored credentials
        }
      }

      if (authToken && currentUser) {
        await renderApp();
      } else {
        renderLogin();
      }
    }
    init();

    // Auto-refresh every 30 seconds (only when logged in)
    setInterval(async () => {
      if (authToken && currentUser) {
        await fetchAllData();
        checkForStatusChanges(); // Check for offline alerts
        if (isAdmin()) {
          await fetchPendingChangesCount();
        }
        render();
      }
    }, 30000);

    // Request notification permission for alerts
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  </script>

  <!-- Admin Panel Overlay -->
  <div id="admin-overlay" class="admin-overlay" onclick="toggleAdmin()"></div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="admin-panel">
    <div class="admin-header">
      <h2 class="admin-title">‚öôÔ∏è Settings</h2>
      <button class="admin-close" onclick="toggleAdmin()">&times;</button>
    </div>
    <div id="admin-tabs-container" class="admin-tabs"></div>
    <div id="admin-content" class="admin-content"></div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>

  <!-- Dashboard Customize Modal -->
  <div id="customize-modal" class="customize-modal" style="display: none;">
    <div class="customize-modal-content">
      <div class="customize-modal-header">
        <h2>Customize Dashboard</h2>
        <button class="customize-close" onclick="closeCustomizeModal()">&times;</button>
      </div>
      <div class="customize-modal-body">
        <div class="customize-section">
          <h3>Visible Panels</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-left-panel" checked onchange="saveDashboardConfig()">
            <span>Left Panel (Quick Stats)</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-right-panel" checked onchange="saveDashboardConfig()">
            <span>Right Panel (Device List)</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-footer" checked onchange="saveDashboardConfig()">
            <span>Footer (Status Bar)</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Device Categories</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-access-points" checked onchange="saveDashboardConfig()">
            <span>Access Points</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-printers" checked onchange="saveDashboardConfig()">
            <span>Printers</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-zoom-rooms" checked onchange="saveDashboardConfig()">
            <span>Zoom Rooms</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Display Options</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-offline-only" onchange="saveDashboardConfig()">
            <span>Show Offline Devices Only</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="animate-status" checked onchange="saveDashboardConfig()">
            <span>Animated Status Indicators</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-response-times" checked onchange="saveDashboardConfig()">
            <span>Show Response Times</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Refresh Rate</h3>
          <select id="refresh-rate" class="customize-select" onchange="saveDashboardConfig()">
            <option value="10000">10 seconds</option>
            <option value="30000" selected>30 seconds</option>
            <option value="60000">1 minute</option>
            <option value="300000">5 minutes</option>
          </select>
        </div>
        <div class="customize-section">
          <h3>Backup & Restore</h3>
          <div class="customize-buttons">
            <button class="btn btn-secondary" onclick="exportDashboardConfig()">üì• Export Config</button>
            <button class="btn btn-secondary" onclick="document.getElementById('import-config-file').click()">üì§ Import Config</button>
            <input type="file" id="import-config-file" accept=".json" style="display:none" onchange="importDashboardConfig(event)">
          </div>
          <button class="btn btn-outline" onclick="resetDashboardConfig()" style="margin-top: 8px; width: 100%;">üîÑ Reset to Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Customize Modal Styles */
    .customize-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .customize-modal-content {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-default);
      width: 90%;
      max-width: 420px;
      max-height: 85vh;
      overflow: hidden;
      animation: scaleIn 0.2s ease;
    }
    .customize-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }
    .customize-modal-header h2 {
      font-size: var(--text-large);
      font-weight: 600;
      margin: 0;
    }
    .customize-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .customize-close:hover { color: var(--text-primary); }
    .customize-modal-body {
      padding: var(--space-md);
      overflow-y: auto;
      max-height: calc(85vh - 60px);
    }
    .customize-section {
      margin-bottom: var(--space-lg);
    }
    .customize-section h3 {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }
    .customize-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) 0;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .customize-toggle:hover { color: var(--text-primary); }
    .customize-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-blue);
    }
    .customize-select {
      width: 100%;
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: var(--text-body);
    }
    .customize-buttons {
      display: flex;
      gap: var(--space-sm);
    }
    .customize-buttons .btn { flex: 1; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--text-small);
    }
    .btn-outline:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }
  </style>

  <script>
    // Update admin tab styling
    function updateAdminTabs() {
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === adminTab);
      });
    }

    // Override setAdminTab to also update tab styling
    const originalSetAdminTab = setAdminTab;
    setAdminTab = function(tab) {
      adminTab = tab;
      updateAdminTabs();
      renderAdmin();
    };

    // Drag and drop functionality for edit mode
    let isDragging = false;
    let currentDragElement = null;
    let dragStartX = 0;
    let dragStartY = 0;
    let elementStartX = 0;
    let elementStartY = 0;
    let dragHasMovedBeyondThreshold = false;
    const DRAG_THRESHOLD_PX = 5; // Minimum pixels to move before considering it a drag

    function startDrag(e, element) {
      if (!editMode) return;
      e.preventDefault();

      isDragging = true;
      dragHasMovedBeyondThreshold = false;
      currentDragElement = element;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      elementStartX = parseFloat(element.style.left);
      elementStartY = parseFloat(element.style.top);

      element.style.zIndex = '1000';
      element.style.cursor = 'grabbing';

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', endDrag);
    }

    function onDrag(e) {
      if (!isDragging || !currentDragElement) return;

      // Check if we've moved beyond the threshold
      const distanceMoved = Math.sqrt(
        Math.pow(e.clientX - dragStartX, 2) + Math.pow(e.clientY - dragStartY, 2)
      );
      if (distanceMoved > DRAG_THRESHOLD_PX) {
        dragHasMovedBeyondThreshold = true;
      }

      const container = document.querySelector('.floor-map');
      const rect = container.getBoundingClientRect();

      const deltaX = ((e.clientX - dragStartX) / rect.width) * 100;
      const deltaY = ((e.clientY - dragStartY) / rect.height) * 100;

      let newX = elementStartX + deltaX;
      let newY = elementStartY + deltaY;

      // Constrain to container bounds
      newX = Math.max(0, Math.min(100, newX));
      newY = Math.max(0, Math.min(100, newY));

      currentDragElement.style.left = `${newX}%`;
      currentDragElement.style.top = `${newY}%`;
    }

    function endDrag(e) {
      if (!isDragging || !currentDragElement) return;

      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', endDrag);

      const deviceId = currentDragElement.dataset.id;
      const newX = parseFloat(currentDragElement.style.left);
      const newY = parseFloat(currentDragElement.style.top);

      currentDragElement.style.zIndex = '';
      currentDragElement.style.cursor = '';

      // Only store position if we actually dragged (moved beyond threshold)
      if (deviceId && dragHasMovedBeyondThreshold) {
        const isRoom = deviceId.startsWith('room-');
        pendingPositions[deviceId] = { x: newX, y: newY, isRoom, floor: activeFloor };
        console.log(`Position queued for ${isRoom ? 'room' : 'device'} ${deviceId}: ${newX}%, ${newY}%`);
        // Update the save button count
        updateEditModeButtons();
      } else if (!dragHasMovedBeyondThreshold) {
        // Reset position if it was just a click (not a real drag)
        currentDragElement.style.left = `${elementStartX}%`;
        currentDragElement.style.top = `${elementStartY}%`;
      }

      isDragging = false;
      dragHasMovedBeyondThreshold = false;
      currentDragElement = null;
    }

    function updateEditModeButtons() {
      const countEl = document.getElementById('pending-count');
      if (countEl) {
        const count = getPendingCount();
        countEl.textContent = count > 0 ? ` (${count})` : '';
      }
    }

    // Toggle category collapse (Access Points, Printers, Zoom Rooms)
    function toggleCategory(header) {
      header.classList.toggle('collapsed');
      const content = header.nextElementSibling;
      if (content) {
        content.classList.toggle('collapsed');
      }
    }

    // Toggle room collapse and optionally highlight on map
    function toggleRoom(event, header, roomId) {
      event.stopPropagation();

      // If clicking on the room name area, open analytics
      const clickedOnName = event.target.classList.contains('room-name') ||
                           event.target.classList.contains('room-status');

      if (clickedOnName) {
        // Get the room name from the header
        const roomNameEl = header.querySelector('.room-name');
        const roomName = roomNameEl ? roomNameEl.textContent : roomId.replace('room-', '').replace(/-/g, ' ');
        highlightDevice(roomId);
        openAnalytics(roomId, roomName, 'polyLens', true);
      } else {
        // Toggle collapse
        header.classList.toggle('collapsed');
        const devices = header.nextElementSibling;
        if (devices) {
          devices.classList.toggle('collapsed');
        }
      }
    }

    // Highlight device on map when clicked from sidebar
    function highlightDevice(deviceId) {
      // Remove previous highlight
      document.querySelectorAll('.device-marker.highlighted').forEach(el => {
        el.classList.remove('highlighted');
      });

      // Find and highlight the marker
      const marker = document.querySelector(`.device-marker[data-id="${deviceId}"]`);
      if (marker) {
        marker.classList.add('highlighted');

        // Scroll the marker into view
        marker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        // Remove highlight after 5 seconds
        setTimeout(() => {
          marker.classList.remove('highlighted');
        }, 5000);
      } else {
        console.log('Device not found on map:', deviceId);
      }
    }

    // ==================== BULK IMPORT ====================
    function openBulkImportModal() {
      bulkImportData = [];
      bulkImportModalOpen = true;
      renderBulkImportModal();
    }

    function closeBulkImportModal() {
      bulkImportModalOpen = false;
      bulkImportData = [];
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderBulkImportModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeBulkImportModal()">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title">Bulk Import Devices</h3>
              <button class="admin-close" onclick="closeBulkImportModal()">&times;</button>
            </div>
            ${bulkImportData.length === 0 ? `
              <div class="import-dropzone" id="import-dropzone"
                ondragover="event.preventDefault(); this.classList.add('dragover')"
                ondragleave="this.classList.remove('dragover')"
                ondrop="handleImportDrop(event)"
                onclick="document.getElementById('import-file-input').click()">
                <div class="import-icon">üìÅ</div>
                <div class="import-title">Drop CSV file here or click to browse</div>
                <div class="import-subtitle">CSV format: name, hostname, floor, type</div>
              </div>
              <input type="file" id="import-file-input" accept=".csv" style="display: none" onchange="handleImportFile(this.files[0])">
              <div style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="downloadImportTemplate()">üì• Download Template</button>
              </div>
            ` : `
              <div class="import-stats">
                <div class="import-stat">
                  <div class="import-stat-value">${bulkImportData.length}</div>
                  <div class="import-stat-label">Devices</div>
                </div>
                <div class="import-stat">
                  <div class="import-stat-value">${new Set(bulkImportData.map(d => d.floor)).size}</div>
                  <div class="import-stat-label">Floors</div>
                </div>
              </div>
              <div class="import-preview">
                <table class="import-preview-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Hostname/URL</th>
                      <th>Floor</th>
                      <th>Type</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${bulkImportData.map(d => `
                      <tr>
                        <td>${d.name}</td>
                        <td>${d.hostname || d.url || '-'}</td>
                        <td>${d.floor}</td>
                        <td>${d.device_type || d.type}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="submitBulkImport()">üì• Import ${bulkImportData.length} Devices</button>
                <button class="btn btn-secondary" onclick="bulkImportData = []; renderBulkImportModal()">Clear</button>
                <button class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function handleImportDrop(event) {
      event.preventDefault();
      event.target.classList.remove('dragover');
      const file = event.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        handleImportFile(file);
      }
    }

    function handleImportFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const csv = e.target.result;
        const lines = csv.split('\\n').filter(l => l.trim());
        const headers = lines[0].toLowerCase().split(',').map(h => h.trim());

        bulkImportData = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const device = {};
          headers.forEach((h, i) => {
            device[h] = values[i] || '';
          });
          return {
            name: device.name || '',
            hostname: device.hostname || device.ip || '',
            url: device.url || '',
            floor: device.floor || '1st Floor',
            type: device.type === 'http' ? 'http' : 'ping',
            device_type: device.device_type || device.category || 'accessPoints',
            notes: device.notes || ''
          };
        }).filter(d => d.name);

        renderBulkImportModal();
      };
      reader.readAsText(file);
    }

    function downloadImportTemplate() {
      const template = 'name,hostname,floor,device_type,notes\\nAP-Floor1-001,192.168.1.10,1st Floor,accessPoints,Main lobby AP\\nPrinter-HR,192.168.1.20,2nd Floor,printers,HR department printer';
      const blob = new Blob([template], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'device_import_template.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function submitBulkImport() {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ devices: bulkImportData })
        });
        const data = await response.json();
        if (data.success) {
          showAlert(`Successfully imported ${data.imported} devices`, 'success');
          closeBulkImportModal();
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
        } else {
          showAlert('Import failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Import error: ' + e.message, 'error');
      }
    }

    // ==================== DEVICE TEMPLATES ====================
    async function fetchDeviceTemplates() {
      try {
        const response = await fetch(`${API_URL}/api/device-templates`);
        if (response.ok) {
          const data = await response.json();
          deviceTemplates = data.templates || [];
        }
      } catch (e) {
        console.error('Failed to fetch device templates:', e);
      }
    }

    function applyTemplate(template) {
      if (!editingMonitor) return;
      editingMonitor.type = template.type || 'ping';
      editingMonitor.device_type = template.device_type || 'accessPoints';
      editingMonitor.interval = template.default_interval || 30;
      renderModal();
    }

    // ==================== SAVED FILTERS ====================
    async function fetchSavedFilters() {
      try {
        const response = await authFetch(`${API_URL}/api/saved-filters`);
        if (response.ok) {
          const data = await response.json();
          savedFilters = data.filters || [];
        }
      } catch (e) {
        console.error('Failed to fetch saved filters:', e);
      }
    }

    async function saveCurrentFilter() {
      const name = prompt('Enter filter name:');
      if (!name) return;

      const filterConfig = {
        search: deviceFilter,
        floor: activeFloor
      };

      try {
        const response = await authFetch(`${API_URL}/api/saved-filters`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, filter_config: JSON.stringify(filterConfig) })
        });
        if (response.ok) {
          await fetchSavedFilters();
          showAlert('Filter saved!', 'success');
        }
      } catch (e) {
        showAlert('Failed to save filter', 'error');
      }
    }

    function applySavedFilter(filterId) {
      const filter = savedFilters.find(f => f.id == filterId);
      if (!filter) return;

      const config = JSON.parse(filter.filter_config);
      deviceFilter = config.search || '';
      if (config.floor) activeFloor = config.floor;
      activeFilter = filterId;
      renderAdmin();
      render();
    }

    async function deleteSavedFilter(id) {
      if (!confirm('Delete this filter?')) return;
      try {
        await authFetch(`${API_URL}/api/saved-filters/${id}`, { method: 'DELETE' });
        await fetchSavedFilters();
        renderAdmin();
      } catch (e) {
        showAlert('Failed to delete filter', 'error');
      }
    }

    // ==================== BULK ACTIONS ====================
    function toggleBulkSelectMode() {
      bulkSelectMode = !bulkSelectMode;
      if (!bulkSelectMode) {
        selectedDevices.clear();
      }
      renderAdmin();
    }

    function toggleDeviceSelection(id) {
      if (selectedDevices.has(id)) {
        selectedDevices.delete(id);
      } else {
        selectedDevices.add(id);
      }
      renderAdmin();
    }

    function selectAllDevices() {
      const filteredMonitors = allMonitors.filter(m =>
        !deviceFilter || m.name.toLowerCase().includes(deviceFilter.toLowerCase()) ||
        (m.hostname && m.hostname.includes(deviceFilter))
      );
      filteredMonitors.forEach(m => selectedDevices.add(m.id));
      renderAdmin();
    }

    function deselectAllDevices() {
      selectedDevices.clear();
      renderAdmin();
    }

    async function bulkAction(action) {
      if (selectedDevices.size === 0) {
        showAlert('No devices selected', 'error');
        return;
      }

      const ids = Array.from(selectedDevices);
      let data = {};

      if (action === 'move_floor') {
        const floor = prompt('Enter target floor (e.g., "2nd Floor"):');
        if (!floor) return;
        data.floor = floor;
      } else if (action === 'set_interval') {
        const interval = prompt('Enter check interval in seconds:');
        if (!interval || isNaN(interval)) return;
        data.interval = parseInt(interval);
      } else if (action === 'delete') {
        if (!confirm(`Delete ${ids.length} devices? This cannot be undone.`)) return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ids, data })
        });
        const result = await response.json();
        if (result.success) {
          showAlert(`Action completed: ${result.affected} devices affected`, 'success');
          selectedDevices.clear();
          bulkSelectMode = false;
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
          render();
        } else {
          showAlert('Action failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Action error: ' + e.message, 'error');
      }
    }

    // ==================== FLOOR ZONES ====================
    async function fetchFloorZones() {
      try {
        const response = await fetch(`${API_URL}/api/floor-zones`);
        if (response.ok) {
          const data = await response.json();
          floorZones = {};
          (data.zones || []).forEach(zone => {
            if (!floorZones[zone.floor]) floorZones[zone.floor] = [];
            floorZones[zone.floor].push(zone);
          });
        }
      } catch (e) {
        console.error('Failed to fetch floor zones:', e);
      }
    }

    function renderZones(floor) {
      const zones = floorZones[floor] || [];
      if (zones.length === 0) return '';

      return `
        <svg class="zone-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
          ${zones.map(zone => {
            const points = JSON.parse(zone.points || '[]');
            if (points.length < 3) return '';
            const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
            const centerX = points.reduce((s, p) => s + p.x, 0) / points.length;
            const centerY = points.reduce((s, p) => s + p.y, 0) / points.length;
            return `
              <polygon class="zone-polygon" points="${pointsStr}" fill="${zone.color}" stroke="${zone.color}" />
              <text class="zone-label" x="${centerX}" y="${centerY}">${zone.name}</text>
            `;
          }).join('')}
        </svg>
      `;
    }

    // ==================== HEALTH SCORES ====================
    function getHealthColor(score) {
      if (score >= 90) return '#22C55E';
      if (score >= 70) return '#60A5FA';
      if (score >= 50) return '#F59E0B';
      return '#EF4444';
    }

    function getHealthLabel(score) {
      if (score >= 90) return 'Excellent';
      if (score >= 70) return 'Good';
      if (score >= 50) return 'Fair';
      return 'Poor';
    }

    function getHealthClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 70) return 'good';
      if (score >= 50) return 'fair';
      return 'poor';
    }

    function renderHealthBadge(score) {
      if (score === null || score === undefined) return '';
      return `
        <span class="health-badge ${getHealthClass(score)}">
          ‚ù§Ô∏è ${score}%
        </span>
      `;
    }

    // Render printer consumables for analytics panel
    function renderPrinterConsumables(deviceId) {
      const ps = printerStatusData[deviceId];
      if (!ps) return '';

      const toner = ps.toner || {};
      const paper = ps.paper || {};
      const info = ps.info || {};
      const error = ps.error || {};

      const colors = ['black', 'cyan', 'magenta', 'yellow'];
      const colorLabels = {black: 'K', cyan: 'C', magenta: 'M', yellow: 'Y'};
      const colorGradients = {
        black: 'linear-gradient(to top, #1a1a1a, #404040)',
        cyan: 'linear-gradient(to top, #0891B2, #22D3EE)',
        magenta: 'linear-gradient(to top, #BE185D, #F472B6)',
        yellow: 'linear-gradient(to top, #CA8A04, #FDE047)'
      };
      const glowColors = {
        black: 'rgba(100, 100, 100, 0.3)',
        cyan: 'rgba(6, 182, 212, 0.5)',
        magenta: 'rgba(236, 72, 153, 0.5)',
        yellow: 'rgba(234, 179, 8, 0.5)'
      };

      // Error section (show first if there are errors)
      let errorHTML = '';
      if (error.state && error.state !== 'idle' && error.state !== 'printing') {
        errorHTML = '<div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(185, 28, 28, 0.1) 100%); border: 1px solid var(--status-offline); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
          '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">' +
            '<span style="font-size: 20px;">‚ö†Ô∏è</span>' +
            '<span style="font-size: 14px; font-weight: 700; color: var(--status-offline); text-transform: uppercase;">' + (error.state || 'Error') + '</span>' +
          '</div>' +
          (error.description ? '<div style="font-size: 13px; color: var(--text-secondary); padding-left: 30px;">' + error.description + '</div>' : '') +
        '</div>';
      }

      // Toner cartridges
      let tonerHTML = colors.map(color => {
        const level = toner[color];
        if (level === null || level === undefined) return '';
        const isLow = level < 20;
        return '<div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px; background: var(--bg-base); border-radius: 8px;' + (isLow ? ' border: 2px solid var(--status-offline);' : '') + '">' +
          '<div style="font-size: 18px; font-weight: 700; color: ' + (isLow ? 'var(--status-offline)' : 'var(--text-primary)') + ';">' + level + '%</div>' +
          '<div style="width: 32px; height: 50px; background: var(--bg-overlay); border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--border-subtle);">' +
            '<div style="position: absolute; bottom: 0; left: 0; right: 0; height: ' + level + '%; background: ' + colorGradients[color] + '; border-radius: 4px; box-shadow: 0 0 8px ' + glowColors[color] + ';"></div>' +
          '</div>' +
          '<div style="font-size: 10px; font-weight: 600; color: var(--text-muted);">' + colorLabels[color] + '</div>' +
        '</div>';
      }).join('');

      // Waste toner
      let wasteHTML = '';
      if (toner.waste !== null && toner.waste !== undefined) {
        const wasteHigh = toner.waste > 80;
        wasteHTML = '<div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px; background: var(--bg-base); border-radius: 8px;' + (wasteHigh ? ' border: 2px solid var(--status-warning);' : '') + '">' +
          '<div style="font-size: 18px; font-weight: 700; color: ' + (wasteHigh ? 'var(--status-warning)' : 'var(--text-primary)') + ';">' + toner.waste + '%</div>' +
          '<div style="width: 32px; height: 50px; background: var(--bg-overlay); border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--border-subtle);">' +
            '<div style="position: absolute; bottom: 0; left: 0; right: 0; height: ' + toner.waste + '%; background: linear-gradient(to top, #6B7280, #9CA3AF); border-radius: 4px;"></div>' +
          '</div>' +
          '<div style="font-size: 10px; font-weight: 600; color: var(--text-muted);">WASTE</div>' +
        '</div>';
      }

      // Paper level
      let paperHTML = '';
      if (paper.level !== null && paper.level !== undefined) {
        const paperColor = paper.level < 10 ? '#EF4444' : paper.level < 20 ? '#F59E0B' : '#10B981';
        paperHTML = '<div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--bg-base); border-radius: 8px;">' +
          '<span style="font-size: 20px;">üìÑ</span>' +
          '<div style="flex: 1;">' +
            '<div style="height: 8px; background: var(--bg-overlay); border-radius: 4px; overflow: hidden;">' +
              '<div style="height: 100%; width: ' + (paper.level || 0) + '%; background: ' + paperColor + '; border-radius: 4px;"></div>' +
            '</div>' +
          '</div>' +
          '<span style="font-size: 14px; font-weight: 700; color: var(--text-primary);">' + (paper.level || 0) + '%</span>' +
        '</div>';
      }

      // Page count
      let pageCountHTML = '';
      if (info.pageCount) {
        pageCountHTML = '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-base); border-radius: 8px;">' +
          '<span style="font-size: 12px; color: var(--text-muted);">üìä Pages Printed</span>' +
          '<span style="font-size: 16px; font-weight: 700; color: var(--accent-blue);">' + info.pageCount.toLocaleString() + '</span>' +
        '</div>';
      }

      return '<div class="analytics-section">' +
        '<div class="analytics-section-title" style="display: flex; justify-content: space-between; align-items: center;">' +
          '<span>üñ®Ô∏è Printer Status</span>' +
          '<button onclick="refreshPrinterStatus(' + deviceId + ')" style="padding: 4px 10px; background: var(--bg-overlay); border: none; border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer;">‚Üª Refresh</button>' +
        '</div>' +
        '<div style="background: var(--bg-elevated); border-radius: 10px; padding: 14px; border: 1px solid var(--border-subtle);">' +
          errorHTML +
          '<div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">' +
            tonerHTML +
            wasteHTML +
          '</div>' +
          '<div style="display: flex; flex-direction: column; gap: 8px;">' +
            paperHTML +
            pageCountHTML +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Device status history storage (populated from heartbeats)
    let deviceHistoryCache = {};

    function renderSparkline(deviceId) {
      // Generate a simple sparkline based on recent heartbeat data
      // For now, we'll show a placeholder that will be populated when analytics are opened
      const history = deviceHistoryCache[deviceId] || [];

      if (history.length === 0) {
        // Generate placeholder sparkline (last 24 data points)
        return `
          <div class="sparkline-container">
            <div class="sparkline-label">24h Status</div>
            <div class="sparkline" style="opacity: 0.3;">
              ${Array(24).fill(0).map(() => '<div class="sparkline-bar unknown" style="height: 100%;"></div>').join('')}
            </div>
            <div class="sparkline-legend">
              <span>24h ago</span>
              <span>Now</span>
            </div>
          </div>
        `;
      }

      // Render actual sparkline from history
      const bars = history.slice(-24).map(h => {
        const status = h.status === 1 ? 'up' : 'down';
        return `<div class="sparkline-bar ${status}" style="height: 100%;"></div>`;
      }).join('');

      return `
        <div class="sparkline-container">
          <div class="sparkline-label">24h Status</div>
          <div class="sparkline">${bars}</div>
          <div class="sparkline-legend">
            <span>24h ago</span>
            <span>Now</span>
          </div>
        </div>
      `;
    }

    // ==================== AUTO-DISCOVERY ====================
    function openDiscoveryModal() {
      discoveryModalOpen = true;
      discoveryResults = [];
      discoveryScanning = false;
      discoveryProgress = 0;
      renderDiscoveryModal();
    }

    function closeDiscoveryModal() {
      discoveryModalOpen = false;
      discoveryResults = [];
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderDiscoveryModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeDiscoveryModal()">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3 class="modal-title">Auto-Discover Devices</h3>
              <button class="admin-close" onclick="closeDiscoveryModal()">&times;</button>
            </div>
            <div class="discovery-form">
              <div class="form-group">
                <label class="form-label">Subnet</label>
                <input type="text" class="form-input" id="discovery-subnet" value="192.168.1" placeholder="192.168.1">
              </div>
              <div class="form-group">
                <label class="form-label">IP Range</label>
                <div class="discovery-range">
                  <input type="number" class="form-input" id="discovery-start" value="1" min="1" max="254">
                  <span style="color: #64748B;">to</span>
                  <input type="number" class="form-input" id="discovery-end" value="254" min="1" max="254">
                </div>
              </div>
              <button class="btn btn-primary" onclick="startDiscovery()" ${discoveryScanning ? 'disabled' : ''}>
                ${discoveryScanning ? 'üîÑ Scanning...' : 'üîç Start Scan'}
              </button>
            </div>
            ${discoveryScanning ? `
              <div class="discovery-progress">
                <div class="discovery-progress-bar">
                  <div class="discovery-progress-fill" style="width: ${discoveryProgress}%"></div>
                </div>
                <div class="discovery-status">Scanning... ${discoveryProgress}%</div>
              </div>
            ` : ''}
            ${discoveryResults.length > 0 ? `
              <div class="admin-section">
                <h4 class="admin-section-title">Discovered Devices (${discoveryResults.filter(d => !d.existing).length} new)</h4>
                <div class="discovery-results">
                  ${discoveryResults.map((d, i) => `
                    <div class="discovery-device ${d.existing ? 'existing' : ''}">
                      <input type="checkbox" class="discovery-checkbox" id="disc-${i}"
                        ${d.selected ? 'checked' : ''} ${d.existing ? 'disabled' : ''}
                        onchange="toggleDiscoveryDevice(${i})">
                      <div class="discovery-info">
                        <div class="discovery-ip">${d.ip}</div>
                        <div class="discovery-hostname">${d.hostname || 'Unknown hostname'} ${d.existing ? '(Already monitored)' : ''}</div>
                      </div>
                      <div class="discovery-ping">${d.ping}ms</div>
                    </div>
                  `).join('')}
                </div>
                <div class="btn-group" style="margin-top: 16px;">
                  <button class="btn btn-primary" onclick="addDiscoveredDevices()">
                    ‚ûï Add ${discoveryResults.filter(d => d.selected && !d.existing).length} Devices
                  </button>
                  <button class="btn btn-secondary" onclick="selectAllDiscovered()">Select All New</button>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    async function startDiscovery() {
      const subnet = document.getElementById('discovery-subnet').value || '192.168.1';
      const startIp = parseInt(document.getElementById('discovery-start').value) || 1;
      const endIp = parseInt(document.getElementById('discovery-end').value) || 254;

      discoveryScanning = true;
      discoveryProgress = 0;
      discoveryResults = [];
      renderDiscoveryModal();

      // Simulate progress while waiting
      const progressInterval = setInterval(() => {
        if (discoveryProgress < 90) {
          discoveryProgress += 5;
          renderDiscoveryModal();
        }
      }, 500);

      try {
        const response = await authFetch(`${API_URL}/api/auto-discover`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subnet, startIp, endIp })
        });
        const data = await response.json();

        clearInterval(progressInterval);
        discoveryScanning = false;
        discoveryProgress = 100;

        if (data.success) {
          discoveryResults = (data.discovered || []).map(d => ({
            ...d,
            selected: !d.existing
          }));
          showAlert(`Found ${data.discovered.length} devices (${data.existing} already monitored)`, 'success');
        } else {
          showAlert('Discovery failed: ' + (data.error || 'Unknown error'), 'error');
        }
        renderDiscoveryModal();
      } catch (e) {
        clearInterval(progressInterval);
        discoveryScanning = false;
        showAlert('Discovery error: ' + e.message, 'error');
        renderDiscoveryModal();
      }
    }

    function toggleDiscoveryDevice(index) {
      discoveryResults[index].selected = !discoveryResults[index].selected;
      renderDiscoveryModal();
    }

    function selectAllDiscovered() {
      discoveryResults.forEach(d => {
        if (!d.existing) d.selected = true;
      });
      renderDiscoveryModal();
    }

    async function addDiscoveredDevices() {
      const devicesToAdd = discoveryResults
        .filter(d => d.selected && !d.existing)
        .map(d => ({
          name: d.hostname || `Device-${d.ip.split('.').pop()}`,
          hostname: d.ip,
          type: 'ping',
          floor: '1st Floor',
          device_type: 'accessPoints'
        }));

      if (devicesToAdd.length === 0) {
        showAlert('No devices selected', 'error');
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ devices: devicesToAdd })
        });
        const data = await response.json();
        if (data.success) {
          showAlert(`Added ${data.imported} devices`, 'success');
          closeDiscoveryModal();
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
        }
      } catch (e) {
        showAlert('Failed to add devices: ' + e.message, 'error');
      }
    }

    // ==================== CONTEXT MENU ====================
    function showContextMenu(event, device, source = 'monitor') {
      event.preventDefault();
      event.stopPropagation();
      contextMenu = { open: true, x: event.clientX, y: event.clientY, device, source };
      renderContextMenu();
    }

    function hideContextMenu() {
      contextMenu.open = false;
      const menu = document.getElementById('context-menu');
      if (menu) menu.remove();
    }

    function renderContextMenu() {
      hideContextMenu();
      if (!contextMenu.open) return;

      const menu = document.createElement('div');
      menu.id = 'context-menu';
      menu.className = 'context-menu';
      menu.style.left = `${contextMenu.x}px`;
      menu.style.top = `${contextMenu.y}px`;

      const device = contextMenu.device;
      const isPrinter = device.device_type === 'printers';
      menu.innerHTML = `
        <div class="context-menu-item" onclick="pingDevice('${device.hostname || device.ip}'); hideContextMenu();">
          üì° Ping Device
        </div>
        <div class="context-menu-item" onclick="refreshDeviceStatus(${device.id}); hideContextMenu();">
          üîÑ Refresh Status
        </div>
        <div class="context-menu-item" onclick="copyToClipboard('${device.hostname || device.ip}'); hideContextMenu();">
          üìã Copy IP/Hostname
        </div>
        ${device.url ? `
          <div class="context-menu-item" onclick="window.open('${device.url}', '_blank'); hideContextMenu();">
            üåê Open Web Interface
          </div>
        ` : ''}
        ${isPrinter ? `
          <div class="context-menu-item" onclick="refreshPrinterStatus(${device.id}); hideContextMenu();">
            üñ®Ô∏è Refresh Toner
          </div>
        ` : ''}
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="openAnalytics(${device.id}, '${device.name}', '${device.device_type}'); hideContextMenu();">
          üìä View Analytics
        </div>
        <div class="context-menu-item" onclick="highlightDevice('${device.id}'); hideContextMenu();">
          üìç Locate on Map
        </div>
        <div class="context-menu-item" onclick="quickAddNote(${device.id}, '${device.name.replace(/'/g, "\\'")}'); hideContextMenu();">
          üìù Add Note
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="toggleMaintenance(${device.id}); hideContextMenu();">
          üîß ${device.maintenance ? 'End Maintenance' : 'Set Maintenance'}
        </div>
        <div class="context-menu-item" onclick="quickMoveFloor(${device.id}, '${device.name.replace(/'/g, "\\'")}'); hideContextMenu();">
          üè¢ Move to Floor
        </div>
        <div class="context-menu-item" onclick="openEditModal(${JSON.stringify(device).replace(/"/g, '&quot;')}); hideContextMenu();">
          ‚úèÔ∏è Edit Device
        </div>
        <div class="context-menu-item" onclick="toggleDisabled(${device.id}, ${device.disabled ? 'false' : 'true'}); hideContextMenu();">
          ${device.disabled ? '‚úÖ Enable Device' : 'üö´ Disable (Non-serviceable)'}
        </div>
        <div class="context-menu-item danger" onclick="deleteMonitor(${device.id}); hideContextMenu();">
          üóëÔ∏è Delete Device
        </div>
      `;

      document.body.appendChild(menu);

      // Adjust position if menu goes off screen
      const rect = menu.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        menu.style.left = `${window.innerWidth - rect.width - 10}px`;
      }
      if (rect.bottom > window.innerHeight) {
        menu.style.top = `${window.innerHeight - rect.height - 10}px`;
      }
    }

    async function pingDevice(host) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/ping/${encodeURIComponent(host)}`);
        const data = await response.json();
        if (data.success && data.alive) {
          showAlert(`${host} is reachable (${data.time}ms)`, 'success');
        } else {
          showAlert(`${host} is not reachable`, 'error');
        }
      } catch (e) {
        showAlert('Ping failed: ' + e.message, 'error');
      }
    }

    async function refreshDeviceStatus(id) {
      showAlert('Refreshing device status...', 'success');
      try {
        await fetchAllData();
        render();
        showAlert('Status refreshed', 'success');
      } catch (e) {
        showAlert('Refresh failed: ' + e.message, 'error');
      }
    }

    async function refreshPrinterStatus(id) {
      showAlert('Refreshing printer status...', 'success');
      try {
        const response = await authFetch(`${API_URL}/api/printers/${id}/refresh`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          // Refresh printer data
          const statusResponse = await fetch(`${API_URL}/api/printers/${id}/status`);
          const statusData = await statusResponse.json();
          if (statusData.success && statusData.status) {
            printerStatusData[id] = statusData.status;
          }
          render();
          showAlert('Printer status refreshed', 'success');
        } else {
          showAlert('Refresh failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Refresh failed: ' + e.message, 'error');
      }
    }

    function quickAddNote(id, name) {
      const note = prompt(`Add note for ${name}:`);
      if (note === null) return;

      authFetch(`${API_URL}/api/monitors/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: note })
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert('Note added', 'success');
            fetchAllData().then(() => render());
          } else {
            showAlert('Failed to add note', 'error');
          }
        });
    }

    function quickMoveFloor(id, name) {
      const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];
      const floor = prompt(`Move ${name} to floor:\n${floors.map((f, i) => `${i+1}. ${f}`).join('\n')}\n\nEnter floor name or number:`);
      if (!floor) return;

      let targetFloor = floor;
      const num = parseInt(floor);
      if (!isNaN(num) && num >= 1 && num <= floors.length) {
        targetFloor = floors[num - 1];
      }

      authFetch(`${API_URL}/api/monitors/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ floor: targetFloor })
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert(`Moved to ${targetFloor}`, 'success');
            fetchAllData().then(() => render());
          } else {
            showAlert('Failed to move device', 'error');
          }
        });
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      showAlert('Copied to clipboard!', 'success');
    }

    async function toggleMaintenance(id) {
      try {
        const monitor = allMonitors.find(m => m.id === id);
        const newState = monitor ? !monitor.maintenance : false;

        const response = await authFetch(`${API_URL}/api/monitors/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...monitor, maintenance: newState ? 1 : 0 })
        });

        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          render();
          showAlert(newState ? 'Maintenance mode enabled' : 'Maintenance mode disabled', 'success');
        }
      } catch (e) {
        showAlert('Failed to toggle maintenance', 'error');
      }
    }

    async function toggleDisabled(id, disabled) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/disable`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ disabled })
        });

        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          render();
          showAlert(disabled ? 'Device disabled (non-serviceable)' : 'Device enabled', 'success');
        }
      } catch (e) {
        showAlert('Failed to toggle device status', 'error');
      }
    }

    // Wrapper functions for analytics panel buttons
    async function toggleMaintenanceFromAnalytics(id) {
      await toggleMaintenance(id);
      // Refresh analytics panel
      if (analyticsDevice && analyticsDevice.id === id) {
        analyticsData = await fetchAnalyticsData(id, analyticsDevice.isRoom, analyticsDevice.name, analyticsDevice.isPolyDevice, analyticsDevice.polyDeviceData);
        renderAnalyticsSidebar(false);
      }
    }

    async function toggleDisabledFromAnalytics(id, disabled) {
      await toggleDisabled(id, disabled);
      // Refresh analytics panel
      if (analyticsDevice && analyticsDevice.id === id) {
        analyticsData = await fetchAnalyticsData(id, analyticsDevice.isRoom, analyticsDevice.name, analyticsDevice.isPolyDevice, analyticsDevice.polyDeviceData);
        renderAnalyticsSidebar(false);
      }
    }

    // Toggle disabled state for a Poly device
    async function togglePolyDeviceDisabled(deviceId, disabled) {
      try {
        const response = await fetch(`${API_URL}/api/poly-devices/${deviceId}/disable`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ disabled })
        });
        const data = await response.json();
        if (data.success) {
          // Update local poly data
          Object.values(polyLensData).forEach(floorDevices => {
            const device = floorDevices.find(d => d.id === deviceId);
            if (device) {
              device.disabled = data.disabled;
            }
          });
          // Refresh the room analytics if viewing a room
          if (analyticsDevice && analyticsDevice.isRoom) {
            analyticsData = await fetchAnalyticsData(analyticsDevice.id, true, analyticsDevice.name, false, null);
            renderAnalyticsSidebar(false);
          }
          render();
        }
      } catch (e) {
        console.error('Error toggling poly device disabled state:', e);
      }
    }

    // Close context menu when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.context-menu')) {
        hideContextMenu();
      }
    });

    // ==================== UPTIME CHARTS ====================
    function renderUptimeChart(heartbeats, hours = 24) {
      if (!heartbeats || heartbeats.length === 0) {
        return '<div class="uptime-chart"><p style="text-align: center; color: #64748B;">No data available</p></div>';
      }

      // Group heartbeats by hour
      const now = new Date();
      const hourBuckets = [];
      for (let i = hours - 1; i >= 0; i--) {
        const hourStart = new Date(now.getTime() - (i + 1) * 60 * 60 * 1000);
        const hourEnd = new Date(now.getTime() - i * 60 * 60 * 1000);

        const bucketHeartbeats = heartbeats.filter(h => {
          const hTime = new Date(h.timestamp);
          return hTime >= hourStart && hTime < hourEnd;
        });

        const upCount = bucketHeartbeats.filter(h => h.status === 'up').length;
        const total = bucketHeartbeats.length;
        const uptime = total > 0 ? (upCount / total) * 100 : 100;

        hourBuckets.push({ hour: hourStart.getHours(), uptime, total });
      }

      return `
        <div class="uptime-chart">
          <div class="uptime-chart-bars">
            ${hourBuckets.map(b => {
              let barClass = 'up';
              if (b.uptime < 100 && b.uptime >= 50) barClass = 'partial';
              if (b.uptime < 50) barClass = 'down';
              if (b.total === 0) barClass = 'up'; // No data = assume up
              return `<div class="uptime-chart-bar ${barClass}" style="height: ${Math.max(b.uptime, 5)}%"
                title="${b.hour}:00 - ${b.uptime.toFixed(1)}% uptime"></div>`;
            }).join('')}
          </div>
          <div class="uptime-chart-labels">
            <span>${hours}h ago</span>
            <span>Now</span>
          </div>
        </div>
      `;
    }

    // ==================== INITIALIZE NEW FEATURES ====================
    async function initNewFeatures() {
      await Promise.all([
        fetchDeviceTemplates(),
        fetchSavedFilters(),
        fetchFloorZones()
      ]);
      connectWebSocket();
    }

    // ==================== WEBSOCKET ====================
    function connectWebSocket() {
      if (ws) {
        ws.close();
      }

      const wsUrl = API_URL.replace('http', 'ws');
      try {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
          console.log('WebSocket connected');
          wsConnected = true;
          render();
        };

        ws.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
          } catch (e) {
            console.error('WebSocket message parse error:', e);
          }
        };

        ws.onclose = () => {
          console.log('WebSocket disconnected');
          wsConnected = false;
          render();
          // Reconnect after 5 seconds
          if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
          wsReconnectTimer = setTimeout(connectWebSocket, 5000);
        };

        ws.onerror = (error) => {
          console.error('WebSocket error:', error);
        };
      } catch (e) {
        console.error('WebSocket connection failed:', e);
      }
    }

    function handleWebSocketMessage(message) {
      switch (message.type) {
        case 'status_update':
          // Update device status in real-time
          const data = message.data;
          if (data && data.deviceId) {
            // Find and update the device in our data
            Object.keys(uptimeKumaData).forEach(floor => {
              ['accessPoints', 'printers'].forEach(type => {
                const devices = uptimeKumaData[floor]?.[type] || [];
                const device = devices.find(d => d.id == data.deviceId);
                if (device) {
                  device.status = data.status;
                }
              });
            });
            render();
          }
          break;
        case 'notification':
          // Add notification to the list
          if (message.data) {
            notifications.unshift(message.data);
            unreadNotifications++;
            render();
          }
          break;
        case 'incident':
          // Refresh data when incident occurs
          fetchAllData().then(() => render());
          break;
        case 'connected':
          console.log('WebSocket:', message.message);
          break;
      }
    }

    // Clean up WebSocket on page unload
    window.addEventListener('beforeunload', () => {
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (ws) {
        ws.close();
        ws = null;
      }
    });

    // ==================== WIDGETS ====================
    function renderWidgets() {
      // Calculate stats
      let totalDevices = 0;
      let onlineDevices = 0;
      let offlineDevices = 0;

      Object.values(uptimeKumaData).forEach(floor => {
        ['accessPoints', 'printers'].forEach(type => {
          const devices = floor[type] || [];
          devices.forEach(d => {
            totalDevices++;
            if (d.status === 'up') onlineDevices++;
            else if (d.status === 'down') offlineDevices++;
          });
        });
      });

      const onlinePercent = totalDevices > 0 ? Math.round((onlineDevices / totalDevices) * 100) : 0;
      const offlinePercent = 100 - onlinePercent;

      // Count Poly Lens devices
      let polyTotal = 0;
      let polyOnline = 0;
      Object.values(polyLensData).forEach(devices => {
        devices.forEach(d => {
          polyTotal++;
          if (d.connected) polyOnline++;
        });
      });

      // Count floors with issues
      const floorsWithIssues = Object.keys(uptimeKumaData).filter(floor => {
        const floorData = uptimeKumaData[floor];
        return ['accessPoints', 'printers'].some(type =>
          (floorData[type] || []).some(d => d.status === 'down')
        );
      }).length;

      return `
        <div class="widgets-section">
          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Status Overview</span>
              <span class="widget-icon">üìä</span>
            </div>
            <div class="widget-content">
              <div class="pie-chart" style="background: conic-gradient(#22C55E 0% ${onlinePercent}%, #EF4444 ${onlinePercent}% 100%);">
                <div class="pie-chart-center">${onlinePercent}%</div>
              </div>
              <div class="widget-stats">
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Online</span>
                  <span class="widget-stat-value green">${onlineDevices}</span>
                </div>
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Offline</span>
                  <span class="widget-stat-value red">${offlineDevices}</span>
                </div>
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Total</span>
                  <span class="widget-stat-value">${totalDevices}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Quick Stats</span>
              <span class="widget-icon">‚ö°</span>
            </div>
            <div class="widget-content" style="flex-direction: column; gap: 8px;">
              <div class="widget-stat-row">
                <span class="widget-stat-label">Floors Monitored</span>
                <span class="widget-stat-value">${Object.keys(uptimeKumaData).length}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Floors with Issues</span>
                <span class="widget-stat-value ${floorsWithIssues > 0 ? 'red' : 'green'}">${floorsWithIssues}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Zoom Rooms</span>
                <span class="widget-stat-value">${polyTotal}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Zoom Online</span>
                <span class="widget-stat-value ${polyOnline === polyTotal ? 'green' : 'yellow'}">${polyOnline}/${polyTotal}</span>
              </div>
            </div>
          </div>

          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Connection Status</span>
              <span class="widget-icon">${wsConnected ? 'üü¢' : 'üî¥'}</span>
            </div>
            <div class="widget-content" style="flex-direction: column; gap: 8px;">
              <div class="widget-stat-row">
                <span class="widget-stat-label">WebSocket</span>
                <span class="widget-stat-value ${wsConnected ? 'green' : 'red'}">${wsConnected ? 'Connected' : 'Disconnected'}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">API Status</span>
                <span class="widget-stat-value ${apiStatus.uptimeKuma.connected ? 'green' : 'red'}">${apiStatus.uptimeKuma.connected ? 'Online' : 'Offline'}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Poly Lens</span>
                <span class="widget-stat-value ${apiStatus.polyLens.configured ? 'green' : 'yellow'}">${apiStatus.polyLens.configured ? 'Connected' : 'Not Configured'}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Smart popup positioning - show below if not enough space above
    document.addEventListener('mouseenter', function(e) {
      const marker = e.target.closest('.device-marker');
      if (!marker) return;

      const popup = marker.querySelector('.device-popup');
      if (!popup) return;

      // Reset position first
      popup.classList.remove('below');

      // Get container bounds
      const container = marker.closest('.floor-map');
      if (!container) return;

      const containerRect = container.getBoundingClientRect();
      const markerRect = marker.getBoundingClientRect();

      // Calculate space above marker relative to container top
      const spaceAbove = markerRect.top - containerRect.top;
      const popupHeight = 250; // Approximate popup height

      // If not enough space above, show below
      if (spaceAbove < popupHeight) {
        popup.classList.add('below');
      }
    }, true);
  </script>
</body>
</html>

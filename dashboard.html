<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Office Infrastructure Monitor v2</title>

  <!-- PWA Meta Tags -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0F172A">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Office Monitor">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%230F172A' width='100' height='100' rx='20'/><text x='50' y='65' font-size='50' text-anchor='middle'>üè¢</text></svg>">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="application-name" content="Office Monitor">
  <meta name="msapplication-TileColor" content="#0F172A">
  <meta name="msapplication-tap-highlight" content="no">

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    /* ==================== DESIGN SYSTEM ==================== */
    :root {
      /* Background Layers */
      --bg-base: #0A0F1A;
      --bg-surface: #111827;
      --bg-elevated: #1F2937;
      --bg-overlay: #374151;
      --bg-glass: rgba(17, 24, 39, 0.8);

      /* Status Colors */
      --status-online: #10B981;
      --status-online-bg: rgba(16, 185, 129, 0.15);
      --status-offline: #EF4444;
      --status-offline-bg: rgba(239, 68, 68, 0.15);
      --status-warning: #F59E0B;
      --status-warning-bg: rgba(245, 158, 11, 0.15);
      --status-info: #3B82F6;
      --status-info-bg: rgba(59, 130, 246, 0.15);

      /* Text */
      --text-primary: #F9FAFB;
      --text-secondary: #9CA3AF;
      --text-muted: #6B7280;

      /* Accents */
      --accent-blue: #3B82F6;
      --accent-purple: #8B5CF6;
      --accent-cyan: #06B6D4;
      --accent-emerald: #10B981;

      /* Borders */
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.1);
      --border-strong: rgba(255, 255, 255, 0.2);

      /* Typography - Responsive */
      --text-hero: clamp(2.5rem, 4vw, 4rem);
      --text-display: clamp(1.75rem, 3vw, 2.5rem);
      --text-title: clamp(1.25rem, 2vw, 1.5rem);
      --text-large: clamp(1rem, 1.5vw, 1.25rem);
      --text-body: clamp(0.875rem, 1.2vw, 1rem);
      --text-small: clamp(0.75rem, 1vw, 0.875rem);
      --text-tiny: clamp(0.625rem, 0.8vw, 0.75rem);

      /* Spacing - Responsive */
      --space-xs: clamp(4px, 0.5vw, 8px);
      --space-sm: clamp(8px, 1vw, 12px);
      --space-md: clamp(12px, 1.5vw, 20px);
      --space-lg: clamp(20px, 2.5vw, 32px);
      --space-xl: clamp(32px, 4vw, 48px);

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.5);
      --shadow-glow-green: 0 0 20px rgba(16, 185, 129, 0.4);
      --shadow-glow-red: 0 0 20px rgba(239, 68, 68, 0.4);
      --shadow-glow-blue: 0 0 20px rgba(59, 130, 246, 0.4);

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 250ms ease;
      --transition-slow: 400ms ease;

      /* Border Radius */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      --radius-full: 9999px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    html {
      font-size: 16px;
    }

    @media (min-width: 1920px) {
      html { font-size: 18px; }
    }

    @media (min-width: 2560px) {
      html { font-size: 20px; }
    }

    body {
      min-height: 100vh;
      background: var(--bg-base);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      line-height: 1.5;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ==================== ANIMATIONS ==================== */
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    @keyframes ping {
      0% { transform: scale(1); opacity: 0.8; }
      100% { transform: scale(2.5); opacity: 0; }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 5px currentColor; }
      50% { box-shadow: 0 0 20px currentColor, 0 0 30px currentColor; }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes scaleIn {
      from { transform: scale(0.95); opacity: 0; }
      to { transform: scale(1); opacity: 1; }
    }

    @keyframes float {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-4px); }
    }

    @keyframes ticker {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Enhanced Status Animations */
    @keyframes statusPulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    @keyframes statusRipple {
      0% { box-shadow: 0 0 0 0 currentColor; }
      70% { box-shadow: 0 0 0 8px transparent; }
      100% { box-shadow: 0 0 0 0 transparent; }
    }

    @keyframes breathe {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.98); }
    }

    @keyframes onlineGlow {
      0%, 100% { box-shadow: 0 0 4px var(--status-online), 0 0 8px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 0 8px var(--status-online), 0 0 16px rgba(16, 185, 129, 0.5); }
    }

    @keyframes offlineAlert {
      0%, 100% { box-shadow: 0 0 4px var(--status-offline); }
      25% { box-shadow: 0 0 12px var(--status-offline), 0 0 20px rgba(239, 68, 68, 0.4); }
      75% { box-shadow: 0 0 8px var(--status-offline); }
    }

    @keyframes dataRefresh {
      0% { opacity: 0.5; }
      50% { opacity: 1; }
      100% { opacity: 0.5; }
    }

    /* Penguin Loading Animation */
    @keyframes penguinWalk {
      0%, 100% { transform: translateY(0) rotate(-5deg); }
      25% { transform: translateY(-8px) rotate(5deg); }
      50% { transform: translateY(0) rotate(-5deg); }
      75% { transform: translateY(-8px) rotate(5deg); }
    }

    @keyframes hammerSwing {
      0%, 100% { transform: rotate(-20deg); }
      50% { transform: rotate(20deg); }
    }

    @keyframes nailBounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-3px); }
    }

    /* Floor Transition Animation */
    @keyframes floorFadeIn {
      from { opacity: 0; transform: scale(0.98); }
      to { opacity: 1; transform: scale(1); }
    }

    @keyframes floorSlideIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Connection Status Pulse */
    @keyframes connectionPulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    @keyframes reconnectSpin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* Penguin Loading Container */
    .penguin-loader {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 20px;
      gap: 20px;
    }

    .penguin-scene {
      position: relative;
      width: 120px;
      height: 100px;
    }

    .penguin {
      font-size: 48px;
      position: absolute;
      left: 50%;
      bottom: 0;
      transform: translateX(-50%);
      animation: penguinWalk 0.6s ease-in-out infinite;
    }

    .hammer {
      font-size: 24px;
      position: absolute;
      right: 15px;
      top: 10px;
      transform-origin: bottom right;
      animation: hammerSwing 0.3s ease-in-out infinite;
    }

    .nails {
      position: absolute;
      bottom: 5px;
      left: 10px;
      display: flex;
      gap: 4px;
    }

    .nail {
      font-size: 14px;
      animation: nailBounce 0.4s ease-in-out infinite;
    }

    .nail:nth-child(2) { animation-delay: 0.1s; }
    .nail:nth-child(3) { animation-delay: 0.2s; }

    .penguin-text {
      color: var(--text-secondary);
      font-size: 14px;
      text-align: center;
    }

    .penguin-subtext {
      color: var(--text-muted);
      font-size: 12px;
    }

    /* Floor Content Transitions */
    .floor-content {
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    .floor-content.transitioning {
      opacity: 0;
      transform: scale(0.98);
    }

    .floor-content.entering {
      animation: floorFadeIn 0.4s ease forwards;
    }

    /* Connection Status Indicator */
    .connection-status {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .connection-status.connected {
      background: var(--status-online-bg);
      color: var(--status-online);
    }

    .connection-status.disconnected {
      background: var(--status-offline-bg);
      color: var(--status-offline);
      animation: connectionPulse 1.5s ease-in-out infinite;
    }

    .connection-status.reconnecting {
      background: var(--status-warning-bg);
      color: var(--status-warning);
    }

    .connection-status .status-icon {
      font-size: 10px;
    }

    .connection-status.reconnecting .status-icon {
      animation: reconnectSpin 1s linear infinite;
    }

    /* Quick Filters */
    .quick-filters {
      display: flex;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      flex-wrap: wrap;
    }

    .filter-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: 11px;
      font-weight: 500;
      border: 1px solid var(--border-default);
      background: var(--bg-elevated);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .filter-btn:hover {
      border-color: var(--accent-blue);
      color: var(--text-primary);
    }

    .filter-btn.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    .filter-btn .filter-count {
      background: rgba(255,255,255,0.2);
      padding: 1px 5px;
      border-radius: 8px;
      font-size: 10px;
    }

    .filter-btn.active .filter-count {
      background: rgba(255,255,255,0.3);
    }

    /* Last Updated Timestamp */
    .last-updated {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
      color: var(--text-muted);
      padding: 4px 8px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
    }

    .last-updated .refresh-icon {
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .last-updated .refresh-icon:hover {
      transform: rotate(180deg);
    }

    .last-updated .refresh-icon.spinning {
      animation: reconnectSpin 1s linear infinite;
    }

    /* Floor Health Indicator */
    .floor-health {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      margin-top: 2px;
    }

    .floor-health-bar {
      width: 40px;
      height: 4px;
      background: var(--bg-overlay);
      border-radius: 2px;
      overflow: hidden;
    }

    .floor-health-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s ease;
    }

    .floor-health-score {
      font-weight: 600;
      min-width: 28px;
    }

    /* Device Tags */
    .device-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .device-tag {
      display: inline-flex;
      align-items: center;
      gap: 3px;
      padding: 2px 6px;
      background: var(--bg-overlay);
      border-radius: 10px;
      font-size: 9px;
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .device-tag.editable {
      cursor: pointer;
    }

    .device-tag.editable:hover {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    .device-tag .tag-remove {
      cursor: pointer;
      opacity: 0.6;
      margin-left: 2px;
    }

    .device-tag .tag-remove:hover {
      opacity: 1;
    }

    .tag-input {
      padding: 2px 6px;
      font-size: 9px;
      border: 1px solid var(--accent-blue);
      border-radius: 10px;
      background: var(--bg-surface);
      color: var(--text-primary);
      outline: none;
      width: 60px;
    }

    /* Utilization Chart */
    .utilization-bar {
      display: flex;
      height: 20px;
      gap: 1px;
      border-radius: 4px;
      overflow: hidden;
      background: var(--bg-overlay);
    }

    .utilization-segment {
      flex: 1;
      transition: background 0.2s ease;
    }

    .utilization-legend {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Mobile Responsiveness */
    @media (max-width: 768px) {
      .header {
        flex-direction: column;
        gap: 8px;
        padding: 8px;
      }

      .header-left, .header-right {
        width: 100%;
        justify-content: space-between;
      }

      .status-bar {
        flex-wrap: wrap;
        gap: 8px;
      }

      .global-search {
        width: 100%;
        max-width: none;
      }

      .header-actions {
        flex-wrap: wrap;
        justify-content: center;
      }

      .left-panel {
        position: fixed;
        left: -280px;
        top: 60px;
        bottom: 0;
        width: 280px;
        z-index: 100;
        transition: left 0.3s ease;
        background: var(--bg-surface);
        border-right: 1px solid var(--border-default);
      }

      .left-panel.mobile-open {
        left: 0;
      }

      .right-sidebar {
        position: fixed;
        right: -320px;
        top: 60px;
        bottom: 0;
        width: 320px;
        z-index: 100;
        transition: right 0.3s ease;
      }

      .right-sidebar.mobile-open {
        right: 0;
      }

      .map-container {
        padding: 8px;
      }

      .floor-label {
        font-size: 14px;
        padding: 4px 8px;
      }

      .device-popup {
        max-width: 200px;
        font-size: 10px;
      }

      .analytics-sidebar {
        width: 100%;
        max-width: 100%;
      }

      .quick-filters {
        flex-wrap: nowrap;
        overflow-x: auto;
        padding: 8px;
        -webkit-overflow-scrolling: touch;
      }

      .filter-btn {
        flex-shrink: 0;
      }

      .mobile-menu-btn {
        display: flex;
      }

      .time-display {
        display: none;
      }

      .last-updated {
        display: none;
      }
    }

    @media (min-width: 769px) {
      .mobile-menu-btn {
        display: none;
      }

      .mobile-overlay {
        display: none !important;
      }
    }

    .mobile-menu-btn {
      display: none;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: var(--radius-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      color: var(--text-primary);
      cursor: pointer;
      font-size: 18px;
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 99;
    }

    .mobile-overlay.active {
      display: block;
    }

    /* Touch-friendly controls */
    @media (pointer: coarse) {
      .device-marker {
        min-width: 32px;
        min-height: 32px;
      }

      .device-dot {
        width: 28px;
        height: 28px;
      }

      .btn, .header-btn, .filter-btn {
        min-height: 40px;
        padding: 8px 12px;
      }

      .floor-item {
        padding: 12px;
      }
    }

    /* Animated Status Classes */
    .status-animated.online {
      animation: onlineGlow 3s ease-in-out infinite;
    }

    .status-animated.offline {
      animation: offlineAlert 1.5s ease-in-out infinite;
    }

    .data-refreshing {
      animation: dataRefresh 1s ease-in-out infinite;
    }

    .status-change-enter {
      animation: scaleIn 0.3s ease-out;
    }

    /* Device marker animations */
    .device-marker.status-changed {
      animation: statusPulse 0.5s ease-out;
    }

    .device-dot.animated {
      animation: breathe 2s ease-in-out infinite;
    }

    /* ==================== MAIN LAYOUT ==================== */
    .app-container {
      display: grid;
      grid-template-rows: auto 1fr auto;
      min-height: 100vh;
      max-height: 100vh;
      overflow: hidden;
    }

    /* ==================== HEADER ==================== */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md) var(--space-lg);
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      backdrop-filter: blur(12px);
      z-index: 100;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .logo-icon {
      font-size: var(--text-display);
    }

    .logo-text {
      font-size: var(--text-title);
      font-weight: 600;
      color: var(--text-primary);
    }

    .logo-badge {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--accent-blue);
      color: white;
      border-radius: var(--radius-full);
      font-weight: 600;
    }

    .status-bar {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .status-metric {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid var(--border-subtle);
    }

    .status-metric:hover {
      background: var(--bg-overlay);
      border-color: var(--accent-blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .status-metric:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .status-dot.online { background: var(--status-online); box-shadow: var(--shadow-glow-green); }
    .status-dot.offline { background: var(--status-offline); box-shadow: var(--shadow-glow-red); animation: pulse 2s infinite; }
    .status-dot.warning { background: var(--status-warning); }

    .status-value {
      font-size: var(--text-large);
      font-weight: 700;
      color: var(--text-primary);
    }

    .status-label {
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .health-bar-container {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      min-width: 200px;
    }

    .health-bar {
      flex: 1;
      height: 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
      overflow: hidden;
    }

    .health-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--status-online), var(--accent-emerald));
      border-radius: var(--radius-full);
      transition: width var(--transition-slow);
    }

    .health-percent {
      font-size: var(--text-body);
      font-weight: 600;
      color: var(--status-online);
      min-width: 45px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
    }

    .time-display {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
    }

    .time-value {
      font-size: var(--text-large);
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }

    .live-indicator {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: var(--text-tiny);
      color: var(--status-online);
    }

    .live-dot {
      width: 6px;
      height: 6px;
      background: var(--status-online);
      border-radius: 50%;
      animation: pulse 1.5s infinite;
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
    }

    .header-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .header-btn:hover {
      background: var(--bg-overlay);
      border-color: var(--border-default);
    }

    .header-btn.primary {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
    }

    .header-btn.primary:hover {
      background: #2563EB;
    }

    .user-menu {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-full);
      cursor: pointer;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      background: linear-gradient(135deg, var(--accent-blue), var(--accent-purple));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: var(--text-small);
    }

    .user-name {
      font-size: var(--text-small);
      font-weight: 500;
    }

    .user-role {
      font-size: var(--text-tiny);
      padding: 2px 6px;
      background: var(--status-warning-bg);
      color: var(--status-warning);
      border-radius: var(--radius-sm);
      font-weight: 600;
    }

    /* ==================== MAIN CONTENT ==================== */
    .main-content {
      display: grid;
      grid-template-columns: 280px 1fr 320px;
      gap: 0;
      overflow: hidden;
      height: 100%;
    }

    /* Collapsible left panel */
    .main-content.left-collapsed {
      grid-template-columns: 1fr 320px;
    }

    .main-content.left-collapsed .left-panel {
      display: none;
    }

    .panel-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .panel-toggle:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    @media (max-width: 1200px) {
      .main-content {
        grid-template-columns: 1fr 280px;
      }
      .left-panel { display: none; }
      .panel-toggle { display: none; }
    }

    @media (max-width: 1024px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr auto;
      }
      .right-panel {
        max-height: 40vh;
        border-top: 1px solid var(--border-subtle);
        border-left: none;
      }
    }

    /* ==================== LEFT PANEL ==================== */
    .left-panel {
      background: var(--bg-surface);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .panel-header {
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .panel-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .floor-nav {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
    }

    .floor-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      margin-bottom: var(--space-xs);
      background: transparent;
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .floor-item:hover {
      background: var(--bg-elevated);
    }

    .floor-item.active {
      background: var(--status-info-bg);
      border-color: var(--accent-blue);
    }

    .floor-item.has-issues {
      border-color: var(--status-offline);
    }

    .floor-icon {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      font-size: var(--text-large);
    }

    .floor-item.active .floor-icon {
      background: var(--accent-blue);
    }

    .floor-info {
      flex: 1;
    }

    .floor-name {
      font-size: var(--text-body);
      font-weight: 600;
    }

    .floor-stats {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .floor-status {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .floor-status.ok { color: var(--status-online); }
    .floor-status.issue { color: var(--status-offline); }

    .quick-stats {
      padding: var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }

    .quick-stat-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-sm) var(--space-xs);
      margin: 0 calc(-1 * var(--space-xs));
      border-bottom: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .quick-stat-item:hover {
      background: var(--bg-elevated);
      transform: translateX(4px);
    }

    .quick-stat-item:last-child {
      border-bottom: none;
    }

    .quick-stat-label {
      font-size: var(--text-small);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .quick-stat-label::after {
      content: '‚Üí';
      opacity: 0;
      transform: translateX(-5px);
      transition: var(--transition-fast);
    }

    .quick-stat-item:hover .quick-stat-label::after {
      opacity: 0.5;
      transform: translateX(0);
    }

    .quick-stat-value {
      font-size: var(--text-body);
      font-weight: 600;
    }

    /* ==================== FLOOR MAP (HERO) ==================== */
    .map-container {
      position: relative;
      background: var(--bg-base);
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .floor-map {
      position: relative;
      width: 100%;
      height: 100%;
      transform-origin: center center;
      will-change: transform;
      background-position: center;
      background-repeat: no-repeat;
      background-size: contain;
    }

    .floor-plan-bg-loader {
      position: absolute;
      opacity: 0;
      pointer-events: none;
      max-width: 1px;
      max-height: 1px;
    }

    .markers-overlay {
      position: absolute;
      pointer-events: none;
    }

    .markers-overlay .device-marker {
      pointer-events: auto;
    }

    .map-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: var(--space-md);
      color: var(--text-muted);
      text-align: center;
      padding: var(--space-xl);
    }

    .map-placeholder-icon {
      font-size: 4rem;
      opacity: 0.5;
    }

    .map-placeholder-title {
      font-size: var(--text-title);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .map-placeholder-subtitle {
      font-size: var(--text-body);
    }

    .map-controls {
      position: absolute;
      bottom: var(--space-md);
      right: var(--space-md);
      display: flex;
      gap: var(--space-xs);
    }

    .map-control-btn {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .map-control-btn:hover {
      background: var(--bg-elevated);
    }

    .floor-label {
      position: absolute;
      top: var(--space-md);
      left: var(--space-md);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-glass);
      backdrop-filter: blur(8px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      font-size: var(--text-large);
      font-weight: 600;
    }

    /* ==================== DEVICE MARKERS ==================== */
    .device-marker {
      position: absolute;
      transform: translate(-50%, -50%);
      z-index: 10;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .device-marker:hover {
      z-index: 100;
      transform: translate(-50%, -50%) scale(1.15);
    }

    .device-marker.highlighted {
      z-index: 200;
      transform: translate(-50%, -50%) scale(1.3);
    }

    .device-marker.highlighted .device-dot,
    .device-marker.highlighted .marker-dot {
      animation: highlightPulse 1s ease-in-out infinite;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.8), 0 0 40px rgba(59, 130, 246, 0.4);
    }

    @keyframes highlightPulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .marker-ring {
      position: absolute;
      inset: -4px;
      border-radius: 50%;
      border: 2px solid currentColor;
      opacity: 0;
      animation: ping 2s infinite;
    }

    .device-marker.offline .marker-ring {
      opacity: 1;
      border-color: var(--status-offline);
    }

    .marker-dot {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      border: 3px solid;
      box-shadow: var(--shadow-md);
      transition: var(--transition-fast);
    }

    .marker-dot.online {
      background: var(--status-online-bg);
      border-color: var(--status-online);
    }

    .marker-dot.offline {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
      animation: glow 2s infinite;
    }

    /* Disabled/non-serviceable devices */
    .device-marker.disabled {
      opacity: 0.4;
    }

    .device-marker.disabled .device-dot {
      background: var(--bg-overlay) !important;
      border-color: var(--text-muted) !important;
      filter: grayscale(1);
    }

    .device-marker.disabled .device-ping {
      display: none;
    }

    .marker-dot.warning {
      background: var(--status-warning-bg);
      border-color: var(--status-warning);
    }

    .marker-dot.ap { border-color: var(--accent-blue); }
    .marker-dot.printer { border-color: var(--accent-purple); }
    .marker-dot.zoom { border-color: var(--status-warning); }

    .device-marker:hover .marker-dot {
      transform: scale(1.1);
      box-shadow: var(--shadow-lg);
    }

    /* Device Popup */
    .device-popup {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-fast);
      pointer-events: none;
      z-index: 1000;
    }

    .device-marker:hover .device-popup {
      opacity: 1;
      visibility: visible;
    }

    .popup-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .popup-icon {
      font-size: var(--text-title);
    }

    .popup-title {
      flex: 1;
    }

    .popup-name {
      font-size: var(--text-body);
      font-weight: 600;
      max-width: 150px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .popup-type {
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .popup-status {
      padding: 4px 10px;
      border-radius: var(--radius-full);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .popup-status.online {
      background: var(--status-online-bg);
      color: var(--status-online);
    }

    .popup-status.offline {
      background: var(--status-offline-bg);
      color: var(--status-offline);
    }

    .popup-body {
      padding: var(--space-md);
    }

    .popup-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-xs) 0;
      font-size: var(--text-small);
    }

    .popup-label {
      color: var(--text-secondary);
    }

    .popup-value {
      font-weight: 500;
    }

    .popup-actions {
      display: flex;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border-top: 1px solid var(--border-subtle);
    }

    .popup-btn {
      flex: 1;
      padding: var(--space-xs) var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: var(--text-tiny);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .popup-btn:hover {
      background: var(--bg-overlay);
    }

    .popup-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 16px;
      height: 8px;
      overflow: hidden;
    }

    .popup-arrow::after {
      content: '';
      position: absolute;
      top: -8px;
      left: 50%;
      transform: translateX(-50%) rotate(45deg);
      width: 12px;
      height: 12px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
    }

    /* Popup positioned below for markers near top of map */
    .device-marker.popup-below .device-popup {
      bottom: auto;
      top: calc(100% + 12px);
    }

    .device-marker.popup-below .popup-arrow {
      bottom: auto;
      top: -8px;
    }

    .device-marker.popup-below .popup-arrow::after {
      top: auto;
      bottom: -8px;
    }

    /* Make popup more compact for MacBook screens */
    @media (max-width: 1600px) {
      .device-popup {
        min-width: 240px;
        max-width: 280px;
      }
      .popup-header {
        padding: var(--space-sm);
      }
      .popup-body {
        padding: var(--space-sm);
      }
      .popup-row {
        font-size: var(--text-tiny);
      }
    }

    /* ==================== RIGHT PANEL ==================== */
    .right-panel {
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .device-list-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .device-list-title {
      font-size: var(--text-body);
      font-weight: 600;
    }

    .device-search {
      position: relative;
    }

    .device-search input {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      padding-left: 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-full);
      color: var(--text-primary);
      font-size: var(--text-small);
    }

    .device-search input:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .device-search::before {
      content: 'üîç';
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
    }

    .device-list {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-sm);
    }

    .device-category {
      margin-bottom: var(--space-sm);
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .category-header:hover {
      background: var(--bg-overlay);
    }

    .category-icon {
      font-size: var(--text-large);
    }

    .category-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 600;
    }

    .category-count {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
    }

    .category-toggle {
      font-size: 10px;
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .category-header.collapsed .category-toggle {
      transform: rotate(-90deg);
    }

    .category-devices {
      margin-top: var(--space-xs);
      overflow: hidden;
      transition: max-height 0.4s ease-out, margin-top 0.3s ease, opacity 0.3s ease;
      opacity: 1;
    }

    .category-devices.collapsed {
      max-height: 0 !important;
      margin-top: 0;
      opacity: 0;
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      margin-bottom: 2px;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .device-item:hover {
      background: var(--bg-elevated);
    }

    .device-item.offline {
      background: var(--status-offline-bg);
    }

    .device-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .device-status-dot.online { background: var(--status-online); }
    .device-status-dot.offline { background: var(--status-offline); animation: pulse 1.5s infinite; }

    .device-info {
      flex: 1;
      min-width: 0;
    }

    .device-name {
      font-size: var(--text-small);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-meta {
      font-size: var(--text-tiny);
      color: var(--text-muted);
    }

    .device-ping {
      font-size: var(--text-tiny);
      color: var(--status-online);
      font-weight: 500;
    }

    /* ==================== FOOTER ==================== */
    .footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-sm) var(--space-lg);
      background: var(--bg-surface);
      border-top: 1px solid var(--border-subtle);
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: var(--space-lg);
    }

    .legend {
      display: flex;
      gap: var(--space-md);
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      font-size: var(--text-small);
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }

    .legend-item:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
      transform: translateY(-1px);
    }

    .legend-item.active {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    .legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      transition: var(--transition-fast);
    }

    .legend-item:hover .legend-dot {
      transform: scale(1.2);
      box-shadow: 0 0 8px currentColor;
    }

    .legend-dot.ap { background: var(--accent-blue); }
    .legend-dot.printer { background: var(--accent-purple); }
    .legend-dot.zoom { background: var(--status-warning); }
    .legend-dot.online { background: var(--status-online); }
    .legend-dot.offline { background: var(--status-offline); }

    .footer-center {
      flex: 1;
      overflow: hidden;
    }

    .event-ticker {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      font-size: var(--text-small);
      color: var(--text-secondary);
      white-space: nowrap;
      animation: ticker 30s linear infinite;
    }

    .event-ticker-item {
      display: flex;
      align-items: center;
      gap: var(--space-xs);
      padding: 0 var(--space-lg);
    }

    .footer-right {
      display: flex;
      align-items: center;
      gap: var(--space-md);
      font-size: var(--text-small);
      color: var(--text-secondary);
    }

    .data-source {
      display: flex;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      transition: var(--transition-fast);
    }

    .data-source:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
      transform: translateY(-1px);
    }

    /* ==================== MODALS ==================== */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .modal {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      width: 90%;
      max-width: 600px;
      max-height: 90vh;
      overflow: hidden;
      transform: scale(0.95);
      transition: var(--transition-base);
    }

    .modal-overlay.open .modal {
      transform: scale(1);
    }

    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .modal-title {
      font-size: var(--text-title);
      font-weight: 600;
    }

    .modal-close {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-elevated);
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .modal-close:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    .modal-body {
      padding: var(--space-lg);
      overflow-y: auto;
      max-height: calc(90vh - 140px);
    }

    /* Status list items in modals */
    .status-list-item:hover {
      background: var(--bg-elevated) !important;
    }

    .status-list-item:active {
      background: var(--bg-overlay) !important;
    }

    .modal-section {
      margin-bottom: var(--space-lg);
    }

    .modal-section:last-child {
      margin-bottom: 0;
    }

    .modal-section-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-md);
    }

    .info-item {
      padding: var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
    }

    .info-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .info-value {
      font-size: var(--text-body);
      font-weight: 500;
    }

    .info-source {
      font-size: var(--text-tiny);
      color: var(--accent-blue);
      cursor: pointer;
      margin-top: 4px;
    }

    .info-source:hover {
      text-decoration: underline;
    }

    .uptime-chart {
      height: 60px;
      display: flex;
      align-items: flex-end;
      gap: 2px;
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
    }

    .uptime-bar {
      flex: 1;
      border-radius: 2px;
      min-height: 4px;
      transition: var(--transition-fast);
    }

    .uptime-bar.up { background: var(--status-online); }
    .uptime-bar.down { background: var(--status-offline); }
    .uptime-bar.partial { background: var(--status-warning); }

    .modal-actions {
      display: flex;
      gap: var(--space-sm);
      padding: var(--space-lg);
      border-top: 1px solid var(--border-subtle);
    }

    .btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-xs);
      padding: var(--space-sm) var(--space-md);
      border-radius: var(--radius-md);
      font-size: var(--text-body);
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
    }

    .btn-primary {
      background: var(--accent-blue);
      color: white;
    }

    .btn-primary:hover {
      background: #2563EB;
    }

    .btn-secondary {
      background: var(--bg-elevated);
      border-color: var(--border-default);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      background: var(--bg-overlay);
    }

    .btn-danger {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
      color: var(--status-offline);
    }

    .btn-danger:hover {
      background: var(--status-offline);
      color: white;
    }

    .btn-sm {
      padding: var(--space-xs) var(--space-sm);
      font-size: var(--text-small);
    }

    .btn-warning {
      background: rgba(245, 158, 11, 0.2);
      border-color: var(--status-warning);
      color: var(--status-warning);
    }

    .btn-warning:hover {
      background: var(--status-warning);
      color: white;
    }

    .btn-success {
      background: rgba(16, 185, 129, 0.2);
      border-color: var(--status-online);
      color: var(--status-online);
    }

    .btn-success:hover {
      background: var(--status-online);
      color: white;
    }

    /* ==================== ADMIN PANEL ==================== */
    .admin-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 999;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .admin-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .admin-panel {
      position: fixed;
      top: 0;
      right: -500px;
      width: 500px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      z-index: 1000;
      transition: right var(--transition-base);
      display: flex;
      flex-direction: column;
    }

    .admin-panel.open {
      right: 0;
    }

    .admin-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
    }

    .admin-title {
      font-size: var(--text-title);
      font-weight: 600;
    }

    .admin-tabs {
      display: flex;
      border-bottom: 1px solid var(--border-subtle);
    }

    .admin-tab {
      flex: 1;
      padding: var(--space-md);
      text-align: center;
      font-size: var(--text-small);
      color: var(--text-secondary);
      cursor: pointer;
      border-bottom: 2px solid transparent;
      transition: var(--transition-fast);
    }

    .admin-tab:hover {
      color: var(--text-primary);
      background: var(--bg-elevated);
    }

    .admin-tab.active {
      color: var(--accent-blue);
      border-bottom-color: var(--accent-blue);
    }

    .admin-content {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-lg);
    }

    /* ==================== FORMS ==================== */
    .form-group {
      margin-bottom: var(--space-md);
    }

    .form-label {
      display: block;
      font-size: var(--text-small);
      color: var(--text-secondary);
      margin-bottom: var(--space-xs);
    }

    .form-input,
    .form-select,
    .form-textarea {
      width: 100%;
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: var(--text-body);
      transition: var(--transition-fast);
    }

    .form-input:focus,
    .form-select:focus,
    .form-textarea:focus {
      outline: none;
      border-color: var(--accent-blue);
    }

    .form-textarea {
      min-height: 100px;
      resize: vertical;
    }

    /* ==================== UTILITIES ==================== */
    .hidden { display: none !important; }
    .text-online { color: var(--status-online); }
    .text-offline { color: var(--status-offline); }
    .text-warning { color: var(--status-warning); }
    .text-muted { color: var(--text-muted); }
    .font-mono { font-family: 'SF Mono', Monaco, monospace; }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-base);
    }

    ::-webkit-scrollbar-thumb {
      background: var(--bg-overlay);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ==================== LEGACY COMPATIBILITY ==================== */
    /* Login Page */
    .login-page {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, var(--bg-base) 0%, var(--bg-surface) 50%, var(--bg-base) 100%);
    }

    .login-container {
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-xl);
      padding: var(--space-xl);
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
    }

    .login-logo {
      text-align: center;
      margin-bottom: var(--space-lg);
    }

    .login-logo-icon {
      font-size: 3rem;
      margin-bottom: var(--space-md);
    }

    .login-logo-title {
      font-size: var(--text-title);
      font-weight: 600;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-md);
    }

    .login-input {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: var(--bg-elevated);
      color: var(--text-primary);
      font-size: var(--text-body);
      transition: var(--transition-fast);
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
    }

    .login-btn {
      width: 100%;
      padding: var(--space-md);
      border-radius: var(--radius-md);
      border: none;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-purple));
      color: white;
      font-size: var(--text-body);
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-glow-blue);
    }

    .login-error {
      padding: var(--space-sm);
      border-radius: var(--radius-md);
      background: var(--status-offline-bg);
      border: 1px solid var(--status-offline);
      color: var(--status-offline);
      font-size: var(--text-small);
      text-align: center;
    }

    /* Analytics Sidebar */
    .analytics-sidebar {
      position: fixed;
      top: 0;
      right: -450px;
      width: 450px;
      height: 100vh;
      background: var(--bg-surface);
      border-left: 1px solid var(--border-subtle);
      z-index: 1002;
      transition: right var(--transition-base);
      overflow-y: auto;
      box-shadow: var(--shadow-lg);
    }

    .analytics-sidebar.open { right: 0; }

    .analytics-header {
      padding: var(--space-lg);
      border-bottom: 1px solid var(--border-subtle);
      position: sticky;
      top: 0;
      background: var(--bg-surface);
      z-index: 10;
    }

    .analytics-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .analytics-title {
      font-size: var(--text-title);
      font-weight: 600;
      margin: 0 0 4px 0;
    }

    .analytics-subtitle {
      font-size: var(--text-small);
      color: var(--text-muted);
    }

    .analytics-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
    }

    .analytics-close:hover { color: var(--text-primary); }

    .analytics-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: var(--radius-full);
      font-size: var(--text-small);
      font-weight: 500;
      margin-top: var(--space-sm);
    }

    .analytics-status.up {
      background: var(--status-online-bg);
      color: var(--status-online);
    }

    .analytics-status.down {
      background: var(--status-offline-bg);
      color: var(--status-offline);
    }

    .analytics-content { padding: var(--space-lg); }

    .analytics-section { margin-bottom: var(--space-lg); }

    .analytics-section-title {
      font-size: var(--text-tiny);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
    }

    .stat-card {
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: var(--space-md);
      border: 1px solid var(--border-subtle);
    }

    .stat-value {
      font-size: var(--text-title);
      font-weight: 700;
      color: var(--text-primary);
    }

    .stat-value.green { color: var(--status-online); }
    .stat-value.red { color: var(--status-offline); }
    .stat-value.yellow { color: var(--status-warning); }
    .stat-value.blue { color: var(--accent-blue); }

    .stat-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-top: 4px;
    }

    .analytics-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1001;
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-base);
    }

    .analytics-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    /* Analytics sidebar - uptime bar and segments */
    .analytics-section .uptime-bar {
      display: flex;
      gap: 2px;
      height: 24px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      padding: 3px;
      overflow: hidden;
    }

    .uptime-segment {
      flex: 1;
      border-radius: 2px;
      min-width: 2px;
      transition: var(--transition-fast);
      cursor: pointer;
      position: relative;
    }

    .uptime-segment.up { background: var(--status-online); }
    .uptime-segment.down { background: var(--status-offline); }
    .uptime-segment.unknown { background: var(--border-default); }

    .uptime-segment:hover {
      transform: scaleY(1.2);
      opacity: 0.9;
    }

    .uptime-segment[data-tooltip]:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-overlay);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 4px;
    }

    .uptime-legend {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-top: 4px;
    }

    /* Analytics sidebar - response time chart */
    .response-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 60px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      padding: 8px;
      overflow: hidden;
    }

    .response-bar {
      flex: 1;
      min-width: 4px;
      background: var(--status-online);
      border-radius: 2px 2px 0 0;
      transition: var(--transition-fast);
      cursor: pointer;
      position: relative;
    }

    .response-bar:hover {
      opacity: 0.8;
      transform: scaleX(1.3);
    }

    .response-bar.slow {
      background: var(--status-warning);
    }

    .response-bar.timeout {
      background: var(--status-offline);
    }

    .response-bar[title]:hover::after {
      content: attr(title);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-overlay);
      color: var(--text-primary);
      padding: 4px 8px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      white-space: nowrap;
      z-index: 10;
      margin-bottom: 4px;
    }

    /* Analytics sidebar - history list */
    .history-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }

    .history-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px;
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
    }

    .history-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .history-status.up { background: var(--status-online); }
    .history-status.down { background: var(--status-offline); }

    .history-info {
      flex: 1;
      min-width: 0;
    }

    .history-time {
      font-size: var(--text-tiny);
      color: var(--text-muted);
    }

    .history-message {
      font-size: var(--text-small);
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .history-ping {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--accent-blue);
      flex-shrink: 0;
    }

    /* Feature-specific styles using design system variables */
    .import-dropzone {
      border: 2px dashed var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-xl);
      text-align: center;
      cursor: pointer;
      transition: var(--transition-fast);
      background: var(--bg-elevated);
    }

    .import-dropzone:hover,
    .import-dropzone.dragover {
      border-color: var(--accent-blue);
      background: var(--status-info-bg);
    }

    .import-icon { font-size: 3rem; margin-bottom: var(--space-sm); }
    .import-title { font-size: var(--text-body); font-weight: 500; }
    .import-subtitle { font-size: var(--text-small); color: var(--text-muted); }

    .device-notes {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }

    .device-notes-label {
      font-size: var(--text-tiny);
      color: var(--status-warning);
      margin-bottom: 4px;
    }

    .device-notes-content {
      font-size: var(--text-small);
      color: var(--text-secondary);
      background: var(--bg-elevated);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      font-style: italic;
    }

    .health-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .health-badge.excellent { background: var(--status-online-bg); color: var(--status-online); }
    .health-badge.good { background: var(--status-info-bg); color: var(--accent-blue); }
    .health-badge.fair { background: var(--status-warning-bg); color: var(--status-warning); }
    .health-badge.poor { background: var(--status-offline-bg); color: var(--status-offline); }

    .bulk-actions-bar {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm);
      background: var(--status-info-bg);
      border: 1px solid var(--accent-blue);
      border-radius: var(--radius-md);
      margin-bottom: var(--space-md);
    }

    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: var(--space-sm);
      margin-bottom: var(--space-md);
    }

    .template-card {
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      text-align: center;
    }

    .template-card:hover,
    .template-card.selected {
      background: var(--status-info-bg);
      border-color: var(--accent-blue);
    }

    .zone-overlay {
      position: absolute;
      pointer-events: none;
      inset: 0;
      z-index: 5;
    }

    .zone-labels-overlay {
      position: absolute;
      pointer-events: none;
      inset: 0;
      z-index: 4;
      overflow: visible;
    }

    .zone-labels-container {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 4;
      pointer-events: none;
    }

    .room-borders-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 2;
      pointer-events: none;
    }

    .room-borders-overlay .room-label-group {
      pointer-events: auto;
      cursor: pointer;
    }

    .room-borders-overlay .room-label-group:hover .room-label-bg {
      fill: rgba(59, 130, 246, 0.8);
    }

    .excluded-zones-overlay {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 3;
      pointer-events: none;
    }

    .room-label {
      position: absolute;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      font-weight: 500;
      white-space: nowrap;
      max-width: 100px;
      overflow: hidden;
      text-overflow: ellipsis;
      pointer-events: auto;
      cursor: pointer;
    }

    .room-label:hover {
      background: rgba(59, 130, 246, 0.8);
      transform: translate(-50%, -50%) scale(1.05);
    }

    .room-label-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    }

    .room-label-modal-content {
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: 20px;
      min-width: 300px;
    }

    .room-label-modal-content h3 {
      margin-bottom: 16px;
      font-size: 16px;
    }

    .label-editor-row {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }

    .label-editor-row label {
      width: 80px;
      font-size: 13px;
      color: var(--text-secondary);
    }

    .label-editor-row input[type="range"] {
      flex: 1;
      height: 6px;
      border-radius: 3px;
      background: var(--bg-elevated);
      cursor: pointer;
    }

    .label-editor-row span {
      width: 50px;
      text-align: right;
      font-size: 12px;
      color: var(--text-muted);
    }

    .label-editor-buttons {
      display: flex;
      gap: 8px;
      margin-top: 20px;
      justify-content: flex-end;
    }

    .label-btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .label-btn.save {
      background: var(--accent-blue);
      color: white;
    }

    .label-btn.save:hover {
      background: #2563eb;
    }

    .label-btn.cancel {
      background: var(--bg-elevated);
      color: var(--text-secondary);
    }

    .label-btn.cancel:hover {
      background: var(--bg-overlay);
    }

    .label-btn.reset {
      background: transparent;
      color: var(--text-muted);
      margin-right: auto;
    }

    .label-btn.reset:hover {
      color: var(--status-warning);
    }

    .zone-editor-panel {
      position: absolute;
      bottom: var(--space-lg);
      left: var(--space-lg);
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      padding: var(--space-md);
      z-index: 100;
      min-width: 250px;
    }

    .discovery-progress-bar {
      height: 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-sm);
      overflow: hidden;
    }

    .discovery-progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--accent-blue), var(--accent-cyan));
      border-radius: var(--radius-sm);
      transition: width var(--transition-base);
    }

    .context-menu {
      position: fixed;
      background: var(--bg-glass);
      backdrop-filter: blur(12px);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      z-index: 10000;
      min-width: 180px;
      overflow: hidden;
    }

    .context-menu-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      cursor: pointer;
      font-size: var(--text-small);
      transition: var(--transition-fast);
    }

    .context-menu-item:hover { background: var(--status-info-bg); }
    .context-menu-item.danger:hover { background: var(--status-offline-bg); color: var(--status-offline); }

    .context-menu-divider {
      height: 1px;
      background: var(--border-subtle);
      margin: 4px 0;
    }

    .widgets-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: var(--space-md);
      margin-bottom: var(--space-lg);
    }

    .widget {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-lg);
      border: 1px solid var(--border-subtle);
    }

    .widget-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-md);
    }

    .widget-title {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-secondary);
    }

    .pie-chart {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      position: relative;
    }

    .pie-chart-center {
      position: absolute;
      inset: 12px;
      background: var(--bg-surface);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: var(--text-large);
      font-weight: 700;
    }

    .widget-stat-value.green { color: var(--status-online); }
    .widget-stat-value.red { color: var(--status-offline); }
    .widget-stat-value.yellow { color: var(--status-warning); }

    /* ==================== ENHANCED SIDEBAR COMPONENTS ==================== */
    .device-category {
      margin-bottom: var(--space-sm);
    }

    .category-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      border-left: 3px solid;
    }

    .category-header:hover {
      background: var(--bg-overlay);
    }

    .category-header.ap { border-color: var(--accent-blue); background: var(--status-info-bg); }
    .category-header.printer { border-color: var(--accent-purple); background: rgba(139, 92, 246, 0.1); }
    .category-header.poly { border-color: var(--status-warning); background: var(--status-warning-bg); }

    .category-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 600;
    }

    .category-count {
      font-size: var(--text-tiny);
      padding: 2px 8px;
      background: var(--bg-overlay);
      border-radius: var(--radius-full);
    }

    .collapse-icon {
      font-size: 10px;
      color: var(--text-muted);
      transition: var(--transition-fast);
    }

    .category-header.collapsed .collapse-icon {
      transform: rotate(-90deg);
    }

    .category-content {
      margin-top: var(--space-xs);
      max-height: 1000px;
      overflow: hidden;
      transition: max-height var(--transition-base);
    }

    .category-content.collapsed {
      max-height: 0;
    }

    .device-item {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      margin-bottom: 2px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: var(--transition-fast);
      border: 1px solid transparent;
    }

    .device-item:hover {
      background: var(--bg-overlay);
      border-color: var(--border-default);
    }

    .device-item.clickable:hover {
      border-color: var(--accent-blue);
    }

    .device-item.down {
      background: var(--status-offline-bg);
      border-color: var(--status-offline);
    }

    .device-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .device-status-dot.up, .device-status-dot.online { background: var(--status-online); }
    .device-status-dot.down, .device-status-dot.offline { background: var(--status-offline); animation: pulse 1.5s infinite; }
    .device-status-dot.warning { background: var(--status-warning); animation: pulse 2s infinite; }
    .device-status-dot.maintenance { background: var(--status-warning); }

    .device-info {
      flex: 1;
      min-width: 0;
    }

    .device-name {
      font-size: var(--text-small);
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .device-meta {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      display: flex;
      gap: var(--space-sm);
      flex-wrap: wrap;
    }

    .device-model {
      color: var(--status-warning);
      font-weight: 500;
    }

    /* Room Groups for Zoom Rooms */
    .room-group {
      margin-bottom: var(--space-sm);
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .room-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-sm) var(--space-md);
      background: var(--status-warning-bg);
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: var(--transition-fast);
    }

    .room-header:hover {
      background: rgba(245, 158, 11, 0.2);
    }

    .room-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .room-status.up { background: var(--status-online); }
    .room-status.down { background: var(--status-offline); box-shadow: var(--shadow-glow-red); }

    .room-name {
      flex: 1;
      font-size: var(--text-small);
      font-weight: 500;
    }

    .room-devices {
      padding: var(--space-sm);
      max-height: 500px;
      overflow: hidden;
      transition: max-height var(--transition-base), padding var(--transition-base);
    }

    .room-devices.collapsed {
      max-height: 0;
      padding: 0 var(--space-sm);
    }

    /* Device Marker Enhancements */
    .device-marker .device-dot,
    .marker-dot {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      border: 3px solid;
      box-shadow: var(--shadow-md);
      transition: var(--transition-fast);
      background: var(--bg-surface);
    }

    .device-marker:hover .device-dot {
      transform: scale(1.15);
      box-shadow: var(--shadow-lg);
    }

    .device-ping {
      position: absolute;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      opacity: 0.5;
      animation: ping 1.5s cubic-bezier(0, 0, 0.2, 1) infinite;
      transform: translate(-50%, -50%);
      left: 50%;
      top: 50%;
    }

    /* Device Popup Enhancements */
    .device-popup {
      position: absolute;
      bottom: calc(100% + 12px);
      left: 50%;
      transform: translateX(-50%);
      min-width: 280px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-lg);
      opacity: 0;
      visibility: hidden;
      transition: var(--transition-fast);
      pointer-events: none;
      z-index: 1000;
    }

    .device-marker:hover .device-popup,
    .device-popup.force-show {
      opacity: 1;
      visibility: visible;
    }

    .device-popup.force-show {
      animation: popupPulse 0.5s ease-out;
      box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
    }

    @keyframes popupPulse {
      0% { transform: translateX(-50%) scale(0.9); opacity: 0; }
      50% { transform: translateX(-50%) scale(1.05); }
      100% { transform: translateX(-50%) scale(1); opacity: 1; }
    }

    .popup-header {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }

    .popup-icon { font-size: var(--text-title); }
    .popup-name { font-size: var(--text-body); font-weight: 600; max-width: 150px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .popup-details { padding: var(--space-md); }

    .popup-row {
      display: flex;
      justify-content: space-between;
      padding: var(--space-xs) 0;
      font-size: var(--text-small);
    }

    .popup-row strong { color: var(--text-secondary); }

    .status-badge {
      padding: 2px 8px;
      border-radius: var(--radius-sm);
      font-size: var(--text-tiny);
      font-weight: 600;
    }

    .popup-section {
      margin-top: var(--space-sm);
      padding-top: var(--space-sm);
      border-top: 1px solid var(--border-subtle);
    }

    .popup-section-title {
      font-size: var(--text-tiny);
      color: var(--status-warning);
      font-weight: 600;
      margin-bottom: var(--space-xs);
    }

    .popup-arrow {
      position: absolute;
      bottom: -8px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 8px solid transparent;
      border-right: 8px solid transparent;
      border-top: 8px solid var(--bg-surface);
    }

    /* Toner Level Bars - Enhanced */
    .printer-consumables {
      background: linear-gradient(135deg, var(--bg-elevated) 0%, rgba(31, 41, 55, 0.9) 100%);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-top: 12px;
    }

    .consumables-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
      padding-bottom: 10px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .consumables-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .consumables-title-icon {
      font-size: 18px;
    }

    .consumables-refresh {
      padding: 4px 10px;
      background: var(--bg-overlay);
      border: none;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .consumables-refresh:hover {
      background: var(--accent-blue);
      color: white;
    }

    .toner-levels {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .toner-bar {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 10px 6px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .toner-bar:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .toner-bar.low {
      background: rgba(239, 68, 68, 0.15);
      border: 1px solid var(--status-offline);
    }

    .toner-bar-track {
      width: 28px;
      height: 55px;
      background: var(--bg-overlay);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
      border: 2px solid var(--border-subtle);
    }

    .toner-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 4px;
      transition: height 0.5s ease;
    }

    .toner-bar-fill.black {
      background: linear-gradient(to top, #1a1a1a, #404040);
      box-shadow: inset 0 0 6px rgba(255, 255, 255, 0.1);
    }
    .toner-bar-fill.cyan {
      background: linear-gradient(to top, #0891B2, #22D3EE);
      box-shadow: 0 0 10px rgba(6, 182, 212, 0.5);
    }
    .toner-bar-fill.magenta {
      background: linear-gradient(to top, #BE185D, #F472B6);
      box-shadow: 0 0 10px rgba(236, 72, 153, 0.5);
    }
    .toner-bar-fill.yellow {
      background: linear-gradient(to top, #CA8A04, #FDE047);
      box-shadow: 0 0 10px rgba(234, 179, 8, 0.5);
    }

    .toner-bar-label {
      font-size: 9px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .toner-bar-value {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
    }

    .toner-bar.low .toner-bar-value {
      color: var(--status-offline);
    }

    .toner-bar.low .toner-bar-track {
      border-color: var(--status-offline);
      animation: toner-pulse 2s infinite;
    }

    @keyframes toner-pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 4px rgba(239, 68, 68, 0); }
    }

    .toner-low-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      background: var(--status-offline);
      color: white;
      font-size: 9px;
      font-weight: 600;
      border-radius: 4px;
      text-transform: uppercase;
      animation: pulse 1.5s infinite;
    }

    /* Paper Level - Enhanced */
    .paper-section {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      margin-top: 12px;
    }

    .paper-icon-large {
      font-size: 24px;
    }

    .paper-info {
      flex: 1;
    }

    .paper-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .paper-bar {
      height: 10px;
      background: var(--bg-overlay);
      border-radius: 5px;
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }

    .paper-bar-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--status-online), #34D399);
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .paper-bar-fill.low {
      background: linear-gradient(90deg, var(--status-warning), #FBBF24);
    }

    .paper-bar-fill.empty {
      background: linear-gradient(90deg, var(--status-offline), #F87171);
    }

    .paper-value {
      font-size: 14px;
      font-weight: 700;
      min-width: 45px;
      text-align: right;
    }

    /* Page count styling */
    .page-count-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 12px;
      background: var(--bg-base);
      border-radius: var(--radius-sm);
      margin-top: 8px;
    }

    .page-count-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    .page-count-value {
      font-size: 16px;
      font-weight: 700;
      color: var(--accent-blue);
    }

    /* Legacy support */
    .paper-level {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: var(--space-xs);
      padding: var(--space-xs);
      background: var(--bg-elevated);
      border-radius: var(--radius-sm);
    }

    .paper-icon {
      font-size: 16px;
    }

    /* Sidebar toner indicator */
    .sidebar-toner {
      display: flex;
      gap: 2px;
      margin-left: auto;
    }

    .sidebar-toner-dot {
      width: 8px;
      height: 8px;
      border-radius: 2px;
    }

    .sidebar-toner-dot.black { background: #1a1a1a; border: 1px solid #444; }
    .sidebar-toner-dot.cyan { background: #06B6D4; }
    .sidebar-toner-dot.magenta { background: #EC4899; }
    .sidebar-toner-dot.yellow { background: #EAB308; }
    .sidebar-toner-dot.low { opacity: 0.3; }

    /* Printer sidebar edit controls */
    .printer-floor-select {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 10px;
      padding: 2px 4px;
      cursor: pointer;
      min-width: 45px;
    }
    .printer-floor-select:hover {
      border-color: var(--accent);
    }
    .printer-floor-select:focus {
      outline: none;
      border-color: var(--accent);
    }
    .printer-serial-input {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: 4px;
      color: var(--text-secondary);
      font-size: 10px;
      padding: 2px 6px;
      width: 90px;
      font-family: monospace;
    }
    .printer-serial-input:hover {
      border-color: var(--accent);
    }
    .printer-serial-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--bg-primary);
    }
    .printer-serial-input::placeholder {
      color: var(--text-muted);
      opacity: 0.6;
    }

    /* ==================== DASHBOARD WIDGETS ==================== */
    .widgets-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      padding: 4px 16px;
      background: var(--bg-surface);
      border-bottom: 1px solid var(--border-subtle);
      align-items: center;
    }

    .widget-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      background: var(--bg-elevated);
      border-radius: 12px;
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      border: 1px solid var(--border-subtle);
    }

    .widget-badge:hover {
      background: var(--bg-overlay);
      border-color: var(--accent-blue);
    }

    .badge-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: var(--text-muted);
    }
    .badge-dot.green { background: var(--status-online); }
    .badge-dot.red { background: var(--status-offline); }

    .badge-value {
      font-weight: 700;
      color: var(--text-primary);
    }

    .widget-badge.green .badge-value { color: var(--status-online); }
    .widget-badge.red .badge-value { color: var(--status-offline); }
    .widget-badge.yellow .badge-value { color: var(--status-warning); }
    .widget-badge.blue .badge-value { color: var(--accent-blue); }

    .badge-label {
      color: var(--text-muted);
      font-weight: 500;
    }

    /* Status Summary in Right Panel */
    .status-summary {
      padding: 12px;
      border-top: 1px solid var(--border-subtle);
      background: var(--bg-base);
    }

    .summary-title {
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .summary-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .summary-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      background: var(--bg-elevated);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 1px solid transparent;
      position: relative;
      overflow: hidden;
    }

    .summary-stat::after {
      content: '‚Üí';
      position: absolute;
      right: 4px;
      top: 50%;
      transform: translateY(-50%) translateX(10px);
      opacity: 0;
      font-size: 10px;
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .summary-stat:hover {
      background: var(--bg-overlay);
      border-color: var(--accent-blue);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
    }

    .summary-stat:hover::after {
      opacity: 1;
      transform: translateY(-50%) translateX(0);
    }

    .summary-stat:active {
      transform: translateY(0);
      box-shadow: none;
    }

    .summary-stat .stat-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      transition: transform 0.2s ease;
    }

    .summary-stat:hover .stat-value {
      transform: scale(1.1);
    }

    .summary-stat.green .stat-value { color: var(--status-online); }
    .summary-stat.red .stat-value { color: var(--status-offline); }
    .summary-stat.yellow .stat-value { color: var(--status-warning); }
    .summary-stat.blue .stat-value { color: var(--accent-blue); }

    .summary-stat .stat-label {
      font-size: 9px;
      color: var(--text-muted);
      text-transform: uppercase;
      margin-top: 2px;
    }

    /* ==================== GLOBAL SEARCH ==================== */
    .global-search {
      position: relative;
      margin-right: 16px;
    }

    .search-input {
      width: 220px;
      padding: 8px 12px 8px 36px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      color: var(--text-primary);
      font-size: 13px;
      transition: all 0.2s;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--accent-blue);
      width: 300px;
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .search-icon {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      font-size: 14px;
    }

    .search-results {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 4px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      max-height: 400px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: var(--shadow-md);
      display: none;
    }

    .search-results.active {
      display: block;
    }

    .search-result-item {
      padding: 10px 14px;
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s;
    }

    .search-result-item:hover {
      background: var(--bg-elevated);
    }

    .search-result-item:last-child {
      border-bottom: none;
    }

    .search-result-status {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .search-result-status.up { background: var(--status-online); }
    .search-result-status.down { background: var(--status-offline); }

    .search-result-info {
      flex: 1;
    }

    .search-result-name {
      font-weight: 500;
      font-size: 13px;
    }

    .search-result-meta {
      font-size: 11px;
      color: var(--text-muted);
    }

    .search-no-results {
      padding: 20px;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* ==================== NOTIFICATION CENTER ==================== */
    .notification-btn {
      position: relative;
      padding: 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 18px;
    }

    .notification-btn:hover {
      background: var(--bg-overlay);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      min-width: 18px;
      height: 18px;
      background: var(--status-offline);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 9px;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0 4px;
    }

    .notification-panel {
      position: fixed;
      top: 60px;
      right: 20px;
      width: 380px;
      max-height: 500px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-lg);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 2000;
      display: none;
      overflow: hidden;
    }

    .notification-panel.active {
      display: block;
      animation: slideDown 0.2s ease;
    }

    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .notification-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 16px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .notification-title {
      font-weight: 600;
      font-size: 14px;
    }

    .notification-clear {
      font-size: 12px;
      color: var(--accent-blue);
      cursor: pointer;
    }

    .notification-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 12px 16px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      gap: 12px;
      transition: background 0.15s;
    }

    .notification-item:hover {
      background: var(--bg-elevated);
    }

    .notification-item.unread {
      background: rgba(59, 130, 246, 0.05);
    }

    .notification-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      flex-shrink: 0;
    }

    .notification-icon.offline { background: rgba(239, 68, 68, 0.15); }
    .notification-icon.online { background: rgba(16, 185, 129, 0.15); }
    .notification-icon.warning { background: rgba(245, 158, 11, 0.15); }

    .notification-content {
      flex: 1;
      min-width: 0;
    }

    .notification-text {
      font-size: 13px;
      line-height: 1.4;
    }

    .notification-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .notification-empty {
      padding: 40px 20px;
      text-align: center;
      color: var(--text-muted);
    }

    /* ==================== BULK ACTIONS ==================== */
    .bulk-mode-bar {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-surface);
      border: 1px solid var(--accent-blue);
      border-radius: var(--radius-lg);
      padding: 12px 20px;
      display: flex;
      align-items: center;
      gap: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      z-index: 1000;
      animation: slideUp 0.2s ease;
    }

    @keyframes slideUp {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .bulk-count {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .bulk-actions {
      display: flex;
      gap: 8px;
    }

    .bulk-btn {
      padding: 8px 14px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .bulk-btn.primary {
      background: var(--accent-blue);
      color: white;
    }

    .bulk-btn.secondary {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    .bulk-btn.danger {
      background: var(--status-offline);
      color: white;
    }

    .bulk-btn:hover {
      filter: brightness(1.1);
    }

    .device-checkbox {
      position: absolute;
      top: -5px;
      left: -5px;
      width: 18px;
      height: 18px;
      background: var(--bg-surface);
      border: 2px solid var(--border-default);
      border-radius: 4px;
      display: none;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 5;
    }

    .bulk-mode .device-checkbox {
      display: flex;
    }

    .device-checkbox.selected {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    /* ==================== ZONE EDITOR ==================== */
    .zone-overlay {
      position: absolute;
      border: 2px dashed var(--accent-blue);
      background: rgba(59, 130, 246, 0.1);
      border-radius: var(--radius-sm);
      pointer-events: none;
    }

    .zone-label {
      position: absolute;
      top: 4px;
      left: 4px;
      padding: 2px 8px;
      background: var(--accent-blue);
      color: white;
      font-size: 10px;
      font-weight: 600;
      border-radius: 4px;
      max-width: 120px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .zone-editor-toolbar {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: var(--bg-surface);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-md);
      padding: 8px;
      display: flex;
      gap: 8px;
      z-index: 100;
    }

    .zone-tool-btn {
      padding: 8px 12px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .zone-tool-btn:hover, .zone-tool-btn.active {
      background: var(--accent-blue);
      border-color: var(--accent-blue);
      color: white;
    }

    /* ==================== HISTORICAL TRENDS ==================== */
    .trends-chart {
      height: 200px;
      background: var(--bg-elevated);
      border-radius: var(--radius-md);
      padding: 16px;
      position: relative;
    }

    .trends-bars {
      display: flex;
      align-items: flex-end;
      height: 150px;
      gap: 2px;
      padding-top: 10px;
    }

    .trend-bar {
      flex: 1;
      background: var(--accent-blue);
      border-radius: 2px 2px 0 0;
      min-height: 2px;
      transition: all 0.3s;
      cursor: pointer;
    }

    .trend-bar:hover {
      background: var(--status-info);
    }

    .trend-bar.low { background: var(--status-offline); }
    .trend-bar.medium { background: var(--status-warning); }
    .trend-bar.high { background: var(--status-online); }

    .trends-labels {
      display: flex;
      justify-content: space-between;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ==================== INCIDENT TIMELINE ==================== */
    .incident-timeline {
      position: relative;
      padding-left: 24px;
    }

    .incident-timeline::before {
      content: '';
      position: absolute;
      left: 8px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-default);
    }

    .incident-item {
      position: relative;
      padding: 12px 0;
      padding-left: 20px;
    }

    .incident-dot {
      position: absolute;
      left: -20px;
      top: 16px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid var(--bg-surface);
    }

    .incident-dot.down { background: var(--status-offline); }
    .incident-dot.up { background: var(--status-online); }
    .incident-dot.warning { background: var(--status-warning); }

    .incident-card {
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 12px;
    }

    .incident-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .incident-title {
      font-weight: 600;
      font-size: 13px;
    }

    .incident-time {
      font-size: 11px;
      color: var(--text-muted);
    }

    .incident-details {
      font-size: 12px;
      color: var(--text-secondary);
    }

    .incident-duration {
      display: inline-block;
      padding: 2px 8px;
      background: rgba(239, 68, 68, 0.15);
      color: var(--status-offline);
      font-size: 11px;
      border-radius: 4px;
      margin-top: 8px;
    }

    /* ==================== ACTIVITY LOG ==================== */
    .activity-list {
      max-height: 400px;
      overflow-y: auto;
    }

    .activity-item {
      display: flex;
      gap: 12px;
      padding: 10px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .activity-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .activity-icon.edit { background: rgba(59, 130, 246, 0.15); }
    .activity-icon.add { background: rgba(16, 185, 129, 0.15); }
    .activity-icon.delete { background: rgba(239, 68, 68, 0.15); }
    .activity-icon.login { background: rgba(139, 92, 246, 0.15); }

    .activity-content {
      flex: 1;
    }

    .activity-text {
      font-size: 13px;
    }

    .activity-user {
      font-weight: 600;
      color: var(--accent-blue);
    }

    .activity-time {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    /* ==================== COMPACT MODE ==================== */
    .compact-mode {
      --space-xs: 2px;
      --space-sm: 4px;
      --space-md: 8px;
      --space-lg: 12px;
      --space-xl: 16px;
      --text-title: 1rem;
      --text-large: 0.875rem;
      --text-body: 0.8125rem;
      --text-small: 0.75rem;
      --text-tiny: 0.625rem;
    }

    .compact-mode .header {
      padding: 8px 16px;
    }

    .compact-mode .logo-text {
      display: none;
    }

    .compact-mode .logo-badge {
      display: none;
    }

    .compact-mode .status-metric {
      padding: 4px 8px;
      gap: 4px;
    }

    .compact-mode .status-label {
      display: none;
    }

    .compact-mode .health-bar-container {
      min-width: 120px;
      padding: 4px 8px;
    }

    .compact-mode .header-btn {
      padding: 6px 10px;
      font-size: 12px;
    }

    .compact-mode .time-display {
      display: none;
    }

    .compact-mode .main-content {
      grid-template-columns: 200px 1fr 240px;
    }

    .compact-mode .left-panel {
      width: 200px;
    }

    .compact-mode .floor-item {
      padding: 8px;
    }

    .compact-mode .floor-icon {
      width: 28px;
      height: 28px;
      font-size: 14px;
    }

    .compact-mode .floor-name {
      font-size: 13px;
    }

    .compact-mode .floor-stats {
      font-size: 11px;
    }

    .compact-mode .quick-stats {
      padding: 8px;
    }

    .compact-mode .device-item {
      padding: 6px 8px;
    }

    .compact-mode .device-name {
      font-size: 12px;
    }

    .compact-mode .device-meta {
      font-size: 10px;
    }

    .compact-mode .footer {
      padding: 4px 16px;
    }

    .compact-mode .legend {
      font-size: 11px;
    }

    .compact-mode .marker-dot {
      width: 28px;
      height: 28px;
      font-size: 12px;
    }

    .compact-mode .device-popup {
      min-width: 220px;
    }

    .compact-toggle {
      font-size: 11px;
      padding: 4px 8px;
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      cursor: pointer;
    }

    .compact-toggle:hover {
      background: var(--bg-overlay);
      color: var(--text-primary);
    }

    .compact-toggle.active {
      background: var(--accent-blue);
      color: white;
      border-color: var(--accent-blue);
    }

    /* ==================== SPARKLINE ==================== */
    .sparkline-container {
      margin-top: var(--space-sm);
      padding: var(--space-xs) 0;
    }

    .sparkline-label {
      font-size: var(--text-tiny);
      color: var(--text-muted);
      margin-bottom: 4px;
    }

    .sparkline {
      display: flex;
      gap: 1px;
      height: 20px;
      align-items: flex-end;
    }

    .sparkline-bar {
      flex: 1;
      min-width: 2px;
      border-radius: 1px;
      transition: height 0.2s;
    }

    .sparkline-bar.up { background: var(--status-online); }
    .sparkline-bar.down { background: var(--status-offline); }
    .sparkline-bar.unknown { background: var(--bg-overlay); }

    .sparkline-legend {
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: var(--text-muted);
      margin-top: 2px;
    }
  </style>
  <!-- Shared Modules -->
  <script src="js/auth.js"></script>
  <script src="js/error-handler.js"></script>
</head>
<body>
  <div id="app"></div>
  <div id="analytics-container"></div>

  <script>
    // Register Service Worker for PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(reg => console.log('Service Worker registered'))
        .catch(err => console.log('Service Worker registration failed:', err));
    }

    // API Configuration
    const API_URL = window.location.origin;

    // Local time formatting helpers (converts UTC timestamps to local timezone)
    function parseUTCDate(date) {
      // Server returns timestamps without timezone (e.g., "2026-02-04 07:11:05")
      // These are stored in UTC, so we need to parse them as UTC
      if (typeof date === 'string' && !date.includes('T') && !date.includes('Z')) {
        // Add 'Z' to indicate UTC
        return new Date(date.replace(' ', 'T') + 'Z');
      }
      return new Date(date);
    }
    function formatIsraelTime(date) {
      return parseUTCDate(date).toLocaleString();
    }
    function formatIsraelTimeOnly(date) {
      return parseUTCDate(date).toLocaleTimeString();
    }
    function formatIsraelDate(date) {
      return parseUTCDate(date).toLocaleDateString();
    }

    // XSS sanitization - escapes HTML to prevent injection attacks
    function sanitizeHTML(str) {
      if (str === null || str === undefined) return '';
      const div = document.createElement('div');
      div.textContent = String(str);
      return div.innerHTML;
    }

    // Auth state
    let authToken = localStorage.getItem('authToken');
    let currentUser = null;
    try {
      currentUser = JSON.parse(localStorage.getItem('currentUser') || 'null');
    } catch (e) {
      console.error('Failed to parse currentUser from localStorage:', e);
      localStorage.removeItem('currentUser');
      localStorage.removeItem('authToken');
      authToken = null;
    }
    let loginError = '';

    // Data stores
    let monitorData = {};
    let polyLensData = {};
    let zoomOnlyRooms = {}; // Zoom rooms without Poly devices, by floor
    let printerStatusData = {}; // Store printer toner/paper status by monitor ID
    let apiStatus = {
      monitors: { connected: false, monitorCount: 0 },
      polyLens: { configured: false, deviceCount: 0 },
      zoomRooms: { configured: false, roomCount: 0 }
    };
    let lastFetchError = null;
    let activeFloor = "1st Floor";
    let floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor']; // Updated dynamically from data
    let leftPanelCollapsed = localStorage.getItem('leftPanelCollapsed') === 'true';
    let compactMode = localStorage.getItem('compactMode') === 'true';
    let alertSoundsEnabled = localStorage.getItem('alertSoundsEnabled') === 'true';
    let previousDeviceStatuses = {}; // Track previous statuses for change detection
    let activeThresholdAlerts = {}; // Server-side toner alert state: { monitorId: [alert_types] }

    // Admin state
    let adminOpen = false;
    let adminTab = 'devices';
    let editMode = false;
    let pendingPositions = {}; // Track unsaved position changes: { deviceId: { x, y, isRoom, floor } }
    let allMonitors = [];
    let settings = {};
    let floorPlans = {};
    let roomPositions = {}; // Stored room positions from database
    let deviceFilter = '';
    let editingMonitor = null;
    let draggedDevice = null;
    let apiIntegrations = [];
    let customDeviceTypes = [];
    let pendingChangesCount = 0;

    // New feature states
    let bulkImportData = [];
    let bulkImportModalOpen = false;
    let bulkSelectMode = false;
    let selectedDevices = new Set();
    let savedFilters = [];
    let activeFilter = null;
    let deviceTemplates = [];
    let floorZones = {};
    let zoneEditMode = false;
    let discoveryModalOpen = false;
    let discoveryResults = [];
    let discoveryScanning = false;
    let discoveryProgress = 0;
    let contextMenu = { open: false, x: 0, y: 0, device: null };

    // WebSocket state
    let ws = null;
    let wsConnected = false;
    let wsReconnectTimer = null;
    let wsReconnectAttempts = 0;
    let wsReconnecting = false;

    // Quick filter state
    let activeFilters = {
      offlineOnly: false,
      lowToner: false,
      inMeeting: false
    };

    // Last updated state
    let lastDataUpdate = null;
    let isRefreshing = false;

    // Floor transition state
    let isFloorTransitioning = false;

    // Notifications state
    let unreadNotifications = 0;

    // Token rotation state management - prevents race conditions with concurrent requests
    let tokenRotationPending = false;
    let lastTokenRotationTime = 0;
    const TOKEN_ROTATION_DEBOUNCE = 2000; // 2 seconds debounce for WebSocket reconnection

    // Auth helper for fetch with automatic token rotation handling
    async function authFetch(url, options = {}) {
      const headers = { ...options.headers };
      // Capture the token we're sending WITH this request
      const requestToken = authToken;
      if (requestToken) {
        headers['Authorization'] = `Bearer ${requestToken}`;
      }
      const response = await fetch(url, { ...options, headers });

      // Only check for token rotation on SUCCESSFUL responses (2xx)
      // Never trust X-New-Token from failed/cached error responses
      if (response.ok) {
        const newToken = response.headers.get('X-New-Token');
        if (newToken && newToken !== authToken && requestToken === authToken) {
          // Only accept if: response is successful, token is new, and request used current token
          console.log('Token rotated, updating stored token');
          console.log('  Old token:', authToken ? authToken.substring(0, 20) + '...' : 'NULL');
          console.log('  New token:', newToken.substring(0, 20) + '...');

          authToken = newToken;
          localStorage.setItem('authToken', newToken);

          // Debounce WebSocket reconnection to avoid multiple reconnects from concurrent requests
          const now = Date.now();
          if (!tokenRotationPending && (now - lastTokenRotationTime) > TOKEN_ROTATION_DEBOUNCE) {
            tokenRotationPending = true;
            lastTokenRotationTime = now;

            // Small delay to let other concurrent responses arrive with same token
            setTimeout(() => {
              tokenRotationPending = false;
              // Only reconnect if WebSocket is open and using an old token
              if (ws && (ws.readyState === WebSocket.OPEN || ws.readyState === WebSocket.CONNECTING)) {
                wsTokenRotationInProgress = true;
                connectWebSocket();
              }
            }, 100); // 100ms delay to batch concurrent token rotations
          }
        }
      }

      return response;
    }

    // Login function
    let pendingApprovalToken = null;
    let approvalCheckInterval = null;

    async function login(username, password) {
      try {
        const response = await fetch(`${API_URL}/api/auth/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          authToken = data.token;
          currentUser = data.user;
          localStorage.setItem('authToken', authToken);
          localStorage.setItem('currentUser', JSON.stringify(currentUser));
          localStorage.setItem('lastSessionValidated', Date.now().toString());
          loginError = '';
          renderApp();

          // Check if password reset is required - show modal after render
          if (data.user.password_reset_required) {
            setTimeout(() => {
              showChangePasswordModal(true);
            }, 500);
          }
        } else if (data.requires_slack_approval) {
          // Slack 2FA - show waiting screen and poll for approval
          pendingApprovalToken = data.pending_token;
          showSlackApprovalWaiting(username);
          startApprovalPolling();
        } else {
          loginError = data.error || 'Login failed';
          renderLogin();
        }
      } catch (e) {
        loginError = 'Connection error. Please try again.';
        renderLogin();
      }
    }

    // Show Slack 2FA approval waiting screen
    function showSlackApprovalWaiting(username) {
      document.getElementById('app').innerHTML = `
        <div class="login-page">
          <div class="login-container" style="text-align: center;">
            <div class="login-logo">
              <div class="login-logo-icon">üîî</div>
              <div class="login-logo-title">Awaiting Approval</div>
            </div>
            <div class="approval-spinner" style="margin: 24px 0;">
              <svg width="48" height="48" viewBox="0 0 48 48" style="animation: spin 1.5s linear infinite;">
                <circle cx="24" cy="24" r="20" fill="none" stroke="var(--border-default)" stroke-width="4"></circle>
                <circle cx="24" cy="24" r="20" fill="none" stroke="var(--accent-blue)" stroke-width="4"
                        stroke-linecap="round" stroke-dasharray="80" stroke-dashoffset="60"></circle>
              </svg>
            </div>
            <p style="color: var(--text-secondary); font-size: 14px; margin-bottom: 8px;">
              A login approval request has been sent to Slack.
            </p>
            <p style="color: var(--text-muted); font-size: 13px; margin-bottom: 24px;">
              Waiting for an administrator to approve your login as <strong style="color: var(--text-primary);">${username}</strong>
            </p>
            <div id="approval-status" style="padding: 12px; background: var(--bg-elevated); border-radius: 8px; margin-bottom: 16px;">
              <span style="color: var(--status-warning);">‚è≥ Pending approval...</span>
            </div>
            <button onclick="cancelSlackApproval()" class="login-btn" style="background: var(--bg-elevated); border: 1px solid var(--border-default);">
              Cancel
            </button>
          </div>
        </div>
        <style>
          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
        </style>
      `;
    }

    // Start polling for approval status
    function startApprovalPolling() {
      if (approvalCheckInterval) {
        clearInterval(approvalCheckInterval);
      }

      approvalCheckInterval = setInterval(async () => {
        if (!pendingApprovalToken) {
          clearInterval(approvalCheckInterval);
          return;
        }

        try {
          const response = await fetch(`${API_URL}/api/auth/check-login-status/${pendingApprovalToken}`);
          const data = await response.json();

          if (data.status === 'approved' && data.token) {
            // Login approved!
            clearInterval(approvalCheckInterval);
            pendingApprovalToken = null;

            authToken = data.token;
            currentUser = data.user;
            localStorage.setItem('authToken', authToken);
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            localStorage.setItem('lastSessionValidated', Date.now().toString());
            loginError = '';

            // Update status before redirecting
            const statusEl = document.getElementById('approval-status');
            if (statusEl) {
              statusEl.innerHTML = '<span style="color: var(--status-online);">‚úì Approved! Logging in...</span>';
            }

            setTimeout(() => {
              renderApp();
              // Check if password reset is required
              if (data.user && data.user.password_reset_required) {
                setTimeout(() => showChangePasswordModal(true), 500);
              }
            }, 1000);
          } else if (data.status === 'denied') {
            // Login denied
            clearInterval(approvalCheckInterval);
            pendingApprovalToken = null;

            const statusEl = document.getElementById('approval-status');
            if (statusEl) {
              statusEl.innerHTML = '<span style="color: var(--status-offline);">‚úï Login denied by administrator</span>';
            }

            setTimeout(() => {
              loginError = 'Login was denied by an administrator';
              renderLogin();
            }, 2000);
          } else if (data.status === 'expired') {
            // Request expired
            clearInterval(approvalCheckInterval);
            pendingApprovalToken = null;
            loginError = 'Login approval request expired. Please try again.';
            renderLogin();
          }
        } catch (e) {
          console.error('Error checking approval status:', e);
        }
      }, 2000); // Check every 2 seconds
    }

    // Cancel Slack approval and go back to login
    function cancelSlackApproval() {
      if (approvalCheckInterval) {
        clearInterval(approvalCheckInterval);
        approvalCheckInterval = null;
      }
      pendingApprovalToken = null;
      loginError = '';
      renderLogin();
    }

    // Logout function
    async function logout() {
      try {
        await authFetch(`${API_URL}/api/auth/logout`, { method: 'POST' });
      } catch (e) {}

      // Clean up WebSocket and timers
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (ws) {
        ws.isClosedIntentionally = true;
        ws.close();
        ws = null;
      }
      wsTokenRotationInProgress = false;

      // Clean up analytics interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }

      authToken = null;
      currentUser = null;
      localStorage.removeItem('authToken');
      localStorage.removeItem('currentUser');
      localStorage.removeItem('notifications');
      localStorage.removeItem('lastSessionValidated');
      renderLogin();
    }

    // Handle login form submit
    function handleLogin(e) {
      e.preventDefault();
      const username = document.getElementById('login-username').value;
      const password = document.getElementById('login-password').value;
      login(username, password);
    }

    // Render login page
    function renderLogin() {
      document.getElementById('app').innerHTML = `
        <div class="login-page">
          <div class="login-container">
            <div class="login-logo">
              <div class="login-logo-icon">üè¢</div>
              <div class="login-logo-title">Office Monitor</div>
            </div>
            ${loginError ? `<div class="login-error">${loginError}</div>` : ''}
            <form class="login-form" onsubmit="handleLogin(event)">
              <input type="text" id="login-username" class="login-input" placeholder="Username" required autofocus>
              <input type="password" id="login-password" class="login-input" placeholder="Password" required>
              <button type="submit" class="login-btn">Sign In</button>
            </form>
            <div style="margin-top: 16px; text-align: center;">
              <a href="#" onclick="showForgotPassword(); return false;" style="color: var(--accent-blue); font-size: 13px; text-decoration: none;">Forgot Password?</a>
            </div>
          </div>
        </div>
      `;
    }

    // Forgot password UI
    function showForgotPassword() {
      loginError = '';
      document.getElementById('app').innerHTML = `
        <div class="login-page">
          <div class="login-container">
            <div class="login-logo">
              <div class="login-logo-icon">üîê</div>
              <div class="login-logo-title">Reset Password</div>
            </div>
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px; text-align: center;">
              Enter your username and a password reset will be initiated. An admin will be notified via Slack.
            </p>
            <form class="login-form" onsubmit="handleForgotPassword(event)">
              <input type="text" id="forgot-username" class="login-input" placeholder="Username" required autofocus>
              <button type="submit" class="login-btn">Request Reset</button>
            </form>
            <div style="margin-top: 16px; text-align: center;">
              <a href="#" onclick="renderLogin(); return false;" style="color: var(--text-secondary); font-size: 13px; text-decoration: none;">‚Üê Back to Login</a>
            </div>
          </div>
        </div>
      `;
    }

    // Handle forgot password submission
    async function handleForgotPassword(event) {
      event.preventDefault();
      const username = document.getElementById('forgot-username').value;

      try {
        const response = await fetch(`${API_URL}/api/auth/forgot-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username })
        });

        const data = await response.json();

        document.getElementById('app').innerHTML = `
          <div class="login-page">
            <div class="login-container">
              <div class="login-logo">
                <div class="login-logo-icon">‚úÖ</div>
                <div class="login-logo-title">Request Sent</div>
              </div>
              <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px; text-align: center;">
                If the username exists, a password reset has been initiated. An admin has been notified. Please try logging in with the temporary password.
              </p>
              <button class="login-btn" onclick="renderLogin()">Back to Login</button>
            </div>
          </div>
        `;
      } catch (e) {
        showAlert('Connection error. Please try again.', 'error');
        showForgotPassword();
      }
    }

    // Show change password modal
    function showChangePasswordModal(required = false) {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" ${required ? '' : 'onclick="if(event.target === this) closeChangePasswordModal()"'}>
          <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
              <h3 class="modal-title">üîê ${required ? 'Password Change Required' : 'Change Password'}</h3>
              ${required ? '' : '<button class="admin-close" onclick="closeChangePasswordModal()">&times;</button>'}
            </div>
            ${required ? `
              <div style="padding: 12px 16px; background: var(--status-warning-bg); color: var(--status-warning); font-size: 13px; border-bottom: 1px solid var(--border-subtle);">
                Your password has been reset. Please create a new password to continue.
              </div>
            ` : ''}
            <form onsubmit="handleChangePassword(event, ${required})" style="padding: 16px;">
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Current Password</label>
                <input type="password" id="current-password" class="login-input" style="width: 100%;" required>
              </div>
              <div style="margin-bottom: 12px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">New Password</label>
                <input type="password" id="new-password" class="login-input" style="width: 100%;" required minlength="12">
                <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px; line-height: 1.4;">
                  Must be 12+ characters with uppercase, lowercase, number, and special character
                </div>
              </div>
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">Confirm New Password</label>
                <input type="password" id="confirm-password" class="login-input" style="width: 100%;" required minlength="12">
              </div>
              <button type="submit" class="login-btn" style="width: 100%;">Change Password</button>
            </form>
          </div>
        </div>
      `;
    }

    function closeChangePasswordModal() {
      document.getElementById('modal-container').innerHTML = '';
    }

    // Handle change password submission
    async function handleChangePassword(event, required = false) {
      event.preventDefault();
      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      if (newPassword !== confirmPassword) {
        showAlert('New passwords do not match', 'error');
        return;
      }

      if (newPassword.length < 6) {
        showAlert('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/auth/change-password`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ current_password: currentPassword, new_password: newPassword })
        });

        const data = await response.json();

        if (data.success) {
          closeChangePasswordModal();
          showAlert('Password changed successfully!', 'success');
          // Update user state to reflect password is no longer reset required
          if (currentUser) {
            currentUser.password_reset_required = false;
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
          }
        } else {
          showAlert(data.error || 'Failed to change password', 'error');
        }
      } catch (e) {
        showAlert('Connection error. Please try again.', 'error');
      }
    }

    // Check if user is admin
    function isAdmin() {
      return currentUser?.role === 'admin';
    }

    // Fetch data from both APIs
    async function fetchAllData() {
      try {
        // Fetch monitor data (requires auth)
        const monitorsResponse = await authFetch(`${API_URL}/api/monitors/by-floor`);
        if (monitorsResponse.ok) {
          const monitorsResult = await monitorsResponse.json();
          if (monitorsResult.success) {
            monitorData = monitorsResult.floors;
            apiStatus.monitors.connected = monitorsResult.connected;
          }
        }

        // Fetch Poly Lens data (requires auth)
        const plResponse = await authFetch(`${API_URL}/api/poly-lens/by-floor`);
        if (plResponse.ok) {
          const plData = await plResponse.json();
          if (plData.success) {
            polyLensData = plData.floors;
            apiStatus.polyLens.configured = true;
            apiStatus.polyLens.deviceCount = plData.deviceCount;
          }
        }

        // Fetch Zoom-only rooms (rooms without Poly devices) (requires auth)
        const zoomResponse = await authFetch(`${API_URL}/api/zoom-rooms/unmatched`);
        if (zoomResponse.ok) {
          const zoomData = await zoomResponse.json();
          if (zoomData.success) {
            // Group unmatched rooms by floor
            zoomOnlyRooms = {};
            (zoomData.rooms || []).forEach(room => {
              const floor = room.floor || 'Floor 5';
              const floorNum = floor.replace('Floor ', '');
              const floorKey = floorNum + (['1','2','3'].includes(floorNum)
                ? (floorNum === '1' ? 'st' : floorNum === '2' ? 'nd' : 'rd')
                : 'th') + ' Floor';
              if (!zoomOnlyRooms[floorKey]) {
                zoomOnlyRooms[floorKey] = [];
              }
              zoomOnlyRooms[floorKey].push(room);
            });
            apiStatus.zoomRooms.configured = true;
            apiStatus.zoomRooms.roomCount = zoomData.count;
          }
        }

        // Fetch health for counts
        const healthResponse = await authFetch(`${API_URL}/api/health`);
        if (healthResponse.ok) {
          const health = await healthResponse.json();
          apiStatus.monitors.monitorCount = health.monitors?.monitorCount || 0;
          apiStatus.polyLens.deviceCount = health.polyLens?.deviceCount || 0;
        }

        // Fetch room positions
        await fetchRoomPositions();

        // Fetch printer status for all printers
        await fetchPrinterStatus();

        // Fetch active threshold alerts (toner alerts etc.)
        await fetchActiveThresholdAlerts();

        lastFetchError = null;
        lastDataUpdate = new Date();
      } catch (error) {
        console.error('Failed to fetch data:', error);
        lastFetchError = error.message;
        // Show user-friendly error notification
        if (window.ErrorHandler) {
          ErrorHandler.showError(error, {
            title: 'Data Load Error',
            action: () => fetchAllData(),
            actionText: 'Retry'
          });
        }
      }
    }

    const deviceTypes = {
      accessPoints: { icon: "üì°", label: "Access Points", color: "#3B82F6" },
      printers: { icon: "üñ®Ô∏è", label: "Printers", color: "#8B5CF6" },
      polyLens: { icon: "üìπ", label: "Zoom Rooms", color: "#F59E0B" },
      zoomOnly: { icon: "üé•", label: "Zoom Room", color: "#06B6D4" }
    };

    const statusColors = {
      up: { bg: "#22C55E", pulse: "#4ADE80", label: "Online" },
      down: { bg: "#EF4444", pulse: "#F87171", label: "Offline" },
      unknown: { bg: "#6B7280", pulse: "#9CA3AF", label: "Unknown" }
    };

    function generatePositions(count, seed) {
      const positions = [];
      for (let i = 0; i < count; i++) {
        const angle = (seed + i * 137.5) % 360;
        const radius = 25 + ((seed * i) % 20);
        positions.push({
          x: 50 + radius * Math.cos(angle * Math.PI / 180) * 0.8,
          y: 50 + radius * Math.sin(angle * Math.PI / 180) * 0.6
        });
      }
      return positions;
    }

    function getStatusCounts(floorData, polyData) {
      let up = 0, down = 0;

      // Count from monitors
      if (floorData) {
        Object.values(floorData).forEach(category => {
          if (Array.isArray(category)) {
            category.forEach(device => {
              if (device.status === 'up') up++;
              else if (device.status === 'down') down++;
            });
          }
        });
      }

      return { up, down, total: up + down };
    }

    function getPolyLensRooms(floor) {
      const devices = polyLensData[floor] || [];
      const rooms = {};

      devices.forEach(device => {
        const roomName = device.room || 'Unassigned';
        if (!rooms[roomName]) {
          rooms[roomName] = [];
        }
        rooms[roomName].push(device);
      });

      return rooms;
    }

    // ==================== ADMIN FUNCTIONS ====================

    async function fetchAllMonitors() {
      try {
        const response = await authFetch(`${API_URL}/api/monitors`);
        if (response.ok) {
          const data = await response.json();
          allMonitors = data.monitors || [];
        }
      } catch (e) {
        console.error('Failed to fetch monitors:', e);
      }
    }

    async function fetchSettings() {
      try {
        const response = await authFetch(`${API_URL}/api/settings`);
        if (response.ok) {
          const data = await response.json();
          settings = data.settings || {};
        }
      } catch (e) {
        console.error('Failed to fetch settings:', e);
      }
    }

    async function fetchFloorPlans() {
      try {
        // First get the list of floor plans
        const response = await fetch(`${API_URL}/api/floor-plans`);
        if (response.ok) {
          const data = await response.json();
          floorPlans = {};

          // Fetch full data for each floor plan (including image_data)
          for (const plan of data.plans) {
            try {
              const fullResponse = await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(plan.floor)}`);
              if (fullResponse.ok) {
                const fullData = await fullResponse.json();
                floorPlans[plan.floor] = fullData.plan;
              }
            } catch (e) {
              console.error(`Failed to fetch floor plan for ${plan.floor}:`, e);
            }
          }
        }
      } catch (e) {
        console.error('Failed to fetch floor plans:', e);
      }
    }

    async function fetchApiIntegrations() {
      try {
        const response = await authFetch(`${API_URL}/api/integrations`);
        if (response.ok) {
          const data = await response.json();
          apiIntegrations = data.integrations || [];
        }
      } catch (e) {
        console.error('Failed to fetch API integrations:', e);
      }
    }

    async function fetchCustomDeviceTypes() {
      try {
        const response = await fetch(`${API_URL}/api/device-types`);
        if (response.ok) {
          const data = await response.json();
          customDeviceTypes = data.types || [];
        }
      } catch (e) {
        console.error('Failed to fetch device types:', e);
      }
    }

    async function fetchRoomPositions() {
      try {
        const response = await fetch(`${API_URL}/api/room-positions`);
        if (response.ok) {
          const data = await response.json();
          roomPositions = data.positions || {};
        }
      } catch (e) {
        console.error('Failed to fetch room positions:', e);
      }
    }

    async function fetchPrinterStatus() {
      try {
        // Get all printer IDs from the current data
        const printerIds = [];
        Object.values(monitorData).forEach(floor => {
          if (floor.printers) {
            floor.printers.forEach(p => printerIds.push(p.id));
          }
        });

        // Fetch status for each printer in parallel
        const statusPromises = printerIds.map(async (id) => {
          try {
            const response = await fetch(`${API_URL}/api/printers/${id}/status`);
            if (response.ok) {
              const data = await response.json();
              if (data.success && data.status) {
                printerStatusData[id] = data.status;
              }
            }
          } catch (e) {
            console.error(`Failed to fetch printer ${id} status:`, e);
          }
        });

        await Promise.all(statusPromises);
      } catch (e) {
        console.error('Failed to fetch printer status:', e);
      }
    }

    // Fetch active threshold alerts from server (for once-per-incident toner alerts)
    async function fetchActiveThresholdAlerts() {
      try {
        const response = await fetch(`${API_URL}/api/threshold-alerts/active-map`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            activeThresholdAlerts = data.alertMap || {};
          }
        }
      } catch (e) {
        console.error('Failed to fetch threshold alerts:', e);
      }
    }

    async function fetchPendingChangesCount() {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/count`);
        if (response.ok) {
          const data = await response.json();
          pendingChangesCount = data.count || 0;
        }
      } catch (e) {
        console.error('Failed to fetch pending changes count:', e);
      }
    }

    async function saveSettings(updates) {
      try {
        const response = await authFetch(`${API_URL}/api/settings`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(updates)
        });
        if (response.ok) {
          await fetchSettings();
          return { success: true };
        }
        return { success: false, error: 'Save failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function testSlack() {
      try {
        const response = await authFetch(`${API_URL}/api/settings/test-slack`, { method: 'POST' });
        const data = await response.json();
        return data;
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function saveMonitor(monitor) {
      const isNew = !monitor.id;
      const url = isNew ? `${API_URL}/api/monitors` : `${API_URL}/api/monitors/${monitor.id}`;
      const method = isNew ? 'POST' : 'PUT';

      try {
        const response = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(monitor)
        });
        const data = await response.json();
        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          }
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false, error: 'Save failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function deleteMonitor(id) {
      if (!confirm('Are you sure you want to delete this monitor?')) return { success: false };

      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}`, { method: 'DELETE' });
        const data = await response.json();
        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          }
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false, error: 'Delete failed' };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function toggleMonitor(id) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/toggle`, { method: 'PATCH' });
        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          return { success: true };
        }
        return { success: false };
      } catch (e) {
        return { success: false, error: e.message };
      }
    }

    async function saveDevicePosition(id, pos_x, pos_y, tvMode = false) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/position`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pos_x, pos_y, tv_mode: tvMode })
        });
        return response.ok;
      } catch (e) {
        console.error('Failed to save position:', e);
        return false;
      }
    }

    // Update printer floor
    async function updatePrinterFloor(id, floor) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ floor })
        });
        if (response.ok) {
          showAlert('Floor updated', 'success');
          await fetchAllMonitors();
          await fetchAllData();
          render();
        } else {
          showAlert('Failed to update floor', 'error');
        }
      } catch (e) {
        console.error('Failed to update floor:', e);
        showAlert('Failed to update floor', 'error');
      }
    }

    // Update printer serial number
    async function updatePrinterSerial(id, serialNumber) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serial_number: serialNumber })
        });
        if (response.ok) {
          showAlert('Serial number updated', 'success');
          await fetchAllMonitors();
        } else {
          showAlert('Failed to update serial', 'error');
        }
      } catch (e) {
        console.error('Failed to update serial:', e);
        showAlert('Failed to update serial', 'error');
      }
    }

    // Enable serial number editing in analytics panel
    function enableSerialEdit(id) {
      const viewEl = document.getElementById(`serial-view-${id}`);
      const editEl = document.getElementById(`serial-edit-${id}`);
      const inputEl = document.getElementById(`analytics-serial-${id}`);
      if (viewEl && editEl) {
        viewEl.style.display = 'none';
        editEl.style.display = 'flex';
        if (inputEl) inputEl.focus();
      }
    }

    // Save serial number from analytics panel (device click panel)
    async function saveAnalyticsSerial(id, serialNumber) {
      if (!serialNumber || !serialNumber.trim()) {
        showAlert('Please enter a serial number', 'error');
        return;
      }
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ serial_number: serialNumber.trim() })
        });
        if (response.ok) {
          showAlert('Serial number saved', 'success');
          // Update local data
          const monitor = allMonitors.find(m => m.id == id);
          if (monitor) {
            monitor.serial_number = serialNumber.trim();
          }
          // Toggle to view mode
          const viewEl = document.getElementById(`serial-view-${id}`);
          const editEl = document.getElementById(`serial-edit-${id}`);
          const displayEl = document.getElementById(`serial-display-${id}`);
          if (viewEl && editEl && displayEl) {
            displayEl.textContent = serialNumber.trim();
            viewEl.style.display = 'flex';
            editEl.style.display = 'none';
          }
          await fetchAllMonitors();
        } else {
          showAlert('Failed to save serial', 'error');
        }
      } catch (e) {
        console.error('Failed to save serial:', e);
        showAlert('Failed to save serial', 'error');
      }
    }

    // Manual ping device
    async function manualPingDevice(id) {
      const btn = document.getElementById(`ping-btn-${id}`);
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Pinging...';
      }
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/ping`, {
          method: 'POST'
        });
        const result = await response.json();
        if (result.success) {
          const status = result.result.status;
          const ping = result.result.ping;
          showAlert(`Ping ${status === 'up' ? 'successful' : 'failed'}: ${ping ? ping + 'ms' : result.result.message}`, status === 'up' ? 'success' : 'error');
          // Refresh the analytics panel to show updated data
          if (analyticsDevice) {
            await openAnalytics(analyticsDevice.id, analyticsDevice.name, analyticsDevice.type);
          }
          // Also refresh main data
          await fetchAllData();
          render();
        } else {
          showAlert('Ping failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        console.error('Manual ping error:', e);
        showAlert('Ping failed: ' + e.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üì° Ping Now';
        }
      }
    }

    // Manual ping Poly device by IP
    async function manualPingPolyDevice(ip) {
      const btn = document.querySelector(`[id^="ping-btn-poly-"]`);
      if (btn) {
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Pinging...';
      }
      try {
        const response = await authFetch(`${API_URL}/api/ping`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ip })
        });
        const result = await response.json();
        if (result.success) {
          const status = result.result.status;
          const ping = result.result.ping;
          showAlert(`Ping ${status === 'up' ? 'successful' : 'failed'}: ${ping ? ping + 'ms' : result.result.message}`, status === 'up' ? 'success' : 'error');
        } else {
          showAlert('Ping failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        console.error('Manual ping error:', e);
        showAlert('Ping failed: ' + e.message, 'error');
      } finally {
        if (btn) {
          btn.disabled = false;
          btn.innerHTML = 'üì° Ping Now';
        }
      }
    }

    async function uploadFloorPlan(floor, file) {
      return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
          const base64 = e.target.result.split(',')[1];
          const imageType = file.type.split('/')[1];

          try {
            const response = await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(floor)}`, {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ image_data: base64, image_type: imageType })
            });
            if (response.ok) {
              await fetchFloorPlans();
              resolve({ success: true });
            } else {
              resolve({ success: false, error: 'Upload failed' });
            }
          } catch (e) {
            resolve({ success: false, error: e.message });
          }
        };
        reader.readAsDataURL(file);
      });
    }

    async function deleteFloorPlan(floor) {
      if (!confirm(`Delete floor plan for ${floor}?`)) return;

      try {
        await fetch(`${API_URL}/api/floor-plans/${encodeURIComponent(floor)}`, { method: 'DELETE' });
        await fetchFloorPlans();
        renderAdmin();
      } catch (e) {
        console.error('Failed to delete floor plan:', e);
      }
    }

    function toggleAdmin() {
      adminOpen = !adminOpen;
      if (adminOpen) {
        fetchAllMonitors();
        fetchSettings();
        fetchFloorPlans();
        fetchApiIntegrations();
        if (isAdmin()) {
          fetchPendingChangesCount();
        }
      }
      renderAdmin();
    }

    function setAdminTab(tab) {
      adminTab = tab;
      renderAdmin();
    }

    function toggleEditMode() {
      if (editMode) {
        // Exiting edit mode - ask to discard unsaved changes
        if (Object.keys(pendingPositions).length > 0) {
          if (!confirm('You have unsaved position changes. Discard them?')) {
            return;
          }
          pendingPositions = {};
        }
      }
      editMode = !editMode;
      render();
    }

    async function savePositionChanges() {
      const changes = Object.entries(pendingPositions);
      if (changes.length === 0) {
        alert('No changes to save');
        return;
      }

      let saved = 0;
      for (const [deviceId, pos] of changes) {
        let success = false;
        if (pos.isRoom) {
          // Save room position
          success = await saveRoomPosition(deviceId, pos.x, pos.y, pos.floor);
        } else {
          // Save monitor position
          success = await saveDevicePosition(deviceId, pos.x, pos.y);
        }
        if (success) saved++;
      }

      pendingPositions = {};
      editMode = false;
      await fetchAllData();
      render();
      alert(`Saved positions for ${saved} item(s)`);
    }

    async function saveRoomPosition(roomId, pos_x, pos_y, floor) {
      try {
        const response = await authFetch(`${API_URL}/api/room-positions/${encodeURIComponent(roomId)}`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ pos_x, pos_y, floor })
        });
        return response.ok;
      } catch (e) {
        console.error('Failed to save room position:', e);
        return false;
      }
    }

    function cancelPositionChanges() {
      if (Object.keys(pendingPositions).length > 0) {
        if (!confirm('Discard all position changes?')) {
          return;
        }
      }
      pendingPositions = {};
      editMode = false;
      render();
    }

    function getPendingCount() {
      return Object.keys(pendingPositions).length;
    }

    function openEditModal(monitor = null) {
      editingMonitor = monitor ? { ...monitor } : {
        name: '', type: 'ping', hostname: '', url: '', floor: '1st Floor', device_type: 'accessPoints', interval: 30
      };
      renderModal();
    }

    function closeModal() {
      editingMonitor = null;
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderModal() {
      if (!editingMonitor) return;

      const isNew = !editingMonitor.id;
      const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      // Built-in device types
      const builtInTypes = [
        { value: 'accessPoints', label: 'Access Point' },
        { value: 'printers', label: 'Printer' },
        { value: 'polyLens', label: 'Poly Lens Device' }
      ];

      // Combine with custom types
      const allTypes = [...builtInTypes];
      customDeviceTypes.forEach(t => {
        if (!builtInTypes.find(bt => bt.value === t.name)) {
          allTypes.push({ value: t.name, label: t.name, icon: t.icon, color: t.color });
        }
      });

      // Check if current device_type is custom (not in allTypes)
      const currentTypeInList = allTypes.find(t => t.value === editingMonitor.device_type);
      const showCustomInput = editingMonitor.device_type === '__custom__';

      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">${isNew ? 'Add New Device' : 'Edit Device'}</h3>
              <button class="admin-close" onclick="closeModal()">&times;</button>
            </div>
            ${isNew && deviceTemplates.length > 0 ? `
              <div class="form-group">
                <label class="form-label">Quick Templates</label>
                <div class="template-grid">
                  ${deviceTemplates.map(t => `
                    <div class="template-card" onclick="applyTemplate(${JSON.stringify(t).replace(/"/g, '&quot;')})">
                      <div class="template-icon">${t.icon || 'üì±'}</div>
                      <div class="template-name">${t.name}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="edit-name" value="${editingMonitor.name || ''}" placeholder="Device name">
            </div>
            <div class="form-group">
              <label class="form-label">Monitor Type</label>
              <select class="form-select" id="edit-type" onchange="updateModalFields()">
                <option value="ping" ${editingMonitor.type === 'ping' ? 'selected' : ''}>Ping (ICMP)</option>
                <option value="http" ${editingMonitor.type === 'http' ? 'selected' : ''}>HTTP/HTTPS</option>
              </select>
            </div>
            <div class="form-group" id="hostname-group" style="display: ${editingMonitor.type === 'ping' ? 'block' : 'none'}">
              <label class="form-label">Hostname / IP *</label>
              <input type="text" class="form-input" id="edit-hostname" value="${editingMonitor.hostname || ''}" placeholder="192.168.1.1">
            </div>
            <div class="form-group" id="url-group" style="display: ${editingMonitor.type === 'http' ? 'block' : 'none'}">
              <label class="form-label">URL *</label>
              <input type="text" class="form-input" id="edit-url" value="${editingMonitor.url || ''}" placeholder="https://192.168.1.1">
            </div>
            <div class="form-group">
              <label class="form-label">Floor</label>
              <select class="form-select" id="edit-floor">
                ${floors.map(f => `<option value="${f}" ${editingMonitor.floor === f ? 'selected' : ''}>${f}</option>`).join('')}
              </select>
            </div>
            <div class="form-group">
              <label class="form-label">Device Type</label>
              <select class="form-select" id="edit-device-type" onchange="toggleCustomDeviceType()">
                ${allTypes.map(t => `<option value="${t.value}" ${editingMonitor.device_type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
                <option value="__custom__" ${showCustomInput ? 'selected' : ''}>+ Add Custom Type...</option>
              </select>
            </div>
            <div class="form-group" id="custom-device-type-group" style="display: ${showCustomInput ? 'block' : 'none'}">
              <label class="form-label">Custom Device Type Name *</label>
              <input type="text" class="form-input" id="edit-custom-device-type" value="" placeholder="Enter custom type name (e.g., Camera, Switch, Server)">
              <p style="font-size: 11px; color: #64748B; margin-top: 4px;">This will create a new device type that can be reused for other devices.</p>
            </div>
            <div class="form-group">
              <label class="form-label">Check Interval (seconds)</label>
              <input type="number" class="form-input" id="edit-interval" value="${editingMonitor.interval || 30}" min="10" max="3600">
            </div>
            <div class="form-group">
              <label class="form-label">Notes</label>
              <textarea class="form-textarea" id="edit-notes" placeholder="Optional notes about this device...">${editingMonitor.notes || ''}</textarea>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="submitMonitor()">üíæ ${isNew ? 'Add Device' : 'Save Changes'}</button>
              <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
            </div>
          </div>
        </div>
      `;
    }

    function toggleCustomDeviceType() {
      const select = document.getElementById('edit-device-type');
      const customGroup = document.getElementById('custom-device-type-group');
      customGroup.style.display = select.value === '__custom__' ? 'block' : 'none';
    }

    function updateModalFields() {
      const type = document.getElementById('edit-type').value;
      document.getElementById('hostname-group').style.display = type === 'ping' ? 'block' : 'none';
      document.getElementById('url-group').style.display = type === 'http' ? 'block' : 'none';
    }

    async function submitMonitor() {
      let deviceType = document.getElementById('edit-device-type').value;

      // Handle custom device type
      if (deviceType === '__custom__') {
        const customTypeName = document.getElementById('edit-custom-device-type').value.trim();
        if (!customTypeName) {
          alert('Please enter a custom device type name');
          return;
        }

        // Create the new device type
        try {
          const response = await authFetch(`${API_URL}/api/device-types`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: customTypeName })
          });
          const data = await response.json();
          if (data.success) {
            deviceType = customTypeName;
            // Refresh custom device types list
            await fetchCustomDeviceTypes();
          } else {
            // Type might already exist, use it anyway
            deviceType = customTypeName;
          }
        } catch (e) {
          // If creation fails, use the name as-is
          deviceType = customTypeName;
        }
      }

      const monitor = {
        ...editingMonitor,
        name: document.getElementById('edit-name').value,
        type: document.getElementById('edit-type').value,
        hostname: document.getElementById('edit-hostname').value,
        url: document.getElementById('edit-url').value,
        floor: document.getElementById('edit-floor').value,
        device_type: deviceType,
        interval: parseInt(document.getElementById('edit-interval').value) || 30,
        notes: document.getElementById('edit-notes').value || ''
      };

      if (!monitor.name) {
        alert('Name is required');
        return;
      }

      if (monitor.type === 'ping' && !monitor.hostname) {
        alert('Hostname is required for ping monitors');
        return;
      }

      if (monitor.type === 'http' && !monitor.url) {
        alert('URL is required for HTTP monitors');
        return;
      }

      const result = await saveMonitor(monitor);
      if (result.success) {
        closeModal();
        renderAdmin();
      } else {
        alert('Error: ' + (result.error || 'Unknown error'));
      }
    }

    async function submitSettings() {
      const updates = {
        slack_webhook_url: document.getElementById('setting-slack-webhook')?.value || '',
        slack_channel: document.getElementById('setting-slack-channel')?.value || '',
        slack_enabled: document.getElementById('setting-slack-enabled')?.checked ? '1' : '0'
      };

      const result = await saveSettings(updates);
      if (result.success) {
        showAlert('Settings saved!', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Unknown error'), 'error');
      }
    }

    async function submitApiSettings() {
      const updates = {
        poly_lens_client_id: document.getElementById('setting-poly-client-id')?.value || '',
        poly_lens_client_secret: document.getElementById('setting-poly-secret')?.value || ''
      };

      const result = await saveSettings(updates);
      if (result.success) {
        showAlert('API settings saved! Poly Lens will reconnect.', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Unknown error'), 'error');
      }
    }

    async function handleTestSlack() {
      const result = await testSlack();
      if (result.success) {
        showAlert('Test notification sent!', 'success');
      } else {
        showAlert('Error: ' + (result.error || 'Failed to send'), 'error');
      }
    }

    function showAlert(message, type) {
      const alertEl = document.createElement('div');
      alertEl.className = `alert alert-${type}`;
      alertEl.textContent = message;

      const content = document.querySelector('.admin-content');
      if (content) {
        content.insertBefore(alertEl, content.firstChild);
        setTimeout(() => alertEl.remove(), 3000);
      }
    }

    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = 'toast-notification';
      toast.style.cssText = `
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: ${type === 'success' ? 'var(--status-online)' : type === 'error' ? 'var(--status-offline)' : 'var(--accent-blue)'};
        color: white;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        z-index: 100000;
        animation: slideUp 0.3s ease;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
      `;
      toast.textContent = message;
      document.body.appendChild(toast);
      setTimeout(() => {
        toast.style.animation = 'fadeIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }

    // Button loading state helpers
    function setButtonLoading(button, loading, loadingText = 'Loading...') {
      if (!button) return;
      if (loading) {
        button.dataset.originalText = button.textContent;
        button.textContent = loadingText;
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'wait';
      } else {
        button.textContent = button.dataset.originalText || button.textContent;
        button.disabled = false;
        button.style.opacity = '';
        button.style.cursor = '';
      }
    }

    // Async action wrapper with loading state and error handling
    async function withLoading(button, action, { loadingText = 'Saving...', successText = 'Saved!', errorText = 'Failed' } = {}) {
      setButtonLoading(button, true, loadingText);
      try {
        const result = await action();
        if (result?.success !== false) {
          showToast(successText, 'success');
        }
        return result;
      } catch (err) {
        console.error('Action failed:', err);
        showToast(err.message || errorText, 'error');
        throw err;
      } finally {
        setButtonLoading(button, false);
      }
    }

    function handleFloorPlanUpload(floor, input) {
      const file = input.files[0];
      if (file) {
        uploadFloorPlan(floor, file).then(result => {
          if (result.success) {
            showAlert(`Floor plan for ${floor} uploaded!`, 'success');
            render();
            renderAdmin();
          } else {
            showAlert('Upload failed: ' + result.error, 'error');
          }
        });
      }
    }

    function renderAdmin() {
      const overlay = document.getElementById('admin-overlay');
      const panel = document.getElementById('admin-panel');
      const tabsContainer = document.getElementById('admin-tabs-container');

      if (adminOpen) {
        overlay.classList.add('open');
        panel.classList.add('open');
      } else {
        overlay.classList.remove('open');
        panel.classList.remove('open');
        return;
      }

      // Render tabs based on user role
      let tabsHtml = `
        <div class="admin-tab ${adminTab === 'devices' ? 'active' : ''}" onclick="setAdminTab('devices')" data-tab="devices">Devices</div>
        <div class="admin-tab ${adminTab === 'notifications' ? 'active' : ''}" onclick="setAdminTab('notifications')" data-tab="notifications">Notifications</div>
        <div class="admin-tab ${adminTab === 'api' ? 'active' : ''}" onclick="setAdminTab('api')" data-tab="api">API</div>
        <div class="admin-tab ${adminTab === 'floors' ? 'active' : ''}" onclick="setAdminTab('floors')" data-tab="floors">Floor Plans</div>
      `;
      if (isAdmin()) {
        tabsHtml += `<div class="admin-tab ${adminTab === 'users' ? 'active' : ''}" onclick="setAdminTab('users')" data-tab="users">2FA</div>`;
        tabsHtml += `<div class="admin-tab ${adminTab === 'approvals' ? 'active' : ''}" onclick="setAdminTab('approvals')" data-tab="approvals">
          Approvals${pendingChangesCount > 0 ? `<span class="pending-badge">${pendingChangesCount}</span>` : ''}
        </div>`;
      }
      tabsContainer.innerHTML = tabsHtml;

      const filteredMonitors = allMonitors.filter(m =>
        !deviceFilter || m.name.toLowerCase().includes(deviceFilter.toLowerCase()) ||
        (m.hostname && m.hostname.includes(deviceFilter)) ||
        (m.floor && m.floor.toLowerCase().includes(deviceFilter.toLowerCase()))
      );

      // Get all device types including custom ones
      const allDeviceTypeOptions = [
        { value: 'accessPoints', label: 'Access Point' },
        { value: 'printers', label: 'Printer' },
        { value: 'polyLens', label: 'Poly Lens Device' },
        ...customDeviceTypes.filter(t => !['accessPoints', 'printers', 'polyLens'].includes(t.name))
          .map(t => ({ value: t.name, label: t.name }))
      ];

      let content = '';

      if (adminTab === 'devices') {
        content = `
          <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 8px;">
              <h3 class="admin-section-title" style="margin: 0;">Devices (${allMonitors.length})</h3>
              <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                <button class="btn btn-primary btn-sm" onclick="openEditModal()">+ Add Device</button>
                <button class="btn btn-secondary btn-sm" onclick="openBulkImportModal()">üì• Import</button>
                <button class="btn btn-secondary btn-sm" onclick="openDiscoveryModal()">üîç Discover</button>
                <button class="btn btn-secondary btn-sm ${bulkSelectMode ? 'active' : ''}" onclick="toggleBulkSelectMode()">
                  ‚òëÔ∏è ${bulkSelectMode ? 'Cancel' : 'Bulk'}
                </button>
              </div>
            </div>
            ${bulkSelectMode && selectedDevices.size > 0 ? `
              <div class="bulk-actions-bar">
                <span class="bulk-selected-count">${selectedDevices.size} selected</span>
                <div class="bulk-actions-btns">
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('activate')">Activate</button>
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('deactivate')">Deactivate</button>
                  <button class="btn btn-sm btn-secondary" onclick="bulkAction('move_floor')">Move</button>
                  <button class="btn btn-sm btn-danger" onclick="bulkAction('delete')">Delete</button>
                </div>
                <button class="btn btn-sm btn-secondary" onclick="selectAllAdminDevices()">All</button>
                <button class="btn btn-sm btn-secondary" onclick="deselectAllAdminDevices()">None</button>
              </div>
            ` : ''}
            <div class="filter-bar">
              <div class="search-box" style="flex: 1; margin-bottom: 0;">
                <input type="text" placeholder="Search devices..." value="${deviceFilter}"
                  onkeyup="deviceFilter = this.value; renderAdmin()">
              </div>
              <select class="filter-select" style="width: auto; min-width: 120px;" onchange="if(this.value) applySavedFilter(this.value)">
                <option value="">Saved Filters</option>
                ${savedFilters.map(f => `<option value="${f.id}" ${activeFilter == f.id ? 'selected' : ''}>${f.name}</option>`).join('')}
              </select>
              <button class="btn btn-sm btn-secondary" onclick="saveCurrentFilter()" title="Save current filter">üíæ</button>
            </div>
            <div class="device-list">
              ${filteredMonitors.map(m => `
                <div class="device-item" oncontextmenu="showContextMenu(event, ${JSON.stringify(m).replace(/"/g, '&quot;')}); return false;">
                  ${bulkSelectMode ? `
                    <input type="checkbox" class="bulk-checkbox device-checkbox"
                      ${selectedDevices.has(m.id) ? 'checked' : ''}
                      onclick="event.stopPropagation(); toggleAdminDeviceSelection(${m.id})">
                  ` : ''}
                  <div class="device-info">
                    <div class="device-name">
                      <span style="color: ${m.status === 'up' ? '#22C55E' : m.status === 'down' ? '#EF4444' : '#6B7280'};">‚óè</span>
                      ${sanitizeHTML(m.name)}
                      ${m.health_score !== null && m.health_score !== undefined ? renderHealthBadge(m.health_score) : ''}
                    </div>
                    <div class="device-meta">
                      ${sanitizeHTML(m.hostname || m.url || '')} ¬∑ ${sanitizeHTML(m.floor || 'No floor')} ¬∑ ${sanitizeHTML(m.device_type || m.type)}
                      ${m.notes ? `¬∑ <span title="${sanitizeHTML(m.notes)}">üìù</span>` : ''}
                    </div>
                  </div>
                  <div class="device-actions">
                    ${isAdmin() ? `
                      <label class="toggle-switch">
                        <input type="checkbox" ${m.active ? 'checked' : ''} onchange="toggleMonitor(${m.id})">
                        <span class="toggle-slider"></span>
                      </label>
                    ` : ''}
                    <button class="btn btn-secondary btn-sm" onclick="openEditModal(${JSON.stringify(m).replace(/"/g, '&quot;')})">‚úèÔ∏è</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteMonitor(${m.id})">üóëÔ∏è</button>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      } else if (adminTab === 'notifications') {
        const canEdit = isAdmin();
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Webhook Notifications</h3>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Send alerts to any webhook-compatible service: Slack, Discord, Microsoft Teams, Telegram bots, or custom endpoints.
            </p>
            ${!canEdit ? '<p style="color: #F59E0B; font-size: 13px; margin-bottom: 12px;">‚ö†Ô∏è Only admins can edit notification settings</p>' : ''}
            <div class="form-group">
              <label class="form-label">Webhook URL</label>
              <input type="text" class="form-input" id="setting-slack-webhook"
                value="${settings.slack_webhook_url || ''}" placeholder="https://hooks.slack.com/... or https://discord.com/api/webhooks/... or any webhook URL" ${!canEdit ? 'disabled' : ''}>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Examples: Slack, Discord, Teams, Telegram Bot API, n8n, Zapier, Make, or any custom endpoint
              </small>
            </div>
            <div class="form-group">
              <label class="form-label">Channel / Target (optional)</label>
              <input type="text" class="form-input" id="setting-slack-channel"
                value="${settings.slack_channel || ''}" placeholder="#channel, @user, or chat_id" ${!canEdit ? 'disabled' : ''}>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Depends on your platform - may be channel name, user ID, or chat ID
              </small>
            </div>
            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                  <input type="checkbox" id="setting-slack-enabled" ${settings.slack_enabled === '1' ? 'checked' : ''} ${!canEdit ? 'disabled' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                Enable webhook notifications
              </label>
            </div>
            ${canEdit ? `
              <div class="btn-group">
                <button class="btn btn-primary" onclick="submitSettings()">üíæ Save</button>
                <button class="btn btn-secondary" onclick="handleTestSlack()">üîî Send Test</button>
              </div>
            ` : ''}
          </div>
        `;
      } else if (adminTab === 'api') {
        const canEdit = isAdmin();
        content = `
          <div class="admin-section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
              <h3 class="admin-section-title" style="margin: 0;">External Integrations</h3>
              <button class="btn btn-primary btn-sm" onclick="openApiModal()">+ Add Integration</button>
            </div>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Connect to external services and APIs: monitoring systems, device management platforms, IoT hubs, or any REST API.
            </p>
            ${!canEdit ? '<p style="color: #F59E0B; font-size: 13px; margin-bottom: 12px;">‚ö†Ô∏è Editing integrations requires admin approval</p>' : ''}
            ${apiIntegrations.map(api => `
              <div class="api-item">
                <div class="api-item-info">
                  <h4>
                    <span class="api-type-badge">${api.type}</span>
                    ${api.name}
                  </h4>
                  <div class="api-item-meta">
                    ${api.client_id ? `ID: ${api.client_id.substring(0, 10)}...` : api.webhook_url ? 'Webhook configured' : 'No credentials'}
                    ¬∑ ${api.active ? '<span style="color: #22C55E;">Active</span>' : '<span style="color: #EF4444;">Inactive</span>'}
                  </div>
                </div>
                <div class="device-actions">
                  <button class="btn btn-secondary btn-sm" onclick="openApiModal(${JSON.stringify(api).replace(/"/g, '&quot;')})">‚úèÔ∏è Edit</button>
                </div>
              </div>
            `).join('')}
            ${apiIntegrations.length === 0 ? `
              <div style="text-align: center; padding: 24px; color: #64748B; background: var(--bg-base); border-radius: 8px;">
                <div style="font-size: 24px; margin-bottom: 8px;">üîå</div>
                <p style="margin: 0 0 4px 0;">No integrations configured</p>
                <small>Add connections to Poly Lens, LibreNMS, Zabbix, or any custom API</small>
              </div>
            ` : ''}
          </div>
        `;
      } else if (adminTab === 'floors') {
        const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Floor Plans</h3>
            <p style="color: #94A3B8; font-size: 13px; margin-bottom: 16px;">
              Upload blueprint images for each floor. Supported formats: PNG, JPG, SVG
            </p>
            ${floors.map(floor => {
              const plan = floorPlans[floor];
              return `
                <div style="margin-bottom: 16px;">
                  <label class="form-label">${floor}</label>
                  <div class="floor-plan-upload ${plan ? 'has-image' : ''}"
                    onclick="document.getElementById('upload-${floor.replace(/\s/g, '')}').click()">
                    ${plan ? `
                      <img src="data:image/${plan.image_type};base64,${plan.image_data || ''}"
                        class="floor-plan-preview" alt="${floor}" onerror="this.style.display='none'">
                      <div style="margin-top: 8px;">
                        <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation();">Change</button>
                        <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteFloorPlan('${floor}')">Remove</button>
                      </div>
                    ` : `
                      <div class="upload-icon">üìÅ</div>
                      <div class="upload-text">Click to upload floor plan</div>
                    `}
                  </div>
                  <input type="file" id="upload-${floor.replace(/\s/g, '')}" accept="image/*" style="display: none"
                    onchange="handleFloorPlanUpload('${floor}', this)">
                </div>
              `;
            }).join('')}
          </div>
        `;
      } else if (adminTab === 'users' && isAdmin()) {
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">User Management</h3>
            <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">
              Manage user accounts and security settings. Enable Slack 2FA to require admin approval for logins.
            </p>
            <button class="btn btn-primary btn-sm" onclick="openCreateUserModal()" style="margin-bottom: 16px;">+ Add User</button>
            <div id="users-list">
              <p style="color: var(--text-muted); text-align: center; padding: 20px;">Loading users...</p>
            </div>
          </div>
        `;
        // Load users after render
        setTimeout(loadUsers, 0);
      } else if (adminTab === 'approvals' && isAdmin()) {
        content = `
          <div class="admin-section">
            <h3 class="admin-section-title">Pending Approvals</h3>
            <div id="pending-changes-list"></div>
          </div>
        `;
        // Load pending changes after render
        setTimeout(loadPendingChanges, 0);
      }

      document.getElementById('admin-content').innerHTML = content;
    }

    async function loadPendingChanges() {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes`);
        const data = await response.json();
        const changes = data.changes || [];

        const container = document.getElementById('pending-changes-list');
        if (!container) return;

        if (changes.length === 0) {
          container.innerHTML = '<p style="color: #64748B; text-align: center; padding: 20px;">No pending changes</p>';
          return;
        }

        container.innerHTML = changes.map(change => {
          const changeData = JSON.parse(change.data);
          return `
            <div class="device-item" style="margin-bottom: 12px;">
              <div class="device-info">
                <div class="device-name">
                  <span class="api-type-badge">${change.change_type}</span>
                  ${change.entity_type}: ${changeData.name || `ID ${change.entity_id}`}
                </div>
                <div class="device-meta">
                  Requested by: ${change.requested_by} ¬∑ ${formatIsraelTime(change.created_at)}
                </div>
              </div>
              <div class="device-actions">
                <button class="btn btn-primary btn-sm" onclick="approveChange(${change.id})">‚úì Approve</button>
                <button class="btn btn-danger btn-sm" onclick="rejectChange(${change.id})">‚úó Reject</button>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('Failed to load pending changes:', e);
      }
    }

    async function approveChange(id) {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/${id}/approve`, { method: 'POST' });
        if (response.ok) {
          showAlert('Change approved!', 'success');
          await fetchPendingChangesCount();
          await fetchAllMonitors();
          await fetchAllData();
          loadPendingChanges();
          render();
        }
      } catch (e) {
        showAlert('Failed to approve change', 'error');
      }
    }

    async function rejectChange(id) {
      try {
        const response = await authFetch(`${API_URL}/api/pending-changes/${id}/reject`, { method: 'POST' });
        if (response.ok) {
          showAlert('Change rejected', 'success');
          await fetchPendingChangesCount();
          loadPendingChanges();
          render();
        }
      } catch (e) {
        showAlert('Failed to reject change', 'error');
      }
    }

    // ==================== USER MANAGEMENT ====================
    let allUsers = [];

    async function loadUsers() {
      try {
        const response = await authFetch(`${API_URL}/api/users`);
        const data = await response.json();

        if (!data.success) {
          throw new Error(data.error || 'Failed to load users');
        }

        allUsers = data.users || [];
        renderUsersList();
      } catch (e) {
        console.error('Failed to load users:', e);
        const container = document.getElementById('users-list');
        if (container) {
          container.innerHTML = '<p style="color: var(--status-offline); text-align: center; padding: 20px;">Failed to load users</p>';
        }
      }
    }

    function renderUsersList() {
      const container = document.getElementById('users-list');
      if (!container) return;

      if (allUsers.length === 0) {
        container.innerHTML = '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No users found</p>';
        return;
      }

      container.innerHTML = allUsers.map(user => `
        <div class="device-item" style="margin-bottom: 12px;">
          <div class="device-info">
            <div class="device-name">
              <span style="color: var(--accent-blue);">üë§</span>
              ${sanitizeHTML(user.username)}
              ${user.id === currentUser.id ? '<span style="font-size: 11px; color: var(--text-muted); margin-left: 8px;">(you)</span>' : ''}
              ${user.is_locked ? '<span style="font-size: 11px; background: var(--status-offline); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 8px;">üîí Locked</span>' : ''}
            </div>
            <div class="device-meta">
              Role: <strong>${user.role}</strong> ¬∑
              Created: ${formatIsraelTime(user.created_at)}
              ${user.slack_2fa_enabled ? '¬∑ <span style="color: var(--status-online);">üîê Slack 2FA enabled</span>' : ''}
              ${user.is_locked ? `¬∑ <span style="color: var(--status-offline);">Locked until ${formatIsraelTime(user.locked_until)}</span>` : ''}
            </div>
          </div>
          <div class="device-actions" style="display: flex; align-items: center; gap: 12px;">
            <label class="toggle-switch" title="${user.slack_2fa_enabled ? 'Disable' : 'Enable'} Slack 2FA">
              <input type="checkbox" ${user.slack_2fa_enabled ? 'checked' : ''}
                onchange="toggleSlack2FA(${user.id}, this.checked)"
                ${user.id === currentUser.id ? 'disabled title="Cannot change your own 2FA setting"' : ''}>
              <span class="toggle-slider"></span>
            </label>
            <span style="font-size: 11px; color: var(--text-muted); min-width: 60px;">Slack 2FA</span>
            ${user.is_locked ? `
              <button class="btn btn-warning btn-sm" onclick="unlockUser(${user.id}, '${sanitizeHTML(user.username)}')">üîì Unlock</button>
            ` : ''}
            ${user.id !== currentUser.id ? `
              <button class="btn btn-secondary btn-sm" onclick="resetUserPassword(${user.id}, '${sanitizeHTML(user.username)}')">üîë Reset</button>
              <button class="btn btn-danger btn-sm" onclick="deleteUser(${user.id}, '${sanitizeHTML(user.username)}')">üóëÔ∏è</button>
            ` : ''}
          </div>
        </div>
      `).join('');
    }

    async function toggleSlack2FA(userId, enabled) {
      try {
        const response = await authFetch(`${API_URL}/api/users/${userId}/slack-2fa`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ enabled })
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`Slack 2FA ${enabled ? 'enabled' : 'disabled'} successfully`, 'success');
          // Update local state
          const userIndex = allUsers.findIndex(u => u.id === userId);
          if (userIndex !== -1) {
            allUsers[userIndex].slack_2fa_enabled = enabled ? 1 : 0;
          }
        } else {
          throw new Error(data.error || 'Failed to toggle Slack 2FA');
        }
      } catch (e) {
        showAlert('Failed to toggle Slack 2FA: ' + e.message, 'error');
        // Reload to reset checkbox state
        loadUsers();
      }
    }

    async function deleteUser(userId, username) {
      if (!confirm(`Are you sure you want to delete user "${username}"? This cannot be undone.`)) {
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/users/${userId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`User "${username}" deleted successfully`, 'success');
          loadUsers();
        } else {
          throw new Error(data.error || 'Failed to delete user');
        }
      } catch (e) {
        showAlert('Failed to delete user: ' + e.message, 'error');
      }
    }

    async function unlockUser(userId, username) {
      if (!confirm(`Unlock account for "${username}"?`)) {
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/users/${userId}/unlock`, {
          method: 'POST'
        });

        const data = await response.json();

        if (data.success) {
          showAlert(`Account "${username}" unlocked successfully`, 'success');
          loadUsers();
        } else {
          throw new Error(data.error || 'Failed to unlock user');
        }
      } catch (e) {
        showAlert('Failed to unlock user: ' + e.message, 'error');
      }
    }

    // Generate a secure random password for admin reset
    function generateTempPassword() {
      const upper = 'ABCDEFGHJKLMNPQRSTUVWXYZ';
      const lower = 'abcdefghjkmnpqrstuvwxyz';
      const nums = '23456789';
      const special = '!@#$%&*';
      let pwd = '';
      pwd += upper[Math.floor(Math.random() * upper.length)];
      pwd += lower[Math.floor(Math.random() * lower.length)];
      pwd += nums[Math.floor(Math.random() * nums.length)];
      pwd += special[Math.floor(Math.random() * special.length)];
      const all = upper + lower + nums + special;
      for (let i = pwd.length; i < 12; i++) {
        pwd += all[Math.floor(Math.random() * all.length)];
      }
      return pwd.split('').sort(() => Math.random() - 0.5).join('');
    }

    async function resetUserPassword(userId, username) {
      if (!confirm(`Reset password for "${username}"? A new random password will be generated and they will be required to change it on next login.`)) {
        return;
      }

      const tempPassword = generateTempPassword();

      try {
        const response = await authFetch(`${API_URL}/api/users/${userId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ password: tempPassword, role: allUsers.find(u => u.id === userId)?.role || 'user' })
        });

        const data = await response.json();

        if (data.success) {
          // Also mark password reset required
          await authFetch(`${API_URL}/api/auth/admin-password-reset/${userId}`, {
            method: 'POST'
          }).catch(() => {});

          // Show password in a modal so admin can copy it
          alert(`Password for "${username}" has been reset.\n\nTemporary password: ${tempPassword}\n\nPlease share this securely with the user. They will be required to change it on next login.`);
          showAlert(`Password for "${username}" has been reset`, 'success');
        } else {
          throw new Error(data.error || 'Failed to reset password');
        }
      } catch (e) {
        showAlert('Failed to reset password: ' + e.message, 'error');
      }
    }

    function openCreateUserModal() {
      const modal = document.createElement('div');
      modal.className = 'modal-overlay';
      modal.id = 'create-user-modal';
      modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
          <div class="modal-header">
            <h3>Create New User</h3>
            <button class="modal-close" onclick="closeCreateUserModal()">√ó</button>
          </div>
          <div class="modal-content">
            <div class="form-group">
              <label class="form-label">Username</label>
              <input type="text" class="form-input" id="new-user-username" placeholder="Enter username" required>
            </div>
            <div class="form-group">
              <label class="form-label">Password</label>
              <input type="password" class="form-input" id="new-user-password" placeholder="Enter password (min 12 chars)" required minlength="12">
              <div style="font-size: 11px; color: var(--text-muted); margin-top: 4px;">
                12+ chars with uppercase, lowercase, number, and special character
              </div>
            </div>
            <div class="form-group">
              <label class="form-label">Role</label>
              <select class="form-select" id="new-user-role">
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                <input type="checkbox" id="new-user-slack-2fa">
                Enable Slack 2FA (require login approval)
              </label>
            </div>
          </div>
          <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeCreateUserModal()">Cancel</button>
            <button class="btn btn-primary" onclick="createUser()">Create User</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function closeCreateUserModal() {
      const modal = document.getElementById('create-user-modal');
      if (modal) modal.remove();
    }

    async function createUser() {
      const username = document.getElementById('new-user-username').value.trim();
      const password = document.getElementById('new-user-password').value;
      const role = document.getElementById('new-user-role').value;
      const slack2fa = document.getElementById('new-user-slack-2fa').checked;

      if (!username || !password) {
        showAlert('Username and password are required', 'error');
        return;
      }

      if (password.length < 6) {
        showAlert('Password must be at least 6 characters', 'error');
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/users`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, role })
        });

        const data = await response.json();

        if (data.success) {
          // If Slack 2FA should be enabled, do that now
          if (slack2fa && data.id) {
            await authFetch(`${API_URL}/api/users/${data.id}/slack-2fa`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ enabled: true })
            }).catch(() => {});
          }

          showAlert(`User "${username}" created successfully`, 'success');
          closeCreateUserModal();
          loadUsers();
        } else {
          throw new Error(data.error || 'Failed to create user');
        }
      } catch (e) {
        showAlert('Failed to create user: ' + e.message, 'error');
      }
    }

    // ==================== API MODAL ====================
    let editingApi = null;

    function openApiModal(api = null) {
      editingApi = api ? { ...api } : {
        name: '',
        type: 'poly_lens',
        client_id: '',
        client_secret: '',
        webhook_url: '',
        config: '',
        active: 1
      };
      renderApiModal();
    }

    function closeApiModal() {
      editingApi = null;
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderApiModal() {
      if (!editingApi) return;

      const isNew = !editingApi.id;
      const apiTypes = [
        { value: 'poly_lens', label: 'Poly Lens / Poly API' },
        { value: 'librenms', label: 'LibreNMS' },
        { value: 'zabbix', label: 'Zabbix' },
        { value: 'prtg', label: 'PRTG Network Monitor' },
        { value: 'webhook', label: 'Webhook (Slack, Discord, Teams, etc.)' },
        { value: 'custom', label: 'Custom REST API' }
      ];

      const showCredentials = ['poly_lens', 'librenms', 'zabbix', 'prtg', 'custom'].includes(editingApi.type);
      const showWebhook = ['webhook', 'custom'].includes(editingApi.type);

      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeApiModal()">
          <div class="modal-content">
            <div class="modal-header">
              <h3 class="modal-title">${isNew ? 'Add External Integration' : 'Edit Integration'}</h3>
              <button class="admin-close" onclick="closeApiModal()">&times;</button>
            </div>
            <p style="color: #94A3B8; font-size: 12px; margin-bottom: 16px;">
              Connect to monitoring systems, device APIs, or any REST endpoint.
            </p>
            <div class="form-group">
              <label class="form-label">Name *</label>
              <input type="text" class="form-input" id="edit-api-name" value="${editingApi.name || ''}" placeholder="e.g., Production Monitoring, Office Network">
            </div>
            <div class="form-group">
              <label class="form-label">Integration Type</label>
              <select class="form-select" id="edit-api-type" onchange="updateApiModalFields()">
                ${apiTypes.map(t => `<option value="${t.value}" ${editingApi.type === t.value ? 'selected' : ''}>${t.label}</option>`).join('')}
              </select>
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Select a preset or use Custom REST API for any other service
              </small>
            </div>
            <div class="form-group" id="api-webhook-group" style="display: ${showWebhook ? 'block' : 'none'}">
              <label class="form-label">API URL / Webhook URL</label>
              <input type="text" class="form-input" id="edit-api-webhook" value="${editingApi.webhook_url || ''}" placeholder="https://your-server.com/api/...">
              <small style="color: #64748B; font-size: 11px; margin-top: 4px; display: block;">
                Base URL for API requests or full webhook endpoint
              </small>
            </div>
            <div class="form-group" id="api-client-id-group" style="display: ${showCredentials ? 'block' : 'none'}">
              <label class="form-label">API Key / Client ID</label>
              <input type="text" class="form-input" id="edit-api-client-id" value="${editingApi.client_id || ''}" placeholder="API key, Client ID, or username">
            </div>
            <div class="form-group" id="api-client-secret-group" style="display: ${showCredentials ? 'block' : 'none'}">
              <label class="form-label">Secret / Token ${!isNew ? '(leave blank to keep existing)' : ''}</label>
              <input type="password" class="form-input" id="edit-api-client-secret" value="" placeholder="${isNew ? 'API secret, token, or password' : '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢'}">
            </div>
            <div class="form-group">
              <label class="form-label" style="display: flex; align-items: center; gap: 12px;">
                <label class="toggle-switch">
                  <input type="checkbox" id="edit-api-active" ${editingApi.active ? 'checked' : ''}>
                  <span class="toggle-slider"></span>
                </label>
                Active
              </label>
            </div>
            <div class="btn-group">
              <button class="btn btn-primary" onclick="submitApi()">üíæ ${isNew ? 'Add Integration' : 'Save Changes'}</button>
              <button class="btn btn-secondary" onclick="closeApiModal()">Cancel</button>
            </div>
          </div>
        </div>
      `;
    }

    function updateApiModalFields() {
      const type = document.getElementById('edit-api-type').value;
      const showCredentials = ['poly_lens', 'librenms', 'zabbix', 'prtg', 'custom'].includes(type);
      const showWebhook = ['webhook', 'custom'].includes(type);

      document.getElementById('api-client-id-group').style.display = showCredentials ? 'block' : 'none';
      document.getElementById('api-client-secret-group').style.display = showCredentials ? 'block' : 'none';
      document.getElementById('api-webhook-group').style.display = showWebhook ? 'block' : 'none';
    }

    async function submitApi() {
      const api = {
        ...editingApi,
        name: document.getElementById('edit-api-name').value,
        type: document.getElementById('edit-api-type').value,
        client_id: document.getElementById('edit-api-client-id').value,
        client_secret: document.getElementById('edit-api-client-secret').value || editingApi.client_secret,
        webhook_url: document.getElementById('edit-api-webhook').value,
        active: document.getElementById('edit-api-active').checked ? 1 : 0
      };

      if (!api.name) {
        alert('Name is required');
        return;
      }

      const isNew = !api.id;
      const url = isNew ? `${API_URL}/api/integrations` : `${API_URL}/api/integrations/${api.id}`;
      const method = isNew ? 'POST' : 'PUT';

      try {
        const response = await authFetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(api)
        });
        const data = await response.json();

        if (data.success) {
          if (data.pending) {
            showAlert(data.message, 'success');
          } else {
            showAlert(isNew ? 'API integration added!' : 'API integration updated!', 'success');
          }
          await fetchApiIntegrations();
          closeApiModal();
          renderAdmin();
        } else {
          alert('Error: ' + (data.error || 'Unknown error'));
        }
      } catch (e) {
        alert('Error: ' + e.message);
      }
    }

    // ==================== ANALYTICS SIDEBAR ====================
    let analyticsOpen = false;
    let analyticsDevice = null;
    let analyticsData = null;
    let analyticsRefreshInterval = null;

    async function fetchAnalyticsData(deviceId, isRoom, roomName = null, isPolyDevice = false, polyDeviceData = null) {
      if (isRoom) {
        // Get room devices from polyLensData
        const roomDevices = [];
        Object.values(polyLensData).forEach(floorDevices => {
          floorDevices.forEach(device => {
            if (device.room === roomName) {
              roomDevices.push(device);
            }
          });
        });

        // Count only non-disabled devices for status
        const activeDevices = roomDevices.filter(d => !d.disabled);
        const onlineCount = activeDevices.filter(d => d.connected).length;
        const offlineCount = activeDevices.filter(d => !d.connected).length;
        const disabledCount = roomDevices.filter(d => d.disabled).length;
        const uptime = activeDevices.length > 0 ? ((onlineCount / activeDevices.length) * 100).toFixed(1) : 100;

        return {
          isRoom: true,
          roomName: roomName,
          devices: roomDevices,
          onlineCount,
          offlineCount,
          disabledCount,
          totalCount: roomDevices.length,
          activeCount: activeDevices.length,
          currentUptime: uptime
        };
      }

      if (isPolyDevice && polyDeviceData) {
        // Fetch real analytics data for Poly device from our database
        try {
          const polyDeviceId = polyDeviceData.id;

          // Fetch uptime stats
          const uptimeRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=24`);
          const uptimeData = uptimeRes.ok ? await uptimeRes.json() : null;

          // Fetch history
          const historyRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/history?limit=50`);
          const historyData = historyRes.ok ? await historyRes.json() : null;

          // Get 7 day uptime
          const uptime7dRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=168`);
          const uptime7dData = uptime7dRes.ok ? await uptime7dRes.json() : null;

          // Get 30 day uptime
          const uptime30dRes = await fetch(`${API_URL}/api/poly-devices/${polyDeviceId}/uptime?hours=720`);
          const uptime30dData = uptime30dRes.ok ? await uptime30dRes.json() : null;

          return {
            isPolyDevice: true,
            device: polyDeviceData,
            connected: polyDeviceData.connected,
            name: polyDeviceData.name,
            model: polyDeviceData.hardwareModel,
            ip: polyDeviceData.ip,
            serialNumber: polyDeviceData.serialNumber,
            softwareVersion: polyDeviceData.softwareVersion,
            room: polyDeviceData.room,
            lastSeen: polyDeviceData.lastSeen,
            // Analytics data from our database
            uptime24h: uptimeData?.uptime || 0,
            uptime7d: uptime7dData?.uptime || 0,
            uptime30d: uptime30dData?.uptime || 0,
            totalChecks: uptimeData?.total || 0,
            heartbeats: historyData?.heartbeats || []
          };
        } catch (e) {
          console.error('Failed to fetch Poly device analytics:', e);
          // Fallback to basic data
          return {
            isPolyDevice: true,
            device: polyDeviceData,
            connected: polyDeviceData.connected,
            name: polyDeviceData.name,
            model: polyDeviceData.hardwareModel,
            ip: polyDeviceData.ip,
            serialNumber: polyDeviceData.serialNumber,
            softwareVersion: polyDeviceData.softwareVersion,
            room: polyDeviceData.room,
            lastSeen: polyDeviceData.lastSeen,
            noHistory: true
          };
        }
      }

      try {
        // Get monitor info for maintenance/disabled status
        const monitor = allMonitors.find(m => m.id == deviceId);

        // Also look up from monitorData for IP (sidebar data has ip field)
        let sidebarDevice = null;
        Object.values(monitorData).forEach(floorData => {
          if (floorData.accessPoints) {
            const found = floorData.accessPoints.find(d => d.id == deviceId);
            if (found) sidebarDevice = found;
          }
          if (floorData.printers) {
            const found = floorData.printers.find(d => d.id == deviceId);
            if (found) sidebarDevice = found;
          }
        });

        // Fetch uptime stats
        const uptimeRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=24`);
        const uptimeData = uptimeRes.ok ? await uptimeRes.json() : null;

        // Fetch history
        const historyRes = await fetch(`${API_URL}/api/monitors/${deviceId}/history?limit=50`);
        const historyData = historyRes.ok ? await historyRes.json() : null;

        // Get 7 day uptime
        const uptime7dRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=168`);
        const uptime7dData = uptime7dRes.ok ? await uptime7dRes.json() : null;

        // Get 30 day uptime
        const uptime30dRes = await fetch(`${API_URL}/api/monitors/${deviceId}/uptime?hours=720`);
        const uptime30dData = uptime30dRes.ok ? await uptime30dRes.json() : null;

        // For printers, also fetch printer status which contains serial number from SNMP
        let printerSerial = null;
        if (monitor?.device_type === 'printers') {
          const printerStatusRes = await fetch(`${API_URL}/api/printers/${deviceId}/status`);
          if (printerStatusRes.ok) {
            const printerStatusData = await printerStatusRes.json();
            printerSerial = printerStatusData?.info?.serialNumber || null;
          }
        }

        return {
          uptime24h: uptimeData?.uptime || 0,
          uptime7d: uptime7dData?.uptime || 0,
          uptime30d: uptime30dData?.uptime || 0,
          totalChecks: uptimeData?.total || 0,
          heartbeats: historyData?.heartbeats || [],
          maintenance: monitor?.maintenance || 0,
          disabled: monitor?.disabled || 0,
          // Device info fields
          name: monitor?.name || sidebarDevice?.name || null,
          hostname: sidebarDevice?.ip || monitor?.hostname || null,
          floor: monitor?.floor || null,
          serial_number: printerSerial || monitor?.serial_number || null
        };
      } catch (e) {
        console.error('Failed to fetch analytics:', e);
        return { error: true };
      }
    }

    async function refreshAnalytics() {
      if (!analyticsDevice || !analyticsOpen) return;

      console.log('Refreshing analytics data...');
      analyticsData = await fetchAnalyticsData(
        analyticsDevice.id,
        analyticsDevice.isRoom,
        analyticsDevice.name,
        analyticsDevice.isPolyDevice,
        analyticsDevice.polyDeviceData
      );
      renderAnalyticsSidebar(false);
    }

    // Open details for Zoom-only room (no Poly device)
    async function openZoomRoomDetails(roomId, roomName) {
      // Clear any existing refresh interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }

      // Find the room data from zoomOnlyRooms or fetch fresh data
      let roomData = null;
      Object.values(zoomOnlyRooms).forEach(rooms => {
        const found = rooms.find(r => r.id === roomId);
        if (found) roomData = found;
      });

      // If not found in zoomOnlyRooms, try to fetch from all zoom rooms
      if (!roomData) {
        try {
          const response = await fetch(`${API_URL}/api/zoom-rooms`);
          if (response.ok) {
            const data = await response.json();
            roomData = data.rooms?.find(r => r.id === roomId);
          }
        } catch (e) {
          console.error('Failed to fetch Zoom room data:', e);
        }
      }

      if (!roomData) return;

      // Show in right sidebar using the standard analytics container
      analyticsOpen = true;
      analyticsDevice = { id: roomId, name: roomName, type: 'zoomRoom', isRoom: true, isZoomOnly: true };

      // Mark device as selected in sidebar
      markDeviceSelected(roomId);

      const statusColor = roomData.zoom_status === 'Available' ? 'var(--status-online)' :
                          roomData.zoom_status === 'InMeeting' ? 'var(--status-warning)' :
                          'var(--status-offline)';
      const statusText = roomData.zoom_status === 'Available' ? 'Available' :
                         roomData.zoom_status === 'InMeeting' ? 'In Meeting' :
                         roomData.zoom_status === 'Offline' ? 'Offline' :
                         roomData.zoom_status || 'Unknown';

      const devices = roomData.zoom_devices || [];
      const onlineDevices = devices.filter(d => d.status === 'Online').length;
      const totalDevices = devices.length;

      // Fetch uptime history if available
      let uptimeData = null;
      try {
        const uptimeResponse = await fetch(`${API_URL}/api/zoom-rooms/${roomId}/history`);
        if (uptimeResponse.ok) {
          uptimeData = await uptimeResponse.json();
        }
      } catch (e) {
        // Uptime history not available yet
      }

      // Fetch meeting utilization data
      const utilizationData = await fetchRoomUtilization(roomId);

      const uptimePercent = uptimeData?.uptime_percent ?? null;
      const historyData = uptimeData?.history || [];

      // Build uptime bar from history (last 24 hours)
      let uptimeBarHTML = '';
      if (historyData.length > 0) {
        const segments = [];
        const now = new Date();
        for (let i = 47; i >= 0; i--) {
          const segmentEnd = new Date(now - i * 30 * 60 * 1000);
          const segmentStart = new Date(segmentEnd - 30 * 60 * 1000);

          const segmentRecords = historyData.filter(h => {
            const time = new Date(h.time);
            return time >= segmentStart && time < segmentEnd;
          });

          let status = 'unknown';
          if (segmentRecords.length > 0) {
            const anyDown = segmentRecords.some(h => h.status === 'Offline');
            status = anyDown ? 'down' : 'up';
          }
          segments.push({ status, time: segmentStart });
        }

        uptimeBarHTML = `
          <div class="uptime-bar" style="display: flex; height: 24px; gap: 1px; border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
            ${segments.map((s, i) => `
              <div style="flex: 1; background: ${s.status === 'up' ? 'var(--status-online)' : s.status === 'down' ? 'var(--status-offline)' : 'var(--bg-overlay)'};"
                   title="${s.time.toLocaleTimeString()} - ${s.status}"></div>
            `).join('')}
          </div>
          <div style="display: flex; justify-content: space-between; font-size: 10px; color: var(--text-muted);">
            <span>24h ago</span>
            <span>Now</span>
          </div>
        `;
      }

      // Render in the standard analytics container
      document.getElementById('analytics-container').innerHTML = `
        <div class="analytics-overlay ${analyticsOpen ? 'open' : ''}" onclick="closeAnalytics()"></div>
        <div class="analytics-sidebar ${analyticsOpen ? 'open' : ''}">
          <div class="analytics-header">
            <div class="analytics-header-top">
              <div>
                <h2 class="analytics-title">üé• ${roomName}</h2>
                <p class="analytics-subtitle">Zoom Room ‚Ä¢ ${roomData.floor || 'Unknown Floor'}</p>
              </div>
              <button class="analytics-close" onclick="closeAnalytics()">&times;</button>
            </div>
            <div class="analytics-status ${roomData.zoom_status === 'Available' ? 'up' : roomData.zoom_status === 'InMeeting' ? 'warning' : 'down'}">
              <span style="font-size: 10px;">‚óè</span>
              ${statusText}
              ${roomData.zoom_in_meeting ? ' ‚Ä¢ üìû In Call' : ''}
            </div>
          </div>

          <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
            <button onclick="highlightDevice('zoom-${roomId}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
              üìç Locate on Map
            </button>
            <button onclick="navigator.clipboard.writeText('${roomData.zoom_serial || ''}'); showAlert('Serial copied!', 'success');" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;" ${!roomData.zoom_serial ? 'disabled' : ''}>
              üìã Copy Serial
            </button>
          </div>

          <div class="analytics-content">
            <div class="analytics-section">
              <div class="analytics-section-title">24h Uptime</div>
              ${uptimeBarHTML || '<div style="color: var(--text-muted); font-size: 12px;">No history data yet</div>'}
              <div class="stats-grid" style="margin-top: 12px;">
                <div class="stat-card">
                  <div class="stat-value ${uptimePercent !== null && uptimePercent >= 99 ? 'green' : uptimePercent !== null && uptimePercent >= 90 ? 'yellow' : 'red'}">${uptimePercent !== null ? uptimePercent.toFixed(1) + '%' : '--'}</div>
                  <div class="stat-label">Uptime</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value ${onlineDevices === totalDevices ? 'green' : 'yellow'}">${onlineDevices}/${totalDevices}</div>
                  <div class="stat-label">Devices</div>
                </div>
                <div class="stat-card">
                  <div class="stat-value" style="color: ${roomData.zoom_health === 'Good' || roomData.zoom_health === 'Healthy' ? 'var(--status-online)' : 'var(--text-muted)'};">${roomData.zoom_health || 'Unknown'}</div>
                  <div class="stat-label">Health</div>
                </div>
              </div>
            </div>

            <div class="analytics-section">
              <div class="analytics-section-title">üìÖ Meeting Utilization (7 Days)</div>
              ${utilizationData && utilizationData.daily_stats ? `
                ${renderUtilizationChart(utilizationData.daily_stats)}
                <div class="stats-grid" style="margin-top: 12px;">
                  <div class="stat-card">
                    <div class="stat-value" style="color: ${utilizationData.avg_utilization > 70 ? 'var(--status-offline)' : utilizationData.avg_utilization > 40 ? 'var(--status-warning)' : 'var(--status-online)'};">${utilizationData.avg_utilization?.toFixed(0) || 0}%</div>
                    <div class="stat-label">Avg Utilization</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value" style="color: var(--accent-primary);">${utilizationData.total_meetings || 0}</div>
                    <div class="stat-label">Total Meetings</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value">${Math.round((utilizationData.total_meeting_minutes || 0) / 60)}h</div>
                    <div class="stat-label">Meeting Hours</div>
                  </div>
                </div>
              ` : '<div style="color: var(--text-muted); font-size: 12px;">No utilization data yet</div>'}
            </div>

            ${devices.length > 0 ? `
            <div class="analytics-section">
              <div class="analytics-section-title">Devices (${devices.length})</div>
              <div style="display: flex; flex-direction: column; gap: 8px;">
                ${devices.map(dev => `
                  <div style="background: ${dev.status === 'Online' ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border: 1px solid ${dev.status === 'Online' ? 'rgba(34, 197, 94, 0.2)' : 'rgba(239, 68, 68, 0.2)'}; border-radius: 6px; padding: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                      <span style="font-weight: 600; color: ${dev.status === 'Online' ? '#86EFAC' : '#FCA5A5'};">${dev.device_model || dev.device_type || 'Unknown Device'}</span>
                      <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; background: ${dev.status === 'Online' ? '#22C55E' : '#EF4444'}; color: white;">${dev.status || 'Unknown'}</span>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                      <div>
                        <span style="color: #64748B;">Type:</span>
                        <span style="color: #94A3B8; margin-left: 4px;">${dev.device_type || 'Unknown'}</span>
                      </div>
                      ${dev.ip_address ? `
                      <div>
                        <span style="color: #64748B;">IP:</span>
                        <span style="color: #60A5FA; margin-left: 4px;">${dev.ip_address}</span>
                      </div>
                      ` : ''}
                      ${dev.serial_number ? `
                      <div style="grid-column: span 2;">
                        <span style="color: #64748B;">Serial:</span>
                        <span style="color: #94A3B8; margin-left: 4px; font-family: monospace;">${dev.serial_number}</span>
                      </div>
                      ` : ''}
                      ${dev.device_firmware ? `
                      <div style="grid-column: span 2;">
                        <span style="color: #64748B;">Firmware:</span>
                        <span style="color: #94A3B8; margin-left: 4px;">${dev.device_firmware}</span>
                      </div>
                      ` : ''}
                    </div>
                  </div>
                `).join('')}
              </div>
            </div>
            ` : ''}

            <div class="analytics-section">
              <div class="analytics-section-title">Room Info</div>
              <div style="display: flex; flex-direction: column; gap: 8px; font-size: 12px;">
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Full Name</span>
                  <span style="color: var(--text-primary);">${roomData.name}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Display Name</span>
                  <span style="color: var(--text-primary);">${roomData.displayName}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Floor</span>
                  <span style="color: var(--text-primary);">${roomData.floor || 'Unknown'}</span>
                </div>
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Room ID</span>
                  <span style="color: var(--text-primary); font-size: 10px; font-family: monospace;">${roomData.room_id || roomData.id}</span>
                </div>
                ${roomData.location ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Location</span>
                  <span style="color: var(--text-primary);">${roomData.location}</span>
                </div>
                ` : ''}
                ${roomData.last_start_time ? `
                <div style="display: flex; justify-content: space-between;">
                  <span style="color: var(--text-muted);">Last Meeting</span>
                  <span style="color: var(--text-primary);">${new Date(roomData.last_start_time).toLocaleString()}</span>
                </div>
                ` : ''}
              </div>
            </div>

            ${roomData.zoom_issues && roomData.zoom_issues.length > 0 ? `
            <div class="analytics-section" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
              <div class="analytics-section-title" style="color: #EF4444;">‚ö†Ô∏è Issues (${roomData.zoom_issues.length})</div>
              <div style="display: flex; flex-direction: column; gap: 4px;">
                ${roomData.zoom_issues.map(issue => `
                  <div style="color: #FCA5A5; font-size: 12px;">‚Ä¢ ${issue}</div>
                `).join('')}
              </div>
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    // Helper function to mark device as selected in sidebar
    function markDeviceSelected(deviceId) {
      // Remove selected from all items
      document.querySelectorAll('.device-item.selected, .room-item.selected').forEach(el => {
        el.classList.remove('selected');
      });
      // Find and mark the current device
      const deviceEl = document.querySelector(`.device-item[onclick*="'${deviceId}'"], .device-item[onclick*="'zoom-${deviceId}'"]`);
      if (deviceEl) {
        deviceEl.classList.add('selected');
      }
    }

    async function openAnalytics(deviceId, deviceName, deviceType, isRoom = false, polyDeviceData = null) {
      // Clear any existing refresh interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
      }

      const isPolyDevice = polyDeviceData !== null;
      analyticsDevice = { id: deviceId, name: deviceName, type: deviceType, isRoom, isPolyDevice, polyDeviceData };
      analyticsOpen = true;

      // Mark device as selected in sidebar
      markDeviceSelected(deviceId);

      // Render loading state
      renderAnalyticsSidebar(true);

      // Fetch device data (pass roomName for room analytics, or polyDeviceData for individual poly device)
      analyticsData = await fetchAnalyticsData(deviceId, isRoom, deviceName, isPolyDevice, polyDeviceData);
      renderAnalyticsSidebar(false);

      // Set up auto-refresh every 30 minutes (1800000 ms)
      analyticsRefreshInterval = setInterval(refreshAnalytics, 30 * 60 * 1000);
      console.log('Analytics auto-refresh enabled (every 30 minutes)');
    }

    function closeAnalytics() {
      // Clear auto-refresh interval
      if (analyticsRefreshInterval) {
        clearInterval(analyticsRefreshInterval);
        analyticsRefreshInterval = null;
        console.log('Analytics auto-refresh disabled');
      }

      // Clear selected state from sidebar
      document.querySelectorAll('.device-item.selected, .room-item.selected').forEach(el => {
        el.classList.remove('selected');
      });

      analyticsOpen = false;
      analyticsDevice = null;
      analyticsData = null;
      analyticsParentRoom = null;
      document.getElementById('analytics-container').innerHTML = '';
    }

    // Store parent room for back navigation
    let analyticsParentRoom = null;

    function openPolyDeviceAnalytics(deviceData) {
      // Store current room for back navigation
      if (analyticsDevice && analyticsDevice.isRoom) {
        analyticsParentRoom = { ...analyticsDevice };
      }
      // Open analytics for the individual Poly Lens device
      openAnalytics(deviceData.id || deviceData.name, deviceData.name, 'polyLensDevice', false, deviceData);
    }

    function goBackToRoom() {
      if (analyticsParentRoom) {
        const room = analyticsParentRoom;
        analyticsParentRoom = null;
        openAnalytics(room.id, room.name, room.type, true, null);
      }
    }

    function renderAnalyticsSidebar(loading = false) {
      if (!analyticsDevice) return;

      const device = analyticsDevice;
      const data = analyticsData;

      // Calculate current status from heartbeats
      const currentStatus = data?.heartbeats?.[0]?.status === 1 ? 'up' : 'down';
      const lastPing = data?.heartbeats?.[0]?.ping;
      const avgPing = data?.heartbeats?.length > 0
        ? (data.heartbeats.filter(h => h.ping).reduce((sum, h) => sum + (h.ping || 0), 0) / data.heartbeats.filter(h => h.ping).length).toFixed(1)
        : 0;

      // Calculate downtime incidents
      let incidents = 0;
      let lastStatus = null;
      data?.heartbeats?.forEach(h => {
        if (lastStatus === 1 && h.status === 0) incidents++;
        lastStatus = h.status;
      });

      // Build uptime bar (last 24 hours, each segment = 30 minutes)
      const uptimeSegments = [];
      if (data?.heartbeats?.length > 0) {
        const now = new Date();
        const segments = 48; // 24 hours / 30 min = 48 segments
        for (let i = 0; i < segments; i++) {
          const segmentEnd = new Date(now - i * 30 * 60 * 1000);
          const segmentStart = new Date(segmentEnd - 30 * 60 * 1000);

          const segmentHeartbeats = data.heartbeats.filter(h => {
            const time = new Date(h.time);
            return time >= segmentStart && time < segmentEnd;
          });

          if (segmentHeartbeats.length === 0) {
            uptimeSegments.unshift({ status: 'unknown', time: segmentStart });
          } else {
            const anyDown = segmentHeartbeats.some(h => h.status === 0);
            uptimeSegments.unshift({ status: anyDown ? 'down' : 'up', time: segmentStart });
          }
        }
      }

      // Build response time chart
      const responseTimes = data?.heartbeats?.slice(0, 30).reverse() || [];

      document.getElementById('analytics-container').innerHTML = `
        <div class="analytics-overlay ${analyticsOpen ? 'open' : ''}" onclick="closeAnalytics()"></div>
        <div class="analytics-sidebar ${analyticsOpen ? 'open' : ''}">
          <div class="analytics-header">
            <div class="analytics-header-top">
              <div>
                <h2 class="analytics-title">${sanitizeHTML(device.name)}</h2>
                <p class="analytics-subtitle">${device.type === 'accessPoints' ? 'Access Point' : device.type === 'printers' ? 'Printer' : device.type === 'polyLensDevice' ? 'Poly Lens Device' : 'Zoom Room'}</p>
              </div>
              <button class="analytics-close" onclick="closeAnalytics()">&times;</button>
            </div>
            ${!loading && !device.isRoom ? `
              <div class="analytics-status ${currentStatus}">
                <span style="font-size: 10px;">‚óè</span>
                ${currentStatus === 'up' ? 'Online' : 'Offline'}
                ${lastPing ? ` ‚Ä¢ ${lastPing}ms` : ''}
              </div>
            ` : ''}
            ${!loading && device.isRoom && data?.devices ? `
              <div class="analytics-status ${data.offlineCount === 0 ? 'up' : 'down'}">
                <span style="font-size: 10px;">‚óè</span>
                ${data.onlineCount}/${data.totalCount} Online
              </div>
            ` : ''}
            ${!loading && data?.isPolyDevice ? `
              <div class="analytics-status ${data.connected ? 'up' : 'down'}">
                <span style="font-size: 10px;">‚óè</span>
                ${data.connected ? 'Online' : 'Offline'}
              </div>
            ` : ''}
          </div>

          ${!loading && !device.isRoom && !device.isPolyDevice ? `
            <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
              <button onclick="manualPingDevice(${device.id})" class="btn btn-sm btn-primary" style="flex: 1; min-width: 100px;" id="ping-btn-${device.id}">
                üì° Ping Now
              </button>
              <button onclick="toggleMaintenanceFromAnalytics(${device.id})" class="btn btn-sm ${data?.maintenance ? 'btn-warning' : 'btn-secondary'}" style="flex: 1; min-width: 120px;">
                üîß ${data?.maintenance ? 'End Maintenance' : 'Maintenance'}
              </button>
              <button onclick="toggleDisabledFromAnalytics(${device.id}, ${data?.disabled ? 'false' : 'true'})" class="btn btn-sm ${data?.disabled ? 'btn-success' : 'btn-danger'}" style="flex: 1; min-width: 120px;">
                ${data?.disabled ? '‚úÖ Enable' : 'üö´ Disable'}
              </button>
              <button onclick="highlightDevice('${device.id}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
                üìç Locate
              </button>
            </div>
          ` : ''}

          ${!loading && device.isRoom ? `
            <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
              <button onclick="highlightDevice('${device.id}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
                üìç Locate on Map
              </button>
            </div>
          ` : ''}

          ${!loading && device.isPolyDevice && data?.ip ? `
            <div class="analytics-actions" style="display: flex; gap: 8px; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); flex-wrap: wrap;">
              <button onclick="manualPingPolyDevice('${data.ip}')" class="btn btn-sm btn-primary" style="flex: 1; min-width: 100px;" id="ping-btn-poly-${device.id}">
                üì° Ping Now
              </button>
              <button onclick="highlightDevice('${device.id}')" class="btn btn-sm btn-secondary" style="flex: 1; min-width: 100px;">
                üìç Locate
              </button>
            </div>
          ` : ''}

          <div class="analytics-content">
            ${loading ? `
              <div style="text-align: center; padding: 40px; color: #64748B;">
                <div style="font-size: 24px; margin-bottom: 12px;">‚è≥</div>
                Loading analytics...
              </div>
            ` : device.isRoom && data?.devices ? `
              <div class="analytics-section">
                <div class="analytics-section-title">Room Status</div>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.currentUptime) >= 99 ? 'green' : parseFloat(data.currentUptime) >= 50 ? 'yellow' : 'red'}">${data.currentUptime}%</div>
                    <div class="stat-label">Uptime</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value green">${data.onlineCount}</div>
                    <div class="stat-label">Online</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${data.offlineCount > 0 ? 'red' : 'green'}">${data.offlineCount}</div>
                    <div class="stat-label">Offline</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value" style="color: var(--text-muted);">${data.disabledCount || 0}</div>
                    <div class="stat-label">Disabled</div>
                  </div>
                </div>
              </div>

              ${data.devices.filter(d => d.disabled).length > 0 ? `
                <div class="analytics-section" style="background: rgba(107, 114, 128, 0.1); border: 1px solid rgba(107, 114, 128, 0.3); border-radius: 8px; padding: 12px;">
                  <div class="analytics-section-title" style="color: #9CA3AF;">üö´ Disabled Devices (${data.devices.filter(d => d.disabled).length})</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${data.devices.filter(d => d.disabled).map(d => `
                      <div style="background: rgba(107, 114, 128, 0.15); border-radius: 6px; padding: 10px; opacity: 0.6;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                          <span style="font-weight: 600; color: #9CA3AF;">${d.name}</span>
                          <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', false)" class="btn btn-sm btn-success" style="padding: 2px 8px; font-size: 10px;">
                            ‚úÖ Enable
                          </button>
                        </div>
                        <div style="font-size: 12px; color: #6B7280;">${d.hardwareModel || 'Unknown Model'}</div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              ${data.devices.filter(d => !d.connected && !d.disabled).length > 0 ? `
                <div class="analytics-section" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
                  <div class="analytics-section-title" style="color: #EF4444;">‚ö†Ô∏è Devices with Issues (${data.devices.filter(d => !d.connected && !d.disabled).length})</div>
                  <div style="display: flex; flex-direction: column; gap: 8px;">
                    ${data.devices.filter(d => !d.connected && !d.disabled).map(d => `
                      <div style="background: rgba(239, 68, 68, 0.15); border-radius: 6px; padding: 10px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                          <span onclick="openPolyDeviceAnalytics(${JSON.stringify(d).replace(/"/g, '&quot;')})" style="font-weight: 600; color: #FCA5A5; cursor: pointer;">${d.name}</span>
                          <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; background: #EF4444; color: white;">OFFLINE</span>
                            <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', true)" class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 10px;" title="Disable this device">
                              üö´
                            </button>
                          </div>
                        </div>
                        <div style="font-size: 12px; color: #FDA4AF;">${d.hardwareModel || 'Unknown Model'}</div>
                        ${d.ip ? `<div style="font-size: 11px; color: #94A3B8; margin-top: 4px;">IP: ${d.ip}</div>` : '<div style="font-size: 11px; color: #F87171; margin-top: 4px;">No IP assigned</div>'}
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">${data.devices.filter(d => !d.connected && !d.disabled).length > 0 ? 'Online Devices' : 'All Devices'} (${data.devices.filter(d => d.connected && !d.disabled).length})</div>
                <div style="display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto;">
                  ${data.devices.filter(d => d.connected && !d.disabled).map(d => `
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 6px; padding: 10px;">
                      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                        <span onclick="openPolyDeviceAnalytics(${JSON.stringify(d).replace(/"/g, '&quot;')})" style="font-weight: 600; color: #86EFAC; cursor: pointer;">${d.name}</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                          <span style="padding: 2px 8px; border-radius: 4px; font-size: 10px; background: #22C55E; color: white;">ONLINE</span>
                          <button onclick="event.stopPropagation(); togglePolyDeviceDisabled('${d.id}', true)" class="btn btn-sm btn-secondary" style="padding: 2px 8px; font-size: 10px;" title="Disable this device">
                            üö´
                          </button>
                        </div>
                      </div>
                      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 4px; font-size: 11px;">
                        <div>
                          <span style="color: #64748B;">Model:</span>
                          <span style="color: #94A3B8; margin-left: 4px;">${d.hardwareModel || 'Unknown'}</span>
                        </div>
                        <div>
                          <span style="color: #64748B;">IP:</span>
                          <span style="color: #60A5FA; margin-left: 4px;">${d.ip || 'N/A'}</span>
                        </div>
                      </div>
                    </div>
                  `).join('')}
                </div>
              </div>

              <div class="analytics-section" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: #64748B; text-align: center;">
                  üìπ Data from Poly Lens API ‚Ä¢ Auto-refreshes every 30 minutes
                </div>
              </div>
            ` : data?.isPolyDevice ? `
              ${analyticsParentRoom ? `
                <button onclick="goBackToRoom()" style="display: flex; align-items: center; gap: 6px; background: rgba(59, 130, 246, 0.2); border: 1px solid rgba(59, 130, 246, 0.3); color: #60A5FA; padding: 8px 12px; border-radius: 6px; cursor: pointer; margin-bottom: 16px; font-size: 12px;">
                  ‚Üê Back to ${analyticsParentRoom.name}
                </button>
              ` : ''}

              ${data.heartbeats && data.heartbeats.length > 0 ? `
                <div class="analytics-section">
                  <div class="analytics-section-title">Uptime Statistics</div>
                  <div class="stats-grid">
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime24h) >= 99 ? 'green' : parseFloat(data.uptime24h) >= 95 ? 'yellow' : 'red'}">${data.uptime24h}%</div>
                      <div class="stat-label">Last 24 Hours</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime7d) >= 99 ? 'green' : parseFloat(data.uptime7d) >= 95 ? 'yellow' : 'red'}">${data.uptime7d}%</div>
                      <div class="stat-label">Last 7 Days</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value ${parseFloat(data.uptime30d) >= 99 ? 'green' : parseFloat(data.uptime30d) >= 95 ? 'yellow' : 'red'}">${data.uptime30d}%</div>
                      <div class="stat-label">Last 30 Days</div>
                    </div>
                    <div class="stat-card">
                      <div class="stat-value blue">${data.totalChecks}</div>
                      <div class="stat-label">Total Checks</div>
                    </div>
                  </div>
                </div>

                <div class="analytics-section">
                  <div class="analytics-section-title">24 Hour Connection History</div>
                  <div class="uptime-bar">
                    ${(() => {
                      const segments = [];
                      const now = new Date();
                      for (let i = 0; i < 48; i++) {
                        const segmentEnd = new Date(now - i * 30 * 60 * 1000);
                        const segmentStart = new Date(segmentEnd - 30 * 60 * 1000);
                        const segmentHeartbeats = data.heartbeats.filter(h => {
                          const time = new Date(h.time);
                          return time >= segmentStart && time < segmentEnd;
                        });
                        if (segmentHeartbeats.length === 0) {
                          segments.unshift({ status: 'unknown', time: segmentStart });
                        } else {
                          const anyDown = segmentHeartbeats.some(h => h.status === 0);
                          segments.unshift({ status: anyDown ? 'down' : 'up', time: segmentStart });
                        }
                      }
                      return segments.map(seg =>
                        '<div class="uptime-segment ' + seg.status + '" data-tooltip="' + formatIsraelTimeOnly(seg.time) + ' - ' + seg.status.toUpperCase() + '" style="flex: 1;"></div>'
                      ).join('');
                    })()}
                  </div>
                  <div class="uptime-legend">
                    <span>24h ago</span>
                    <span>Now</span>
                  </div>
                </div>

                <div class="analytics-section">
                  <div class="analytics-section-title">Recent History</div>
                  <div class="history-list">
                    ${data.heartbeats.slice(0, 15).map(h => `
                      <div class="history-item">
                        <div class="history-status ${h.status === 1 ? 'up' : 'down'}"></div>
                        <div class="history-info">
                          <div class="history-time">${formatIsraelTime(h.time)}</div>
                          <div class="history-message">${h.status === 1 ? 'Connected' : 'Disconnected'}${h.ip ? ' ‚Ä¢ IP: ' + h.ip : ''}</div>
                        </div>
                      </div>
                    `).join('')}
                  </div>
                </div>
              ` : `
                <div class="analytics-section">
                  <div class="analytics-section-title">Device Status</div>
                  <div style="background: ${data.connected ? 'rgba(34, 197, 94, 0.1)' : 'rgba(239, 68, 68, 0.1)'}; border: 1px solid ${data.connected ? 'rgba(34, 197, 94, 0.3)' : 'rgba(239, 68, 68, 0.3)'}; border-radius: 8px; padding: 16px; text-align: center;">
                    <div style="font-size: 48px; margin-bottom: 8px;">${data.connected ? '‚úÖ' : '‚ùå'}</div>
                    <div style="font-size: 18px; font-weight: 600; color: ${data.connected ? '#22C55E' : '#EF4444'};">
                      ${data.connected ? 'Online' : 'Offline'}
                    </div>
                    <div style="font-size: 12px; color: #94A3B8; margin-top: 4px;">
                      Current Connection Status
                    </div>
                  </div>
                </div>

                <div style="text-align: center; padding: 20px; color: #64748B; font-size: 12px;">
                  üìä Historical data will be available once the system starts tracking this device.
                </div>
              `}

              <div class="analytics-section">
                <div class="analytics-section-title">Device Information</div>
                <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 16px;">
                  <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Device Name</span>
                      <span style="color: #E2E8F0; font-weight: 500;">${data.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Model</span>
                      <span style="color: #E2E8F0;">${data.model || 'Unknown'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Room</span>
                      <span style="color: #E2E8F0;">${data.room || 'Unassigned'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">IP Address</span>
                      <span style="color: #60A5FA; font-family: monospace;">${data.ip || 'N/A'}</span>
                    </div>
                    ${data.serialNumber ? `
                      <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                        <span style="color: #64748B;">Serial Number</span>
                        <span style="color: #E2E8F0; font-family: monospace; font-size: 11px;">${data.serialNumber}</span>
                      </div>
                    ` : ''}
                    ${data.softwareVersion ? `
                      <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                        <span style="color: #64748B;">Software Version</span>
                        <span style="color: #E2E8F0;">${data.softwareVersion}</span>
                      </div>
                    ` : ''}
                    ${data.lastSeen ? `
                      <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748B;">Last Seen</span>
                        <span style="color: ${data.connected ? '#94A3B8' : '#F87171'};">${formatIsraelTime(data.lastSeen)}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              ${!data.connected ? `
                <div class="analytics-section" style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; padding: 16px;">
                  <div class="analytics-section-title" style="color: #EF4444;">‚ö†Ô∏è Troubleshooting</div>
                  <ul style="margin: 0; padding-left: 20px; color: #FDA4AF; font-size: 12px; line-height: 1.8;">
                    <li>Check if the device is powered on</li>
                    <li>Verify network connectivity</li>
                    <li>Check if the device is connected to the correct network</li>
                    <li>Try restarting the device</li>
                    <li>Contact IT support if the issue persists</li>
                  </ul>
                </div>
              ` : ''}

              <div class="analytics-section" style="margin-top: 16px; padding: 12px; background: rgba(59, 130, 246, 0.1); border-radius: 8px;">
                <div style="font-size: 11px; color: #64748B; text-align: center;">
                  üìπ Data tracked locally ‚Ä¢ Auto-refreshes every 30 minutes
                </div>
              </div>
            ` : data?.error ? `
              <div style="text-align: center; padding: 40px; color: #EF4444;">
                Failed to load analytics data.
              </div>
            ` : `
              <div class="analytics-section">
                <div class="analytics-section-title">Uptime Statistics</div>
                <div class="stats-grid">
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime24h) >= 99 ? 'green' : parseFloat(data.uptime24h) >= 95 ? 'yellow' : 'red'}">${data.uptime24h}%</div>
                    <div class="stat-label">Last 24 Hours</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime7d) >= 99 ? 'green' : parseFloat(data.uptime7d) >= 95 ? 'yellow' : 'red'}">${data.uptime7d}%</div>
                    <div class="stat-label">Last 7 Days</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value ${parseFloat(data.uptime30d) >= 99 ? 'green' : parseFloat(data.uptime30d) >= 95 ? 'yellow' : 'red'}">${data.uptime30d}%</div>
                    <div class="stat-label">Last 30 Days</div>
                  </div>
                  <div class="stat-card">
                    <div class="stat-value blue">${avgPing}ms</div>
                    <div class="stat-label">Avg Response</div>
                  </div>
                </div>
              </div>

              ${device.type === 'printers' ? renderPrinterConsumables(device.id) : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">Device Information</div>
                <div style="background: rgba(30, 41, 59, 0.5); border-radius: 8px; padding: 16px;">
                  <div style="display: grid; gap: 12px;">
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Device Name</span>
                      <span style="color: #E2E8F0; font-weight: 500;">${data.name || device.name}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">IP Address</span>
                      <span style="color: #60A5FA; font-family: monospace;">${data.hostname || 'N/A'}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; padding-bottom: 12px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                      <span style="color: #64748B;">Floor</span>
                      <span style="color: #E2E8F0;">${data.floor || 'Unknown'}</span>
                    </div>
                    ${device.type === 'printers' ? `
                      <div style="display: flex; justify-content: space-between; align-items: center;" id="serial-container-${device.id}">
                        <span style="color: #64748B;">Serial Number</span>
                        <!-- View Mode -->
                        <div id="serial-view-${device.id}" style="display: ${data.serial_number ? 'flex' : 'none'}; align-items: center; gap: 8px;">
                          <span style="color: #E2E8F0; font-family: monospace; font-size: 11px;" id="serial-display-${device.id}">${data.serial_number || ''}</span>
                          <button onclick="enableSerialEdit(${device.id})"
                            style="background: #475569; border: none; border-radius: 4px; padding: 4px 10px; color: white; cursor: pointer; font-size: 12px;">Edit</button>
                        </div>
                        <!-- Edit Mode -->
                        <div id="serial-edit-${device.id}" style="display: ${data.serial_number ? 'none' : 'flex'}; align-items: center; gap: 8px;">
                          <input type="text"
                            id="analytics-serial-${device.id}"
                            value="${data.serial_number || ''}"
                            placeholder="Enter serial #"
                            style="background: var(--bg-elevated); border: 1px solid var(--border-default); border-radius: 4px; padding: 4px 8px; color: #E2E8F0; font-family: monospace; font-size: 11px; width: 140px;"
                            onkeydown="if(event.key==='Enter') saveAnalyticsSerial(${device.id}, this.value)">
                          <button onclick="saveAnalyticsSerial(${device.id}, document.getElementById('analytics-serial-${device.id}').value)"
                            style="background: var(--accent); border: none; border-radius: 4px; padding: 4px 10px; color: white; cursor: pointer; font-size: 12px;">Save</button>
                        </div>
                      </div>
                    ` : data.serial_number ? `
                      <div style="display: flex; justify-content: space-between;">
                        <span style="color: #64748B;">Serial Number</span>
                        <span style="color: #E2E8F0; font-family: monospace; font-size: 11px;">${data.serial_number}</span>
                      </div>
                    ` : ''}
                  </div>
                </div>
              </div>

              <div class="analytics-section">
                <div class="analytics-section-title">24 Hour Uptime</div>
                <div class="uptime-bar">
                  ${uptimeSegments.map(seg => `
                    <div class="uptime-segment ${seg.status}"
                      data-tooltip="${formatIsraelTimeOnly(seg.time)} - ${seg.status.toUpperCase()}"
                      style="flex: 1;"></div>
                  `).join('')}
                </div>
                <div class="uptime-legend">
                  <span>24h ago</span>
                  <span>Now</span>
                </div>
              </div>

              ${responseTimes.length > 0 ? `
                <div class="analytics-section">
                  <div class="analytics-section-title">Response Time (Last ${responseTimes.length} checks)</div>
                  <div class="response-chart">
                    ${responseTimes.map(h => {
                      const maxPing = Math.max(...responseTimes.map(r => r.ping || 0), 100);
                      const height = h.ping ? Math.max(10, (h.ping / maxPing) * 100) : 5;
                      const slow = h.ping > 200;
                      const timeout = h.status === 0;
                      return `<div class="response-bar ${timeout ? 'timeout' : slow ? 'slow' : ''}"
                        style="height: ${timeout ? 100 : height}%;"
                        title="${h.ping ? h.ping + 'ms' : 'Timeout'} at ${formatIsraelTimeOnly(h.time)}"></div>`;
                    }).join('')}
                  </div>
                </div>
              ` : ''}

              <div class="analytics-section">
                <div class="analytics-section-title">Recent History</div>
                <div class="history-list">
                  ${data.heartbeats.slice(0, 15).map(h => `
                    <div class="history-item">
                      <div class="history-status ${h.status === 1 ? 'up' : 'down'}"></div>
                      <div class="history-info">
                        <div class="history-time">${formatIsraelTime(h.time)}</div>
                        ${h.message ? `<div class="history-message">${h.message}</div>` : ''}
                      </div>
                      ${h.ping ? `<div class="history-ping">${h.ping}ms</div>` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            `}
          </div>
        </div>
      `;
    }

    // Track collapsed state of sidebar categories across renders
    let collapsedCategories = new Set();

    function render() {
      // Update global floors array from data
      floors = Object.keys(monitorData).length > 0
        ? Object.keys(monitorData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      const currentFloorData = monitorData[activeFloor] || { accessPoints: [], printers: [], polyLens: [] };
      const currentPolyData = polyLensData[activeFloor] || [];
      const currentCounts = getStatusCounts(currentFloorData, currentPolyData);
      const now = formatIsraelTimeOnly(new Date());

      // Build device markers for floor plan
      let deviceMarkersHTML = '';
      let allDevices = [];

      // Add monitors from database (Access Points and Printers only - not polyLens type)
      Object.entries(currentFloorData).forEach(([type, devices]) => {
        if (Array.isArray(devices) && type !== 'polyLens') {
          devices.forEach(d => allDevices.push({ ...d, type, source: 'monitor' }));
        }
      });

      // Group Poly Lens devices by room
      const polyRoomGroups = {};
      currentPolyData.forEach(polyDevice => {
        const roomName = polyDevice.room || 'Unassigned';
        if (!polyRoomGroups[roomName]) {
          polyRoomGroups[roomName] = [];
        }
        polyRoomGroups[roomName].push(polyDevice);
      });

      // Add one marker per Poly Lens room
      Object.entries(polyRoomGroups).forEach(([roomName, devices]) => {
        // Filter out disabled and maintenance devices for count display
        const activeDevices = devices.filter(d => !d.disabled && !d.maintenance);
        // Check ALL devices for connection status (even disabled/maintenance ones should show if disconnected)
        const anyDeviceDisconnected = devices.some(d => !d.connected);
        const allDevicesConnected = devices.length > 0 && devices.every(d => d.connected);
        allDevices.push({
          id: `room-${roomName.replace(/\s+/g, '-')}`,
          name: roomName,
          ip: devices.map(d => d.ip).filter(Boolean).join(', '),
          status: allDevicesConnected ? 'up' : 'down',
          type: 'polyLens',
          source: 'polyLensRoom',
          roomDevices: devices,
          deviceCount: devices.length,
          pos_x: null,
          pos_y: null
        });
      });

      // Add Zoom-only rooms (rooms without Poly devices) as markers
      const currentZoomOnlyRooms = zoomOnlyRooms[activeFloor] || [];
      currentZoomOnlyRooms.forEach(zoomRoom => {
        const roomId = `zoom-${zoomRoom.id}`;
        const isAvailable = zoomRoom.zoom_status === 'Available' || zoomRoom.zoom_status === 'InMeeting';
        allDevices.push({
          id: roomId,
          name: zoomRoom.displayName,
          fullName: zoomRoom.name,
          status: isAvailable ? 'up' : 'down',
          type: 'zoomOnly',
          source: 'zoomOnly',
          zoom_status: zoomRoom.zoom_status,
          zoom_in_meeting: zoomRoom.in_meeting,
          zoom_id: zoomRoom.id,
          zoom_ip: zoomRoom.zoom_ip,
          zoom_serial: zoomRoom.zoom_serial,
          zoom_device_type: zoomRoom.zoom_device_type,
          zoom_devices: zoomRoom.zoom_devices || [],
          pos_x: null,
          pos_y: null
        });
      });

      // Apply quick filters to allDevices
      let filteredDevices = allDevices;
      if (activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting) {
        filteredDevices = allDevices.filter(device => {
          // Offline filter
          if (activeFilters.offlineOnly) {
            if (device.source === 'polyLensRoom') {
              const hasOffline = device.roomDevices?.some(d => !d.connected && !d.disabled);
              if (!hasOffline) return false;
            } else if (device.status !== 'down' || device.disabled) {
              return false;
            }
          }

          // Low toner filter (only for printers)
          if (activeFilters.lowToner) {
            if (device.type !== 'printers') return false;
            const toner = printerStatusData[device.id]?.toner || {};
            const hasLowToner = Object.values(toner).some(level => level !== null && level < 20);
            if (!hasLowToner) return false;
          }

          // In meeting filter (only for rooms)
          if (activeFilters.inMeeting) {
            if (device.source === 'polyLensRoom') {
              const inMeeting = device.roomDevices?.some(d => d.zoom_in_meeting);
              if (!inMeeting) return false;
            } else if (device.source === 'zoomOnly') {
              if (!device.zoom_in_meeting) return false;
            } else {
              return false; // Not a room
            }
          }

          return true;
        });
      }

      const positions = generatePositions(filteredDevices.length, activeFloor.charCodeAt(0) * 7);

      filteredDevices.forEach((device, idx) => {
        // Use saved position if available, otherwise use generated position
        // In TV mode, prefer TV positions if available
        let pos;
        const isRoomMarker = device.source === 'polyLensRoom' || device.source === 'zoomOnly';

        if (isRoomMarker) {
          // Check for saved room position (for both Poly rooms and Zoom-only rooms)
          const savedRoomPos = roomPositions[device.id];
          if (savedRoomPos && savedRoomPos.pos_x !== null && savedRoomPos.pos_y !== null) {
            pos = { x: savedRoomPos.pos_x, y: savedRoomPos.pos_y };
          } else {
            pos = positions[idx];
          }
        } else {
          // Check for saved monitor position
          const hasCustomPos = device.pos_x !== null && device.pos_y !== null;
          pos = hasCustomPos ? { x: device.pos_x, y: device.pos_y } : positions[idx];
        }

        // Final safety check - ensure position is never null
        if (pos.x === null || pos.y === null || pos.x === undefined || pos.y === undefined) {
          pos = positions[idx] || { x: 10 + (idx % 5) * 20, y: 20 + Math.floor(idx / 5) * 20 };
        }

        const typeInfo = deviceTypes[device.type] || deviceTypes.polyLens;
        const status = statusColors[device.status] || statusColors.unknown;

        if (device.source === 'polyLensRoom') {
          // Poly Lens room marker with multiple devices
          const roomDevices = device.roomDevices || [];
          // Filter out disabled and maintenance devices for status calculation
          const activeDevices = roomDevices.filter(d => !d.disabled && !d.maintenance);
          const onlineCount = activeDevices.filter(d => d.connected).length;
          const offlineCount = activeDevices.length - onlineCount;

          // Get Zoom status and device info from any device in the room
          const zoomDevice = roomDevices.find(d => d.zoom_status);
          const zoomStatus = zoomDevice?.zoom_status || null;
          const zoomInMeeting = roomDevices.some(d => d.zoom_in_meeting);
          const zoomIp = zoomDevice?.zoom_ip || null;
          const zoomSerial = zoomDevice?.zoom_serial || null;
          const zoomDeviceType = zoomDevice?.zoom_device_type || null;
          const zoomDevices = zoomDevice?.zoom_devices || [];
          const zoomStatusColor = zoomStatus === 'Available' ? '#22C55E' :
                                  zoomStatus === 'InMeeting' ? '#F59E0B' :
                                  zoomStatus === 'Offline' ? '#EF4444' : '#6B7280';
          const zoomStatusText = zoomStatus === 'Available' ? 'Available' :
                                 zoomStatus === 'InMeeting' ? 'In Meeting' :
                                 zoomStatus === 'Offline' ? 'Offline' : null;

          const popupBelowClass = pos.y < 30 ? 'popup-below' : '';
          deviceMarkersHTML += `
            <div class="device-marker ${popupBelowClass}" data-id="${device.id}" style="left: ${pos.x}%; top: ${pos.y}%;"
              ${editMode ? 'draggable="true" onmousedown="startDrag(event, this)" onclick="event.stopPropagation(); event.preventDefault();"' : `onclick="event.stopPropagation(); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'polyLens', true)"`}>
              ${offlineCount > 0 && activeDevices.length > 0 ? `<div class="device-ping" style="background: ${statusColors.down.pulse};"></div>` : ''}
              <div class="device-dot" style="background: ${zoomInMeeting ? '#F59E0B' : status.bg}; border-color: ${typeInfo.color}; min-width: 28px; font-size: 9px;">
                ${zoomInMeeting ? 'üìû' : roomDevices.length}
              </div>
              <div class="device-popup">
                <div class="popup-header">
                  <span class="popup-icon">üö™</span>
                  <span class="popup-name">${sanitizeHTML(device.name)}</span>
                  ${zoomInMeeting ? '<span style="background: #F59E0B; color: #000; font-size: 9px; padding: 1px 4px; border-radius: 3px; margin-left: 4px;">Meeting</span>' : ''}
                </div>
                <div class="popup-details" style="padding: 4px 0;">
                  <div style="display: flex; gap: 8px; font-size: 10px;">
                    <span>Poly: <span style="color: #22C55E;">${onlineCount}‚úì</span>${offlineCount > 0 ? `<span style="color: #EF4444; margin-left: 2px;">${offlineCount}‚úó</span>` : ''}</span>
                    ${zoomStatus ? `<span>Zoom: <span style="color: ${zoomStatusColor};">${zoomStatusText}</span></span>` : ''}
                  </div>
                </div>
                ${zoomDevices.length > 0 ? `
                <div class="popup-section" style="padding: 4px 0;">
                  <div style="font-size: 10px; color: #06B6D4; margin-bottom: 2px;">üé• Zoom (${zoomDevices.length})</div>
                  ${zoomDevices.map(zd => `
                    <div style="font-size: 10px; padding: 2px 0; display: flex; align-items: baseline; gap: 4px;">
                      <span style="color: ${zd.status === 'Online' ? '#22C55E' : '#EF4444'};">‚óè</span>
                      <span style="color: #E2E8F0;">${zd.device_model || zd.device_type}</span>
                      <span style="color: #60A5FA;">${zd.ip_address || ''}</span>
                      <span style="color: #64748B; font-family: monospace; font-size: 9px;">${zd.serial_number || ''}</span>
                    </div>
                  `).join('')}
                </div>
                ` : ''}
                <div class="popup-section" style="padding: 4px 0;">
                  <div style="font-size: 10px; color: #F59E0B; margin-bottom: 2px;">üìπ Poly (${roomDevices.length})</div>
                  ${roomDevices.map(rd => `
                    <div style="font-size: 10px; padding: 2px 0; display: flex; align-items: baseline; gap: 4px;">
                      <span style="color: ${rd.connected ? '#22C55E' : '#EF4444'};">‚óè</span>
                      <span style="color: #E2E8F0;">${rd.hardwareModel || rd.name}</span>
                      <span style="color: #60A5FA;">${rd.ip || ''}</span>
                      <span style="color: #64748B; font-family: monospace; font-size: 9px;">${rd.serialNumber || ''}</span>
                    </div>
                  `).join('')}
                </div>
                <div class="popup-arrow"></div>
              </div>
            </div>
          `;
        } else if (device.source === 'zoomOnly') {
          // Zoom-only room marker (no Poly device)
          const popupBelowClass = pos.y < 30 ? 'popup-below' : '';
          const zoomStatusColor = device.zoom_status === 'Available' ? '#22C55E' :
                                  device.zoom_status === 'InMeeting' ? '#F59E0B' : '#EF4444';
          const zoomStatusText = device.zoom_status === 'Available' ? 'Available' :
                                 device.zoom_status === 'InMeeting' ? 'In Meeting' :
                                 device.zoom_status === 'Offline' ? 'Offline' : device.zoom_status;
          deviceMarkersHTML += `
            <div class="device-marker ${popupBelowClass}" data-id="${device.id}" style="left: ${pos.x}%; top: ${pos.y}%;"
              ${editMode ? 'draggable="true" onmousedown="startDrag(event, this)" onclick="event.stopPropagation(); event.preventDefault();"' : `onclick="event.stopPropagation(); openZoomRoomDetails('${device.zoom_id}', '${device.name.replace(/'/g, "\\'")}')"`}>
              ${device.status === 'down' ? `<div class="device-ping" style="background: ${statusColors.down.pulse};"></div>` : ''}
              <div class="device-dot" style="background: ${zoomStatusColor}; border-color: ${typeInfo.color};">
                ${device.zoom_in_meeting ? 'üìû' : 'üé•'}
              </div>
              <div class="device-popup">
                <div class="popup-header">
                  <span class="popup-icon">üé•</span>
                  <span class="popup-name">${sanitizeHTML(device.name)}</span>
                  <span class="status-badge" style="background: ${zoomStatusColor}; margin-left: 6px; font-size: 9px;">${zoomStatusText}</span>
                </div>
                ${device.zoom_devices && device.zoom_devices.length > 0 ? `
                <div class="popup-section" style="padding: 4px 0;">
                  <div style="font-size: 10px; color: #06B6D4; margin-bottom: 2px;">Devices (${device.zoom_devices.length})</div>
                  ${device.zoom_devices.map(zd => `
                    <div style="font-size: 10px; padding: 2px 0; display: flex; align-items: baseline; gap: 4px;">
                      <span style="color: ${zd.status === 'Online' ? '#22C55E' : '#EF4444'};">‚óè</span>
                      <span style="color: #E2E8F0;">${zd.device_model || zd.device_type}</span>
                      <span style="color: #60A5FA;">${zd.ip_address || ''}</span>
                      <span style="color: #64748B; font-family: monospace; font-size: 9px;">${zd.serial_number || ''}</span>
                    </div>
                  `).join('')}
                </div>
                ` : ''}
                <div class="popup-arrow"></div>
              </div>
            </div>
          `;
        } else {
          // Regular device marker (AP, Printer)
          const polyDevice = currentPolyData.find(p => p.ip === device.ip);
          const popupBelowClass = pos.y < 30 ? 'popup-below' : '';

          const disabledClass = device.disabled ? 'disabled' : '';
          deviceMarkersHTML += `
            <div class="device-marker ${popupBelowClass} ${disabledClass}" data-id="${device.id}" style="left: ${pos.x}%; top: ${pos.y}%;"
              ${editMode ? 'draggable="true" onmousedown="startDrag(event, this)" onclick="event.stopPropagation(); event.preventDefault();"' : `onclick="event.stopPropagation(); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', '${device.type}')"`}
              oncontextmenu="showContextMenu(event, ${JSON.stringify({id: device.id, name: device.name, hostname: device.ip || device.hostname, url: device.url, device_type: device.type, notes: device.notes, maintenance: device.maintenance, disabled: device.disabled}).replace(/"/g, '&quot;')}); return false;">
              ${device.status === 'down' && !device.disabled ? `<div class="device-ping" style="background: ${status.pulse};"></div>` : ''}
              <div class="device-dot" style="background: ${status.bg}; border-color: ${typeInfo.color};">
                ${typeInfo.icon.slice(0, 2)}
              </div>
              <div class="device-popup">
                <div class="popup-header">
                  <span class="popup-icon">${typeInfo.icon}</span>
                  <span class="popup-name">${sanitizeHTML(device.name)}</span>
                  <span class="status-badge" style="background: ${status.bg}; margin-left: 6px; font-size: 9px;">${status.label}</span>
                  ${device.health_score !== null && device.health_score !== undefined ? `
                    <span class="health-badge ${getHealthClass(device.health_score)}" style="margin-left: 4px; font-size: 9px;">‚ù§Ô∏è${device.health_score}%</span>
                  ` : ''}
                </div>
                <div class="popup-details" style="padding: 4px 0;">
                  <div style="font-size: 10px; display: flex; flex-wrap: wrap; gap: 8px;">
                    <span style="color: #60A5FA;">${device.ip || device.hostname || 'No IP'}</span>
                    ${device.ping ? `<span style="color: #94A3B8;">${device.ping}ms</span>` : ''}
                  </div>
                  ${device.lastCheck ? `
                  <div style="font-size: 9px; color: #64748B; margin-top: 2px;">
                    üïê Last seen: ${getTimeAgo(new Date(device.lastCheck))}
                  </div>
                  ` : ''}
                  ${device.serial_number ? `<div style="font-size: 9px; color: #64748B; font-family: monospace; margin-top: 2px;">SN: ${device.serial_number}</div>` : ''}
                </div>
                ${device.notes ? `
                  <div style="font-size: 10px; color: #94A3B8; padding: 2px 0; border-top: 1px solid rgba(148,163,184,0.2);">
                    üìù ${device.notes}
                  </div>
                ` : ''}
                ${renderSparkline(device.id)}
                ${polyDevice ? `
                  <div style="font-size: 10px; padding: 4px 0; border-top: 1px solid rgba(148,163,184,0.2);">
                    <span style="color: #F59E0B;">üìπ Poly:</span>
                    <span style="color: ${polyDevice.connected ? '#22C55E' : '#EF4444'};">${polyDevice.connected ? '‚óè' : '‚óã'}</span>
                    <span style="color: #E2E8F0;">${polyDevice.hardwareModel || ''}</span>
                    <span style="color: #94A3B8;">${polyDevice.room || ''}</span>
                  </div>
                ` : ''}
                ${device.type === 'printers' && printerStatusData[device.id] ? `
                  <div class="popup-section" style="padding: 4px 0; border-top: 1px solid rgba(148,163,184,0.2);">
                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 4px;">
                      <span style="font-size: 10px; color: #94A3B8;">Toner:</span>
                      ${['black', 'cyan', 'magenta', 'yellow'].map(color => {
                        const level = printerStatusData[device.id].toner[color];
                        if (level === null || level === undefined) return '';
                        const isLow = level < 20;
                        const bgColor = {black: '#1F2937', cyan: '#06B6D4', magenta: '#EC4899', yellow: '#FACC15'}[color];
                        return `
                          <div style="display: flex; align-items: center; gap: 2px;">
                            <div style="width: 20px; height: 8px; background: #374151; border-radius: 2px; overflow: hidden;">
                              <div style="width: ${level}%; height: 100%; background: ${bgColor};"></div>
                            </div>
                            <span style="font-size: 9px; color: ${isLow ? '#EF4444' : '#94A3B8'};">${level}%</span>
                          </div>
                        `;
                      }).join('')}
                    </div>
                    ${printerStatusData[device.id].paper?.level !== null ? `
                      <div style="display: flex; align-items: center; gap: 6px;">
                        <span style="font-size: 10px; color: #94A3B8;">üìÑ Paper:</span>
                        <div style="flex: 1; max-width: 60px; height: 6px; background: #374151; border-radius: 2px; overflow: hidden;">
                          <div style="width: ${printerStatusData[device.id].paper.level || 0}%; height: 100%; background: ${printerStatusData[device.id].paper.level < 20 ? '#EF4444' : '#22C55E'};"></div>
                        </div>
                        <span style="font-size: 9px; color: ${printerStatusData[device.id].paper.level < 20 ? '#EF4444' : '#94A3B8'};">${printerStatusData[device.id].paper.level || 0}%</span>
                        ${printerStatusData[device.id].info?.pageCount ? `<span style="font-size: 9px; color: #64748B; margin-left: 4px;">üìä ${printerStatusData[device.id].info.pageCount.toLocaleString()}</span>` : ''}
                      </div>
                    ` : ''}
                  </div>
                ` : ''}
                <div class="popup-arrow"></div>
              </div>
            </div>
          `;
        }
      });

      // Build sidebar with room groupings for Poly devices
      let sidebarHTML = '';

      // Access Points section (apply filters)
      let aps = currentFloorData.accessPoints || [];
      if (activeFilters.offlineOnly) {
        aps = aps.filter(d => d.status === 'down' && !d.disabled);
      }
      if (activeFilters.lowToner || activeFilters.inMeeting) {
        aps = []; // APs don't have toner or meetings
      }
      const allAps = currentFloorData.accessPoints || [];
      if (allAps.length > 0 && !activeFilters.lowToner && !activeFilters.inMeeting) {
        const apDownCount = allAps.filter(d => d.status === 'down').length;
        const showingFiltered = aps.length !== allAps.length;
        sidebarHTML += `
          <div class="device-category">
            <div class="category-header ap collapsed" onclick="toggleCategory(this)">
              <span>üì°</span>
              <span class="category-name">Access Points</span>
              <span class="category-count">${showingFiltered ? aps.length + ' filtered' : (allAps.length - apDownCount) + '/' + allAps.length}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${aps.length === 0 ? '<div style="padding: 8px; color: var(--text-muted); font-size: 12px;">No matching devices</div>' : aps.map(device => `
                <div class="device-item clickable ${device.status === 'down' ? 'down' : ''}" onclick="highlightDevice('${device.id}'); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'accessPoints')">
                  <div class="device-status-dot ${device.status}"></div>
                  <div class="device-info">
                    <div class="device-name">${sanitizeHTML(device.name)}</div>
                    <div class="device-meta">
                      <span>${sanitizeHTML(device.ip)}</span>
                      ${device.ping ? `<span>${device.ping}ms</span>` : ''}
                    </div>
                    ${device.serial_number ? `<div class="device-meta" style="font-size: 10px; opacity: 0.7;">SN: ${sanitizeHTML(device.serial_number)}</div>` : ''}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        `;
      }

      // Printers section (apply filters)
      const allPrinters = currentFloorData.printers || [];
      let printers = [...allPrinters];
      if (activeFilters.offlineOnly) {
        printers = printers.filter(d => d.status === 'down' && !d.disabled);
      }
      if (activeFilters.lowToner) {
        printers = printers.filter(d => {
          const toner = printerStatusData[d.id]?.toner || {};
          return Object.values(toner).some(level => level !== null && level < 20);
        });
      }
      if (activeFilters.inMeeting) {
        printers = []; // Printers don't have meetings
      }
      if (allPrinters.length > 0 && !activeFilters.inMeeting) {
        const printerDownCount = allPrinters.filter(d => d.status === 'down').length;
        const showingFilteredPrinters = printers.length !== allPrinters.length;
        sidebarHTML += `
          <div class="device-category">
            <div class="category-header printer collapsed" onclick="toggleCategory(this)">
              <span>üñ®Ô∏è</span>
              <span class="category-name">Printers</span>
              <span class="category-count">${showingFilteredPrinters ? printers.length + ' filtered' : (allPrinters.length - printerDownCount) + '/' + allPrinters.length}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${printers.length === 0 ? '<div style="padding: 8px; color: var(--text-muted); font-size: 12px;">No matching devices</div>' : printers.map(device => {
                const ps = printerStatusData[device.id];
                const toner = ps?.toner || {};
                const hasLowToner = [toner.black, toner.cyan, toner.magenta, toner.yellow].some(v => v !== null && v < 20);
                const monitor = allMonitors.find(m => m.id == device.id) || {};
                const currentFloor = monitor.floor || activeFloor;
                const serialNum = monitor.serial_number || '';
                return `
                <div class="device-item ${device.status === 'down' ? 'down' : ''}">
                  <div class="device-status-dot ${device.status}" onclick="highlightDevice('${device.id}'); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'printers')"></div>
                  <div class="device-info" style="flex: 1;">
                    <div class="device-name clickable" onclick="highlightDevice('${device.id}'); openAnalytics('${device.id}', '${device.name.replace(/'/g, "\\'")}', 'printers')">${sanitizeHTML(device.name)} ${hasLowToner ? '<span style="color: var(--status-warning);" title="Low toner">‚ö†Ô∏è</span>' : ''}</div>
                    <div class="device-meta">
                      <span>${sanitizeHTML(device.ip)}</span>
                      ${ps ? `<span style="margin-left: 8px;">üìÑ ${ps.paper?.level || 0}%</span>` : ''}
                    </div>
                    <div class="device-meta" style="margin-top: 4px; display: flex; gap: 8px; align-items: center;">
                      <select class="printer-floor-select" onchange="updatePrinterFloor(${device.id}, this.value)" onclick="event.stopPropagation()">
                        <option value="1st Floor" ${currentFloor === '1st Floor' ? 'selected' : ''}>1st</option>
                        <option value="2nd Floor" ${currentFloor === '2nd Floor' ? 'selected' : ''}>2nd</option>
                        <option value="3rd Floor" ${currentFloor === '3rd Floor' ? 'selected' : ''}>3rd</option>
                        <option value="5th Floor" ${currentFloor === '5th Floor' ? 'selected' : ''}>5th</option>
                      </select>
                      <input type="text" class="printer-serial-input" placeholder="Serial #" value="${serialNum}"
                             onclick="event.stopPropagation()"
                             onblur="updatePrinterSerial(${device.id}, this.value)"
                             onkeypress="if(event.key==='Enter'){this.blur();}">
                    </div>
                  </div>
                  ${ps ? `
                    <div class="sidebar-toner" title="Toner: K:${toner.black || 0}% C:${toner.cyan || 0}% M:${toner.magenta || 0}% Y:${toner.yellow || 0}%">
                      <div class="sidebar-toner-dot black ${(toner.black || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot cyan ${(toner.cyan || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot magenta ${(toner.magenta || 0) < 20 ? 'low' : ''}"></div>
                      <div class="sidebar-toner-dot yellow ${(toner.yellow || 0) < 20 ? 'low' : ''}"></div>
                    </div>
                  ` : ''}
                </div>
              `}).join('')}
            </div>
          </div>
        `;
      }

      // Poly Lens / Zoom Rooms section - grouped by room (apply filters)
      const polyRooms = getPolyLensRooms(activeFloor);
      let roomNames = Object.keys(polyRooms).sort();

      // Apply filters to rooms
      if (activeFilters.offlineOnly) {
        roomNames = roomNames.filter(roomName => {
          const roomDevices = polyRooms[roomName];
          return roomDevices.some(d => !d.connected && !d.disabled);
        });
      }
      if (activeFilters.lowToner) {
        roomNames = []; // Rooms don't have toner
      }
      if (activeFilters.inMeeting) {
        roomNames = roomNames.filter(roomName => {
          const roomDevices = polyRooms[roomName];
          return roomDevices.some(d => d.zoom_in_meeting);
        });
      }

      const allRoomNames = Object.keys(polyRooms);
      if (allRoomNames.length > 0 && !activeFilters.lowToner) {
        const totalPolyDevices = currentPolyData.length;
        const onlinePolyDevices = currentPolyData.filter(d => d.connected).length;
        const showingFilteredRooms = roomNames.length !== allRoomNames.length;

        sidebarHTML += `
          <div class="device-category">
            <div class="category-header poly collapsed" onclick="toggleCategory(this)">
              <span>üìπ</span>
              <span class="category-name">Zoom Rooms</span>
              <span class="category-count">${showingFilteredRooms ? roomNames.length + ' filtered' : onlinePolyDevices + '/' + totalPolyDevices}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content collapsed">
              ${roomNames.length === 0 ? '<div style="padding: 8px; color: var(--text-muted); font-size: 12px;">No matching rooms</div>' : roomNames.map(roomName => {
                const roomDevices = polyRooms[roomName];
                // Check ALL devices for connection status (not just active ones)
                const onlineInRoom = roomDevices.filter(d => d.connected).length;
                const allOnline = roomDevices.length > 0 && roomDevices.every(d => d.connected);
                const anyOffline = roomDevices.some(d => !d.connected);
                // Check Zoom status for any device in room
                const anyInMeeting = roomDevices.some(d => d.zoom_in_meeting);
                const zoomStatus = roomDevices.find(d => d.zoom_status)?.zoom_status;
                // Get Zoom devices from any device in room
                const zoomDevices = roomDevices.find(d => d.zoom_devices)?.zoom_devices || [];

                const roomId = 'room-' + roomName.replace(/\s+/g, '-');
                return `
                  <div class="room-group">
                    <div class="room-header collapsed" onclick="toggleRoom(event, this, '${roomId}')">
                      <div class="room-status ${anyOffline ? 'down' : 'up'}"></div>
                      <span class="room-name">${roomName}</span>
                      ${anyInMeeting ? '<span style="font-size: 10px; background: var(--status-warning); color: #000; padding: 1px 6px; border-radius: 8px; margin-left: 6px;">In Meeting</span>' : ''}
                      <span style="font-size: 11px; color: #64748B;">${onlineInRoom}/${roomDevices.length}</span>
                      <span class="collapse-icon">‚ñº</span>
                    </div>
                    <div class="room-devices collapsed">
                      ${zoomDevices.length > 0 ? `
                        <div style="padding: 6px 8px; margin-bottom: 6px; background: rgba(6, 182, 212, 0.1); border-radius: 6px; border-left: 2px solid #06B6D4;">
                          <div style="font-size: 10px; color: #06B6D4; font-weight: 600; margin-bottom: 4px;">üé• Zoom Devices (${zoomDevices.length})</div>
                          ${zoomDevices.map(zd => `
                            <div style="padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                              <div style="display: flex; align-items: center; gap: 4px;">
                                <span style="color: ${zd.status === 'Online' ? '#22C55E' : '#EF4444'};">‚óè</span>
                                <strong>${zd.device_model || zd.device_type || 'Device'}</strong>
                              </div>
                              <div style="margin-left: 12px; color: #94A3B8;">
                                ${zd.ip_address ? `<div><span style="color: #60A5FA;">IP: ${zd.ip_address}</span></div>` : ''}
                                ${zd.serial_number ? `<div style="font-family: monospace;">SN: ${zd.serial_number}</div>` : ''}
                              </div>
                            </div>
                          `).join('')}
                        </div>
                      ` : ''}
                      <div style="font-size: 10px; color: #F59E0B; font-weight: 600; margin-bottom: 4px; padding-left: 8px;">üìπ Poly Devices (${roomDevices.length})</div>
                      ${roomDevices.map(device => `
                        <div class="device-item clickable ${!device.connected ? 'down' : ''}" onclick="event.stopPropagation(); highlightDevice('${roomId}'); openAnalytics('${roomId}', '${roomName.replace(/'/g, "\\'")}', 'polyLens', true)">
                          <div class="device-status-dot ${device.connected ? 'up' : 'down'}"></div>
                          <div class="device-info">
                            <div class="device-name">${sanitizeHTML(device.name)}</div>
                            <div class="device-meta">
                              <span class="device-model">${device.hardwareModel || 'Unknown'}</span>
                            </div>
                            ${device.ip ? `<div class="device-meta" style="font-size: 10px;"><span style="color: #60A5FA;">IP: ${device.ip}</span></div>` : ''}
                            ${device.serialNumber ? `<div class="device-meta" style="font-size: 10px; opacity: 0.7;">SN: ${device.serialNumber}</div>` : ''}
                          </div>
                        </div>
                      `).join('')}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          </div>
        `;
      }

      // Zoom-only rooms section (rooms without Poly devices) - apply filters
      const allZoomOnly = zoomOnlyRooms[activeFloor] || [];
      let currentZoomOnly = [...allZoomOnly];
      if (activeFilters.offlineOnly) {
        currentZoomOnly = currentZoomOnly.filter(r => r.zoom_status === 'Offline');
      }
      if (activeFilters.lowToner) {
        currentZoomOnly = []; // Zoom rooms don't have toner
      }
      if (activeFilters.inMeeting) {
        currentZoomOnly = currentZoomOnly.filter(r => r.in_meeting);
      }
      if (allZoomOnly.length > 0 && !activeFilters.lowToner) {
        const zoomOnline = allZoomOnly.filter(r => r.zoom_status === 'Available' || r.zoom_status === 'InMeeting').length;
        const showingFilteredZoom = currentZoomOnly.length !== allZoomOnly.length;

        sidebarHTML += `
          <div class="device-category">
            <div class="category-header" style="border-color: #06B6D4; background: rgba(6, 182, 212, 0.1);" onclick="toggleCategory(this)">
              <span>üé•</span>
              <span class="category-name">Zoom Only</span>
              <span class="category-count">${showingFilteredZoom ? currentZoomOnly.length + ' filtered' : zoomOnline + '/' + allZoomOnly.length}</span>
              <span class="collapse-icon">‚ñº</span>
            </div>
            <div class="category-content">
              ${currentZoomOnly.length === 0 ? '<div style="padding: 8px; color: var(--text-muted); font-size: 12px;">No matching rooms</div>' : currentZoomOnly.map(room => {
                const devices = room.zoom_devices || [];
                return `
                <div class="room-group" style="margin-bottom: 8px;">
                  <div class="device-item clickable ${room.zoom_status === 'Offline' ? 'down' : ''}" onclick="openZoomRoomDetails('${room.id}', '${room.displayName.replace(/'/g, "\\'")}')">
                    <div class="device-status-dot ${room.zoom_status === 'Available' ? 'up' : room.zoom_status === 'InMeeting' ? 'warning' : 'down'}"></div>
                    <div class="device-info">
                      <div class="device-name">${room.displayName}</div>
                      <div class="device-meta">
                        <span style="color: ${room.zoom_status === 'Available' ? 'var(--status-online)' : room.zoom_status === 'InMeeting' ? 'var(--status-warning)' : 'var(--status-offline)'};">
                          ${room.zoom_status === 'Available' ? '‚úì Available' : room.zoom_status === 'InMeeting' ? 'üìû In Meeting' : room.zoom_status === 'Offline' ? '‚ö† Offline' : room.zoom_status}
                        </span>
                        <span style="margin-left: 6px; font-size: 10px; color: #64748B;">${devices.length} device${devices.length !== 1 ? 's' : ''}</span>
                      </div>
                    </div>
                  </div>
                  ${devices.length > 0 ? `
                  <div style="margin-left: 20px; padding: 6px 8px; background: rgba(15, 23, 42, 0.5); border-radius: 6px; border-left: 2px solid #06B6D4;">
                    ${devices.map(zd => `
                      <div style="padding: 4px 0; font-size: 10px; border-bottom: 1px solid rgba(148,163,184,0.1);">
                        <div style="display: flex; align-items: center; gap: 4px;">
                          <span style="color: ${zd.status === 'Online' ? '#22C55E' : '#EF4444'};">‚óè</span>
                          <strong style="color: var(--text-primary);">${zd.device_model || zd.device_type || 'Device'}</strong>
                        </div>
                        <div style="margin-left: 12px; color: #94A3B8;">
                          ${zd.ip_address ? `<div><span style="color: #60A5FA;">IP: ${zd.ip_address}</span></div>` : ''}
                          ${zd.serial_number ? `<div style="font-family: monospace;">SN: ${zd.serial_number}</div>` : ''}
                        </div>
                      </div>
                    `).join('')}
                  </div>
                  ` : ''}
                </div>
              `}).join('')}
            </div>
          </div>
        `;
      }

      // Show active filter indicator
      const hasActiveFilters = activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting;

      // Calculate total stats across all floors
      const totalStats = { online: 0, offline: 0, polyOnline: 0, polyTotal: 0, zoomOnline: 0, zoomTotal: 0 };
      floors.forEach(floor => {
        const fd = monitorData[floor] || { accessPoints: [], printers: [] };
        const pf = polyLensData[floor] || [];
        const zf = zoomOnlyRooms[floor] || [];
        Object.values(fd).forEach(cat => {
          if (Array.isArray(cat)) {
            cat.forEach(d => {
              if (d.status === 'up') totalStats.online++;
              else if (d.status === 'down') totalStats.offline++;
            });
          }
        });
        totalStats.polyOnline += pf.filter(d => d.connected).length;
        totalStats.polyTotal += pf.length;
        // Add Zoom-only rooms to stats
        totalStats.zoomOnline += zf.filter(r => r.zoom_status === 'Available' || r.zoom_status === 'InMeeting').length;
        totalStats.zoomTotal += zf.length;
      });
      const healthPercent = totalStats.online + totalStats.offline > 0
        ? Math.round((totalStats.online / (totalStats.online + totalStats.offline)) * 100)
        : 100;

      // Render the page with new professional 3-column layout
      document.getElementById('app').innerHTML = `
        <div class="app-container">
          <!-- HEADER -->
          <header class="header">
            <div class="header-left">
              <div class="logo">
                <span class="logo-icon">üè¢</span>
                <span class="logo-text">Office Monitor</span>
                <span class="logo-badge">v2</span>
              </div>

              <div class="status-bar">
                <div class="status-metric" onclick="showStatusDetail('online')" title="Click for details">
                  <span class="status-dot online"></span>
                  <span class="status-value">${totalStats.online}</span>
                  <span class="status-label">Online</span>
                </div>
                <div class="status-metric" onclick="showStatusDetail('offline')" title="Click for details">
                  <span class="status-dot ${totalStats.offline > 0 ? 'offline' : 'online'}"></span>
                  <span class="status-value">${totalStats.offline}</span>
                  <span class="status-label">Offline</span>
                </div>
                <div class="status-metric" onclick="showStatusDetail('poly')" title="Click for details">
                  <span class="status-dot online"></span>
                  <span class="status-value">${totalStats.polyOnline}</span>
                  <span class="status-label">Zoom</span>
                </div>

                <div class="health-bar-container" title="System Health: ${healthPercent}%">
                  <div class="health-bar">
                    <div class="health-bar-fill" style="width: ${healthPercent}%; background: ${healthPercent >= 90 ? 'var(--status-online)' : healthPercent >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'};"></div>
                  </div>
                  <span class="health-percent" style="color: ${healthPercent >= 90 ? 'var(--status-online)' : healthPercent >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'};">${healthPercent}%</span>
                </div>
              </div>
            </div>

            <div class="header-right">
              <!-- Global Search -->
              <div class="global-search">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" placeholder="Search devices..." id="global-search" oninput="handleSearch(this.value)" onfocus="showSearchResults()" onblur="hideSearchResults()">
                <div class="search-results" id="search-results" onmousedown="event.preventDefault()"></div>
              </div>

              <!-- Notification Center -->
              <button class="notification-btn" onclick="toggleNotifications()" title="Notifications">
                üîî
                <span class="notification-badge" id="notification-badge" style="display: none;">0</span>
              </button>

              <div class="time-display">
                <span class="time-value">${now}</span>
                <div id="connection-status" class="connection-status ${wsConnected ? 'connected' : wsReconnecting ? 'reconnecting' : 'disconnected'}">
                  <span class="status-icon">${wsConnected ? '‚óè' : wsReconnecting ? '‚Üª' : '‚óè'}</span>
                  ${wsConnected ? 'Live' : wsReconnecting ? 'Reconnecting...' : 'Disconnected'}
                </div>
              </div>
              <div class="last-updated" title="Last data refresh">
                <span>Updated:</span>
                <span id="last-updated-time">${lastDataUpdate ? formatLastUpdated() : 'Loading...'}</span>
                <span class="refresh-icon" onclick="manualRefresh()" title="Refresh now">‚Üª</span>
              </div>

              <div class="header-actions">
                <button class="mobile-menu-btn" onclick="toggleMobileMenu()" title="Menu" aria-label="Toggle mobile menu">
                  <span aria-hidden="true">‚ò∞</span>
                </button>
                <button class="panel-toggle" onclick="toggleLeftPanel()" title="Toggle sidebar (S)" aria-label="Toggle sidebar" aria-expanded="${!leftPanelCollapsed}">
                  <span aria-hidden="true">${leftPanelCollapsed ? '‚ñ∂' : '‚óÄ'}</span>
                </button>
                <button class="compact-toggle ${compactMode ? 'active' : ''}" onclick="toggleCompactMode()" title="Compact mode (C)" aria-label="Toggle compact mode" aria-pressed="${compactMode}">
                  <span aria-hidden="true">${compactMode ? '‚ñ¢' : '‚ñ£'}</span>
                </button>
                <button class="compact-toggle ${alertSoundsEnabled ? 'active' : ''}" onclick="toggleAlertSounds()" title="Alert sounds" aria-label="Toggle alert sounds" aria-pressed="${alertSoundsEnabled}">
                  <span aria-hidden="true">${alertSoundsEnabled ? 'üîî' : 'üîï'}</span>
                </button>
                <button class="compact-toggle ${pushNotificationsEnabled ? 'active' : ''}" onclick="togglePushNotifications()" title="Push notifications" aria-label="Toggle push notifications" aria-pressed="${pushNotificationsEnabled}">
                  <span aria-hidden="true">${pushNotificationsEnabled ? 'üì≤' : 'üìµ'}</span>
                </button>
                ${editMode ? `
                  <button class="header-btn primary" onclick="savePositionChanges()" aria-label="Save position changes">
                    <span aria-hidden="true">üíæ</span> Save${getPendingCount() > 0 ? ` (${getPendingCount()})` : ''}
                  </button>
                  <button class="header-btn" onclick="cancelPositionChanges()" style="border-color: var(--status-offline);" aria-label="Cancel editing">
                    <span aria-hidden="true">‚úï</span> Cancel
                  </button>
                ` : `
                  <button class="header-btn" onclick="toggleEditMode()" aria-label="Enable edit mode"><span aria-hidden="true">‚úèÔ∏è</span> Edit</button>
                `}
                <button class="header-btn" onclick="openCustomizeModal()" title="Customize Dashboard" aria-label="Customize dashboard">
                  <span aria-hidden="true">üé®</span><span class="sr-only">Customize</span>
                </button>
                <button class="header-btn" onclick="window.location.href='reports.html'" title="Uptime Reports" aria-label="View uptime reports">
                  <span aria-hidden="true">üìä</span><span class="sr-only">Reports</span>
                </button>
                <button class="header-btn" onclick="window.location.href='topology.html'" title="Network Topology" aria-label="View network topology">
                  <span aria-hidden="true">üîó</span><span class="sr-only">Topology</span>
                </button>
                <button class="header-btn" onclick="window.location.href='3d-floor-view.html'" title="3D Floor View" aria-label="View 3D floor">
                  <span aria-hidden="true">üè†</span><span class="sr-only">3D View</span>
                </button>
                <button class="header-btn" onclick="window.location.href='wall-editor.html'" title="Wall Editor" aria-label="Edit walls">
                  <span aria-hidden="true">üèóÔ∏è</span><span class="sr-only">Wall Editor</span>
                </button>
                <button class="header-btn" onclick="window.location.href='settings.html'" title="Settings" aria-label="Open settings">
                  <span aria-hidden="true">‚öôÔ∏è</span>${isAdmin() && pendingChangesCount > 0 ? `<span class="pending-badge" aria-label="${pendingChangesCount} pending changes">${pendingChangesCount}</span>` : ''}<span class="sr-only">Settings</span>
                </button>
              </div>

              <div class="user-menu" onclick="toggleUserMenu()">
                <div class="user-avatar">${(currentUser?.username || 'G')[0].toUpperCase()}</div>
                <div style="display: flex; flex-direction: column; align-items: flex-start;">
                  <span class="user-name">${currentUser?.username || 'Guest'}</span>
                  <span class="user-role">${currentUser?.role === 'admin' ? 'Admin' : 'User'}</span>
                </div>
              </div>
            </div>
          </header>

          <!-- NOTIFICATION PANEL -->
          <div class="notification-panel" id="notification-panel">
            <div class="notification-header">
              <span class="notification-title">üîî Notifications</span>
              <span class="notification-clear" onclick="clearNotifications()">Clear all</span>
            </div>
            <div class="notification-list" id="notification-list">
              <div class="notification-empty">No notifications yet</div>
            </div>
          </div>

          <!-- Mobile Overlay -->
          <div class="mobile-overlay" onclick="closeMobileMenu()"></div>

          <!-- MAIN CONTENT - 3 Column Layout -->
          <div class="main-content ${editMode ? 'edit-mode' : ''} ${leftPanelCollapsed ? 'left-collapsed' : ''}">

            <!-- LEFT PANEL - Floor Navigation -->
            <aside class="left-panel">
              <div class="panel-header">
                <h2 class="panel-title">Floors</h2>
              </div>
              <nav class="floor-nav">
                ${floors.map(floor => {
                  const floorData = monitorData[floor] || { accessPoints: [], printers: [] };
                  const polyFloor = polyLensData[floor] || [];
                  const counts = getStatusCounts(floorData, polyFloor);
                  const deviceCount = counts.total + polyFloor.length;
                  const issueCount = counts.down + polyFloor.filter(d => !d.connected).length;
                  const isActive = floor === activeFloor;
                  const health = floorHealthData[floor];
                  const healthScore = health?.health_score ?? 100;
                  const healthColor = getFloorHealthColor(healthScore);

                  return `
                    <div class="floor-item ${isActive ? 'active' : ''} ${issueCount > 0 ? 'has-issues' : ''}"
                         onclick="setFloor('${floor}')">
                      <div class="floor-icon">${isActive ? '‚ñ∂' : 'üè¢'}</div>
                      <div class="floor-info">
                        <div class="floor-name">${floor}</div>
                        <div class="floor-stats">
                          <span>${deviceCount} devices</span>
                          <span class="floor-status ${issueCount > 0 ? 'issue' : 'ok'}">
                            ${issueCount > 0 ? `‚óè ${issueCount} issue${issueCount > 1 ? 's' : ''}` : '‚úì OK'}
                          </span>
                        </div>
                        <div class="floor-health">
                          <div class="floor-health-bar">
                            <div class="floor-health-fill" style="width: ${healthScore}%; background: ${healthColor};"></div>
                          </div>
                          <span class="floor-health-score" style="color: ${healthColor};">${healthScore}%</span>
                        </div>
                      </div>
                    </div>
                  `;
                }).join('')}
              </nav>

              <!-- Quick Filters -->
              <div class="quick-filters" role="group" aria-label="Device filters">
                <button class="filter-btn ${activeFilters.offlineOnly ? 'active' : ''}" onclick="toggleFilter('offlineOnly')" title="Show only offline devices" aria-pressed="${activeFilters.offlineOnly}" aria-label="Filter offline devices (${getFilterCounts().offlineCount})">
                  <span aria-hidden="true">üî¥</span> Offline <span class="filter-count">${getFilterCounts().offlineCount}</span>
                </button>
                <button class="filter-btn ${activeFilters.lowToner ? 'active' : ''}" onclick="toggleFilter('lowToner')" title="Show printers with low toner" aria-pressed="${activeFilters.lowToner}" aria-label="Filter low toner printers (${getFilterCounts().lowTonerCount})">
                  <span aria-hidden="true">üé®</span> Low Toner <span class="filter-count">${getFilterCounts().lowTonerCount}</span>
                </button>
                <button class="filter-btn ${activeFilters.inMeeting ? 'active' : ''}" onclick="toggleFilter('inMeeting')" title="Show rooms in meeting" aria-pressed="${activeFilters.inMeeting}" aria-label="Filter rooms in meeting (${getFilterCounts().inMeetingCount})">
                  <span aria-hidden="true">üìû</span> In Meeting <span class="filter-count">${getFilterCounts().inMeetingCount}</span>
                </button>
              </div>

              <div class="quick-stats">
                <div class="quick-stat-item" onclick="showDevicesByType('accessPoints')" title="View all Access Points">
                  <span class="quick-stat-label">Access Points</span>
                  <span class="quick-stat-value">${(currentFloorData.accessPoints || []).length}</span>
                </div>
                <div class="quick-stat-item" onclick="showDevicesByType('printers')" title="View all Printers">
                  <span class="quick-stat-label">Printers</span>
                  <span class="quick-stat-value">${(currentFloorData.printers || []).length}</span>
                </div>
                <div class="quick-stat-item" onclick="showDevicesByType('polyLens')" title="View all Zoom Rooms">
                  <span class="quick-stat-label">Zoom Rooms</span>
                  <span class="quick-stat-value">${currentPolyData.length}</span>
                </div>
              </div>
            </aside>

            <!-- CENTER - Floor Map (Hero) -->
            <main class="map-container">
              <div class="floor-label">${activeFloor}</div>

              <div class="floor-map" id="floor-map-container">
                ${floorPlans[activeFloor]?.image_data ? `
                  <img src="data:image/${floorPlans[activeFloor].image_type};base64,${floorPlans[activeFloor].image_data}"
                       class="floor-plan-bg-loader"
                       id="floor-plan-img"
                       onload="onFloorPlanLoaded(this)"
                       alt="" />
                  <div class="markers-overlay" id="markers-overlay">
                    ${renderZones(activeFloor)}
                    ${deviceMarkersHTML}
                  </div>
                ` : `
                  <div class="map-placeholder">
                    <div class="map-placeholder-icon">üó∫Ô∏è</div>
                    <div class="map-placeholder-title">No Floor Plan</div>
                    <div class="map-placeholder-subtitle">Upload a floor plan in Settings</div>
                  </div>
                `}
              </div>

              <div class="map-controls" role="toolbar" aria-label="Map controls">
                <button class="map-control-btn" onclick="zoomIn()" title="Zoom In" aria-label="Zoom in">+</button>
                <button class="map-control-btn" onclick="zoomOut()" title="Zoom Out" aria-label="Zoom out">‚àí</button>
                <button class="map-control-btn" onclick="resetZoom()" title="Reset" aria-label="Reset view">‚ü≤</button>
                <button class="map-control-btn" onclick="toggleFullscreen()" title="Fullscreen" aria-label="Toggle fullscreen">‚õ∂</button>
              </div>
            </main>

            <!-- RIGHT PANEL - Device List -->
            <aside class="right-panel">
              <div class="device-list-header">
                <h2 class="device-list-title">${activeFloor} Devices</h2>
                <div class="device-search">
                  <input type="text" placeholder="Search devices..." onkeyup="filterDevices(this.value)" aria-label="Search devices" role="searchbox">
                </div>
              </div>

              <div class="device-list">
                ${sidebarHTML || `
                  <div class="empty-state">
                    <div class="empty-state-icon">${(activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting) ? 'üîç' : 'üì≠'}</div>
                    <div class="empty-state-title">${(activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting) ? 'No matching devices' : 'No devices found'}</div>
                    <div class="empty-state-text">${(activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting)
                      ? 'Try adjusting your filters or switch to a different floor'
                      : 'Add devices to start monitoring this floor'}</div>
                    ${(activeFilters.offlineOnly || activeFilters.lowToner || activeFilters.inMeeting) ? `
                      <button class="btn btn-sm btn-secondary" onclick="clearAllFilters()" style="margin-top: 8px;">Clear Filters</button>
                    ` : ''}
                  </div>
                `}
              </div>

              <!-- Status Summary -->
              <div class="status-summary">
                <div class="summary-title">Status Overview</div>
                <div class="summary-stats">
                  <div class="summary-stat green" onclick="showStatusDetail('online')">
                    <span class="stat-value">${totalStats.online}</span>
                    <span class="stat-label">Online</span>
                  </div>
                  <div class="summary-stat ${totalStats.offline > 0 ? 'red' : ''}" onclick="showStatusDetail('offline')">
                    <span class="stat-value">${totalStats.offline}</span>
                    <span class="stat-label">Offline</span>
                  </div>
                  <div class="summary-stat yellow" onclick="showLowTonerPrinters()">
                    <span class="stat-value" id="low-toner-count">${getLowTonerCount()}</span>
                    <span class="stat-label">Low Toner</span>
                  </div>
                  <div class="summary-stat blue" onclick="showHealthDetails()">
                    <span class="stat-value">${healthPercent}%</span>
                    <span class="stat-label">Health</span>
                  </div>
                </div>
              </div>
            </aside>
          </div>

          <!-- FOOTER -->
          <footer class="footer">
            <div class="footer-left">
              <div class="legend">
                <div class="legend-item" onclick="showDevicesByType('accessPoints')" title="Click to view all Access Points">
                  <span class="legend-dot ap"></span>
                  <span>Access Points</span>
                </div>
                <div class="legend-item" onclick="showDevicesByType('printers')" title="Click to view all Printers">
                  <span class="legend-dot printer"></span>
                  <span>Printers</span>
                </div>
                <div class="legend-item" onclick="showDevicesByType('polyLens')" title="Click to view all Zoom Rooms">
                  <span class="legend-dot zoom"></span>
                  <span>Zoom Rooms</span>
                </div>
                <div class="legend-item" onclick="showStatusDetail('online')" title="Click to view Online devices">
                  <span class="legend-dot online"></span>
                  <span>Online</span>
                </div>
                <div class="legend-item" onclick="showStatusDetail('offline')" title="Click to view Offline devices">
                  <span class="legend-dot offline"></span>
                  <span>Offline</span>
                </div>
              </div>
            </div>

            <div class="footer-center">
              <!-- Event ticker can go here -->
            </div>

            <div class="footer-right">
              <div class="data-source" onclick="showDataSourceInfo('monitors')">
                <span style="color: ${apiStatus.monitors.connected ? 'var(--status-online)' : 'var(--status-offline)'};">‚óè</span>
                Monitors (${apiStatus.monitors.monitorCount})
              </div>
              <div class="data-source" onclick="showDataSourceInfo('polylens')">
                <span style="color: ${apiStatus.polyLens.configured ? 'var(--status-online)' : 'var(--status-offline)'};">‚óè</span>
                Poly Lens (${apiStatus.polyLens.deviceCount})
              </div>
            </div>
          </footer>
        </div>
      `;

      // Update markers overlay position after DOM update
      setTimeout(updateMarkersOverlay, 50);
    }

    function setFloor(floor) {
      // Clean up any active drag operation
      if (isDragging) {
        document.removeEventListener('mousemove', onDrag);
        document.removeEventListener('mouseup', endDrag);
        isDragging = false;
        currentDragElement = null;
      }

      // Skip if same floor or transitioning
      if (floor === activeFloor || isFloorTransitioning) return;

      // Animate floor transition
      isFloorTransitioning = true;
      const mapContainer = document.querySelector('.floor-map');

      if (mapContainer) {
        mapContainer.style.opacity = '0';
        mapContainer.style.transform = 'scale(0.98)';

        setTimeout(() => {
          activeFloor = floor;
          render();

          requestAnimationFrame(() => {
            const newMap = document.querySelector('.floor-map');
            if (newMap) {
              newMap.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              newMap.style.opacity = '1';
              newMap.style.transform = 'scale(1)';
            }
            setTimeout(() => {
              isFloorTransitioning = false;
            }, 300);
          });
        }, 250);
      } else {
        activeFloor = floor;
        render();
        isFloorTransitioning = false;
      }
    }

    function toggleLeftPanel() {
      leftPanelCollapsed = !leftPanelCollapsed;
      localStorage.setItem('leftPanelCollapsed', leftPanelCollapsed);
      render();
      // Update overlay after panel animation completes
      setTimeout(updateMarkersOverlay, 350);
    }

    function toggleCompactMode() {
      compactMode = !compactMode;
      localStorage.setItem('compactMode', compactMode);
      document.body.classList.toggle('compact-mode', compactMode);
      render();
    }

    // Apply compact mode on load
    if (compactMode) {
      document.body.classList.add('compact-mode');
    }

    function toggleAlertSounds() {
      alertSoundsEnabled = !alertSoundsEnabled;
      localStorage.setItem('alertSoundsEnabled', alertSoundsEnabled);
      if (alertSoundsEnabled) {
        playAlertSound('enable'); // Play a soft sound to confirm enabled
      }
      render();
    }

    function playAlertSound(type = 'alert') {
      if (!alertSoundsEnabled && type !== 'enable') return;

      try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();

        const playTone = (freq, duration, startTime = 0, waveType = 'sine', volume = 0.3) => {
          const osc = audioContext.createOscillator();
          const gain = audioContext.createGain();
          osc.connect(gain);
          gain.connect(audioContext.destination);
          osc.type = waveType;
          osc.frequency.setValueAtTime(freq, audioContext.currentTime + startTime);
          gain.gain.setValueAtTime(volume, audioContext.currentTime + startTime);
          gain.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + startTime + duration);
          osc.start(audioContext.currentTime + startTime);
          osc.stop(audioContext.currentTime + startTime + duration);
        };

        switch (type) {
          case 'offline':
            // Urgent descending alarm - device went offline
            playTone(880, 0.15, 0);
            playTone(660, 0.15, 0.18);
            playTone(440, 0.25, 0.36);
            break;

          case 'online':
            // Pleasant ascending chime - device back online
            playTone(440, 0.12, 0, 'sine', 0.2);
            playTone(550, 0.12, 0.12, 'sine', 0.2);
            playTone(660, 0.2, 0.24, 'sine', 0.2);
            break;

          case 'lowToner':
            // Warning beeps - low toner
            playTone(600, 0.1, 0, 'triangle', 0.25);
            playTone(600, 0.1, 0.15, 'triangle', 0.25);
            playTone(500, 0.15, 0.3, 'triangle', 0.25);
            break;

          case 'meeting':
            // Soft notification - meeting started/ended
            playTone(523, 0.1, 0, 'sine', 0.15);
            playTone(659, 0.15, 0.12, 'sine', 0.15);
            break;

          case 'critical':
            // Urgent repeated alarm - critical issue
            for (let i = 0; i < 3; i++) {
              playTone(880, 0.08, i * 0.2, 'square', 0.2);
              playTone(660, 0.08, i * 0.2 + 0.1, 'square', 0.2);
            }
            break;

          case 'enable':
            // Soft confirmation sound
            playTone(440, 0.1, 0, 'sine', 0.2);
            playTone(550, 0.15, 0.1, 'sine', 0.2);
            break;

          case 'alert':
          default:
            // Standard alert - two quick beeps
            playTone(800, 0.15, 0);
            playTone(600, 0.15, 0.2);
            break;
        }
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    // ==================== PUSH NOTIFICATIONS ====================
    let pushNotificationsEnabled = localStorage.getItem('pushNotificationsEnabled') === 'true';

    async function requestPushPermission() {
      if (!('Notification' in window)) {
        showAlert('Push notifications not supported in this browser', 'warning');
        return false;
      }

      if (Notification.permission === 'granted') {
        pushNotificationsEnabled = true;
        localStorage.setItem('pushNotificationsEnabled', 'true');
        return true;
      }

      if (Notification.permission === 'denied') {
        showAlert('Push notifications were denied. Please enable in browser settings.', 'warning');
        return false;
      }

      const permission = await Notification.requestPermission();
      if (permission === 'granted') {
        pushNotificationsEnabled = true;
        localStorage.setItem('pushNotificationsEnabled', 'true');
        showAlert('Push notifications enabled!', 'success');
        return true;
      }
      return false;
    }

    function sendPushNotification(title, options = {}) {
      if (!pushNotificationsEnabled || Notification.permission !== 'granted') return;

      const notification = new Notification(title, {
        icon: 'üè¢',
        badge: 'üè¢',
        tag: options.tag || 'office-monitor',
        renotify: options.renotify || false,
        requireInteraction: options.requireInteraction || false,
        ...options
      });

      notification.onclick = () => {
        window.focus();
        notification.close();
        if (options.onClick) options.onClick();
      };

      // Auto-close after 10 seconds
      setTimeout(() => notification.close(), 10000);
    }

    function togglePushNotifications() {
      if (pushNotificationsEnabled) {
        pushNotificationsEnabled = false;
        localStorage.setItem('pushNotificationsEnabled', 'false');
        showAlert('Push notifications disabled', 'info');
      } else {
        requestPushPermission();
      }
      render();
    }

    // ==================== FLOOR HEALTH ====================
    let floorHealthData = {};

    async function fetchFloorHealth() {
      try {
        const response = await fetch(`${API_URL}/api/floors/health`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            floorHealthData = {};
            data.floors.forEach(f => {
              floorHealthData[f.floor] = f;
            });
          }
        }
      } catch (e) {
        console.error('Failed to fetch floor health:', e);
      }
    }

    function getFloorHealthColor(score) {
      if (score >= 95) return 'var(--status-online)';
      if (score >= 80) return 'var(--status-warning)';
      return 'var(--status-offline)';
    }

    // ==================== DEVICE TAGS ====================
    let allTags = [];

    async function fetchAllTags() {
      try {
        const response = await fetch(`${API_URL}/api/tags`);
        if (response.ok) {
          const data = await response.json();
          if (data.success) {
            allTags = data.tags;
          }
        }
      } catch (e) {
        console.error('Failed to fetch tags:', e);
      }
    }

    async function addTagToDevice(deviceId, tag) {
      const monitor = allMonitors.find(m => m.id == deviceId);
      if (!monitor) return;

      let tags = [];
      try {
        tags = JSON.parse(monitor.tags || '[]');
      } catch (e) {
        tags = [];
      }

      if (!tags.includes(tag)) {
        tags.push(tag);
        await authFetch(`${API_URL}/api/monitors/${deviceId}/tags`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ tags })
        });
        monitor.tags = JSON.stringify(tags);
        if (!allTags.includes(tag)) allTags.push(tag);
        render();
      }
    }

    async function removeTagFromDevice(deviceId, tag) {
      const monitor = allMonitors.find(m => m.id == deviceId);
      if (!monitor) return;

      let tags = [];
      try {
        tags = JSON.parse(monitor.tags || '[]');
      } catch (e) {
        tags = [];
      }

      tags = tags.filter(t => t !== tag);
      await authFetch(`${API_URL}/api/monitors/${deviceId}/tags`, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ tags })
      });
      monitor.tags = JSON.stringify(tags);
      render();
    }

    function renderDeviceTags(deviceId) {
      const monitor = allMonitors.find(m => m.id == deviceId);
      if (!monitor) return '';

      let tags = [];
      try {
        tags = JSON.parse(monitor.tags || '[]');
      } catch (e) {
        tags = [];
      }

      return `
        <div class="device-tags">
          ${tags.map(tag => `
            <span class="device-tag">
              ${tag}
              <span class="tag-remove" onclick="event.stopPropagation(); removeTagFromDevice(${deviceId}, '${tag}')">&times;</span>
            </span>
          `).join('')}
          <span class="device-tag editable" onclick="event.stopPropagation(); promptAddTag(${deviceId})">+ Add</span>
        </div>
      `;
    }

    function promptAddTag(deviceId) {
      const tag = prompt('Enter tag name:');
      if (tag && tag.trim()) {
        addTagToDevice(deviceId, tag.trim().toLowerCase());
      }
    }

    // ==================== MOBILE MENU ====================
    let mobileMenuOpen = false;

    function toggleMobileMenu() {
      mobileMenuOpen = !mobileMenuOpen;
      document.querySelector('.left-panel')?.classList.toggle('mobile-open', mobileMenuOpen);
      document.querySelector('.mobile-overlay')?.classList.toggle('active', mobileMenuOpen);
    }

    function closeMobileMenu() {
      mobileMenuOpen = false;
      document.querySelector('.left-panel')?.classList.remove('mobile-open');
      document.querySelector('.mobile-overlay')?.classList.remove('active');
    }

    // ==================== MEETING UTILIZATION ====================
    async function fetchRoomUtilization(roomId) {
      try {
        const response = await fetch(`${API_URL}/api/zoom-rooms/${roomId}/utilization?days=7`);
        if (response.ok) {
          return await response.json();
        }
      } catch (e) {
        console.error('Failed to fetch room utilization:', e);
      }
      return null;
    }

    function renderUtilizationChart(dailyStats) {
      if (!dailyStats || dailyStats.length === 0) {
        return '<div style="color: var(--text-muted); font-size: 11px;">No utilization data yet</div>';
      }

      return `
        <div class="utilization-bar">
          ${dailyStats.map(d => {
            const color = d.utilization > 70 ? 'var(--status-offline)' :
                          d.utilization > 40 ? 'var(--status-warning)' :
                          d.utilization > 0 ? 'var(--status-online)' : 'var(--bg-overlay)';
            return `<div class="utilization-segment" style="background: ${color};" title="${d.date}: ${d.utilization}% (${d.meeting_count} meetings)"></div>`;
          }).join('')}
        </div>
        <div class="utilization-legend">
          <span>${dailyStats[0]?.date || ''}</span>
          <span>${dailyStats[dailyStats.length - 1]?.date || ''}</span>
        </div>
      `;
    }

    // ==================== DASHBOARD CUSTOMIZATION ====================
    const defaultDashboardConfig = {
      showLeftPanel: true,
      showRightPanel: true,
      showFooter: true,
      showAccessPoints: true,
      showPrinters: true,
      showZoomRooms: true,
      showOfflineOnly: false,
      animateStatus: true,
      showResponseTimes: true,
      refreshRate: 30000
    };

    let dashboardConfig = { ...defaultDashboardConfig };

    function loadDashboardConfig() {
      const saved = localStorage.getItem('dashboardConfig');
      if (saved) {
        try {
          dashboardConfig = { ...defaultDashboardConfig, ...JSON.parse(saved) };
        } catch (e) {
          dashboardConfig = { ...defaultDashboardConfig };
        }
      }
      applyDashboardConfig();
    }

    function saveDashboardConfig() {
      dashboardConfig = {
        showLeftPanel: document.getElementById('show-left-panel')?.checked ?? true,
        showRightPanel: document.getElementById('show-right-panel')?.checked ?? true,
        showFooter: document.getElementById('show-footer')?.checked ?? true,
        showAccessPoints: document.getElementById('show-access-points')?.checked ?? true,
        showPrinters: document.getElementById('show-printers')?.checked ?? true,
        showZoomRooms: document.getElementById('show-zoom-rooms')?.checked ?? true,
        showOfflineOnly: document.getElementById('show-offline-only')?.checked ?? false,
        animateStatus: document.getElementById('animate-status')?.checked ?? true,
        showResponseTimes: document.getElementById('show-response-times')?.checked ?? true,
        refreshRate: parseInt(document.getElementById('refresh-rate')?.value) || 30000
      };
      localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
      applyDashboardConfig();
      render();
    }

    function applyDashboardConfig() {
      // Apply panel visibility
      const leftPanel = document.querySelector('.left-panel');
      const rightPanel = document.querySelector('.right-panel');
      const footer = document.querySelector('.footer');

      if (leftPanel) leftPanel.style.display = dashboardConfig.showLeftPanel ? '' : 'none';
      if (rightPanel) rightPanel.style.display = dashboardConfig.showRightPanel ? '' : 'none';
      if (footer) footer.style.display = dashboardConfig.showFooter ? '' : 'none';

      // Apply animation class to body
      document.body.classList.toggle('animations-enabled', dashboardConfig.animateStatus);

      // Update refresh interval if changed
      if (window.refreshInterval) {
        clearInterval(window.refreshInterval);
      }
      window.refreshInterval = setInterval(() => {
        fetchAllData();
      }, dashboardConfig.refreshRate);
    }

    function openCustomizeModal() {
      const modal = document.getElementById('customize-modal');
      modal.style.display = 'flex';

      // Populate form with current values
      document.getElementById('show-left-panel').checked = dashboardConfig.showLeftPanel;
      document.getElementById('show-right-panel').checked = dashboardConfig.showRightPanel;
      document.getElementById('show-footer').checked = dashboardConfig.showFooter;
      document.getElementById('show-access-points').checked = dashboardConfig.showAccessPoints;
      document.getElementById('show-printers').checked = dashboardConfig.showPrinters;
      document.getElementById('show-zoom-rooms').checked = dashboardConfig.showZoomRooms;
      document.getElementById('show-offline-only').checked = dashboardConfig.showOfflineOnly;
      document.getElementById('animate-status').checked = dashboardConfig.animateStatus;
      document.getElementById('show-response-times').checked = dashboardConfig.showResponseTimes;
      document.getElementById('refresh-rate').value = dashboardConfig.refreshRate;
    }

    function closeCustomizeModal() {
      document.getElementById('customize-modal').style.display = 'none';
    }

    function exportDashboardConfig() {
      const config = {
        dashboardConfig: dashboardConfig,
        leftPanelCollapsed: leftPanelCollapsed,
        compactMode: compactMode,
        alertSoundsEnabled: alertSoundsEnabled,
        activeFloor: activeFloor,
        exportDate: new Date().toISOString(),
        version: '2.0'
      };
      const blob = new Blob([JSON.stringify(config, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `office-monitor-config-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Configuration exported!', 'success');
    }

    function importDashboardConfig(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const config = JSON.parse(e.target.result);
          if (config.dashboardConfig) {
            dashboardConfig = { ...defaultDashboardConfig, ...config.dashboardConfig };
            localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
          }
          if (config.leftPanelCollapsed !== undefined) {
            leftPanelCollapsed = config.leftPanelCollapsed;
            localStorage.setItem('leftPanelCollapsed', leftPanelCollapsed);
          }
          if (config.compactMode !== undefined) {
            compactMode = config.compactMode;
            localStorage.setItem('compactMode', compactMode);
          }
          if (config.alertSoundsEnabled !== undefined) {
            alertSoundsEnabled = config.alertSoundsEnabled;
            localStorage.setItem('alertSoundsEnabled', alertSoundsEnabled);
          }
          applyDashboardConfig();
          render();
          closeCustomizeModal();
          showToast('Configuration imported!', 'success');
        } catch (err) {
          showToast('Invalid config file', 'error');
        }
      };
      reader.readAsText(file);
      event.target.value = '';
    }

    function resetDashboardConfig() {
      if (!confirm('Reset all dashboard settings to defaults?')) return;
      dashboardConfig = { ...defaultDashboardConfig };
      localStorage.setItem('dashboardConfig', JSON.stringify(dashboardConfig));
      applyDashboardConfig();
      openCustomizeModal(); // Refresh the modal
      render();
      showToast('Settings reset to defaults', 'success');
    }

    // Close all modals on escape key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        // Close customize modal
        closeCustomizeModal();
        // Close edit monitor modal
        if (typeof closeModal === 'function') closeModal();
        // Close room label editor if open
        const roomLabelModal = document.querySelector('.room-label-editor-modal');
        if (roomLabelModal) roomLabelModal.remove();
        // Close any other open modal overlays
        document.querySelectorAll('.modal-overlay.open, .modal.open').forEach(modal => {
          modal.classList.remove('open');
        });
      }
    });

    document.getElementById('customize-modal')?.addEventListener('click', (e) => {
      if (e.target.id === 'customize-modal') {
        closeCustomizeModal();
      }
    });

    function checkForStatusChanges() {
      let newOfflineDevices = [];
      let newOnlineDevices = [];
      let lowTonerPrinters = [];

      // Check all floors for status changes
      Object.values(monitorData).forEach(floor => {
        ['accessPoints', 'printers'].forEach(type => {
          if (floor[type]) {
            floor[type].forEach(device => {
              const prevStatus = previousDeviceStatuses[device.id];
              const currentStatus = device.status;

              // Device went offline
              if (prevStatus === 'up' && currentStatus === 'down' && !device.disabled && !device.maintenance) {
                newOfflineDevices.push(device.name);
              }

              // Device came back online
              if (prevStatus === 'down' && currentStatus === 'up') {
                newOnlineDevices.push(device.name);
              }

              // Check for low toner on printers (using server-side alert state)
              if (type === 'printers' && printerStatusData[device.id]) {
                const toner = printerStatusData[device.id].toner || {};
                const activeAlerts = activeThresholdAlerts[device.id] || [];

                // Check each toner color - only alert if critically low AND no active server alert
                const tonerColors = ['black', 'cyan', 'magenta', 'yellow'];
                let hasNewLowToner = false;

                for (const color of tonerColors) {
                  const level = toner[color];
                  const alertType = `toner_${color}`;
                  // Alert at <10% for critical browser notification
                  // Server alerts at <20%, so we only show browser alert if server hasn't alerted yet
                  if (level !== null && level < 10 && !activeAlerts.includes(alertType)) {
                    hasNewLowToner = true;
                    break;
                  }
                }

                if (hasNewLowToner) {
                  lowTonerPrinters.push(device.name);
                }
              }

              // Update stored status
              previousDeviceStatuses[device.id] = currentStatus;
            });
          }
        });
      });

      // Handle offline alerts (highest priority)
      if (newOfflineDevices.length > 0) {
        const isCritical = newOfflineDevices.length >= 3;
        playAlertSound(isCritical ? 'critical' : 'offline');
        sendPushNotification(
          isCritical ? 'üö® Critical: Multiple Devices Offline' : 'üî¥ Device Offline',
          {
            body: newOfflineDevices.join(', ') + ' went offline',
            tag: 'offline-alert',
            renotify: true,
            requireInteraction: isCritical
          }
        );
        addNotification('offline', `${newOfflineDevices.join(', ')} went offline`);
      }

      // Handle back online notifications
      if (newOnlineDevices.length > 0) {
        playAlertSound('online');
        sendPushNotification('‚úÖ Device Back Online', {
          body: newOnlineDevices.join(', ') + ' is back online',
          tag: 'online-alert'
        });
        addNotification('online', `${newOnlineDevices.join(', ')} is back online`);
      }

      // Handle low toner warnings
      if (lowTonerPrinters.length > 0) {
        playAlertSound('lowToner');
        sendPushNotification('üé® Low Toner Warning', {
          body: lowTonerPrinters.join(', ') + ' has critically low toner (<10%)',
          tag: 'toner-alert'
        });
        addNotification('warning', `${lowTonerPrinters.join(', ')} has low toner`);
      }

      // Refresh floor health data periodically
      fetchFloorHealth();
    }

    // ==================== KEYBOARD SHORTCUTS ====================
    document.addEventListener('keydown', (e) => {
      // Ignore if typing in an input
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

      const floors = Object.keys(monitorData).length > 0
        ? Object.keys(monitorData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      switch(e.key) {
        case '1': setFloor(floors[0] || '1st Floor'); break;
        case '2': setFloor(floors[1] || '2nd Floor'); break;
        case '3': setFloor(floors[2] || '3rd Floor'); break;
        case '4': case '5': setFloor(floors[3] || '5th Floor'); break;
        case 'e': case 'E':
          if (!e.metaKey && !e.ctrlKey) toggleEditMode();
          break;
        case 's': case 'S':
          if (!e.metaKey && !e.ctrlKey) toggleLeftPanel();
          break;
        case 'c': case 'C':
          if (!e.metaKey && !e.ctrlKey) toggleCompactMode();
          break;
      }
    });

    // ==================== DASHBOARD WIDGETS & NEW FEATURES ====================

    // Notifications storage
    let notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    let notificationPanelOpen = false;

    // Get low toner printer count
    function getLowTonerCount() {
      let count = 0;
      Object.values(printerStatusData).forEach(ps => {
        if (ps?.toner) {
          const levels = [ps.toner.black, ps.toner.cyan, ps.toner.magenta, ps.toner.yellow];
          if (levels.some(l => l !== null && l < 20)) count++;
        }
      });
      return count;
    }

    // Sidebar list view state
    let sidebarListView = null;

    // Show sidebar list view (replaces device list in right panel)
    function showSidebarList(title, content) {
      sidebarListView = { title, content };
      const deviceList = document.querySelector('.device-list');
      if (deviceList) {
        deviceList.innerHTML = `
          <div class="sidebar-list-view">
            <div class="sidebar-list-header" style="display: flex; align-items: center; gap: 10px; padding: 12px 16px; background: var(--bg-elevated); border-bottom: 1px solid var(--border-subtle);">
              <button onclick="closeSidebarList()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; font-size: 18px; padding: 4px;">‚Üê</button>
              <h3 style="font-size: 14px; font-weight: 600; color: var(--text-primary); margin: 0;">${title}</h3>
            </div>
            <div class="sidebar-list-content" style="overflow-y: auto; max-height: calc(100vh - 350px);">
              ${content}
            </div>
            <div style="padding: 10px 16px; background: var(--bg-secondary); font-size: 11px; color: var(--text-muted); text-align: center; border-top: 1px solid var(--border-subtle);">
              Click a device to locate it on the map
            </div>
          </div>
        `;
      }
    }

    // Close sidebar list and restore device list
    function closeSidebarList() {
      sidebarListView = null;
      renderDashboard(); // Re-render to restore device list
    }

    // Show low toner printers in sidebar
    function showLowTonerPrinters() {
      const lowToner = [];
      Object.entries(printerStatusData).forEach(([id, ps]) => {
        if (ps?.toner) {
          const low = [];
          let printer = null;
          // Find printer info
          Object.values(monitorData).forEach(floor => {
            if (floor.printers) {
              const p = floor.printers.find(pr => pr.id == id);
              if (p) printer = p;
            }
          });
          if (ps.toner.black !== null && ps.toner.black < 20) low.push({ color: 'black', level: ps.toner.black });
          if (ps.toner.cyan !== null && ps.toner.cyan < 20) low.push({ color: 'cyan', level: ps.toner.cyan });
          if (ps.toner.magenta !== null && ps.toner.magenta < 20) low.push({ color: 'magenta', level: ps.toner.magenta });
          if (ps.toner.yellow !== null && ps.toner.yellow < 20) low.push({ color: 'yellow', level: ps.toner.yellow });
          if (low.length > 0) {
            lowToner.push({ id, name: printer?.name || 'Printer ' + id, floor: printer?.floor || '', low });
          }
        }
      });

      if (lowToner.length === 0) {
        showAlert('All printers have sufficient toner!', 'success');
        return;
      }

      const content = lowToner.map(p => `
        <div class="status-list-item" onclick="closeSidebarList(); highlightDevice('${p.id}');" style="cursor: pointer; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; transition: background 0.15s;">
          <div>
            <div style="font-weight: 600; color: var(--text-primary);">${p.name}</div>
            <div style="font-size: 11px; color: var(--text-muted);">${p.floor || 'Unknown floor'}</div>
          </div>
          <div style="display: flex; gap: 6px; align-items: center;">
            ${p.low.map(l => `
              <div style="display: flex; flex-direction: column; align-items: center; min-width: 28px;">
                <div style="width: 12px; height: 12px; border-radius: 50%; background: ${l.color === 'black' ? '#374151' : l.color}; border: 1px solid rgba(255,255,255,0.2);"></div>
                <span style="font-size: 9px; color: var(--status-warning); font-weight: 600;">${l.level}%</span>
              </div>
            `).join('')}
            <span style="color: var(--accent-blue); font-size: 16px; margin-left: 8px;">üìç</span>
          </div>
        </div>
      `).join('');

      showSidebarList(`‚ö†Ô∏è Low Toner Printers (${lowToner.length})`, content);
    }

    function closeStatusModal() {
      document.getElementById('modal-container').innerHTML = '';
    }

    // Show health details in sidebar
    function showHealthDetails() {
      const total = totalStats.online + totalStats.offline;
      const health = total > 0 ? Math.round((totalStats.online / total) * 100) : 100;

      // Get devices with low health scores
      const lowHealthDevices = [];
      Object.values(monitorData).forEach(floor => {
        Object.values(floor).forEach(cat => {
          if (Array.isArray(cat)) {
            cat.forEach(d => {
              if (d.health_score !== null && d.health_score < 90) {
                lowHealthDevices.push(d);
              }
            });
          }
        });
      });
      lowHealthDevices.sort((a, b) => (a.health_score || 0) - (b.health_score || 0));

      const content = `
        <div style="padding: 20px; text-align: center; border-bottom: 1px solid var(--border-subtle);">
          <div style="font-size: 48px; font-weight: 700; color: ${health >= 90 ? 'var(--status-online)' : health >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'};">${health}%</div>
          <div style="display: flex; justify-content: center; gap: 30px; margin-top: 12px;">
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: 600; color: var(--status-online);">${totalStats.online}</div>
              <div style="font-size: 11px; color: var(--text-muted);">Online</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: 600; color: var(--status-offline);">${totalStats.offline}</div>
              <div style="font-size: 11px; color: var(--text-muted);">Offline</div>
            </div>
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: 600; color: var(--text-primary);">${total}</div>
              <div style="font-size: 11px; color: var(--text-muted);">Total</div>
            </div>
          </div>
        </div>
        ${lowHealthDevices.length > 0 ? `
          <div style="padding: 12px 16px; background: var(--bg-secondary);">
            <div style="font-size: 12px; font-weight: 600; color: var(--text-muted);">‚ö†Ô∏è Devices Needing Attention</div>
          </div>
          ${lowHealthDevices.slice(0, 10).map(d => `
            <div class="status-list-item" onclick="closeSidebarList(); highlightDevice('${d.id}');" style="cursor: pointer; padding: 10px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center;">
              <div style="font-weight: 500; color: var(--text-primary);">${d.name}</div>
              <div style="display: flex; align-items: center; gap: 8px;">
                <span style="font-size: 12px; color: ${d.health_score >= 70 ? 'var(--status-warning)' : 'var(--status-offline)'}; font-weight: 600;">${d.health_score}%</span>
                <span style="color: var(--accent-blue);">üìç</span>
              </div>
            </div>
          `).join('')}
        ` : `
          <div style="padding: 20px; text-align: center; color: var(--text-muted);">
            All devices are healthy!
          </div>
        `}
      `;

      showSidebarList('üíö Network Health', content);
    }

    // ==================== GLOBAL SEARCH ====================
    let allSearchableDevices = [];

    function buildSearchIndex() {
      allSearchableDevices = [];
      Object.entries(monitorData).forEach(([floor, data]) => {
        if (data.accessPoints) {
          data.accessPoints.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Access Point' }));
        }
        if (data.printers) {
          data.printers.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Printer' }));
        }
      });
      Object.entries(polyLensData).forEach(([floor, devices]) => {
        devices.forEach(d => allSearchableDevices.push({ ...d, floor, type: 'Zoom Room', status: d.connected ? 'up' : 'down' }));
      });
    }

    function handleSearch(query) {
      if (!query || query.length < 2) {
        document.getElementById('search-results').innerHTML = '';
        return;
      }

      buildSearchIndex();
      const q = query.toLowerCase();
      const results = allSearchableDevices.filter(d =>
        (d.name && d.name.toLowerCase().includes(q)) ||
        (d.ip && d.ip.toLowerCase().includes(q)) ||
        (d.hostname && d.hostname.toLowerCase().includes(q)) ||
        (d.floor && d.floor.toLowerCase().includes(q)) ||
        (d.type && d.type.toLowerCase().includes(q))
      ).slice(0, 10);

      const container = document.getElementById('search-results');
      if (results.length === 0) {
        container.innerHTML = '<div class="search-no-results">No devices found</div>';
      } else {
        container.innerHTML = results.map(d => `
          <div class="search-result-item" onclick="goToDevice('${d.id}', '${d.floor}', '${d.type}')">
            <div class="search-result-status ${d.status}"></div>
            <div class="search-result-info">
              <div class="search-result-name">${sanitizeHTML(d.name)}</div>
              <div class="search-result-meta">${d.type} ¬∑ ${d.floor} ¬∑ ${d.ip || 'No IP'}</div>
            </div>
          </div>
        `).join('');
      }
    }

    function showSearchResults() {
      document.getElementById('search-results').classList.add('active');
    }

    function hideSearchResults() {
      document.getElementById('search-results').classList.remove('active');
    }

    function goToDevice(id, floor, type) {
      setFloor(floor);
      setTimeout(() => {
        highlightDevice(id);
        const typeLower = type === 'Access Point' ? 'accessPoints' : type === 'Printer' ? 'printers' : 'polyLens';
        openAnalytics(id, '', typeLower);
      }, 300);
      hideSearchResults();
      document.getElementById('global-search').value = '';
    }

    // ==================== NOTIFICATION CENTER ====================
    function addNotification(type, message, deviceName = '') {
      const notification = {
        id: Date.now(),
        type,
        message,
        deviceName,
        time: new Date().toISOString(),
        read: false
      };
      notifications.unshift(notification);
      if (notifications.length > 50) notifications = notifications.slice(0, 50);
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      renderNotifications();
    }

    function updateNotificationBadge() {
      const unread = notifications.filter(n => !n.read).length;
      const badge = document.getElementById('notification-badge');
      if (badge) {
        if (unread > 0) {
          badge.textContent = unread > 99 ? '99+' : unread;
          badge.style.display = 'flex';
        } else {
          badge.style.display = 'none';
        }
      }
    }

    function toggleNotifications() {
      notificationPanelOpen = !notificationPanelOpen;
      const panel = document.getElementById('notification-panel');
      if (panel) {
        panel.classList.toggle('active', notificationPanelOpen);
        if (notificationPanelOpen) {
          notifications.forEach(n => n.read = true);
          localStorage.setItem('notifications', JSON.stringify(notifications));
          updateNotificationBadge();
        }
      }
    }

    function renderNotifications() {
      const list = document.getElementById('notification-list');
      if (!list) return;

      if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-empty">No notifications yet</div>';
        return;
      }

      list.innerHTML = notifications.slice(0, 20).map(n => {
        const icon = n.type === 'offline' ? 'üî¥' : n.type === 'online' ? 'üü¢' : '‚ö†Ô∏è';
        const iconClass = n.type === 'offline' ? 'offline' : n.type === 'online' ? 'online' : 'warning';
        const timeAgo = getTimeAgo(new Date(n.time));
        return `
          <div class="notification-item ${n.read ? '' : 'unread'}">
            <div class="notification-icon ${iconClass}">${icon}</div>
            <div class="notification-content">
              <div class="notification-text">${n.message}</div>
              <div class="notification-time">${timeAgo}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function clearNotifications() {
      notifications = [];
      localStorage.setItem('notifications', JSON.stringify(notifications));
      updateNotificationBadge();
      renderNotifications();
    }

    function getTimeAgo(date) {
      const seconds = Math.floor((new Date() - date) / 1000);
      if (seconds < 60) return 'Just now';
      if (seconds < 3600) return Math.floor(seconds / 60) + 'm ago';
      if (seconds < 86400) return Math.floor(seconds / 3600) + 'h ago';
      return Math.floor(seconds / 86400) + 'd ago';
    }

    // Close notification panel when clicking outside
    document.addEventListener('click', (e) => {
      const panel = document.getElementById('notification-panel');
      const btn = document.querySelector('.notification-btn');
      if (panel && notificationPanelOpen && !panel.contains(e.target) && !btn.contains(e.target)) {
        notificationPanelOpen = false;
        panel.classList.remove('active');
      }
    });

    // ==================== BULK ACTIONS ====================
    let bulkMode = false;

    function toggleBulkMode() {
      bulkMode = !bulkMode;
      selectedDevices.clear();
      document.body.classList.toggle('bulk-mode', bulkMode);
      render();
    }

    function toggleDeviceSelection(deviceId, event) {
      if (event) event.stopPropagation();
      if (selectedDevices.has(deviceId)) {
        selectedDevices.delete(deviceId);
      } else {
        selectedDevices.add(deviceId);
      }
      render();
    }

    function selectAllDevices() {
      buildSearchIndex();
      allSearchableDevices.forEach(d => selectedDevices.add(d.id));
      render();
    }

    function deselectAllDevices() {
      selectedDevices.clear();
      render();
    }

    async function bulkMoveToFloor(targetFloor) {
      for (const deviceId of selectedDevices) {
        try {
          await authFetch(API_URL + '/api/monitors/' + deviceId, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ floor: targetFloor })
          });
        } catch (e) {
          console.error('Failed to move device ' + deviceId);
        }
      }
      showAlert('Moved ' + selectedDevices.size + ' devices to ' + targetFloor, 'success');
      selectedDevices.clear();
      bulkMode = false;
      await fetchData();
    }

    async function bulkDelete() {
      if (!confirm('Delete ' + selectedDevices.size + ' devices? This cannot be undone.')) return;
      for (const deviceId of selectedDevices) {
        try {
          await authFetch(API_URL + '/api/monitors/' + deviceId, { method: 'DELETE' });
        } catch (e) {
          console.error('Failed to delete device ' + deviceId);
        }
      }
      showAlert('Deleted ' + selectedDevices.size + ' devices', 'success');
      selectedDevices.clear();
      bulkMode = false;
      await fetchData();
    }

    // ==================== INCIDENT TIMELINE ====================
    let incidents = [];

    async function loadIncidents() {
      try {
        const response = await authFetch(API_URL + '/api/incidents');
        if (response.ok) {
          const data = await response.json();
          incidents = data.incidents || [];
          updateIncidentCount();
        }
      } catch (e) {
        console.error('Failed to load incidents:', e);
      }
    }

    function updateIncidentCount() {
      const today = new Date().toDateString();
      const todayIncidents = incidents.filter(i => new Date(i.started_at).toDateString() === today);
      const el = document.getElementById('incident-count');
      if (el) el.textContent = todayIncidents.length;
    }

    function showIncidentTimeline() {
      if (incidents.length === 0) {
        showAlert('No incidents recorded yet', 'info');
        return;
      }

      const html = incidents.slice(0, 10).map(i => {
        const duration = i.resolved_at
          ? Math.round((new Date(i.resolved_at) - new Date(i.started_at)) / 60000) + ' min'
          : 'Ongoing';
        return i.device_name + ' went ' + (i.type === 'down' ? 'offline' : 'online') +
          ' (' + formatIsraelTime(i.started_at) + ', ' + duration + ')';
      }).join('\\n');

      showAlert('Recent Incidents:\\n' + html, 'info');
    }

    // Record incident when device status changes
    function recordIncident(deviceId, deviceName, type) {
      const incident = {
        device_id: deviceId,
        device_name: deviceName,
        type: type,
        started_at: new Date().toISOString()
      };

      // Try to save to server
      authFetch(API_URL + '/api/incidents', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(incident)
      }).catch(e => console.error('Failed to record incident:', e));

      // Add to local list
      incidents.unshift(incident);
      updateIncidentCount();

      // Add notification
      addNotification(type, deviceName + ' went ' + (type === 'down' ? 'offline' : 'online'), deviceName);
    }

    // ==================== ACTIVITY LOG ====================
    async function logActivity(action, details) {
      try {
        await authFetch(API_URL + '/api/activity-log', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, details })
        });
      } catch (e) {
        console.error('Failed to log activity:', e);
      }
    }

    // ==================== HISTORICAL TRENDS ====================
    function renderTrendsChart(containerId, data) {
      const container = document.getElementById(containerId);
      if (!container || !data || data.length === 0) return;

      const maxVal = Math.max(...data.map(d => d.value), 1);
      const bars = data.map(d => {
        const height = Math.round((d.value / maxVal) * 100);
        const className = d.value >= 99 ? 'high' : d.value >= 90 ? 'medium' : 'low';
        return '<div class="trend-bar ' + className + '" style="height: ' + height + '%;" title="' + d.label + ': ' + d.value + '%"></div>';
      }).join('');

      container.innerHTML = `
        <div class="trends-bars">${bars}</div>
        <div class="trends-labels">
          <span>${data[0]?.label || ''}</span>
          <span>${data[data.length - 1]?.label || ''}</span>
        </div>
      `;
    }

    // Initialize notifications on load
    setTimeout(() => {
      updateNotificationBadge();
      renderNotifications();
      loadIncidents();
    }, 1000);

    // ==================== UI FEATURES ====================

    // Store floor plan dimensions for positioning calculations
    let floorPlanDimensions = {};

    // Called when floor plan image loads (from hidden img element)
    function onFloorPlanLoaded(img) {
      const floor = activeFloor;
      floorPlanDimensions[floor] = {
        width: img.naturalWidth,
        height: img.naturalHeight,
        aspectRatio: img.naturalWidth / img.naturalHeight
      };

      // Set background image on container
      const container = document.getElementById('floor-map-container');
      if (container) {
        container.style.backgroundImage = `url('${img.src}')`;
      }

      // Position the markers overlay
      updateMarkersOverlay();
    }

    // Update markers overlay to match actual floor plan image bounds
    function updateMarkersOverlay() {
      const container = document.getElementById('floor-map-container');
      const overlay = document.getElementById('markers-overlay');
      const dims = floorPlanDimensions[activeFloor];

      if (!container || !overlay || !dims) return;

      const containerRect = container.getBoundingClientRect();
      const containerWidth = containerRect.width;
      const containerHeight = containerRect.height;
      const containerAspect = containerWidth / containerHeight;
      const imageAspect = dims.aspectRatio;

      let imageWidth, imageHeight, offsetX, offsetY;

      if (containerAspect > imageAspect) {
        // Container is wider - image is limited by height
        imageHeight = containerHeight;
        imageWidth = imageHeight * imageAspect;
        offsetX = (containerWidth - imageWidth) / 2;
        offsetY = 0;
      } else {
        // Container is taller - image is limited by width
        imageWidth = containerWidth;
        imageHeight = imageWidth / imageAspect;
        offsetX = 0;
        offsetY = (containerHeight - imageHeight) / 2;
      }

      // Position the overlay to exactly match the image bounds
      overlay.style.left = `${offsetX}px`;
      overlay.style.top = `${offsetY}px`;
      overlay.style.width = `${imageWidth}px`;
      overlay.style.height = `${imageHeight}px`;
    }

    // Update overlay on window resize
    let resizeTimeout;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(updateMarkersOverlay, 50);
    });

    // Also update after render completes
    setTimeout(updateMarkersOverlay, 100);

    // Zoom/Pan for floor map
    let mapZoom = 1;
    let mapPanX = 0;
    let mapPanY = 0;

    function zoomIn() {
      mapZoom = Math.min(mapZoom * 1.2, 4);
      applyMapTransform();
    }

    function zoomOut() {
      mapZoom = Math.max(mapZoom / 1.2, 0.5);
      applyMapTransform();
    }

    function resetZoom() {
      mapZoom = 1;
      mapPanX = 0;
      mapPanY = 0;
      applyMapTransform();
    }

    function applyMapTransform() {
      const floorMap = document.querySelector('.floor-map');
      if (floorMap) {
        floorMap.style.transform = `scale(${mapZoom}) translate(${mapPanX}px, ${mapPanY}px)`;
      }
    }

    function toggleFullscreen() {
      const mapContainer = document.querySelector('.map-container');
      if (!mapContainer) return;

      if (!document.fullscreenElement) {
        mapContainer.requestFullscreen().catch(() => {});
      } else {
        document.exitFullscreen();
      }
    }

    // Device filter
    function filterDevices(query) {
      const items = document.querySelectorAll('.device-item, .room-group');
      const q = query.toLowerCase();

      items.forEach(item => {
        const text = item.textContent.toLowerCase();
        const matches = text.includes(q);
        item.style.display = matches ? '' : 'none';

        // Highlight matching text in device names
        if (matches && q.length > 0) {
          const nameEl = item.querySelector('.device-name');
          if (nameEl && !nameEl.dataset.originalText) {
            nameEl.dataset.originalText = nameEl.innerHTML;
          }
          if (nameEl && nameEl.dataset.originalText) {
            nameEl.innerHTML = highlightSearchText(nameEl.dataset.originalText, query);
          }
        } else {
          const nameEl = item.querySelector('.device-name');
          if (nameEl && nameEl.dataset.originalText) {
            nameEl.innerHTML = nameEl.dataset.originalText;
          }
        }
      });
    }

    // User menu dropdown
    let userMenuOpen = false;
    function toggleUserMenu() {
      userMenuOpen = !userMenuOpen;
      const existingMenu = document.getElementById('user-menu-dropdown');

      if (existingMenu) {
        existingMenu.remove();
        userMenuOpen = false;
        return;
      }

      const userMenu = document.querySelector('.user-menu');
      const rect = userMenu.getBoundingClientRect();

      const dropdown = document.createElement('div');
      dropdown.id = 'user-menu-dropdown';
      dropdown.style.cssText = `
        position: fixed;
        top: ${rect.bottom + 8}px;
        right: ${window.innerWidth - rect.right}px;
        background: var(--bg-elevated);
        border: 1px solid var(--border-default);
        border-radius: var(--radius-md);
        box-shadow: var(--shadow-lg);
        z-index: 1000;
        min-width: 180px;
        overflow: hidden;
      `;

      dropdown.innerHTML = `
        <div style="padding: 12px 16px; border-bottom: 1px solid var(--border-subtle);">
          <div style="font-weight: 600; color: var(--text-primary);">${currentUser?.username || 'Guest'}</div>
          <div style="font-size: 11px; color: var(--text-muted);">${currentUser?.role === 'admin' ? 'Administrator' : 'User'}</div>
        </div>
        <div class="user-menu-item" onclick="closeUserMenu(); showChangePasswordModal();" style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.15s;">
          <span>üîê</span>
          <span>Change Password</span>
        </div>
        <div class="user-menu-item" onclick="closeUserMenu(); logout();" style="padding: 10px 16px; cursor: pointer; display: flex; align-items: center; gap: 10px; color: var(--status-offline); transition: background 0.15s;">
          <span>üö™</span>
          <span>Logout</span>
        </div>
      `;

      // Add hover styles
      dropdown.querySelectorAll('.user-menu-item').forEach(item => {
        item.addEventListener('mouseenter', () => {
          item.style.background = 'var(--bg-overlay)';
        });
        item.addEventListener('mouseleave', () => {
          item.style.background = 'transparent';
        });
      });

      document.body.appendChild(dropdown);

      // Close menu when clicking outside
      setTimeout(() => {
        document.addEventListener('click', closeUserMenuOnClickOutside);
      }, 10);
    }

    function closeUserMenu() {
      const dropdown = document.getElementById('user-menu-dropdown');
      if (dropdown) dropdown.remove();
      userMenuOpen = false;
      document.removeEventListener('click', closeUserMenuOnClickOutside);
    }

    function closeUserMenuOnClickOutside(e) {
      const dropdown = document.getElementById('user-menu-dropdown');
      const userMenu = document.querySelector('.user-menu');
      if (dropdown && !dropdown.contains(e.target) && !userMenu.contains(e.target)) {
        closeUserMenu();
      }
    }

    // Show devices by type (legend click)
    function showDevicesByType(deviceType) {
      const floors = Object.keys(monitorData).length > 0
        ? Object.keys(monitorData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      let devices = [];
      const typeLabels = {
        accessPoints: 'üì° Access Points',
        printers: 'üñ®Ô∏è Printers',
        polyLens: 'üìπ Zoom Rooms'
      };

      if (deviceType === 'polyLens') {
        floors.forEach(floor => {
          const pf = polyLensData[floor] || [];
          pf.forEach(d => {
            devices.push({ ...d, floor, type: 'polyLens', status: d.connected ? 'up' : 'down' });
          });
        });
      } else {
        floors.forEach(floor => {
          const fd = monitorData[floor] || {};
          const cat = fd[deviceType] || [];
          cat.forEach(d => {
            devices.push({ ...d, floor, type: deviceType });
          });
        });
      }

      const content = devices.length > 0 ? devices.map(d => `
        <div class="status-list-item" onclick="closeSidebarList(); highlightDevice('${d.id || d.room}');" style="cursor: pointer; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; transition: background 0.15s;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 10px; height: 10px; border-radius: 50%; background: ${d.status === 'up' || d.connected ? 'var(--status-online)' : 'var(--status-offline)'};"></span>
            <div>
              <div style="font-weight: 600; color: var(--text-primary);">${d.name || d.room}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${d.floor} ${d.ip || d.hostname ? '‚Ä¢ ' + (d.ip || d.hostname) : ''}</div>
            </div>
          </div>
          <span style="color: var(--accent-blue); font-size: 16px;">üìç</span>
        </div>
      `).join('') : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No devices found</p>';

      showSidebarList(`${typeLabels[deviceType] || deviceType} (${devices.length})`, content);
    }

    // Status detail in sidebar
    function showStatusDetail(type) {
      const floors = Object.keys(monitorData).length > 0
        ? Object.keys(monitorData)
        : ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];

      let devices = [];

      if (type === 'online' || type === 'offline') {
        const targetStatus = type === 'online' ? 'up' : 'down';
        floors.forEach(floor => {
          const fd = monitorData[floor] || {};
          Object.entries(fd).forEach(([catType, cat]) => {
            if (Array.isArray(cat)) {
              cat.forEach(d => {
                if (d.status === targetStatus) {
                  devices.push({ ...d, floor, type: catType });
                }
              });
            }
          });
        });
      } else if (type === 'poly') {
        floors.forEach(floor => {
          const pf = polyLensData[floor] || [];
          pf.forEach(d => {
            devices.push({ ...d, floor, type: 'polyLens' });
          });
        });
      }

      const content = devices.length > 0 ? devices.map(d => `
        <div class="status-list-item" onclick="closeSidebarList(); highlightDevice('${d.id}');" style="cursor: pointer; padding: 12px 16px; border-bottom: 1px solid var(--border-subtle); display: flex; justify-content: space-between; align-items: center; transition: background 0.15s;">
          <div style="display: flex; align-items: center; gap: 10px;">
            <span style="width: 10px; height: 10px; border-radius: 50%; background: ${d.status === 'up' || d.connected ? 'var(--status-online)' : 'var(--status-offline)'};"></span>
            <div>
              <div style="font-weight: 600; color: var(--text-primary);">${d.name}</div>
              <div style="font-size: 11px; color: var(--text-muted);">${d.floor} ‚Ä¢ ${d.ip || d.hostname || 'No IP'}</div>
            </div>
          </div>
          <span style="color: var(--accent-blue); font-size: 16px;">üìç</span>
        </div>
      `).join('') : '<p style="color: var(--text-muted); text-align: center; padding: 20px;">No devices found</p>';

      const title = type === 'online' ? '‚úÖ Online Devices' : type === 'offline' ? '‚ùå Offline Devices' : 'üìπ Zoom Devices';
      showSidebarList(`${title} (${devices.length})`, content);
    }

    // Data source info modal
    function showDataSourceInfo(source) {
      const info = source === 'monitors' ? {
        title: 'üìä Monitor Data Source',
        status: apiStatus.monitors.connected ? 'Connected' : 'Disconnected',
        statusColor: apiStatus.monitors.connected ? 'var(--status-online)' : 'var(--status-offline)',
        details: [
          { label: 'Source', value: 'Office Monitor' },
          { label: 'Endpoint', value: '/api/monitors/by-floor' },
          { label: 'Monitor Count', value: apiStatus.monitors.monitorCount },
          { label: 'Refresh Rate', value: '30 seconds' }
        ]
      } : {
        title: 'üìπ Poly Lens Data Source',
        status: apiStatus.polyLens.configured ? 'Connected' : 'Not Configured',
        statusColor: apiStatus.polyLens.configured ? 'var(--status-online)' : 'var(--status-warning)',
        details: [
          { label: 'Source', value: 'Poly Lens API' },
          { label: 'Endpoint', value: '/api/poly-lens/by-floor' },
          { label: 'Device Count', value: apiStatus.polyLens.deviceCount },
          { label: 'Refresh Rate', value: '30 seconds' }
        ]
      };

      const modal = document.createElement('div');
      modal.className = 'modal-overlay open';
      modal.innerHTML = `
        <div class="modal" style="max-width: 400px;">
          <div class="modal-header">
            <h2 class="modal-title">${info.title}</h2>
            <button class="modal-close" onclick="this.closest('.modal-overlay').remove()">√ó</button>
          </div>
          <div class="modal-body">
            <div class="modal-section">
              <div style="display: flex; align-items: center; gap: 8px; margin-bottom: var(--space-md);">
                <span style="width: 10px; height: 10px; border-radius: 50%; background: ${info.statusColor};"></span>
                <span style="font-weight: 600;">${info.status}</span>
              </div>
              <div class="info-grid" style="display: grid; gap: var(--space-sm);">
                ${info.details.map(d => `
                  <div class="info-item" style="display: flex; justify-content: space-between; padding: var(--space-sm); background: var(--bg-elevated); border-radius: var(--radius-sm);">
                    <span style="color: var(--text-muted);">${d.label}</span>
                    <span style="font-weight: 500;">${d.value}</span>
                  </div>
                `).join('')}
              </div>
            </div>
          </div>
        </div>
      `;
      modal.onclick = (e) => { if (e.target === modal) modal.remove(); };
      document.body.appendChild(modal);
    }

    // ==================== END NEW FEATURES ====================

    // Render the main app (after login)
    async function renderApp() {
      if (!authToken || !currentUser) {
        renderLogin();
        return;
      }

      // Show penguin loader while loading
      document.getElementById('app').innerHTML = `
        <div style="min-height: 100vh; display: flex; align-items: center; justify-content: center; background: var(--bg-base);">
          ${renderPenguinLoader('Building your dashboard...')}
        </div>
      `;

      loadDashboardConfig(); // Load user's dashboard customization
      await fetchAllData();
      await fetchAllMonitors(); // Fetch full monitor data including serial numbers
      await fetchFloorPlans();
      await fetchCustomDeviceTypes();
      await initNewFeatures();
      if (isAdmin()) {
        await fetchPendingChangesCount();
      }
      render();
    }

    // Initial check
    async function init() {
      if (authToken && currentUser) {
        // Verify token is still valid
        try {
          const response = await authFetch(`${API_URL}/api/auth/me`);
          if (!response.ok) {
            // Token expired or invalid
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
          }
        } catch (e) {
          // Server unavailable, keep trying with stored credentials
          console.log('Server check failed:', e.message);
        }
      }

      if (authToken && currentUser) {
        await renderApp();
      } else {
        renderLogin();
      }
    }
    init();

    // Scroll shadow functionality
    function setupScrollShadows() {
      const scrollContainers = document.querySelectorAll('.device-list, .analytics-content, .category-devices');
      scrollContainers.forEach(container => {
        if (container.classList.contains('scroll-initialized')) return;
        container.classList.add('scroll-initialized', 'scroll-container');

        // Create shadow elements
        const topShadow = document.createElement('div');
        topShadow.className = 'scroll-shadow-top';
        const bottomShadow = document.createElement('div');
        bottomShadow.className = 'scroll-shadow-bottom';
        container.style.position = 'relative';
        container.appendChild(topShadow);
        container.appendChild(bottomShadow);

        const updateShadows = () => {
          const hasScrollTop = container.scrollTop > 0;
          const hasScrollBottom = container.scrollTop < (container.scrollHeight - container.clientHeight - 1);
          container.classList.toggle('has-scroll-top', hasScrollTop);
          container.classList.toggle('has-scroll-bottom', hasScrollBottom);
        };

        container.addEventListener('scroll', updateShadows);
        updateShadows();
      });
    }

    // Search text highlighting helper
    function highlightSearchText(text, searchTerm) {
      if (!searchTerm || !text) return text;
      const regex = new RegExp(`(${searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      return text.replace(regex, '<span class="search-highlight">$1</span>');
    }

    // Staggered animation for device items
    function animateDeviceItems() {
      const items = document.querySelectorAll('.device-item:not(.animate-initialized)');
      items.forEach((item, index) => {
        item.classList.add('animate-initialized', 'animate-in');
        item.style.animationDelay = `${Math.min(index * 30, 300)}ms`;
      });
    }

    // Run polish setup after each render
    const originalRender = render;
    render = function() {
      // Save scroll positions before render
      const savedScrollPositions = {};
      const leftPanelBefore = document.querySelector('.left-panel');
      const floorPlanBefore = document.querySelector('.floor-plan');
      const rightPanelBefore = document.querySelector('.right-panel');
      if (leftPanelBefore) savedScrollPositions.leftPanel = leftPanelBefore.scrollTop;
      if (floorPlanBefore) savedScrollPositions.floorPlan = { x: floorPlanBefore.scrollLeft, y: floorPlanBefore.scrollTop };
      if (rightPanelBefore) savedScrollPositions.rightPanel = rightPanelBefore.scrollTop;

      // Save collapsed state of sidebar categories before render
      document.querySelectorAll('.category-header').forEach(header => {
        const categoryName = header.querySelector('.category-name')?.textContent;
        if (categoryName && header.classList.contains('collapsed')) {
          collapsedCategories.add(categoryName);
        } else if (categoryName) {
          collapsedCategories.delete(categoryName);
        }
      });

      originalRender.apply(this, arguments);

      requestAnimationFrame(() => {
        setupScrollShadows();
        animateDeviceItems();

        // Restore scroll positions after render
        const leftPanelAfter = document.querySelector('.left-panel');
        const floorPlanAfter = document.querySelector('.floor-plan');
        const rightPanelAfter = document.querySelector('.right-panel');
        if (leftPanelAfter && savedScrollPositions.leftPanel) leftPanelAfter.scrollTop = savedScrollPositions.leftPanel;
        if (floorPlanAfter && savedScrollPositions.floorPlan) {
          floorPlanAfter.scrollLeft = savedScrollPositions.floorPlan.x;
          floorPlanAfter.scrollTop = savedScrollPositions.floorPlan.y;
        }
        if (rightPanelAfter && savedScrollPositions.rightPanel) rightPanelAfter.scrollTop = savedScrollPositions.rightPanel;

        // Restore collapsed state of sidebar categories
        document.querySelectorAll('.category-header').forEach(header => {
          const categoryName = header.querySelector('.category-name')?.textContent;
          const content = header.nextElementSibling;
          if (categoryName && collapsedCategories.has(categoryName)) {
            header.classList.add('collapsed');
            if (content) content.classList.add('collapsed');
          } else if (categoryName) {
            header.classList.remove('collapsed');
            if (content) content.classList.remove('collapsed');
          }
        });
      });
    };

    // Auto-refresh every 30 seconds (only when logged in)
    setInterval(async () => {
      if (authToken && currentUser) {
        await fetchAllData();
        checkForStatusChanges(); // Check for offline alerts
        if (isAdmin()) {
          await fetchPendingChangesCount();
        }
        render();
      }
    }, 30000);

    // Request notification permission for alerts
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission();
    }
  </script>

  <!-- Admin Panel Overlay -->
  <div id="admin-overlay" class="admin-overlay" onclick="toggleAdmin()"></div>

  <!-- Admin Panel -->
  <div id="admin-panel" class="admin-panel">
    <div class="admin-header">
      <h2 class="admin-title">‚öôÔ∏è Settings</h2>
      <button class="admin-close" onclick="toggleAdmin()">&times;</button>
    </div>
    <div id="admin-tabs-container" class="admin-tabs"></div>
    <div id="admin-content" class="admin-content"></div>
  </div>

  <!-- Modal Container -->
  <div id="modal-container"></div>

  <!-- Dashboard Customize Modal -->
  <div id="customize-modal" class="customize-modal" style="display: none;">
    <div class="customize-modal-content">
      <div class="customize-modal-header">
        <h2>Customize Dashboard</h2>
        <button class="customize-close" onclick="closeCustomizeModal()">&times;</button>
      </div>
      <div class="customize-modal-body">
        <div class="customize-section">
          <h3>Visible Panels</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-left-panel" checked onchange="saveDashboardConfig()">
            <span>Left Panel (Quick Stats)</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-right-panel" checked onchange="saveDashboardConfig()">
            <span>Right Panel (Device List)</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-footer" checked onchange="saveDashboardConfig()">
            <span>Footer (Status Bar)</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Device Categories</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-access-points" checked onchange="saveDashboardConfig()">
            <span>Access Points</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-printers" checked onchange="saveDashboardConfig()">
            <span>Printers</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-zoom-rooms" checked onchange="saveDashboardConfig()">
            <span>Zoom Rooms</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Display Options</h3>
          <label class="customize-toggle">
            <input type="checkbox" id="show-offline-only" onchange="saveDashboardConfig()">
            <span>Show Offline Devices Only</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="animate-status" checked onchange="saveDashboardConfig()">
            <span>Animated Status Indicators</span>
          </label>
          <label class="customize-toggle">
            <input type="checkbox" id="show-response-times" checked onchange="saveDashboardConfig()">
            <span>Show Response Times</span>
          </label>
        </div>
        <div class="customize-section">
          <h3>Refresh Rate</h3>
          <select id="refresh-rate" class="customize-select" onchange="saveDashboardConfig()">
            <option value="10000">10 seconds</option>
            <option value="30000" selected>30 seconds</option>
            <option value="60000">1 minute</option>
            <option value="300000">5 minutes</option>
          </select>
        </div>
        <div class="customize-section">
          <h3>Backup & Restore</h3>
          <div class="customize-buttons">
            <button class="btn btn-secondary" onclick="exportDashboardConfig()">üì• Export Config</button>
            <button class="btn btn-secondary" onclick="document.getElementById('import-config-file').click()">üì§ Import Config</button>
            <input type="file" id="import-config-file" accept=".json" style="display:none" onchange="importDashboardConfig(event)">
          </div>
          <button class="btn btn-outline" onclick="resetDashboardConfig()" style="margin-top: 8px; width: 100%;">üîÑ Reset to Defaults</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Customize Modal Styles */
    .customize-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      animation: fadeIn 0.2s ease;
    }
    .customize-modal-content {
      background: var(--bg-surface);
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-default);
      width: 90%;
      max-width: 420px;
      max-height: 85vh;
      overflow: hidden;
      animation: scaleIn 0.2s ease;
    }
    .customize-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: var(--space-md);
      border-bottom: 1px solid var(--border-subtle);
    }
    .customize-modal-header h2 {
      font-size: var(--text-large);
      font-weight: 600;
      margin: 0;
    }
    .customize-close {
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
    }
    .customize-close:hover { color: var(--text-primary); }
    .customize-modal-body {
      padding: var(--space-md);
      overflow-y: auto;
      max-height: calc(85vh - 60px);
    }
    .customize-section {
      margin-bottom: var(--space-lg);
    }
    .customize-section h3 {
      font-size: var(--text-small);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-sm);
    }
    .customize-toggle {
      display: flex;
      align-items: center;
      gap: var(--space-sm);
      padding: var(--space-xs) 0;
      cursor: pointer;
      color: var(--text-secondary);
    }
    .customize-toggle:hover { color: var(--text-primary); }
    .customize-toggle input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--accent-blue);
    }
    .customize-select {
      width: 100%;
      padding: var(--space-sm);
      background: var(--bg-elevated);
      border: 1px solid var(--border-default);
      border-radius: var(--radius-sm);
      color: var(--text-primary);
      font-size: var(--text-body);
    }
    .customize-buttons {
      display: flex;
      gap: var(--space-sm);
    }
    .customize-buttons .btn { flex: 1; }
    .btn-outline {
      background: transparent;
      border: 1px solid var(--border-default);
      color: var(--text-secondary);
      padding: var(--space-sm);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-size: var(--text-small);
    }
    .btn-outline:hover {
      background: var(--bg-elevated);
      color: var(--text-primary);
    }

    /* ==========================================
       POLISH & ACCESSIBILITY IMPROVEMENTS
       ========================================== */

    /* 1. Active/Press States for All Buttons */
    .btn:active,
    .btn-primary:active,
    .btn-secondary:active,
    .btn-danger:active,
    .btn-warning:active,
    .btn-success:active,
    .btn-outline:active {
      transform: scale(0.96);
      opacity: 0.9;
    }
    .header-btn:active,
    .popup-btn:active,
    .filter-btn:active,
    .floor-btn:active {
      transform: scale(0.95);
    }
    .quick-filter-btn:active {
      transform: scale(0.97);
    }

    /* 2. Standardized Input Focus Styles */
    input:focus,
    select:focus,
    textarea:focus,
    .form-input:focus,
    .login-input:focus,
    .device-search input:focus,
    .customize-select:focus,
    .search-input:focus {
      outline: none;
      border-color: var(--accent-primary) !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.25) !important;
    }

    /* 3. Device Selected State in Sidebar */
    .device-item.selected,
    .room-item.selected {
      background: rgba(59, 130, 246, 0.15) !important;
      border-left: 3px solid var(--accent-primary) !important;
      box-shadow: inset 0 0 0 1px var(--accent-primary);
    }

    /* 4. Cursor Consistency */
    .btn:disabled,
    .btn[disabled],
    button:disabled,
    input:disabled,
    select:disabled {
      cursor: not-allowed !important;
      opacity: 0.5;
    }
    .device-item,
    .room-item,
    .floor-btn,
    .category-header,
    .quick-filter-btn,
    .filter-btn,
    .legend-item,
    .stat-card,
    .analytics-close,
    [onclick] {
      cursor: pointer;
    }
    .stat-label,
    .analytics-section-title,
    .category-title {
      cursor: default;
    }

    /* 5. Empty State for No Filter Results */
    .empty-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 20px;
      color: var(--text-muted);
      text-align: center;
      gap: 12px;
    }
    .empty-state-icon {
      font-size: 48px;
      opacity: 0.5;
    }
    .empty-state-title {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
    }
    .empty-state-text {
      font-size: 12px;
      max-width: 200px;
    }

    /* 6. Scroll Indicator Shadows */
    .scroll-container {
      position: relative;
    }
    .scroll-shadow-top,
    .scroll-shadow-bottom {
      position: absolute;
      left: 0;
      right: 0;
      height: 24px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: 5;
    }
    .scroll-shadow-top {
      top: 0;
      background: linear-gradient(to bottom, var(--bg-primary) 0%, transparent 100%);
    }
    .scroll-shadow-bottom {
      bottom: 0;
      background: linear-gradient(to top, var(--bg-primary) 0%, transparent 100%);
    }
    .scroll-container.has-scroll-top .scroll-shadow-top,
    .scroll-container.has-scroll-bottom .scroll-shadow-bottom {
      opacity: 1;
    }

    /* 7. Search Text Highlighting */
    .search-highlight {
      background: rgba(250, 204, 21, 0.3);
      color: var(--text-primary);
      padding: 0 2px;
      border-radius: 2px;
    }

    /* 8. Tooltip Fade-in Animations */
    [title] {
      position: relative;
    }
    .tooltip {
      position: absolute;
      bottom: calc(100% + 8px);
      left: 50%;
      transform: translateX(-50%) translateY(4px);
      background: var(--bg-elevated);
      color: var(--text-primary);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      white-space: nowrap;
      box-shadow: var(--shadow-lg);
      border: 1px solid var(--border-subtle);
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.15s ease, transform 0.15s ease, visibility 0.15s;
      z-index: 1000;
      pointer-events: none;
    }
    .tooltip-trigger:hover .tooltip {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }

    /* 9. Focus-Visible Rings for Keyboard Navigation */
    .btn:focus-visible,
    .header-btn:focus-visible,
    .popup-btn:focus-visible,
    .filter-btn:focus-visible,
    .floor-btn:focus-visible,
    .quick-filter-btn:focus-visible,
    .device-item:focus-visible,
    .room-item:focus-visible,
    .analytics-close:focus-visible,
    button:focus-visible,
    a:focus-visible,
    [tabindex]:focus-visible {
      outline: none;
      box-shadow: 0 0 0 2px var(--bg-primary), 0 0 0 4px var(--accent-primary) !important;
    }

    /* 10. Reduced Motion Support */
    @media (prefers-reduced-motion: reduce) {
      *,
      *::before,
      *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
        scroll-behavior: auto !important;
      }
      .status-dot,
      .device-marker,
      .penguin,
      .hammer {
        animation: none !important;
      }
    }

    /* 11. ARIA - visually hidden but accessible */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    /* 12. Custom Selection Color */
    ::selection {
      background: rgba(59, 130, 246, 0.4);
      color: white;
    }
    ::-moz-selection {
      background: rgba(59, 130, 246, 0.4);
      color: white;
    }

    /* 13. Smooth Scroll Behavior */
    html {
      scroll-behavior: smooth;
    }
    .device-list,
    .analytics-content,
    .category-devices,
    .admin-content {
      scroll-behavior: smooth;
    }

    /* 14. Staggered Device Animations */
    @keyframes deviceFadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    .device-item.animate-in {
      animation: deviceFadeIn 0.25s ease-out forwards;
    }
    .device-item.animate-in:nth-child(1) { animation-delay: 0ms; }
    .device-item.animate-in:nth-child(2) { animation-delay: 30ms; }
    .device-item.animate-in:nth-child(3) { animation-delay: 60ms; }
    .device-item.animate-in:nth-child(4) { animation-delay: 90ms; }
    .device-item.animate-in:nth-child(5) { animation-delay: 120ms; }
    .device-item.animate-in:nth-child(6) { animation-delay: 150ms; }
    .device-item.animate-in:nth-child(7) { animation-delay: 180ms; }
    .device-item.animate-in:nth-child(8) { animation-delay: 210ms; }
    .device-item.animate-in:nth-child(9) { animation-delay: 240ms; }
    .device-item.animate-in:nth-child(10) { animation-delay: 270ms; }

    /* 15. Online Status Pulse Animation */
    @keyframes onlinePulse {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4);
      }
      50% {
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0);
      }
    }
    .status-dot.online {
      animation: onlinePulse 3s ease-in-out infinite;
    }
    .status-dot.offline {
      animation: pulse 1.5s ease-in-out infinite;
    }
    .status-dot.warning {
      animation: pulse 2s ease-in-out infinite;
    }

    /* 16. Form Validation Styles */
    .form-input.invalid,
    input.invalid,
    select.invalid {
      border-color: var(--status-offline) !important;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
    }
    .form-input.valid,
    input.valid {
      border-color: var(--status-online) !important;
    }
    .validation-message {
      font-size: 12px;
      margin-top: 4px;
      padding: 4px 8px;
      border-radius: 4px;
    }
    .validation-message.error {
      color: var(--status-offline);
      background: rgba(239, 68, 68, 0.1);
    }
    .validation-message.success {
      color: var(--status-online);
      background: rgba(34, 197, 94, 0.1);
    }

    /* 17. Button Loading State */
    .btn.loading,
    button.loading {
      position: relative;
      color: transparent !important;
      pointer-events: none;
    }
    .btn.loading::after,
    button.loading::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 16px;
      height: 16px;
      margin: -8px 0 0 -8px;
      border: 2px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: buttonSpin 0.8s linear infinite;
    }
    @keyframes buttonSpin {
      to { transform: rotate(360deg); }
    }

    /* 18. Better Touch Targets for Mobile */
    @media (pointer: coarse) {
      .btn,
      button,
      .floor-btn,
      .quick-filter-btn,
      .device-item,
      .room-item {
        min-height: 44px;
        min-width: 44px;
      }
      .popup-btn {
        min-height: 36px;
        padding: 8px 14px;
      }
    }
  </style>

  <script>
    // Update admin tab styling
    function updateAdminTabs() {
      document.querySelectorAll('.admin-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === adminTab);
      });
    }

    // Override setAdminTab to also update tab styling
    const originalSetAdminTab = setAdminTab;
    setAdminTab = function(tab) {
      adminTab = tab;
      updateAdminTabs();
      renderAdmin();
    };

    // Drag and drop functionality for edit mode
    let isDragging = false;
    let currentDragElement = null;
    let dragStartX = 0;
    let dragStartY = 0;
    let elementStartX = 0;
    let elementStartY = 0;
    let dragHasMovedBeyondThreshold = false;
    const DRAG_THRESHOLD_PX = 5; // Minimum pixels to move before considering it a drag

    function startDrag(e, element) {
      if (!editMode) return;
      e.preventDefault();

      isDragging = true;
      dragHasMovedBeyondThreshold = false;
      currentDragElement = element;
      dragStartX = e.clientX;
      dragStartY = e.clientY;
      elementStartX = parseFloat(element.style.left);
      elementStartY = parseFloat(element.style.top);

      element.style.zIndex = '1000';
      element.style.cursor = 'grabbing';

      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', endDrag);
    }

    function onDrag(e) {
      if (!isDragging || !currentDragElement) return;

      // Check if we've moved beyond the threshold
      const distanceMoved = Math.sqrt(
        Math.pow(e.clientX - dragStartX, 2) + Math.pow(e.clientY - dragStartY, 2)
      );
      if (distanceMoved > DRAG_THRESHOLD_PX) {
        dragHasMovedBeyondThreshold = true;
      }

      const container = document.querySelector('.floor-map');
      const rect = container.getBoundingClientRect();

      const deltaX = ((e.clientX - dragStartX) / rect.width) * 100;
      const deltaY = ((e.clientY - dragStartY) / rect.height) * 100;

      let newX = elementStartX + deltaX;
      let newY = elementStartY + deltaY;

      // Constrain to container bounds
      newX = Math.max(0, Math.min(100, newX));
      newY = Math.max(0, Math.min(100, newY));

      currentDragElement.style.left = `${newX}%`;
      currentDragElement.style.top = `${newY}%`;
    }

    function endDrag(e) {
      if (!isDragging || !currentDragElement) return;

      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', endDrag);

      const deviceId = currentDragElement.dataset.id;
      const newX = parseFloat(currentDragElement.style.left);
      const newY = parseFloat(currentDragElement.style.top);

      currentDragElement.style.zIndex = '';
      currentDragElement.style.cursor = '';

      // Only store position if we actually dragged (moved beyond threshold)
      if (deviceId && dragHasMovedBeyondThreshold) {
        const isRoom = deviceId.startsWith('room-') || deviceId.startsWith('zoom-');
        pendingPositions[deviceId] = { x: newX, y: newY, isRoom, floor: activeFloor };
        console.log(`Position queued for ${isRoom ? 'room' : 'device'} ${deviceId}: ${newX}%, ${newY}%`);
        // Update the save button count
        updateEditModeButtons();
      } else if (!dragHasMovedBeyondThreshold) {
        // Reset position if it was just a click (not a real drag)
        currentDragElement.style.left = `${elementStartX}%`;
        currentDragElement.style.top = `${elementStartY}%`;
      }

      isDragging = false;
      dragHasMovedBeyondThreshold = false;
      currentDragElement = null;
    }

    function updateEditModeButtons() {
      const countEl = document.getElementById('pending-count');
      if (countEl) {
        const count = getPendingCount();
        countEl.textContent = count > 0 ? ` (${count})` : '';
      }
    }

    // Toggle category collapse (Access Points, Printers, Zoom Rooms)
    function toggleCategory(header) {
      header.classList.toggle('collapsed');
      const content = header.nextElementSibling;
      if (content) {
        content.classList.toggle('collapsed');
      }
    }

    // Toggle room collapse and optionally highlight on map
    function toggleRoom(event, header, roomId) {
      event.stopPropagation();

      // If clicking on the room name area, open analytics
      const clickedOnName = event.target.classList.contains('room-name') ||
                           event.target.classList.contains('room-status');

      if (clickedOnName) {
        // Get the room name from the header
        const roomNameEl = header.querySelector('.room-name');
        const roomName = roomNameEl ? roomNameEl.textContent : roomId.replace('room-', '').replace(/-/g, ' ');
        highlightDevice(roomId);
        openAnalytics(roomId, roomName, 'polyLens', true);
      } else {
        // Toggle collapse
        header.classList.toggle('collapsed');
        const devices = header.nextElementSibling;
        if (devices) {
          devices.classList.toggle('collapsed');
        }
      }
    }

    // Highlight device on map when clicked from sidebar
    function highlightDevice(deviceId) {
      // Find the device to get its floor - search through all data sources
      let deviceFloor = null;
      let foundDevice = null;

      // Search in monitorData
      Object.entries(monitorData).forEach(([floor, data]) => {
        if (data.accessPoints) {
          const found = data.accessPoints.find(d => d.id == deviceId);
          if (found) { foundDevice = found; deviceFloor = floor; }
        }
        if (data.printers) {
          const found = data.printers.find(d => d.id == deviceId);
          if (found) { foundDevice = found; deviceFloor = floor; }
        }
      });

      // Search in polyLensData for rooms
      if (!foundDevice) {
        Object.entries(polyLensData).forEach(([floor, devices]) => {
          // Group by room and check if deviceId matches room-RoomName format
          const rooms = {};
          devices.forEach(d => {
            const roomName = d.room || 'Unknown';
            if (!rooms[roomName]) rooms[roomName] = [];
            rooms[roomName].push(d);
          });
          Object.keys(rooms).forEach(roomName => {
            const roomId = `room-${roomName.replace(/\s+/g, '-')}`;
            if (roomId === deviceId || roomName === deviceId) {
              foundDevice = { id: roomId, room: roomName };
              deviceFloor = floor;
            }
          });
        });
      }

      // Also check currentPolyData
      if (!foundDevice && currentPolyData) {
        const polyRoom = currentPolyData.find(p => p.room === deviceId || p.id === deviceId);
        if (polyRoom) {
          foundDevice = polyRoom;
          deviceFloor = polyRoom.floor;
        }
      }

      // Switch floor if needed, then highlight
      if (deviceFloor && deviceFloor !== currentFloor) {
        setFloor(deviceFloor);
        // Wait for floor to render, then highlight
        setTimeout(() => highlightDeviceOnMap(deviceId), 300);
      } else {
        highlightDeviceOnMap(deviceId);
      }
    }

    function highlightDeviceOnMap(deviceId) {
      // Remove previous highlight
      document.querySelectorAll('.device-marker.highlighted').forEach(el => {
        el.classList.remove('highlighted');
        el.querySelector('.device-popup')?.classList.remove('force-show');
      });

      // Find and highlight the marker - try exact match first
      let marker = document.querySelector(`.device-marker[data-id="${deviceId}"]`);

      // If not found, try with CSS escape for special characters
      if (!marker) {
        try {
          marker = document.querySelector(`.device-marker[data-id="${CSS.escape(deviceId)}"]`);
        } catch (e) {
          // CSS.escape not supported, try manual approach
        }
      }

      // If still not found, search all markers for a partial match
      if (!marker) {
        const allMarkers = document.querySelectorAll('.device-marker[data-id]');
        for (const m of allMarkers) {
          const markerId = m.getAttribute('data-id');
          if (markerId && (markerId.includes(deviceId) || deviceId.includes(markerId))) {
            marker = m;
            break;
          }
        }
      }

      if (marker) {
        marker.classList.add('highlighted');

        // Force show the popup
        const popup = marker.querySelector('.device-popup');
        if (popup) {
          popup.classList.add('force-show');
        }

        // Scroll the marker into view
        marker.scrollIntoView({ behavior: 'smooth', block: 'center', inline: 'center' });

        // Remove highlight and popup after 5 seconds
        setTimeout(() => {
          marker.classList.remove('highlighted');
          if (popup) popup.classList.remove('force-show');
        }, 5000);
      } else {
        showAlert('Device not found on current floor map', 'info');
      }
    }

    // ==================== BULK IMPORT ====================
    function openBulkImportModal() {
      bulkImportData = [];
      bulkImportModalOpen = true;
      renderBulkImportModal();
    }

    function closeBulkImportModal() {
      bulkImportModalOpen = false;
      bulkImportData = [];
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderBulkImportModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeBulkImportModal()">
          <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
              <h3 class="modal-title">Bulk Import Devices</h3>
              <button class="admin-close" onclick="closeBulkImportModal()">&times;</button>
            </div>
            ${bulkImportData.length === 0 ? `
              <div class="import-dropzone" id="import-dropzone"
                ondragover="event.preventDefault(); this.classList.add('dragover')"
                ondragleave="this.classList.remove('dragover')"
                ondrop="handleImportDrop(event)"
                onclick="document.getElementById('import-file-input').click()">
                <div class="import-icon">üìÅ</div>
                <div class="import-title">Drop CSV file here or click to browse</div>
                <div class="import-subtitle">CSV format: name, hostname, floor, type</div>
              </div>
              <input type="file" id="import-file-input" accept=".csv" style="display: none" onchange="handleImportFile(this.files[0])">
              <div style="margin-top: 16px;">
                <button class="btn btn-secondary" onclick="downloadImportTemplate()">üì• Download Template</button>
              </div>
            ` : `
              <div class="import-stats">
                <div class="import-stat">
                  <div class="import-stat-value">${bulkImportData.length}</div>
                  <div class="import-stat-label">Devices</div>
                </div>
                <div class="import-stat">
                  <div class="import-stat-value">${new Set(bulkImportData.map(d => d.floor)).size}</div>
                  <div class="import-stat-label">Floors</div>
                </div>
              </div>
              <div class="import-preview">
                <table class="import-preview-table">
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Hostname/URL</th>
                      <th>Floor</th>
                      <th>Type</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${bulkImportData.map(d => `
                      <tr>
                        <td>${sanitizeHTML(d.name)}</td>
                        <td>${sanitizeHTML(d.hostname || d.url || '-')}</td>
                        <td>${sanitizeHTML(d.floor)}</td>
                        <td>${sanitizeHTML(d.device_type || d.type)}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
              <div class="btn-group">
                <button class="btn btn-primary" onclick="submitBulkImport()">üì• Import ${bulkImportData.length} Devices</button>
                <button class="btn btn-secondary" onclick="bulkImportData = []; renderBulkImportModal()">Clear</button>
                <button class="btn btn-secondary" onclick="closeBulkImportModal()">Cancel</button>
              </div>
            `}
          </div>
        </div>
      `;
    }

    function handleImportDrop(event) {
      event.preventDefault();
      event.target.classList.remove('dragover');
      const file = event.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        handleImportFile(file);
      }
    }

    function handleImportFile(file) {
      const reader = new FileReader();
      reader.onload = (e) => {
        const csv = e.target.result;
        const lines = csv.split('\\n').filter(l => l.trim());
        const headers = lines[0].toLowerCase().split(',').map(h => h.trim());

        bulkImportData = lines.slice(1).map(line => {
          const values = line.split(',').map(v => v.trim());
          const device = {};
          headers.forEach((h, i) => {
            device[h] = values[i] || '';
          });
          return {
            name: device.name || '',
            hostname: device.hostname || device.ip || '',
            url: device.url || '',
            floor: device.floor || '1st Floor',
            type: device.type === 'http' ? 'http' : 'ping',
            device_type: device.device_type || device.category || 'accessPoints',
            notes: device.notes || ''
          };
        }).filter(d => d.name);

        renderBulkImportModal();
      };
      reader.readAsText(file);
    }

    function downloadImportTemplate() {
      const template = 'name,hostname,floor,device_type,notes\\nAP-Floor1-001,192.168.1.10,1st Floor,accessPoints,Main lobby AP\\nPrinter-HR,192.168.1.20,2nd Floor,printers,HR department printer';
      const blob = new Blob([template], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'device_import_template.csv';
      a.click();
      URL.revokeObjectURL(url);
    }

    async function submitBulkImport() {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ devices: bulkImportData })
        });
        const data = await response.json();
        if (data.success) {
          showAlert(`Successfully imported ${data.imported} devices`, 'success');
          closeBulkImportModal();
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
        } else {
          showAlert('Import failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Import error: ' + e.message, 'error');
      }
    }

    // ==================== DEVICE TEMPLATES ====================
    async function fetchDeviceTemplates() {
      try {
        const response = await fetch(`${API_URL}/api/device-templates`);
        if (response.ok) {
          const data = await response.json();
          deviceTemplates = data.templates || [];
        }
      } catch (e) {
        console.error('Failed to fetch device templates:', e);
      }
    }

    function applyTemplate(template) {
      if (!editingMonitor) return;
      editingMonitor.type = template.type || 'ping';
      editingMonitor.device_type = template.device_type || 'accessPoints';
      editingMonitor.interval = template.default_interval || 30;
      renderModal();
    }

    // ==================== SAVED FILTERS ====================
    async function fetchSavedFilters() {
      try {
        const response = await authFetch(`${API_URL}/api/saved-filters`);
        if (response.ok) {
          const data = await response.json();
          savedFilters = data.filters || [];
        }
      } catch (e) {
        console.error('Failed to fetch saved filters:', e);
      }
    }

    async function saveCurrentFilter() {
      const name = prompt('Enter filter name:');
      if (!name) return;

      const filterConfig = {
        search: deviceFilter,
        floor: activeFloor
      };

      try {
        const response = await authFetch(`${API_URL}/api/saved-filters`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, filter_config: JSON.stringify(filterConfig) })
        });
        if (response.ok) {
          await fetchSavedFilters();
          showAlert('Filter saved!', 'success');
        }
      } catch (e) {
        showAlert('Failed to save filter', 'error');
      }
    }

    function applySavedFilter(filterId) {
      const filter = savedFilters.find(f => f.id == filterId);
      if (!filter) return;

      const config = JSON.parse(filter.filter_config);
      deviceFilter = config.search || '';
      if (config.floor) activeFloor = config.floor;
      activeFilter = filterId;
      renderAdmin();
      render();
    }

    async function deleteSavedFilter(id) {
      if (!confirm('Delete this filter?')) return;
      try {
        await authFetch(`${API_URL}/api/saved-filters/${id}`, { method: 'DELETE' });
        await fetchSavedFilters();
        renderAdmin();
      } catch (e) {
        showAlert('Failed to delete filter', 'error');
      }
    }

    // ==================== BULK ACTIONS ====================
    function toggleBulkSelectMode() {
      bulkSelectMode = !bulkSelectMode;
      if (!bulkSelectMode) {
        selectedDevices.clear();
      }
      renderAdmin();
    }

    function toggleAdminDeviceSelection(id) {
      if (selectedDevices.has(id)) {
        selectedDevices.delete(id);
      } else {
        selectedDevices.add(id);
      }
      renderAdmin();
    }

    function selectAllAdminDevices() {
      const filteredMonitors = allMonitors.filter(m =>
        !deviceFilter || m.name.toLowerCase().includes(deviceFilter.toLowerCase()) ||
        (m.hostname && m.hostname.includes(deviceFilter))
      );
      filteredMonitors.forEach(m => selectedDevices.add(m.id));
      renderAdmin();
    }

    function deselectAllAdminDevices() {
      selectedDevices.clear();
      renderAdmin();
    }

    async function bulkAction(action) {
      if (selectedDevices.size === 0) {
        showAlert('No devices selected', 'error');
        return;
      }

      const ids = Array.from(selectedDevices);
      let data = {};

      if (action === 'move_floor') {
        const floor = prompt('Enter target floor (e.g., "2nd Floor"):');
        if (!floor) return;
        data.floor = floor;
      } else if (action === 'set_interval') {
        const interval = prompt('Enter check interval in seconds:');
        if (!interval || isNaN(interval)) return;
        data.interval = parseInt(interval);
      } else if (action === 'delete') {
        if (!confirm(`Delete ${ids.length} devices? This cannot be undone.`)) return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-action`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action, ids, data })
        });
        const result = await response.json();
        if (result.success) {
          showAlert(`Action completed: ${result.affected} devices affected`, 'success');
          selectedDevices.clear();
          bulkSelectMode = false;
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
          render();
        } else {
          showAlert('Action failed: ' + (result.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Action error: ' + e.message, 'error');
      }
    }

    // ==================== FLOOR ZONES ====================
    async function fetchFloorZones() {
      try {
        const response = await fetch(`${API_URL}/api/floor-zones`);
        if (response.ok) {
          const data = await response.json();
          floorZones = {};
          (data.zones || []).forEach(zone => {
            if (!floorZones[zone.floor]) floorZones[zone.floor] = [];
            floorZones[zone.floor].push(zone);
          });
        }
      } catch (e) {
        console.error('Failed to fetch floor zones:', e);
      }
    }

    // Room label customizations stored in localStorage
    let roomLabelSettings = JSON.parse(localStorage.getItem('roomLabelSettings') || '{}');

    function saveRoomLabelSettings() {
      localStorage.setItem('roomLabelSettings', JSON.stringify(roomLabelSettings));
    }

    function renderZones(floor) {
      // Filter out walls and doors - only show room names
      const zones = (floorZones[floor] || []).filter(z => z.type !== 'wall' && z.type !== 'door');
      if (zones.length === 0) return '';

      // Find zones to gray out (not part of office)
      const excludedZones = zones.filter(z =>
        z.name.toLowerCase().includes('not ours') ||
        z.name.toLowerCase().includes('not our') ||
        z.name.toLowerCase().includes('excluded')
      );

      // Regular room zones (not excluded)
      const roomZones = zones.filter(z =>
        !z.name.toLowerCase().includes('not ours') &&
        !z.name.toLowerCase().includes('not our') &&
        !z.name.toLowerCase().includes('excluded')
      );

      // Render room borders with subtle blue
      let roomBordersOverlay = '';
      if (roomZones.length > 0) {
        roomBordersOverlay = `
          <svg class="room-borders-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
            ${roomZones.map(zone => {
              let points = zone.points || '[]';
              if (typeof points === 'string') {
                try {
                  points = JSON.parse(points);
                  if (typeof points === 'string') points = JSON.parse(points);
                } catch (e) { points = []; }
              }
              if (!Array.isArray(points) || points.length < 3) return '';
              const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
              // Calculate center for label (same as wall editor)
              const centerX = points.reduce((s, p) => s + p.x, 0) / points.length;
              const centerY = points.reduce((s, p) => s + p.y, 0) / points.length;
              const displayName = zone.name.length > 15 ? zone.name.substring(0, 15) + '...' : zone.name;

              // Get saved settings or use defaults
              const settings = roomLabelSettings[zone.id] || {};
              const labelX = settings.x ?? centerX;
              const labelY = settings.y ?? centerY;
              const fontSize = settings.fontSize ?? 10;
              const svgFontSize = fontSize / 10; // Convert px to SVG units

              const textWidth = displayName.length * svgFontSize * 0.6;
              const textHeight = svgFontSize * 1.6;

              return `
                <polygon points="${pointsStr}" fill="rgba(59, 130, 246, 0.08)" stroke="rgba(59, 130, 246, 0.4)" stroke-width="0.2" />
                <g class="room-label-group" data-zone-id="${zone.id}" data-default-x="${centerX}" data-default-y="${centerY}"
                   style="cursor: pointer;" onclick="openRoomLabelEditor(${zone.id}, '${zone.name.replace(/'/g, "\\'")}', ${labelX}, ${labelY}, ${fontSize})">
                  <rect x="${labelX - textWidth/2 - 0.4}" y="${labelY - textHeight/2}"
                        width="${textWidth + 0.8}" height="${textHeight}" rx="0.3" ry="0.3"
                        fill="rgba(0, 0, 0, 0.7)" class="room-label-bg" />
                  <text x="${labelX}" y="${labelY}" text-anchor="middle" dominant-baseline="central"
                        fill="white" font-size="${svgFontSize}" font-weight="bold" class="room-label-text">
                    ${displayName}
                  </text>
                </g>
              `;
            }).join('')}
          </svg>
        `;
      }

      // Render grayed-out overlay for excluded zones
      let excludedOverlay = '';
      if (excludedZones.length > 0) {
        excludedOverlay = `
          <svg class="excluded-zones-overlay" viewBox="0 0 100 100" preserveAspectRatio="none">
            ${excludedZones.map(zone => {
              let points = zone.points || '[]';
              if (typeof points === 'string') {
                try {
                  points = JSON.parse(points);
                  if (typeof points === 'string') points = JSON.parse(points);
                } catch (e) { points = []; }
              }
              if (!Array.isArray(points) || points.length < 3) return '';
              const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
              return `<polygon points="${pointsStr}" fill="rgba(0,0,0,0.5)" />`;
            }).join('')}
            <defs>
              <pattern id="diagonal-stripes" patternUnits="userSpaceOnUse" width="4" height="4" patternTransform="rotate(45)">
                <line x1="0" y1="0" x2="0" y2="4" stroke="rgba(255,255,255,0.1)" stroke-width="2"/>
              </pattern>
            </defs>
            ${excludedZones.map(zone => {
              let points = zone.points || '[]';
              if (typeof points === 'string') {
                try {
                  points = JSON.parse(points);
                  if (typeof points === 'string') points = JSON.parse(points);
                } catch (e) { points = []; }
              }
              if (!Array.isArray(points) || points.length < 3) return '';
              const pointsStr = points.map(p => `${p.x},${p.y}`).join(' ');
              return `<polygon points="${pointsStr}" fill="url(#diagonal-stripes)" />`;
            }).join('')}
          </svg>
        `;
      }

      return `
        ${roomBordersOverlay}
        ${excludedOverlay}
      `;
    }

    function openRoomLabelEditor(zoneId, zoneName, currentX, currentY, currentSize) {
      const modal = document.createElement('div');
      modal.className = 'room-label-modal';
      modal.innerHTML = `
        <div class="room-label-modal-content">
          <h3>Edit Label: ${zoneName}</h3>
          <div class="label-editor-row">
            <label>Font Size:</label>
            <input type="range" id="label-size-slider" min="6" max="20" value="${currentSize}" oninput="previewLabelSize(${zoneId}, this.value)">
            <span id="label-size-value">${currentSize}px</span>
          </div>
          <div class="label-editor-row">
            <label>Position X:</label>
            <input type="range" id="label-x-slider" min="0" max="100" value="${currentX}" step="0.5" oninput="previewLabelPosition(${zoneId})">
            <span id="label-x-value">${currentX.toFixed(1)}%</span>
          </div>
          <div class="label-editor-row">
            <label>Position Y:</label>
            <input type="range" id="label-y-slider" min="0" max="100" value="${currentY}" step="0.5" oninput="previewLabelPosition(${zoneId})">
            <span id="label-y-value">${currentY.toFixed(1)}%</span>
          </div>
          <div class="label-editor-buttons">
            <button class="label-btn reset" onclick="resetRoomLabel(${zoneId})">Reset</button>
            <button class="label-btn cancel" onclick="closeRoomLabelEditor()">Cancel</button>
            <button class="label-btn save" onclick="saveRoomLabel(${zoneId})">Save</button>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }

    function previewLabelSize(zoneId, size) {
      const group = document.querySelector(`.room-label-group[data-zone-id="${zoneId}"]`);
      if (group) {
        const text = group.querySelector('.room-label-text');
        const bg = group.querySelector('.room-label-bg');
        if (text) {
          // Convert px to SVG units (roughly 1px = 0.1 SVG units)
          const svgSize = size / 10;
          text.setAttribute('font-size', svgSize);
          // Adjust background size
          if (bg) {
            const textContent = text.textContent.trim();
            const textWidth = textContent.length * svgSize * 0.6;
            const textHeight = svgSize * 1.6;
            const x = parseFloat(text.getAttribute('x'));
            const y = parseFloat(text.getAttribute('y'));
            bg.setAttribute('width', textWidth + 0.8);
            bg.setAttribute('height', textHeight);
            bg.setAttribute('x', x - textWidth/2 - 0.4);
            bg.setAttribute('y', y - textHeight/2);
          }
        }
      }
      document.getElementById('label-size-value').textContent = size + 'px';
    }

    function previewLabelPosition(zoneId) {
      const x = parseFloat(document.getElementById('label-x-slider').value);
      const y = parseFloat(document.getElementById('label-y-slider').value);
      const group = document.querySelector(`.room-label-group[data-zone-id="${zoneId}"]`);
      if (group) {
        const text = group.querySelector('.room-label-text');
        const bg = group.querySelector('.room-label-bg');
        if (text) {
          text.setAttribute('x', x);
          text.setAttribute('y', y);
        }
        if (bg) {
          const width = parseFloat(bg.getAttribute('width'));
          const height = parseFloat(bg.getAttribute('height'));
          bg.setAttribute('x', x - width/2);
          bg.setAttribute('y', y - height/2);
        }
      }
      document.getElementById('label-x-value').textContent = x.toFixed(1) + '%';
      document.getElementById('label-y-value').textContent = y.toFixed(1) + '%';
    }

    function saveRoomLabel(zoneId) {
      const size = document.getElementById('label-size-slider').value;
      const x = document.getElementById('label-x-slider').value;
      const y = document.getElementById('label-y-slider').value;
      roomLabelSettings[zoneId] = {
        fontSize: parseInt(size),
        x: parseFloat(x),
        y: parseFloat(y)
      };
      saveRoomLabelSettings();
      closeRoomLabelEditor();
      render(); // Re-render to apply saved position
    }

    function resetRoomLabel(zoneId) {
      const group = document.querySelector(`.room-label-group[data-zone-id="${zoneId}"]`);
      if (group) {
        const defaultX = group.dataset.defaultX;
        const defaultY = group.dataset.defaultY;
        document.getElementById('label-x-slider').value = defaultX;
        document.getElementById('label-y-slider').value = defaultY;
        document.getElementById('label-size-slider').value = 10;
        previewLabelSize(zoneId, 10);
        previewLabelPosition(zoneId);
      }
      delete roomLabelSettings[zoneId];
      saveRoomLabelSettings();
    }

    function closeRoomLabelEditor() {
      const modal = document.querySelector('.room-label-modal');
      if (modal) modal.remove();
    }

    // ==================== HEALTH SCORES ====================
    function getHealthColor(score) {
      if (score >= 90) return '#22C55E';
      if (score >= 70) return '#60A5FA';
      if (score >= 50) return '#F59E0B';
      return '#EF4444';
    }

    function getHealthLabel(score) {
      if (score >= 90) return 'Excellent';
      if (score >= 70) return 'Good';
      if (score >= 50) return 'Fair';
      return 'Poor';
    }

    function getHealthClass(score) {
      if (score >= 90) return 'excellent';
      if (score >= 70) return 'good';
      if (score >= 50) return 'fair';
      return 'poor';
    }

    function renderHealthBadge(score) {
      if (score === null || score === undefined) return '';
      return `
        <span class="health-badge ${getHealthClass(score)}">
          ‚ù§Ô∏è ${score}%
        </span>
      `;
    }

    // Render printer consumables for analytics panel
    function renderPrinterConsumables(deviceId) {
      const ps = printerStatusData[deviceId];
      if (!ps) return '';

      const toner = ps.toner || {};
      const paper = ps.paper || {};
      const info = ps.info || {};
      const error = ps.error || {};

      const colors = ['black', 'cyan', 'magenta', 'yellow'];
      const colorLabels = {black: 'K', cyan: 'C', magenta: 'M', yellow: 'Y'};
      const colorGradients = {
        black: 'linear-gradient(to top, #1a1a1a, #404040)',
        cyan: 'linear-gradient(to top, #0891B2, #22D3EE)',
        magenta: 'linear-gradient(to top, #BE185D, #F472B6)',
        yellow: 'linear-gradient(to top, #CA8A04, #FDE047)'
      };
      const glowColors = {
        black: 'rgba(100, 100, 100, 0.3)',
        cyan: 'rgba(6, 182, 212, 0.5)',
        magenta: 'rgba(236, 72, 153, 0.5)',
        yellow: 'rgba(234, 179, 8, 0.5)'
      };

      // Error section (show first if there are errors)
      let errorHTML = '';
      if (error.state && error.state !== 'idle' && error.state !== 'printing') {
        errorHTML = '<div style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(185, 28, 28, 0.1) 100%); border: 1px solid var(--status-offline); border-radius: 10px; padding: 14px; margin-bottom: 16px;">' +
          '<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">' +
            '<span style="font-size: 20px;">‚ö†Ô∏è</span>' +
            '<span style="font-size: 14px; font-weight: 700; color: var(--status-offline); text-transform: uppercase;">' + (error.state || 'Error') + '</span>' +
          '</div>' +
          (error.description ? '<div style="font-size: 13px; color: var(--text-secondary); padding-left: 30px;">' + error.description + '</div>' : '') +
        '</div>';
      }

      // Toner cartridges
      let tonerHTML = colors.map(color => {
        const level = toner[color];
        if (level === null || level === undefined) return '';
        const isLow = level < 20;
        return '<div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px; background: var(--bg-base); border-radius: 8px;' + (isLow ? ' border: 2px solid var(--status-offline);' : '') + '">' +
          '<div style="font-size: 18px; font-weight: 700; color: ' + (isLow ? 'var(--status-offline)' : 'var(--text-primary)') + ';">' + level + '%</div>' +
          '<div style="width: 32px; height: 50px; background: var(--bg-overlay); border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--border-subtle);">' +
            '<div style="position: absolute; bottom: 0; left: 0; right: 0; height: ' + level + '%; background: ' + colorGradients[color] + '; border-radius: 4px; box-shadow: 0 0 8px ' + glowColors[color] + ';"></div>' +
          '</div>' +
          '<div style="font-size: 10px; font-weight: 600; color: var(--text-muted);">' + colorLabels[color] + '</div>' +
        '</div>';
      }).join('');

      // Waste toner
      let wasteHTML = '';
      if (toner.waste !== null && toner.waste !== undefined) {
        const wasteHigh = toner.waste > 80;
        wasteHTML = '<div style="display: flex; flex-direction: column; align-items: center; gap: 6px; padding: 10px; background: var(--bg-base); border-radius: 8px;' + (wasteHigh ? ' border: 2px solid var(--status-warning);' : '') + '">' +
          '<div style="font-size: 18px; font-weight: 700; color: ' + (wasteHigh ? 'var(--status-warning)' : 'var(--text-primary)') + ';">' + toner.waste + '%</div>' +
          '<div style="width: 32px; height: 50px; background: var(--bg-overlay); border-radius: 6px; overflow: hidden; position: relative; border: 1px solid var(--border-subtle);">' +
            '<div style="position: absolute; bottom: 0; left: 0; right: 0; height: ' + toner.waste + '%; background: linear-gradient(to top, #6B7280, #9CA3AF); border-radius: 4px;"></div>' +
          '</div>' +
          '<div style="font-size: 10px; font-weight: 600; color: var(--text-muted);">WASTE</div>' +
        '</div>';
      }

      // Paper level
      let paperHTML = '';
      if (paper.level !== null && paper.level !== undefined) {
        const paperColor = paper.level < 10 ? '#EF4444' : paper.level < 20 ? '#F59E0B' : '#10B981';
        paperHTML = '<div style="display: flex; align-items: center; gap: 12px; padding: 10px 14px; background: var(--bg-base); border-radius: 8px;">' +
          '<span style="font-size: 20px;">üìÑ</span>' +
          '<div style="flex: 1;">' +
            '<div style="height: 8px; background: var(--bg-overlay); border-radius: 4px; overflow: hidden;">' +
              '<div style="height: 100%; width: ' + (paper.level || 0) + '%; background: ' + paperColor + '; border-radius: 4px;"></div>' +
            '</div>' +
          '</div>' +
          '<span style="font-size: 14px; font-weight: 700; color: var(--text-primary);">' + (paper.level || 0) + '%</span>' +
        '</div>';
      }

      // Page count
      let pageCountHTML = '';
      if (info.pageCount) {
        pageCountHTML = '<div style="display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; background: var(--bg-base); border-radius: 8px;">' +
          '<span style="font-size: 12px; color: var(--text-muted);">üìä Pages Printed</span>' +
          '<span style="font-size: 16px; font-weight: 700; color: var(--accent-blue);">' + info.pageCount.toLocaleString() + '</span>' +
        '</div>';
      }

      return '<div class="analytics-section">' +
        '<div class="analytics-section-title" style="display: flex; justify-content: space-between; align-items: center;">' +
          '<span>üñ®Ô∏è Printer Status</span>' +
          '<button onclick="refreshPrinterStatus(' + deviceId + ')" style="padding: 4px 10px; background: var(--bg-overlay); border: none; border-radius: 4px; color: var(--text-secondary); font-size: 10px; cursor: pointer;">‚Üª Refresh</button>' +
        '</div>' +
        '<div style="background: var(--bg-elevated); border-radius: 10px; padding: 14px; border: 1px solid var(--border-subtle);">' +
          errorHTML +
          '<div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">' +
            tonerHTML +
            wasteHTML +
          '</div>' +
          '<div style="display: flex; flex-direction: column; gap: 8px;">' +
            paperHTML +
            pageCountHTML +
          '</div>' +
        '</div>' +
      '</div>';
    }

    // Device status history storage (populated from heartbeats)
    let deviceHistoryCache = {};

    function renderSparkline(deviceId) {
      // Generate a simple sparkline based on recent heartbeat data
      // For now, we'll show a placeholder that will be populated when analytics are opened
      const history = deviceHistoryCache[deviceId] || [];

      if (history.length === 0) {
        // Generate placeholder sparkline (last 24 data points)
        return `
          <div class="sparkline-container">
            <div class="sparkline-label">24h Status</div>
            <div class="sparkline" style="opacity: 0.3;">
              ${Array(24).fill(0).map(() => '<div class="sparkline-bar unknown" style="height: 100%;"></div>').join('')}
            </div>
            <div class="sparkline-legend">
              <span>24h ago</span>
              <span>Now</span>
            </div>
          </div>
        `;
      }

      // Render actual sparkline from history
      const bars = history.slice(-24).map(h => {
        const status = h.status === 1 ? 'up' : 'down';
        return `<div class="sparkline-bar ${status}" style="height: 100%;"></div>`;
      }).join('');

      return `
        <div class="sparkline-container">
          <div class="sparkline-label">24h Status</div>
          <div class="sparkline">${bars}</div>
          <div class="sparkline-legend">
            <span>24h ago</span>
            <span>Now</span>
          </div>
        </div>
      `;
    }

    // ==================== AUTO-DISCOVERY ====================
    function openDiscoveryModal() {
      discoveryModalOpen = true;
      discoveryResults = [];
      discoveryScanning = false;
      discoveryProgress = 0;
      renderDiscoveryModal();
    }

    function closeDiscoveryModal() {
      discoveryModalOpen = false;
      discoveryResults = [];
      document.getElementById('modal-container').innerHTML = '';
    }

    function renderDiscoveryModal() {
      document.getElementById('modal-container').innerHTML = `
        <div class="modal open" onclick="if(event.target === this) closeDiscoveryModal()">
          <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
              <h3 class="modal-title">Auto-Discover Devices</h3>
              <button class="admin-close" onclick="closeDiscoveryModal()">&times;</button>
            </div>
            <div class="discovery-form">
              <div class="form-group">
                <label class="form-label">Subnet</label>
                <input type="text" class="form-input" id="discovery-subnet" value="192.168.1" placeholder="192.168.1">
              </div>
              <div class="form-group">
                <label class="form-label">IP Range</label>
                <div class="discovery-range">
                  <input type="number" class="form-input" id="discovery-start" value="1" min="1" max="254">
                  <span style="color: #64748B;">to</span>
                  <input type="number" class="form-input" id="discovery-end" value="254" min="1" max="254">
                </div>
              </div>
              <button class="btn btn-primary" onclick="startDiscovery()" ${discoveryScanning ? 'disabled' : ''}>
                ${discoveryScanning ? 'üîÑ Scanning...' : 'üîç Start Scan'}
              </button>
            </div>
            ${discoveryScanning ? `
              <div class="discovery-progress">
                <div class="discovery-progress-bar">
                  <div class="discovery-progress-fill" style="width: ${discoveryProgress}%"></div>
                </div>
                <div class="discovery-status">Scanning... ${discoveryProgress}%</div>
              </div>
            ` : ''}
            ${discoveryResults.length > 0 ? `
              <div class="admin-section">
                <h4 class="admin-section-title">Discovered Devices (${discoveryResults.filter(d => !d.existing).length} new)</h4>
                <div class="discovery-results">
                  ${discoveryResults.map((d, i) => `
                    <div class="discovery-device ${d.existing ? 'existing' : ''}">
                      <input type="checkbox" class="discovery-checkbox" id="disc-${i}"
                        ${d.selected ? 'checked' : ''} ${d.existing ? 'disabled' : ''}
                        onchange="toggleDiscoveryDevice(${i})">
                      <div class="discovery-info">
                        <div class="discovery-ip">${sanitizeHTML(d.ip)}</div>
                        <div class="discovery-hostname">${sanitizeHTML(d.hostname || 'Unknown hostname')} ${d.existing ? '(Already monitored)' : ''}</div>
                      </div>
                      <div class="discovery-ping">${d.ping}ms</div>
                    </div>
                  `).join('')}
                </div>
                <div class="btn-group" style="margin-top: 16px;">
                  <button class="btn btn-primary" onclick="addDiscoveredDevices()">
                    ‚ûï Add ${discoveryResults.filter(d => d.selected && !d.existing).length} Devices
                  </button>
                  <button class="btn btn-secondary" onclick="selectAllDiscovered()">Select All New</button>
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    async function startDiscovery() {
      const subnet = document.getElementById('discovery-subnet').value || '192.168.1';
      const startIp = parseInt(document.getElementById('discovery-start').value) || 1;
      const endIp = parseInt(document.getElementById('discovery-end').value) || 254;

      discoveryScanning = true;
      discoveryProgress = 0;
      discoveryResults = [];
      renderDiscoveryModal();

      // Simulate progress while waiting
      const progressInterval = setInterval(() => {
        if (discoveryProgress < 90) {
          discoveryProgress += 5;
          renderDiscoveryModal();
        }
      }, 500);

      try {
        const response = await authFetch(`${API_URL}/api/auto-discover`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ subnet, startIp, endIp })
        });
        const data = await response.json();

        clearInterval(progressInterval);
        discoveryScanning = false;
        discoveryProgress = 100;

        if (data.success) {
          discoveryResults = (data.discovered || []).map(d => ({
            ...d,
            selected: !d.existing
          }));
          showAlert(`Found ${data.discovered.length} devices (${data.existing} already monitored)`, 'success');
        } else {
          showAlert('Discovery failed: ' + (data.error || 'Unknown error'), 'error');
        }
        renderDiscoveryModal();
      } catch (e) {
        clearInterval(progressInterval);
        discoveryScanning = false;
        showAlert('Discovery error: ' + e.message, 'error');
        renderDiscoveryModal();
      }
    }

    function toggleDiscoveryDevice(index) {
      discoveryResults[index].selected = !discoveryResults[index].selected;
      renderDiscoveryModal();
    }

    function selectAllDiscovered() {
      discoveryResults.forEach(d => {
        if (!d.existing) d.selected = true;
      });
      renderDiscoveryModal();
    }

    async function addDiscoveredDevices() {
      const devicesToAdd = discoveryResults
        .filter(d => d.selected && !d.existing)
        .map(d => ({
          name: d.hostname || `Device-${d.ip.split('.').pop()}`,
          hostname: d.ip,
          type: 'ping',
          floor: '1st Floor',
          device_type: 'accessPoints'
        }));

      if (devicesToAdd.length === 0) {
        showAlert('No devices selected', 'error');
        return;
      }

      try {
        const response = await authFetch(`${API_URL}/api/monitors/bulk-import`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ devices: devicesToAdd })
        });
        const data = await response.json();
        if (data.success) {
          showAlert(`Added ${data.imported} devices`, 'success');
          closeDiscoveryModal();
          await fetchAllMonitors();
          await fetchAllData();
          renderAdmin();
        }
      } catch (e) {
        showAlert('Failed to add devices: ' + e.message, 'error');
      }
    }

    // ==================== CONTEXT MENU ====================
    function showContextMenu(event, device, source = 'monitor') {
      event.preventDefault();
      event.stopPropagation();
      contextMenu = { open: true, x: event.clientX, y: event.clientY, device, source };
      renderContextMenu();
    }

    function hideContextMenu() {
      contextMenu.open = false;
      const menu = document.getElementById('context-menu');
      if (menu) menu.remove();
    }

    function renderContextMenu() {
      hideContextMenu();
      if (!contextMenu.open) return;

      const menu = document.createElement('div');
      menu.id = 'context-menu';
      menu.className = 'context-menu';
      menu.style.left = `${contextMenu.x}px`;
      menu.style.top = `${contextMenu.y}px`;

      const device = contextMenu.device;
      const isPrinter = device.device_type === 'printers';
      menu.innerHTML = `
        <div class="context-menu-item" onclick="pingDevice('${device.hostname || device.ip}'); hideContextMenu();">
          üì° Ping Device
        </div>
        <div class="context-menu-item" onclick="refreshDeviceStatus(${device.id}); hideContextMenu();">
          üîÑ Refresh Status
        </div>
        <div class="context-menu-item" onclick="copyToClipboard('${device.hostname || device.ip}'); hideContextMenu();">
          üìã Copy IP/Hostname
        </div>
        ${device.url ? `
          <div class="context-menu-item" onclick="window.open('${device.url}', '_blank'); hideContextMenu();">
            üåê Open Web Interface
          </div>
        ` : ''}
        ${isPrinter ? `
          <div class="context-menu-item" onclick="refreshPrinterStatus(${device.id}); hideContextMenu();">
            üñ®Ô∏è Refresh Toner
          </div>
        ` : ''}
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="openAnalytics(${device.id}, '${device.name}', '${device.device_type}'); hideContextMenu();">
          üìä View Analytics
        </div>
        <div class="context-menu-item" onclick="highlightDevice('${device.id}'); hideContextMenu();">
          üìç Locate on Map
        </div>
        <div class="context-menu-item" onclick="quickAddNote(${device.id}, '${device.name.replace(/'/g, "\\'")}'); hideContextMenu();">
          üìù Add Note
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="toggleMaintenance(${device.id}); hideContextMenu();">
          üîß ${device.maintenance ? 'End Maintenance' : 'Set Maintenance'}
        </div>
        <div class="context-menu-item" onclick="quickMoveFloor(${device.id}, '${device.name.replace(/'/g, "\\'")}'); hideContextMenu();">
          üè¢ Move to Floor
        </div>
        <div class="context-menu-item" onclick="openEditModal(${JSON.stringify(device).replace(/"/g, '&quot;')}); hideContextMenu();">
          ‚úèÔ∏è Edit Device
        </div>
        <div class="context-menu-item" onclick="toggleDisabled(${device.id}, ${device.disabled ? 'false' : 'true'}); hideContextMenu();">
          ${device.disabled ? '‚úÖ Enable Device' : 'üö´ Disable (Non-serviceable)'}
        </div>
        <div class="context-menu-item danger" onclick="deleteMonitor(${device.id}); hideContextMenu();">
          üóëÔ∏è Delete Device
        </div>
      `;

      document.body.appendChild(menu);

      // Adjust position if menu goes off screen
      const rect = menu.getBoundingClientRect();
      if (rect.right > window.innerWidth) {
        menu.style.left = `${window.innerWidth - rect.width - 10}px`;
      }
      if (rect.bottom > window.innerHeight) {
        menu.style.top = `${window.innerHeight - rect.height - 10}px`;
      }
    }

    async function pingDevice(host) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/ping/${encodeURIComponent(host)}`);
        const data = await response.json();
        if (data.success && data.alive) {
          showAlert(`${host} is reachable (${data.time}ms)`, 'success');
        } else {
          showAlert(`${host} is not reachable`, 'error');
        }
      } catch (e) {
        showAlert('Ping failed: ' + e.message, 'error');
      }
    }

    async function refreshDeviceStatus(id) {
      showAlert('Refreshing device status...', 'success');
      try {
        await fetchAllData();
        render();
        showAlert('Status refreshed', 'success');
      } catch (e) {
        showAlert('Refresh failed: ' + e.message, 'error');
      }
    }

    async function refreshPrinterStatus(id) {
      showAlert('Refreshing printer status...', 'success');
      try {
        const response = await authFetch(`${API_URL}/api/printers/${id}/refresh`, { method: 'POST' });
        const data = await response.json();
        if (data.success) {
          // Refresh printer data
          const statusResponse = await fetch(`${API_URL}/api/printers/${id}/status`);
          const statusData = await statusResponse.json();
          if (statusData.success && statusData.status) {
            printerStatusData[id] = statusData.status;
          }
          render();
          showAlert('Printer status refreshed', 'success');
        } else {
          showAlert('Refresh failed: ' + (data.error || 'Unknown error'), 'error');
        }
      } catch (e) {
        showAlert('Refresh failed: ' + e.message, 'error');
      }
    }

    function quickAddNote(id, name) {
      const note = prompt(`Add note for ${name}:`);
      if (note === null) return;

      authFetch(`${API_URL}/api/monitors/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes: note })
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert('Note added', 'success');
            fetchAllData().then(() => render());
          } else {
            showAlert('Failed to add note', 'error');
          }
        });
    }

    function quickMoveFloor(id, name) {
      const floors = ['1st Floor', '2nd Floor', '3rd Floor', '5th Floor'];
      const floor = prompt(`Move ${name} to floor:\n${floors.map((f, i) => `${i+1}. ${f}`).join('\n')}\n\nEnter floor name or number:`);
      if (!floor) return;

      let targetFloor = floor;
      const num = parseInt(floor);
      if (!isNaN(num) && num >= 1 && num <= floors.length) {
        targetFloor = floors[num - 1];
      }

      authFetch(`${API_URL}/api/monitors/${id}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ floor: targetFloor })
      }).then(response => response.json())
        .then(data => {
          if (data.success) {
            showAlert(`Moved to ${targetFloor}`, 'success');
            fetchAllData().then(() => render());
          } else {
            showAlert('Failed to move device', 'error');
          }
        });
    }

    function copyToClipboard(text) {
      navigator.clipboard.writeText(text);
      showAlert('Copied to clipboard!', 'success');
    }

    async function toggleMaintenance(id) {
      try {
        const monitor = allMonitors.find(m => m.id === id);
        const newState = monitor ? !monitor.maintenance : false;

        const response = await authFetch(`${API_URL}/api/monitors/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ ...monitor, maintenance: newState ? 1 : 0 })
        });

        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          render();
          showAlert(newState ? 'Maintenance mode enabled' : 'Maintenance mode disabled', 'success');
        }
      } catch (e) {
        showAlert('Failed to toggle maintenance', 'error');
      }
    }

    async function toggleDisabled(id, disabled) {
      try {
        const response = await authFetch(`${API_URL}/api/monitors/${id}/disable`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ disabled })
        });

        if (response.ok) {
          await fetchAllMonitors();
          await fetchAllData();
          render();
          showAlert(disabled ? 'Device disabled (non-serviceable)' : 'Device enabled', 'success');
        }
      } catch (e) {
        showAlert('Failed to toggle device status', 'error');
      }
    }

    // Wrapper functions for analytics panel buttons
    async function toggleMaintenanceFromAnalytics(id) {
      await toggleMaintenance(id);
      // Refresh analytics panel
      if (analyticsDevice && analyticsDevice.id === id) {
        analyticsData = await fetchAnalyticsData(id, analyticsDevice.isRoom, analyticsDevice.name, analyticsDevice.isPolyDevice, analyticsDevice.polyDeviceData);
        renderAnalyticsSidebar(false);
      }
    }

    async function toggleDisabledFromAnalytics(id, disabled) {
      await toggleDisabled(id, disabled);
      // Refresh analytics panel
      if (analyticsDevice && analyticsDevice.id === id) {
        analyticsData = await fetchAnalyticsData(id, analyticsDevice.isRoom, analyticsDevice.name, analyticsDevice.isPolyDevice, analyticsDevice.polyDeviceData);
        renderAnalyticsSidebar(false);
      }
    }

    // Toggle disabled state for a Poly device
    async function togglePolyDeviceDisabled(deviceId, disabled) {
      try {
        const response = await fetch(`${API_URL}/api/poly-devices/${deviceId}/disable`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ disabled })
        });
        const data = await response.json();
        if (data.success) {
          // Update local poly data
          Object.values(polyLensData).forEach(floorDevices => {
            const device = floorDevices.find(d => d.id === deviceId);
            if (device) {
              device.disabled = data.disabled;
            }
          });
          // Refresh the room analytics if viewing a room
          if (analyticsDevice && analyticsDevice.isRoom) {
            analyticsData = await fetchAnalyticsData(analyticsDevice.id, true, analyticsDevice.name, false, null);
            renderAnalyticsSidebar(false);
          }
          render();
        }
      } catch (e) {
        console.error('Error toggling poly device disabled state:', e);
      }
    }

    // Close context menu when clicking elsewhere
    document.addEventListener('click', (e) => {
      if (!e.target.closest('.context-menu')) {
        hideContextMenu();
      }
    });

    // ==================== UPTIME CHARTS ====================
    function renderUptimeChart(heartbeats, hours = 24) {
      if (!heartbeats || heartbeats.length === 0) {
        return '<div class="uptime-chart"><p style="text-align: center; color: #64748B;">No data available</p></div>';
      }

      // Group heartbeats by hour
      const now = new Date();
      const hourBuckets = [];
      for (let i = hours - 1; i >= 0; i--) {
        const hourStart = new Date(now.getTime() - (i + 1) * 60 * 60 * 1000);
        const hourEnd = new Date(now.getTime() - i * 60 * 60 * 1000);

        const bucketHeartbeats = heartbeats.filter(h => {
          const hTime = new Date(h.timestamp);
          return hTime >= hourStart && hTime < hourEnd;
        });

        const upCount = bucketHeartbeats.filter(h => h.status === 'up').length;
        const total = bucketHeartbeats.length;
        const uptime = total > 0 ? (upCount / total) * 100 : 100;

        hourBuckets.push({ hour: hourStart.getHours(), uptime, total });
      }

      return `
        <div class="uptime-chart">
          <div class="uptime-chart-bars">
            ${hourBuckets.map(b => {
              let barClass = 'up';
              if (b.uptime < 100 && b.uptime >= 50) barClass = 'partial';
              if (b.uptime < 50) barClass = 'down';
              if (b.total === 0) barClass = 'up'; // No data = assume up
              return `<div class="uptime-chart-bar ${barClass}" style="height: ${Math.max(b.uptime, 5)}%"
                title="${b.hour}:00 - ${b.uptime.toFixed(1)}% uptime"></div>`;
            }).join('')}
          </div>
          <div class="uptime-chart-labels">
            <span>${hours}h ago</span>
            <span>Now</span>
          </div>
        </div>
      `;
    }

    // ==================== INITIALIZE NEW FEATURES ====================
    async function initNewFeatures() {
      await Promise.all([
        fetchDeviceTemplates(),
        fetchSavedFilters(),
        fetchFloorZones(),
        fetchFloorHealth(),
        fetchAllTags()
      ]);
      connectWebSocket();

      // Request push permission if previously enabled
      if (pushNotificationsEnabled && Notification.permission === 'default') {
        requestPushPermission();
      }
    }

    // ==================== WEBSOCKET ====================
    let wsTokenRotationInProgress = false; // Flag to track token rotation state
    let wsConnectedWithToken = null; // Track which token the WebSocket was connected with

    function connectWebSocket() {
      // Clear any pending reconnect timer first
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }

      // Close existing WebSocket if any, marking it to prevent reconnect triggering
      if (ws) {
        ws.isClosedIntentionally = true;
        ws.close();
        ws = null;
      }

      if (!authToken) {
        console.log('WebSocket: No auth token, skipping connection');
        wsConnectedWithToken = null;
        return;
      }

      // Capture the token we're connecting with
      const connectingToken = authToken;
      wsReconnecting = wsReconnectAttempts > 0;
      updateConnectionStatus();

      const wsUrl = `${API_URL.replace('http', 'ws')}?token=${encodeURIComponent(connectingToken)}`;
      console.log('WebSocket connecting with token:', connectingToken ? connectingToken.substring(0, 20) + '...' : 'NULL');
      console.log('localStorage token:', localStorage.getItem('authToken')?.substring(0, 20) + '...');
      try {
        const newWs = new WebSocket(wsUrl);

        newWs.onopen = () => {
          // Check if token changed while we were connecting
          if (authToken !== connectingToken) {
            console.log('WebSocket connected but token changed during connection, reconnecting with new token');
            newWs.isClosedIntentionally = true;
            newWs.close();
            // Schedule reconnect with new token
            setTimeout(connectWebSocket, 100);
            return;
          }

          console.log('WebSocket connected');
          wsConnected = true;
          wsReconnecting = false;
          wsReconnectAttempts = 0;
          wsTokenRotationInProgress = false;
          wsConnectedWithToken = connectingToken;
          updateConnectionStatus();
          // Don't full render - just update connection status indicator
        };

        newWs.onmessage = (event) => {
          try {
            const message = JSON.parse(event.data);
            handleWebSocketMessage(message);
          } catch (e) {
            console.error('WebSocket message parse error:', e);
          }
        };

        // Capture reference to this specific WebSocket instance in closure
        newWs.onclose = function(event) {
          const closedWs = this; // Reference to the WebSocket that actually closed
          console.log('WebSocket disconnected, code:', event.code, 'reason:', event.reason);

          // Only update state if this is the current active WebSocket
          if (closedWs === ws) {
            wsConnected = false;
            wsConnectedWithToken = null;
            updateConnectionStatus();
          }

          // Don't auto-reconnect if:
          // 1. This WebSocket was closed intentionally (replaced by new one)
          // 2. Token rotation is in progress (reconnect handled by authFetch)
          // 3. This is not the current active WebSocket
          // 4. We received 4002 (invalid token) - token may have rotated, try immediate reconnect
          if (closedWs.isClosedIntentionally || wsTokenRotationInProgress || closedWs !== ws) {
            console.log('WebSocket closed intentionally or during token rotation, skipping auto-reconnect');
            return;
          }

          // If closed due to invalid token (4002), try immediate reconnect with current token
          // This handles the case where token rotated and we need to reconnect
          if (event.code === 4002) {
            console.log('WebSocket closed due to invalid token, attempting immediate reconnect with current token');
            wsReconnectAttempts = 0; // Reset attempts since this is a token issue, not connection issue
            if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
            wsReconnectTimer = setTimeout(connectWebSocket, 500); // Quick retry
            return;
          }

          wsReconnecting = true;
          wsReconnectAttempts++;
          // Reconnect with exponential backoff (max 30s)
          const delay = Math.min(5000 * Math.pow(1.5, wsReconnectAttempts - 1), 30000);
          console.log(`Reconnecting in ${delay/1000}s (attempt ${wsReconnectAttempts})`);
          if (wsReconnectTimer) clearTimeout(wsReconnectTimer);
          wsReconnectTimer = setTimeout(connectWebSocket, delay);
        };

        newWs.onerror = (error) => {
          console.error('WebSocket error:', error);
        };

        // Assign to global only after handlers are set up
        ws = newWs;
      } catch (e) {
        console.error('WebSocket connection failed:', e);
      }
    }

    function updateConnectionStatus() {
      const statusEl = document.getElementById('connection-status');
      if (!statusEl) return;

      if (wsConnected) {
        statusEl.className = 'connection-status connected';
        statusEl.innerHTML = '<span class="status-icon">‚óè</span> Live';
      } else if (wsReconnecting) {
        statusEl.className = 'connection-status reconnecting';
        statusEl.innerHTML = '<span class="status-icon">‚Üª</span> Reconnecting...';
      } else {
        statusEl.className = 'connection-status disconnected';
        statusEl.innerHTML = '<span class="status-icon">‚óè</span> Disconnected';
      }
    }

    function handleWebSocketMessage(message) {
      switch (message.type) {
        case 'status_update':
          // Update device status in real-time
          const data = message.data;
          if (data && data.deviceId) {
            // Find and update the device in our data
            Object.keys(monitorData).forEach(floor => {
              ['accessPoints', 'printers'].forEach(type => {
                const devices = monitorData[floor]?.[type] || [];
                const device = devices.find(d => d.id == data.deviceId);
                if (device) {
                  device.status = data.status;
                }
              });
            });
            render();
          }
          break;
        case 'notification':
          // Add notification to the list
          if (message.data) {
            notifications.unshift(message.data);
            unreadNotifications++;
            render();
          }
          break;
        case 'incident':
          // Refresh data when incident occurs
          fetchAllData().then(() => render());
          break;
        case 'connected':
          console.log('WebSocket:', message.message);
          break;
        case 'threshold_alert':
          // Server sent a new threshold alert - update local cache
          if (message.data) {
            const { monitorId, alertType } = message.data;
            if (!activeThresholdAlerts[monitorId]) {
              activeThresholdAlerts[monitorId] = [];
            }
            if (!activeThresholdAlerts[monitorId].includes(alertType)) {
              activeThresholdAlerts[monitorId].push(alertType);
            }
          }
          break;
      }
    }

    // Clean up WebSocket on page unload
    window.addEventListener('beforeunload', () => {
      if (wsReconnectTimer) {
        clearTimeout(wsReconnectTimer);
        wsReconnectTimer = null;
      }
      if (ws) {
        ws.isClosedIntentionally = true;
        ws.close();
        ws = null;
      }
    });

    // ==================== QUICK FILTERS ====================
    function toggleFilter(filterName) {
      activeFilters[filterName] = !activeFilters[filterName];
      render();
    }

    function clearAllFilters() {
      activeFilters.offlineOnly = false;
      activeFilters.lowToner = false;
      activeFilters.inMeeting = false;
      render();
    }

    function getFilterCounts() {
      let offlineCount = 0;
      let lowTonerCount = 0;
      let inMeetingCount = 0;

      // Count from monitors
      Object.values(monitorData).forEach(floor => {
        ['accessPoints', 'printers'].forEach(type => {
          const devices = floor[type] || [];
          devices.forEach(d => {
            if (d.status === 'down' && !d.disabled) offlineCount++;
            if (type === 'printers' && printerStatusData[d.id]) {
              const toner = printerStatusData[d.id].toner || {};
              if (Object.values(toner).some(level => level !== null && level < 20)) {
                lowTonerCount++;
              }
            }
          });
        });
      });

      // Count rooms in meeting
      Object.values(polyLensData).forEach(devices => {
        devices.forEach(d => {
          if (d.zoom_in_meeting) inMeetingCount++;
        });
      });

      return { offlineCount, lowTonerCount, inMeetingCount };
    }

    function applyFilters(devices, deviceType) {
      if (!activeFilters.offlineOnly && !activeFilters.lowToner && !activeFilters.inMeeting) {
        return devices;
      }

      return devices.filter(d => {
        if (activeFilters.offlineOnly && d.status !== 'down') return false;
        if (activeFilters.lowToner && deviceType === 'printers') {
          const toner = printerStatusData[d.id]?.toner || {};
          if (!Object.values(toner).some(level => level !== null && level < 20)) return false;
        }
        if (activeFilters.inMeeting && deviceType === 'polyLens') {
          if (!d.zoom_in_meeting) return false;
        }
        return true;
      });
    }

    // ==================== LAST UPDATED ====================
    function updateLastUpdated() {
      lastDataUpdate = new Date();
      const el = document.getElementById('last-updated-time');
      if (el) {
        el.textContent = formatLastUpdated();
      }
    }

    function formatLastUpdated() {
      if (!lastDataUpdate) return 'Never';
      const now = new Date();
      const diff = Math.floor((now - lastDataUpdate) / 1000);
      if (diff < 5) return 'Just now';
      if (diff < 60) return `${diff}s ago`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
      return lastDataUpdate.toLocaleTimeString();
    }

    async function manualRefresh() {
      if (isRefreshing) return;
      isRefreshing = true;
      const icon = document.querySelector('.refresh-icon');
      if (icon) icon.classList.add('spinning');

      try {
        await fetchAllData();
        updateLastUpdated();
        render();
      } finally {
        isRefreshing = false;
        if (icon) icon.classList.remove('spinning');
      }
    }

    // Update "last updated" display every 10 seconds
    setInterval(() => {
      const el = document.getElementById('last-updated-time');
      if (el && lastDataUpdate) {
        el.textContent = formatLastUpdated();
      }
    }, 10000);

    // ==================== FLOOR TRANSITIONS ====================
    function setFloorWithTransition(floor) {
      if (isFloorTransitioning || floor === activeFloor) return;

      isFloorTransitioning = true;
      const content = document.querySelector('.floor-map-wrapper');

      if (content) {
        content.classList.add('transitioning');

        setTimeout(() => {
          activeFloor = floor;
          render();

          requestAnimationFrame(() => {
            const newContent = document.querySelector('.floor-map-wrapper');
            if (newContent) {
              newContent.classList.remove('transitioning');
              newContent.classList.add('entering');
              setTimeout(() => {
                newContent.classList.remove('entering');
                isFloorTransitioning = false;
              }, 400);
            } else {
              isFloorTransitioning = false;
            }
          });
        }, 300);
      } else {
        activeFloor = floor;
        render();
        isFloorTransitioning = false;
      }
    }

    // ==================== PENGUIN LOADER ====================
    function renderPenguinLoader(message = 'Building your dashboard...') {
      return `
        <div class="penguin-loader">
          <div class="penguin-scene">
            <div class="penguin">üêß</div>
            <div class="hammer">üî®</div>
            <div class="nails">
              <span class="nail">üìç</span>
              <span class="nail">üìç</span>
              <span class="nail">üìç</span>
            </div>
          </div>
          <div class="penguin-text">${message}</div>
          <div class="penguin-subtext">This won't take long...</div>
        </div>
      `;
    }

    // ==================== WIDGETS ====================
    function renderWidgets() {
      // Calculate stats
      let totalDevices = 0;
      let onlineDevices = 0;
      let offlineDevices = 0;

      Object.values(monitorData).forEach(floor => {
        ['accessPoints', 'printers'].forEach(type => {
          const devices = floor[type] || [];
          devices.forEach(d => {
            totalDevices++;
            if (d.status === 'up') onlineDevices++;
            else if (d.status === 'down') offlineDevices++;
          });
        });
      });

      const onlinePercent = totalDevices > 0 ? Math.round((onlineDevices / totalDevices) * 100) : 0;
      const offlinePercent = 100 - onlinePercent;

      // Count Poly Lens devices
      let polyTotal = 0;
      let polyOnline = 0;
      Object.values(polyLensData).forEach(devices => {
        devices.forEach(d => {
          polyTotal++;
          if (d.connected) polyOnline++;
        });
      });

      // Count floors with issues
      const floorsWithIssues = Object.keys(monitorData).filter(floor => {
        const floorData = monitorData[floor];
        return ['accessPoints', 'printers'].some(type =>
          (floorData[type] || []).some(d => d.status === 'down')
        );
      }).length;

      return `
        <div class="widgets-section">
          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Status Overview</span>
              <span class="widget-icon">üìä</span>
            </div>
            <div class="widget-content">
              <div class="pie-chart" style="background: conic-gradient(#22C55E 0% ${onlinePercent}%, #EF4444 ${onlinePercent}% 100%);">
                <div class="pie-chart-center">${onlinePercent}%</div>
              </div>
              <div class="widget-stats">
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Online</span>
                  <span class="widget-stat-value green">${onlineDevices}</span>
                </div>
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Offline</span>
                  <span class="widget-stat-value red">${offlineDevices}</span>
                </div>
                <div class="widget-stat-row">
                  <span class="widget-stat-label">Total</span>
                  <span class="widget-stat-value">${totalDevices}</span>
                </div>
              </div>
            </div>
          </div>

          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Quick Stats</span>
              <span class="widget-icon">‚ö°</span>
            </div>
            <div class="widget-content" style="flex-direction: column; gap: 8px;">
              <div class="widget-stat-row">
                <span class="widget-stat-label">Floors Monitored</span>
                <span class="widget-stat-value">${Object.keys(monitorData).length}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Floors with Issues</span>
                <span class="widget-stat-value ${floorsWithIssues > 0 ? 'red' : 'green'}">${floorsWithIssues}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Zoom Rooms</span>
                <span class="widget-stat-value">${polyTotal}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Zoom Online</span>
                <span class="widget-stat-value ${polyOnline === polyTotal ? 'green' : 'yellow'}">${polyOnline}/${polyTotal}</span>
              </div>
            </div>
          </div>

          <div class="widget">
            <div class="widget-header">
              <span class="widget-title">Connection Status</span>
              <span class="widget-icon">${wsConnected ? 'üü¢' : 'üî¥'}</span>
            </div>
            <div class="widget-content" style="flex-direction: column; gap: 8px;">
              <div class="widget-stat-row">
                <span class="widget-stat-label">WebSocket</span>
                <span class="widget-stat-value ${wsConnected ? 'green' : 'red'}">${wsConnected ? 'Connected' : 'Disconnected'}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">API Status</span>
                <span class="widget-stat-value ${apiStatus.monitors.connected ? 'green' : 'red'}">${apiStatus.monitors.connected ? 'Online' : 'Offline'}</span>
              </div>
              <div class="widget-stat-row">
                <span class="widget-stat-label">Poly Lens</span>
                <span class="widget-stat-value ${apiStatus.polyLens.configured ? 'green' : 'yellow'}">${apiStatus.polyLens.configured ? 'Connected' : 'Not Configured'}</span>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Smart popup positioning - show below if not enough space above
    document.addEventListener('mouseenter', function(e) {
      if (!e.target || !e.target.closest) return;
      const marker = e.target.closest('.device-marker');
      if (!marker) return;

      const popup = marker.querySelector('.device-popup');
      if (!popup) return;

      // Reset position first
      popup.classList.remove('below');

      // Get container bounds
      const container = marker.closest('.floor-map');
      if (!container) return;

      const containerRect = container.getBoundingClientRect();
      const markerRect = marker.getBoundingClientRect();

      // Calculate space above marker relative to container top
      const spaceAbove = markerRect.top - containerRect.top;
      const popupHeight = 250; // Approximate popup height

      // If not enough space above, show below
      if (spaceAbove < popupHeight) {
        popup.classList.add('below');
      }
    }, true);
  </script>
</body>
</html>
